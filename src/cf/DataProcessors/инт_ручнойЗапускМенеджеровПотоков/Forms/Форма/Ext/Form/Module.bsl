////////////////////////////////////////////////////////////////////////////////
// Обработка для ручного управления менеджерами потоков
// Позволяет запускать/останавливать управляющие ФЗ для менеджеров формирования и отправки
////////////////////////////////////////////////////////////////////////////////

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ОбновитьСостояниеКнопок();
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	// Запускаем таймер обновления состояния кнопок
	ПодключитьОбработчикОжидания("ОбновитьСостояниеКнопокНаКлиенте", 3, Ложь);
	
КонецПроцедуры

&НаКлиенте
Процедура ПриЗакрытии(ЗавершениеРаботы)
	
	ОтключитьОбработчикОжидания("ОбновитьСостояниеКнопокНаКлиенте");
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура УправлениеМенеджеромФормирования(Команда)
	
	Если МенеджерФормированияАктивен Тогда
		ОстановитьМенеджерФормированияНаСервере();
	Иначе
		ЗапуститьМенеджерФормированияНаСервере();
	КонецЕсли;
	
	ОбновитьСостояниеКнопокНаКлиенте();
	
КонецПроцедуры

&НаКлиенте
Процедура УправлениеМенеджеромОтправки(Команда)
	
	Если МенеджерОтправкиАктивен Тогда
		ОстановитьМенеджерОтправкиНаСервере();
	Иначе
		ЗапуститьМенеджерОтправкиНаСервере();
	КонецЕсли;
	
	ОбновитьСостояниеКнопокНаКлиенте();
	
КонецПроцедуры

&НаКлиенте
Процедура УправлениеМенеджеромВходящих(Команда)
	
	Если МенеджерВходящихАктивен Тогда
		ОстановитьМенеджерВходящихНаСервере();
	Иначе
		ЗапуститьМенеджерВходящихНаСервере();
	КонецЕсли;
	
	ОбновитьСостояниеКнопокНаКлиенте();
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьСостояние(Команда)
	
	ОбновитьСостояниеКнопокНаКлиенте();
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Ключи фоновых заданий - фиксированные, чтобы ФЗ было доступно после перезапуска клиента

// Ключ ФЗ для менеджера формирования
// 
// Возвращаемое значение:
//  Строка - фиксированный ключ ФЗ
//
&НаСервереБезКонтекста
Функция КлючЗаданияФормирования()
	Возврат "инт_УправляющееЗадание_МенеджерФормирования";
КонецФункции

// Ключ ФЗ для менеджера отправки
// 
// Возвращаемое значение:
//  Строка - фиксированный ключ ФЗ
//
&НаСервереБезКонтекста
Функция КлючЗаданияОтправки()
	Возврат "инт_УправляющееЗадание_МенеджерОтправки";
КонецФункции

// Ключ ФЗ для менеджера входящих потоков
// 
// Возвращаемое значение:
//  Строка - фиксированный ключ ФЗ
//
&НаСервереБезКонтекста
Функция КлючЗаданияВходящих()
	Возврат "инт_УправляющееЗадание_МенеджерВходящих";
КонецФункции

#Область Формирование

&НаСервере
Процедура ЗапуститьМенеджерФормированияНаСервере()
	
	// Проверяем, не запущено ли уже
	Если ЕстьАктивноеЗадание(КлючЗаданияФормирования()) Тогда
		Возврат;
	КонецЕсли;
	
	// Запускаем управляющее ФЗ
	ПараметрыФЗ = Новый Массив;
	ФоновыеЗадания.Выполнить(
		"инт_РучноеУправлениеМенеджерами.УправляющееЗаданиеФормирования",
		ПараметрыФЗ,
		КлючЗаданияФормирования(),
		"Управляющее ФЗ: Менеджер формирования сообщений");
	
	ЗаписьЖурналаРегистрации(
		"ПодсистемаИнтеграции.РучноеУправление",
		УровеньЖурналаРегистрации.Информация,
		,
		,
		"Запущено управляющее ФЗ для менеджера формирования сообщений");
	
КонецПроцедуры

&НаСервере
Процедура ОстановитьМенеджерФормированияНаСервере()
	
	ОстановитьЗадание(КлючЗаданияФормирования());
	
	ЗаписьЖурналаРегистрации(
		"ПодсистемаИнтеграции.РучноеУправление",
		УровеньЖурналаРегистрации.Информация,
		,
		,
		"Остановлено управляющее ФЗ для менеджера формирования сообщений");
	
КонецПроцедуры

#КонецОбласти

#Область Отправка

&НаСервере
Процедура ЗапуститьМенеджерОтправкиНаСервере()
	
	// Проверяем, не запущено ли уже
	Если ЕстьАктивноеЗадание(КлючЗаданияОтправки()) Тогда
		Возврат;
	КонецЕсли;
	
	// Запускаем управляющее ФЗ
	ПараметрыФЗ = Новый Массив;
	ФоновыеЗадания.Выполнить(
		"инт_РучноеУправлениеМенеджерами.УправляющееЗаданиеОтправки",
		ПараметрыФЗ,
		КлючЗаданияОтправки(),
		"Управляющее ФЗ: Менеджер отправки сообщений");
	
	ЗаписьЖурналаРегистрации(
		"ПодсистемаИнтеграции.РучноеУправление",
		УровеньЖурналаРегистрации.Информация,
		,
		,
		"Запущено управляющее ФЗ для менеджера отправки сообщений");
	
КонецПроцедуры

&НаСервере
Процедура ОстановитьМенеджерОтправкиНаСервере()
	
	ОстановитьЗадание(КлючЗаданияОтправки());
	
	ЗаписьЖурналаРегистрации(
		"ПодсистемаИнтеграции.РучноеУправление",
		УровеньЖурналаРегистрации.Информация,
		,
		,
		"Остановлено управляющее ФЗ для менеджера отправки сообщений");
	
КонецПроцедуры

#КонецОбласти

#Область Входящие

&НаСервере
Процедура ЗапуститьМенеджерВходящихНаСервере()
	
	// Проверяем, не запущено ли уже
	Если ЕстьАктивноеЗадание(КлючЗаданияВходящих()) Тогда
		Возврат;
	КонецЕсли;
	
	// Запускаем управляющее ФЗ
	ПараметрыФЗ = Новый Массив;
	ФоновыеЗадания.Выполнить(
		"инт_РучноеУправлениеМенеджерами.УправляющееЗаданиеВходящих",
		ПараметрыФЗ,
		КлючЗаданияВходящих(),
		"Управляющее ФЗ: Менеджер входящих потоков");
	
	ЗаписьЖурналаРегистрации(
		"ПодсистемаИнтеграции.РучноеУправление",
		УровеньЖурналаРегистрации.Информация,
		,
		,
		"Запущено управляющее ФЗ для менеджера входящих потоков");
	
КонецПроцедуры

&НаСервере
Процедура ОстановитьМенеджерВходящихНаСервере()
	
	ОстановитьЗадание(КлючЗаданияВходящих());
	
	// Также останавливаем все активные консьюмеры
	инт_МенеджерВходящихПотоков.ОстановитьВсеКонсьюмеры();
	
	ЗаписьЖурналаРегистрации(
		"ПодсистемаИнтеграции.РучноеУправление",
		УровеньЖурналаРегистрации.Информация,
		,
		,
		"Остановлено управляющее ФЗ для менеджера входящих потоков");
	
КонецПроцедуры

#КонецОбласти

#Область ОбщиеПроцедуры

&НаСервереБезКонтекста
Функция ЕстьАктивноеЗадание(КлючЗадания)
	
	Отбор = Новый Структура;
	Отбор.Вставить("Ключ", КлючЗадания);
	Отбор.Вставить("Состояние", СостояниеФоновогоЗадания.Активно);
	
	Задания = ФоновыеЗадания.ПолучитьФоновыеЗадания(Отбор);
	
	Возврат Задания.Количество() > 0;
	
КонецФункции

&НаСервере
Процедура ОстановитьЗадание(КлючЗадания)
	
	Отбор = Новый Структура;
	Отбор.Вставить("Ключ", КлючЗадания);
	Отбор.Вставить("Состояние", СостояниеФоновогоЗадания.Активно);
	
	Задания = ФоновыеЗадания.ПолучитьФоновыеЗадания(Отбор);
	
	Для Каждого Задание Из Задания Цикл
		Попытка
			Задание.Отменить();
		Исключение
			// Задание могло завершиться между проверкой и отменой - игнорируем
			Продолжить;
		КонецПопытки;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьСостояниеКнопокНаКлиенте()
	
	ОбновитьСостояниеКнопок();
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьСостояниеКнопок()
	
	МенеджерФормированияАктивен = ЕстьАктивноеЗадание(КлючЗаданияФормирования());
	МенеджерОтправкиАктивен = ЕстьАктивноеЗадание(КлючЗаданияОтправки());
	МенеджерВходящихАктивен = ЕстьАктивноеЗадание(КлючЗаданияВходящих());
	
	// Обновляем статусы (атрибуты формы определены в Form.xml)
	// BSLLS:UnusedLocalVariable-off
	СтатусФормирования = ?(МенеджерФормированияАктивен, "Управляющее ФЗ: Активно", "Управляющее ФЗ: Остановлено");
	СтатусОтправки = ?(МенеджерОтправкиАктивен, "Управляющее ФЗ: Активно", "Управляющее ФЗ: Остановлено");
	СтатусВходящих = ?(МенеджерВходящихАктивен, "Управляющее ФЗ: Активно", "Управляющее ФЗ: Остановлено");
	// BSLLS:UnusedLocalVariable-on
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти
