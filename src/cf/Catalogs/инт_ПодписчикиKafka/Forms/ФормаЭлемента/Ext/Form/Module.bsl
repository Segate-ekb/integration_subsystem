////////////////////////////////////////////////////////////////////////////////
// инт_ПодписчикиKafka.ФормаЭлемента
// Форма подписчика Kafka с функциями управления топиками
////////////////////////////////////////////////////////////////////////////////

#Область ОбработчикиСобытийФормы

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	ПроверитьСтатусТопика();
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Инициализация реквизитов формы
	СтатусТопика = 0; // 0 - неизвестен, 1 - существует, 2 - не существует, 3 - ошибка подключения
	
	// Начальная установка видимости элементов
	ОбновитьВидимостьЭлементовФормыНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	ПроверитьСтатусТопика();
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ЭндпоинтПриИзменении(Элемент)
	СтатусТопика = 0;
	ОбновитьВидимостьЭлементовФормы();
КонецПроцедуры

&НаКлиенте
Процедура ИмяТопикаПриИзменении(Элемент)
	СтатусТопика = 0;
	ОбновитьВидимостьЭлементовФормы();
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ТестПодключения(Команда)
	
	Если НЕ ЗначениеЗаполнено(Объект.Эндпоинт) Тогда
		ПоказатьПредупреждение(, "Не указан эндпоинт (брокер Kafka)!");
		Возврат;
	КонецЕсли;
	
	Результат = ВыполнитьТестПодключенияНаСервере();
	
	Если Результат.Успех Тогда
		ТекстСообщения = СтрШаблон("Подключение успешно!
			|
			|Информация о кластере:
			|  Брокеров: %1
			|  Топиков: %2",
			Результат.КоличествоБрокеров,
			Результат.КоличествоТопиков);
		ПоказатьПредупреждение(, ТекстСообщения);
		
		// Проверяем статус топика после успешного теста подключения
		ПроверитьСтатусТопика();
	Иначе
		ПоказатьПредупреждение(, "Ошибка подключения: " + Результат.ОписаниеОшибки);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьТопик(Команда)
	ПроверитьСтатусТопика();
КонецПроцедуры

&НаКлиенте
Процедура СоздатьТопик(Команда)
	
	Если НЕ ЗначениеЗаполнено(Объект.Эндпоинт) Тогда
		ПоказатьПредупреждение(, "Не указан эндпоинт!");
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Объект.ИмяТопика) Тогда
		ПоказатьПредупреждение(, "Не указано имя топика!");
		Возврат;
	КонецЕсли;
	
	// Запрос подтверждения создания топика
	ОписаниеОповещения = Новый ОписаниеОповещения("СоздатьТопикЗавершение", ЭтотОбъект);
	ПоказатьВопрос(ОписаниеОповещения, 
		СтрШаблон("Создать топик '%1' с параметрами:
			|
			|  Партиций: %2
			|  Фактор репликации: %3",
			Объект.ИмяТопика,
			КоличествоПартиций,
			ФакторРепликации),
		РежимДиалогаВопрос.ДаНет);
	
КонецПроцедуры

&НаКлиенте
Процедура СоздатьТопикЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат <> КодВозвратаДиалога.Да Тогда
		Возврат;
	КонецЕсли;
	
	РезультатСоздания = СоздатьТопикНаСервере();
	
	Если РезультатСоздания.Успех Тогда
		ПоказатьПредупреждение(, СтрШаблон("Топик '%1' успешно создан!", Объект.ИмяТопика));
		ПроверитьСтатусТопика();
	Иначе
		ПоказатьПредупреждение(, "Ошибка создания топика: " + РезультатСоздания.ОписаниеОшибки);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура СохранитьНастройки(Команда)
	
	Если НЕ ЗначениеЗаполнено(Объект.Эндпоинт) Тогда
		ПоказатьПредупреждение(, "Не указан эндпоинт!");
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Объект.ИмяТопика) Тогда
		ПоказатьПредупреждение(, "Не указано имя топика!");
		Возврат;
	КонецЕсли;
	
	// Проверяем, есть ли изменённые настройки
	ЕстьИзменения = Ложь;
	Для Каждого СтрокаНастройки Из НастройкиТопика Цикл
		Если СтрокаНастройки.Изменено Тогда
			ЕстьИзменения = Истина;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Если НЕ ЕстьИзменения Тогда
		ПоказатьПредупреждение(, "Нет изменённых настроек для сохранения.");
		Возврат;
	КонецЕсли;
	
	// Запрос подтверждения сохранения
	ОписаниеОповещения = Новый ОписаниеОповещения("СохранитьНастройкиЗавершение", ЭтотОбъект);
	ПоказатьВопрос(ОписаниеОповещения, 
		"Сохранить изменённые настройки топика в Kafka?",
		РежимДиалогаВопрос.ДаНет);
	
КонецПроцедуры

&НаКлиенте
Процедура СохранитьНастройкиЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат <> КодВозвратаДиалога.Да Тогда
		Возврат;
	КонецЕсли;
	
	РезультатСохранения = СохранитьНастройкиНаСервере();
	
	Если РезультатСохранения.Успех Тогда
		ПоказатьПредупреждение(, СтрШаблон("Настройки топика '%1' успешно сохранены!", Объект.ИмяТопика));
		// Обновляем информацию о топике после сохранения
		ПроверитьСтатусТопика();
	Иначе
		ПоказатьПредупреждение(, "Ошибка сохранения настроек: " + РезультатСохранения.ОписаниеОшибки);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Процедура ПроверитьСтатусТопика()
	
	Если НЕ ЗначениеЗаполнено(Объект.Эндпоинт) ИЛИ НЕ ЗначениеЗаполнено(Объект.ИмяТопика) Тогда
		СтатусТопика = 0;
		ОбновитьВидимостьЭлементовФормы();
		Возврат;
	КонецЕсли;
	
	ПроверитьСтатусТопикаНаСервере();
	ОбновитьВидимостьЭлементовФормы();
	
КонецПроцедуры

&НаСервере
Процедура ПроверитьСтатусТопикаНаСервере()
	
	Если НЕ ЗначениеЗаполнено(Объект.Эндпоинт) ИЛИ НЕ ЗначениеЗаполнено(Объект.ИмяТопика) Тогда
		СтатусТопика = 0;
		ОбновитьВидимостьЭлементовФормыНаСервере();
		Возврат;
	КонецЕсли;
	
	Брокеры = Объект.Эндпоинт.АдресРесурса;
	Результат = инт_РаботаСКафка.ТопикСуществует(Брокеры, Объект.ИмяТопика);
	
	Если НЕ ПустаяСтрока(Результат.ОписаниеОшибки) Тогда
		// Ошибка подключения
		СтатусТопика = 3;
		ИнформацияОТопике = "Ошибка: " + Результат.ОписаниеОшибки;
	ИначеЕсли Результат.Существует Тогда
		// Топик существует
		СтатусТопика = 1;
		
		// Получаем информацию о топике
		ДанныеТопика = Результат.Метаданные;
		Если ДанныеТопика <> Неопределено Тогда
			КолПартиций = ДанныеТопика.Получить("partitions_count");
			Если КолПартиций = Неопределено Тогда
				КолПартиций = "?";
			КонецЕсли;
			ИнформацияОТопике = СтрШаблон("Топик существует. Партиций: %1", КолПартиций);
			
			// Получаем настройки топика
			РезультатНастроек = инт_РаботаСКафка.ПолучитьНастройкиТопика(Брокеры, Объект.ИмяТопика);
			Если РезультатНастроек.Успех Тогда
				ЗаполнитьНастройкиТопика(РезультатНастроек.Настройки);
			КонецЕсли;
		Иначе
			ИнформацияОТопике = "Топик существует";
		КонецЕсли;
	Иначе
		// Топик не существует
		СтатусТопика = 2;
		ИнформацияОТопике = "Топик не найден в Kafka";
	КонецЕсли;
	
	ОбновитьВидимостьЭлементовФормыНаСервере();
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьНастройкиТопика(Настройки)
	
	// Очищаем таблицу настроек
	НастройкиТопика.Очистить();
	
	// Заполняем таблицу настроек из полученных данных
	Для Каждого КлючЗначение Из Настройки Цикл
		НоваяСтрока = НастройкиТопика.Добавить();
		НоваяСтрока.КлючНастройки = КлючЗначение.Ключ;
		НоваяСтрока.ЗначениеНастройки = Строка(?(КлючЗначение.Значение = Неопределено, "", КлючЗначение.Значение));
		НоваяСтрока.ИсходноеЗначение = НоваяСтрока.ЗначениеНастройки;
		НоваяСтрока.Изменено = Ложь;
	КонецЦикла;
	
	// Сортируем по ключу для удобства
	НастройкиТопика.Сортировать("КлючНастройки");
	
КонецПроцедуры

&НаКлиенте                                                                                         
Процедура ОбновитьВидимостьЭлементовФормы()
	
	// Кнопка создания топика видна только если топик не существует
	Элементы.ФормаСоздатьТопик.Видимость = (СтатусТопика = 2);
	
	// Группа параметров топика видна только если топик существует
	Элементы.ГруппаПараметрыТопика.Видимость = (СтатусТопика = 1);
	
	// Группа создания топика видна только если топик не существует
	Элементы.ГруппаСозданиеТопика.Видимость = (СтатусТопика = 2);
	
	// Обновляем декорацию статуса
	ОбновитьИндикаторСтатуса();
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьИндикаторСтатуса()
	
	// Обновляем декорацию статуса
	Если СтатусТопика = 0 Тогда
		Элементы.КартинкаСтатусТопика.Картинка = БиблиотекаКартинок.ОформлениеКругПустой;
		Элементы.ДекорацияСтатусТопика.Заголовок = "Не проверено";
	ИначеЕсли СтатусТопика = 1 Тогда
		Элементы.КартинкаСтатусТопика.Картинка = БиблиотекаКартинок.ОформлениеЗнакФлажок;
		Элементы.ДекорацияСтатусТопика.Заголовок = ИнформацияОТопике;
	ИначеЕсли СтатусТопика = 2 Тогда
		Элементы.КартинкаСтатусТопика.Картинка = БиблиотекаКартинок.ОформлениеЗнакВосклицательныйЗнак;
		Элементы.ДекорацияСтатусТопика.Заголовок = ИнформацияОТопике;
	ИначеЕсли СтатусТопика = 3 Тогда
		Элементы.КартинкаСтатусТопика.Картинка = БиблиотекаКартинок.ОформлениеЗнакКрест;
		Элементы.ДекорацияСтатусТопика.Заголовок = ИнформацияОТопике;
	КонецЕсли;	
КонецПроцедуры

&НаСервере
Процедура ОбновитьВидимостьЭлементовФормыНаСервере()
	
	// Кнопка создания топика видна только если топик не существует
	Элементы.ФормаСоздатьТопик.Видимость = (СтатусТопика = 2);
	
	// Группа параметров топика видна только если топик существует
	Элементы.ГруппаПараметрыТопика.Видимость = (СтатусТопика = 1);
	
	// Группа создания топика видна только если топик не существует
	Элементы.ГруппаСозданиеТопика.Видимость = (СтатусТопика = 2);
	
	// Обновляем декорацию статуса
	Если СтатусТопика = 0 Тогда
		Элементы.КартинкаСтатусТопика.Картинка = БиблиотекаКартинок.ОформлениеКругПустой;
		Элементы.ДекорацияСтатусТопика.Заголовок = "Не проверено";
	ИначеЕсли СтатусТопика = 1 Тогда
		Элементы.КартинкаСтатусТопика.Картинка = БиблиотекаКартинок.ОформлениеЗнакФлажок;
		Элементы.ДекорацияСтатусТопика.Заголовок = ИнформацияОТопике;
	ИначеЕсли СтатусТопика = 2 Тогда
		Элементы.КартинкаСтатусТопика.Картинка = БиблиотекаКартинок.ОформлениеЗнакВосклицательныйЗнак;
		Элементы.ДекорацияСтатусТопика.Заголовок = ИнформацияОТопике;
	ИначеЕсли СтатусТопика = 3 Тогда
		Элементы.КартинкаСтатусТопика.Картинка = БиблиотекаКартинок.ОформлениеЗнакКрест;
		Элементы.ДекорацияСтатусТопика.Заголовок = ИнформацияОТопике;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ВыполнитьТестПодключенияНаСервере()
	
	Брокеры = Объект.Эндпоинт.АдресРесурса;
	Результат = инт_РаботаСКафка.ПроверитьДоступностьБрокера(Брокеры);
	
	ВозвращаемыйРезультат = Новый Структура("Успех, ОписаниеОшибки, КоличествоБрокеров, КоличествоТопиков",
		Результат.Успех, Результат.ОписаниеОшибки, 0, 0);
	
	Если Результат.Успех И Результат.ИнформацияОКластере <> Неопределено Тогда
		КолБрокеров = Результат.ИнформацияОКластере.Получить("brokers_count");
		Если КолБрокеров <> Неопределено Тогда
			ВозвращаемыйРезультат.КоличествоБрокеров = Число(КолБрокеров);
		КонецЕсли;
		
		КолТопиков = Результат.ИнформацияОКластере.Получить("topics_count");
		Если КолТопиков <> Неопределено Тогда
			ВозвращаемыйРезультат.КоличествоТопиков = Число(КолТопиков);
		КонецЕсли;
	КонецЕсли;
	
	Возврат ВозвращаемыйРезультат;
	
КонецФункции

&НаСервере
Функция СоздатьТопикНаСервере()
	
	Брокеры = Объект.Эндпоинт.АдресРесурса;
	Возврат инт_РаботаСКафка.СоздатьТопик(Брокеры, Объект.ИмяТопика, КоличествоПартиций, ФакторРепликации);
	
КонецФункции

&НаСервере
Функция СохранитьНастройкиНаСервере()
	
	Брокеры = Объект.Эндпоинт.АдресРесурса;
	
	// Собираем только изменённые настройки
	ИзмененныеНастройки = Новый Соответствие;
	
	Для Каждого СтрокаНастройки Из НастройкиТопика Цикл
		Если СтрокаНастройки.Изменено И ЗначениеЗаполнено(СтрокаНастройки.КлючНастройки) Тогда
			ИзмененныеНастройки.Вставить(СтрокаНастройки.КлючНастройки, СтрокаНастройки.ЗначениеНастройки);
		КонецЕсли;
	КонецЦикла;
	
	Возврат инт_РаботаСКафка.УстановитьНастройкиТопика(Брокеры, Объект.ИмяТопика, ИзмененныеНастройки);
	
КонецФункции

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыНастройкиТопика

&НаКлиенте
Процедура НастройкиТопикаЗначениеНастройкиПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.НастройкиТопика.ТекущиеДанные;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// Отмечаем строку как изменённую, если значение отличается от исходного
	ТекущаяСтрока.Изменено = (ТекущаяСтрока.ЗначениеНастройки <> ТекущаяСтрока.ИсходноеЗначение);
	
КонецПроцедуры

&НаКлиенте
Процедура НастройкиТопикаКлючНастройкиПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.НастройкиТопика.ТекущиеДанные;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// Новая строка считается изменённой
	Если ПустаяСтрока(ТекущаяСтрока.ИсходноеЗначение) Тогда
		ТекущаяСтрока.Изменено = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура НастройкиТопикаПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	
	Если НоваяСтрока Тогда
		ТекущаяСтрока = Элементы.НастройкиТопика.ТекущиеДанные;
		Если ТекущаяСтрока <> Неопределено Тогда
			ТекущаяСтрока.Изменено = Истина;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти
