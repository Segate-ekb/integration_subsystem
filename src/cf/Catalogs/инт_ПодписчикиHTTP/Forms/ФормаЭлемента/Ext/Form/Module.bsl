////////////////////////////////////////////////////////////////////////////////
// инт_ПодписчикиHTTP.ФормаЭлемента
// Форма подписчика HTTP
////////////////////////////////////////////////////////////////////////////////

#Область ОбработчикиСобытийФормы

&НаКлиенте
Процедура ПриОткрытии(Отказ)
// Инициализация
КонецПроцедуры



#КонецОбласти
#Область ОбработчикиСобытийЭлементовТаблицыФормыПостПроцессинг

&НаКлиенте
Процедура ПостПроцессингОбработчикНачалоВыбора(Элемент, ДанныеВыбора, ВыборДобавлением, СтандартнаяОбработка)

СтандартнаяОбработка = Ложь;
ДопПараметры = Новый Структура("ТекстОбработчика", Элемент.ТекстРедактирования);
ОписаниеОповещения = Новый ОписаниеОповещения("ПослеЗакрытияРедактированияОбработчика", ЭтотОбъект);

ОткрытьФорму("Справочник.инт_Подписчики.Форма.ФормаРедактированияОбработчика",
ДопПараметры,
Элемент,
,
,
,
ОписаниеОповещения,
РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);

КонецПроцедуры

&НаКлиенте
Процедура ПослеЗакрытияРедактированияОбработчика(ТекстОбработчика, ДополнительныеПараметры) Экспорт

Если ТекстОбработчика = Неопределено Тогда
Возврат;
КонецЕсли;

Элементы.ПостПроцессинг.ТекущиеДанные.Обработчик = ТекстОбработчика;
Модифицированность = Истина;

КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ТестПодключения(Команда)

Если НЕ ЗначениеЗаполнено(Объект.Эндпоинт) Тогда
ПоказатьПредупреждение(, "Не указан эндпоинт!");
Возврат;
КонецЕсли;

Результат = ВыполнитьТестПодключенияНаСервере();

Если Результат.Успех Тогда
ТекстСообщения = СтрШаблон("Подключение успешно!
|
|Код ответа: %1", Результат.КодСостояния);
ПоказатьПредупреждение(, ТекстСообщения);
Иначе
ПоказатьПредупреждение(, "Ошибка подключения: " + Результат.ОписаниеОшибки);
КонецЕсли;

КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Функция ВыполнитьТестПодключенияНаСервере()

Результат = Новый Структура("Успех, ОписаниеОшибки, КодСостояния", Ложь, "", 0);

Попытка
АдресРесурса = инт_ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Объект.Эндпоинт, "АдресРесурса");
Если НЕ ЗначениеЗаполнено(АдресРесурса) Тогда
Результат.ОписаниеОшибки = "Не указан адрес ресурса в эндпоинте";
Возврат Результат;
КонецЕсли;

// Простая проверка доступности по HEAD запросу
Ответ = инт_КоннекторHTTP.Head(АдресРесурса);
Результат.Успех = (Ответ.КодСостояния >= 200 И Ответ.КодСостояния < 500);
Результат.КодСостояния = Ответ.КодСостояния;
Исключение
Результат.ОписаниеОшибки = ОписаниеОшибки();
КонецПопытки;

Возврат Результат;

КонецФункции

#КонецОбласти
