////////////////////////////////////////////////////////////////////////////////
// инт_ПодписчикиПодсистемаИнтеграции.ФормаЭлемента
// Форма подписчика для обмена с другой базой по подсистеме интеграции
////////////////////////////////////////////////////////////////////////////////

#Область ОбработчикиСобытийФормы

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	// Инициализация
КонецПроцедуры



#КонецОбласти
#Область ОбработчикиСобытийЭлементовТаблицыФормыПостПроцессинг

&НаКлиенте
Процедура ПостПроцессингОбработчикНачалоВыбора(Элемент, ДанныеВыбора, ВыборДобавлением, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ДопПараметры = Новый Структура("ТекстОбработчика", Элемент.ТекстРедактирования);
	ОписаниеОповещения = Новый ОписаниеОповещения("ПослеЗакрытияРедактированияОбработчика", ЭтотОбъект);
	
	ОткрытьФорму("Справочник.инт_Подписчики.Форма.ФормаРедактированияОбработчика",
		ДопПараметры,
		Элемент,
		,
		,
		,
		ОписаниеОповещения,
		РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗакрытияРедактированияОбработчика(ТекстОбработчика, ДополнительныеПараметры) Экспорт
	
	Если ТекстОбработчика = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Элементы.ПостПроцессинг.ТекущиеДанные.Обработчик = ТекстОбработчика;
	Модифицированность = Истина;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ТестПодключения(Команда)
	
	Если НЕ ЗначениеЗаполнено(Объект.Эндпоинт) И НЕ ЗначениеЗаполнено(ЭтотОбъект["АдресРесурса"]) Тогда
		ПоказатьПредупреждение(, "Не указан эндпоинт или адрес ресурса!");
		Возврат;
	КонецЕсли;
	
	Результат = ВыполнитьТестПодключенияНаСервере();
	
	Если Результат.Успех Тогда
		ТекстСообщения = СтрШаблон("Подключение к подсистеме интеграции успешно!
			|
			|Код ответа: %1", Результат.КодСостояния);
		ПоказатьПредупреждение(, ТекстСообщения);
	Иначе
		ПоказатьПредупреждение(, "Ошибка подключения: " + Результат.ОписаниеОшибки);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Функция ВыполнитьТестПодключенияНаСервере()
	
	Результат = Новый Структура("Успех, ОписаниеОшибки, КодСостояния", Ложь, "", 0);
	
	Попытка
		АдресРесурса = ЭтотОбъект["АдресРесурса"];
		Если НЕ ЗначениеЗаполнено(АдресРесурса) Тогда
			Результат.ОписаниеОшибки = "Не указан адрес ресурса";
			Возврат Результат;
		КонецЕсли;
		
		// Проверка доступности HTTP-сервиса подсистемы интеграции
		URLПроверки = СтрШаблон("%1/hs/api/v1/ping", АдресРесурса);
		Ответ = инт_КоннекторHTTP.Get(URLПроверки);
		Результат.Успех = (Ответ.КодСостояния >= 200 И Ответ.КодСостояния < 500);
		Результат.КодСостояния = Ответ.КодСостояния;
	Исключение
		Результат.ОписаниеОшибки = ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти
