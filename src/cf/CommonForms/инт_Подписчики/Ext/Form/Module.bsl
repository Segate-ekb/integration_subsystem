////////////////////////////////////////////////////////////////////////////////
// ОбщаяФорма.инт_Подписчики
// Список всех подписчиков, сгруппированных по типу
////////////////////////////////////////////////////////////////////////////////

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	НастроитьУсловноеОформление();
	СформироватьСписокПодписчиков();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыПодписчики

&НаКлиенте
Процедура ПодписчикиВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ДанныеСтроки = Элементы.Подписчики.ТекущиеДанные;
	
	Если ДанныеСтроки = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ДанныеСтроки.Ссылка) Тогда
		// Это строка группы - разворачиваем/сворачиваем
		Возврат;
	КонецЕсли;
	
	ПоказатьЗначение(, ДанныеСтроки.Ссылка);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Обновить(Команда)
	ОбновитьНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура СоздатьПодписчика(Команда)
	
	СписокТипов = Новый СписокЗначений;
	СписокТипов.Добавить("HTTP", "HTTP");
	СписокТипов.Добавить("JRPC", "JSON-RPC 2.0");
	СписокТипов.Добавить("ПодсистемаИнтеграции", "Подсистема интеграции");
	СписокТипов.Добавить("Kafka", "Apache Kafka");
	СписокТипов.Добавить("RabbitMQ", "RabbitMQ");
	
	ОписаниеОповещения = Новый ОписаниеОповещения("СоздатьПодписчикаЗавершение", ЭтотОбъект);
	ПоказатьВыборИзСписка(ОписаниеОповещения, СписокТипов);
	
КонецПроцедуры

&НаКлиенте
Процедура СоздатьПодписчикаЗавершение(ВыбранныйЭлемент, ДополнительныеПараметры) Экспорт
	
	Если ВыбранныйЭлемент = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ИмяСправочника = "инт_Подписчики" + ВыбранныйЭлемент.Значение;
	ОткрытьФорму("Справочник." + ИмяСправочника + ".ФормаОбъекта", , ЭтотОбъект);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура НастроитьУсловноеОформление()
	
	УсловноеОформление.Элементы.Очистить();
	
	// 1. Скрыть флажок "Активен" для групп (типов подписчиков)
	ЭлементУО = УсловноеОформление.Элементы.Добавить();
	ЭлементУО.Использование = Истина;
	
	ПолеОформления = ЭлементУО.Поля.Элементы.Добавить();
	ПолеОформления.Поле = Новый ПолеКомпоновкиДанных(Элементы.ПодписчикиАктивен.Имя);
	
	ОтборЭлемента = ЭлементУО.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Подписчики.ЭтоГруппа");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;
	
	ЭлементУО.Оформление.УстановитьЗначениеПараметра("Видимость", Ложь);
	
	// 2. Выделить группы жирным шрифтом
	ЭлементУО = УсловноеОформление.Элементы.Добавить();
	ЭлементУО.Использование = Истина;
	
	ПолеОформления = ЭлементУО.Поля.Элементы.Добавить();
	ПолеОформления.Поле = Новый ПолеКомпоновкиДанных(Элементы.ПодписчикиНаименование.Имя);
	
	ОтборЭлемента = ЭлементУО.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Подписчики.ЭтоГруппа");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;
	
	ЭлементУО.Оформление.УстановитьЗначениеПараметра("Шрифт", Новый Шрифт(, , Истина));
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьНаСервере()
	Подписчики.ПолучитьЭлементы().Очистить();
	СформироватьСписокПодписчиков();
КонецПроцедуры

&НаСервере
Процедура СформироватьСписокПодписчиков()
	
	ТипыПодписчиков = Новый Массив;
	ТипыПодписчиков.Добавить(Новый Структура("Тип, Представление", "HTTP", "HTTP"));
	ТипыПодписчиков.Добавить(Новый Структура("Тип, Представление", "JRPC", "JSON-RPC 2.0"));
	ТипыПодписчиков.Добавить(Новый Структура("Тип, Представление", "ПодсистемаИнтеграции", "Подсистема интеграции"));
	ТипыПодписчиков.Добавить(Новый Структура("Тип, Представление", "Kafka", "Apache Kafka"));
	ТипыПодписчиков.Добавить(Новый Структура("Тип, Представление", "RabbitMQ", "RabbitMQ"));
	
	Для Каждого ОписаниеТипа Из ТипыПодписчиков Цикл
		
		ДобавитьГруппуПодписчиков(ОписаниеТипа.Тип, ОписаниеТипа.Представление);
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура ДобавитьГруппуПодписчиков(СуффиксТипа, Представление)
	
	ИмяСправочника = "инт_Подписчики" + СуффиксТипа;
	
	Запрос = Новый Запрос;
	Запрос.Текст = СтрШаблон(
		"ВЫБРАТЬ
		|	Т.Ссылка КАК Ссылка,
		|	Т.Наименование КАК Наименование,
		|	Т.Код КАК Код,
		|	Т.Активен КАК Активен
		|ИЗ
		|	Справочник.%1 КАК Т
		|
		|УПОРЯДОЧИТЬ ПО
		|	Т.Наименование", ИмяСправочника);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	// Создаём группу
	СтрокаГруппы = Подписчики.ПолучитьЭлементы().Добавить();
	СтрокаГруппы.Наименование = СтрШаблон("%1 (%2)", Представление, Выборка.Количество());
	СтрокаГруппы.ТипПодписчика = СуффиксТипа;
	СтрокаГруппы.ЭтоГруппа = Истина;
	
	// Добавляем подписчиков в группу
	Пока Выборка.Следующий() Цикл
		
		СтрокаПодписчика = СтрокаГруппы.ПолучитьЭлементы().Добавить();
		СтрокаПодписчика.Ссылка = Выборка.Ссылка;
		СтрокаПодписчика.Наименование = Выборка.Наименование;
		СтрокаПодписчика.Код = Выборка.Код;
		СтрокаПодписчика.Активен = Выборка.Активен;
		СтрокаПодписчика.ТипПодписчика = СуффиксТипа;
		СтрокаПодписчика.ЭтоГруппа = Ложь;
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

