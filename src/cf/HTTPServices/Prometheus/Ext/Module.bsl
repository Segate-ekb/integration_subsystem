////////////////////////////////////////////////////////////////////////////////
// HTTP-сервис: Prometheus
//
// Описание:
//  HTTP-сервис для предоставления метрик в формате Prometheus.
//  Используется системой мониторинга Prometheus для сбора метрик работы подсистемы интеграции.
//
// Методы:
//  GET /polling - Получить метрики в формате Prometheus
//
// Формат URL:
//  http://<сервер>/integration_subsystem/hs/prometheus/polling
//
// Формат ответа (text/plain):
//  # HELP pde_queue_length Количество сообщений в очереди
//  # TYPE pde_queue_length gauge
//  pde_queue_length{queue="outgoing"} 42
//  pde_queue_length{queue="incoming"} 15
//
// Пример использования в prometheus.yml:
//  scrape_configs:
//    - job_name: '1c_integration'
//      static_configs:
//        - targets: ['server:port']
//      metrics_path: '/integration_subsystem/hs/prometheus/polling'
//
////////////////////////////////////////////////////////////////////////////////

#Область ОбработчикиСобытий

// Функция - Получение метрик для Prometheus
//
// Параметры:
//  Запрос - HTTPСервисЗапрос - Входящий HTTP-запрос от Prometheus
//
// Возвращаемое значение:
//  HTTPСервисОтвет - Ответ с кодом состояния:
//    200 - метрики успешно сформированы
//    204 - нет доступных метрик
//    400 - некорректный запрос (неверные заголовки)
//    405 - неподдерживаемый формат Accept
//
// Описание:
//  Формирует и возвращает метрики работы подсистемы интеграции в формате Prometheus.
//  Включает метрики очередей, времени обработки, количества ошибок и другие.
//
Функция PollingGet(Запрос)
	
	УстановитьПривилегированныйРежим(Истина);
	
	//UserAgent = Запрос.Заголовки.Получить("User-Agent"); 
	//Accept = Запрос.Заголовки.Получить("Accept");
	
 	//Если UserAgent = Неопределено ИЛИ Accept = Неопределено Тогда
	//	Возврат Новый HTTPСервисОтвет(400);
	//ИначеЕсли НЕ UserAgent = "Go-http-client/1.1" Тогда
	//	Возврат пэмМетрикиСервер.ВернутьОписаниеСервиса();
	//КонецЕсли;
	
	//Если (СтрНайти(Accept,"text/plain") = 0) Тогда
	//	Возврат Новый HTTPСервисОтвет(405);	
	//КонецЕсли;
	
	МетрикиСтрокой = пэмМетрикиСервер.СформироватьМетрикиПоЗапросу();

	Если НЕ ЗначениеЗаполнено(МетрикиСтрокой) Тогда
		Возврат Новый HTTPСервисОтвет(204);
	КонецЕсли;
	
	Ответ = Новый HTTPСервисОтвет(200);
	Ответ.УстановитьТелоИзСтроки(МетрикиСтрокой, КодировкаТекста.UTF8, ИспользованиеByteOrderMark.НеИспользовать);
	
	Возврат Ответ;

КонецФункции

#КонецОбласти
