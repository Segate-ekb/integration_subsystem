////////////////////////////////////////////////////////////////////////////////
// инт_АктивныеКонсьюмеры
//
// Регистр сведений для хранения информации об активных консьюмерах.
// Модуль менеджера содержит методы регистрации и управления записями.
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

// Регистрирует новый консьюмер в регистре.
//
// Параметры:
//  Подписка                    - ОпределяемыйТип.инт_Подписка - Подписчик Kafka/RabbitMQ
//  ИдентификаторФоновогоЗадания - УникальныйИдентификатор - ID фонового задания
//  СтатусАктивности            - Строка - "Асинхронный" или "Синхронный"
//
Процедура ЗарегистрироватьКонсьюмер(Подписка, ИдентификаторФоновогоЗадания, СтатусАктивности = "Активен") Экспорт
	
	НаборЗаписей = РегистрыСведений.инт_АктивныеКонсьюмеры.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Подписка.Установить(Подписка);
	НаборЗаписей.Отбор.ИдентификаторФоновогоЗадания.Установить(ИдентификаторФоновогоЗадания);
	
	Запись = НаборЗаписей.Добавить();
	Запись.Подписка = Подписка;
	Запись.ИдентификаторФоновогоЗадания = ИдентификаторФоновогоЗадания;
	Запись.ВремяЗапуска = ТекущаяДатаСеанса();
	Запись.ПоследняяАктивность = ТекущаяДатаСеанса();
	Запись.СтатусАктивности = СтатусАктивности;
	
	НаборЗаписей.Записать();
	
КонецПроцедуры

// Обновляет время последней активности консьюмера.
//
// Параметры:
//  Подписка                    - ОпределяемыйТип.инт_Подписка - Подписчик
//  ИдентификаторФоновогоЗадания - УникальныйИдентификатор - ID фонового задания
//
Процедура ОбновитьАктивность(Подписка, ИдентификаторФоновогоЗадания) Экспорт
	
	НаборЗаписей = РегистрыСведений.инт_АктивныеКонсьюмеры.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Подписка.Установить(Подписка);
	НаборЗаписей.Отбор.ИдентификаторФоновогоЗадания.Установить(ИдентификаторФоновогоЗадания);
	НаборЗаписей.Прочитать();
	
	Если НаборЗаписей.Количество() > 0 Тогда
		НаборЗаписей[0].ПоследняяАктивность = ТекущаяДатаСеанса();
		НаборЗаписей.Записать();
	КонецЕсли;
	
КонецПроцедуры

// Обновляет время активности по подписке (без указания ID задания).
//
// Параметры:
//  Подписка - ОпределяемыйТип.инт_Подписка - Подписчик
//
Процедура ОбновитьАктивностьПоПодписке(Подписка) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	АктивныеКонсьюмеры.Подписка КАК Подписка,
		|	АктивныеКонсьюмеры.ИдентификаторФоновогоЗадания КАК ИдентификаторФоновогоЗадания
		|ИЗ
		|	РегистрСведений.инт_АктивныеКонсьюмеры КАК АктивныеКонсьюмеры
		|ГДЕ
		|	АктивныеКонсьюмеры.Подписка = &Подписка";
	
	Запрос.УстановитьПараметр("Подписка", Подписка);
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		ОбновитьАктивность(Выборка.Подписка, Выборка.ИдентификаторФоновогоЗадания);
	КонецЦикла;
	
КонецПроцедуры

// Удаляет запись о консьюмере из регистра.
//
// Параметры:
//  Подписка                    - ОпределяемыйТип.инт_Подписка - Подписчик
//  ИдентификаторФоновогоЗадания - УникальныйИдентификатор - ID фонового задания
//
Процедура УдалитьКонсьюмер(Подписка, ИдентификаторФоновогоЗадания) Экспорт
	
	НаборЗаписей = РегистрыСведений.инт_АктивныеКонсьюмеры.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Подписка.Установить(Подписка);
	НаборЗаписей.Отбор.ИдентификаторФоновогоЗадания.Установить(ИдентификаторФоновогоЗадания);
	НаборЗаписей.Записать(); // Пустой набор = удаление
	
КонецПроцедуры

// Возвращает список активных консьюмеров.
//
// Параметры:
//  Подписка - ОпределяемыйТип.инт_Подписка, Неопределено - Фильтр по подписке (опционально)
//
// Возвращаемое значение:
//  Массив из Структура - Записи регистра
//
Функция ПолучитьАктивныеКонсьюмеры(Подписка = Неопределено) Экспорт
	
	Результат = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	АктивныеКонсьюмеры.Подписка КАК Подписка,
		|	АктивныеКонсьюмеры.ИдентификаторФоновогоЗадания КАК ИдентификаторФоновогоЗадания,
		|	АктивныеКонсьюмеры.ВремяЗапуска КАК ВремяЗапуска,
		|	АктивныеКонсьюмеры.ПоследняяАктивность КАК ПоследняяАктивность,
		|	АктивныеКонсьюмеры.СтатусАктивности КАК СтатусАктивности
		|ИЗ
		|	РегистрСведений.инт_АктивныеКонсьюмеры КАК АктивныеКонсьюмеры
		|ГДЕ
		|	(&Подписка = НЕОПРЕДЕЛЕНО ИЛИ АктивныеКонсьюмеры.Подписка = &Подписка)";
	
	Запрос.УстановитьПараметр("Подписка", Подписка);
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Запись = Новый Структура("Подписка, ИдентификаторФоновогоЗадания, ВремяЗапуска, ПоследняяАктивность, СтатусАктивности");
		ЗаполнитьЗначенияСвойств(Запись, Выборка);
		Результат.Добавить(Запись);
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

// Очищает все записи регистра.
//
Процедура ОчиститьРегистр() Экспорт
	
	НаборЗаписей = РегистрыСведений.инт_АктивныеКонсьюмеры.СоздатьНаборЗаписей();
	НаборЗаписей.Записать();
	
КонецПроцедуры

#КонецОбласти
