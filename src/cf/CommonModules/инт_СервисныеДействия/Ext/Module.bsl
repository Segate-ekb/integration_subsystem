////////////////////////////////////////////////////////////////////////////////
// Модуль: инт_СервисныеДействия
//
// Описание:
//  Модуль для выполнения сервисных операций подсистемы интеграции.
//  Реализует фоновые задачи по очистке устаревших данных из очередей сообщений.
//
// Основные возможности:
//  - Очистка устаревших сообщений из очереди исходящих сообщений
//  - Очистка устаревших сообщений из очереди входящих сообщений
//  - Параллельное выполнение задач очистки
//  - Контроль выполнения фоновых заданий
//
// Использование:
//  Регламентное задание "Очистка устаревших сообщений" вызывает процедуру
//  инт_ОчисткаУстаревшихСообщений() для периодической очистки очередей.
//  
////////////////////////////////////////////////////////////////////////////////
#Область ПрограммныйИнтерфейс

// Процедура - Очистка устаревших сообщений
//
// Описание:
//  Запускает процесс очистки устаревших сообщений из очередей входящих и исходящих сообщений.
//  Создает два фоновых задания для параллельной очистки и ожидает их завершения.
//  
//  При возникновении ошибки в одном из заданий записывает информацию в журнал
//  регистрации и генерирует исключение.
//
//  Вызывается регламентным заданием для периодической очистки устаревших данных.
//
Процедура инт_ОчисткаУстаревшихСообщений() Экспорт
	МассивФоновыхЗаданий = Новый массив;
	МассивФоновыхЗаданий.Добавить(ФоновыеЗадания.Выполнить("инт_СервисныеДействия.ОчиститьОчередьИсходящихСообщений",,,"Фоновая очистка очереди исходящих сообщений."));
	МассивФоновыхЗаданий.Добавить(ФоновыеЗадания.Выполнить("инт_СервисныеДействия.ОчиститьОчередьВходящихСообщений",,,"Фоновая очистка очереди входящих сообщений."));
	
	МассивФоновыхЗаданий = ФоновыеЗадания.ОжидатьЗавершенияВыполнения(МассивФоновыхЗаданий);
	
	Для Каждого ФоновоеЗадание Из МассивФоновыхЗаданий Цикл
		Если ФоновоеЗадание.Состояние = СостояниеФоновогоЗадания.ЗавершеноАварийно ИЛИ ФоновоеЗадание.Состояние = СостояниеФоновогоЗадания.Отменено Тогда
			 СообщениеОбОшибке = СтрШаблон("В процессе очистки очередей от устаревших данных произошла ошибка!
				| В фоновое задание <%1> завершено с ошибкой
				| Сведения об ошибке: %2", ФоновоеЗадание.Наименование, ФоновоеЗадание.ИнформацияОбОшибке);
			ЗаписьЖурналаРегистрации("ПодсистемаИнтеграции.ОчисткаУстаревшихСообщений",УровеньЖурналаРегистрации.Ошибка,,,СообщениеОбОшибке);
			ВызватьИсключение СообщениеОбОшибке;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

// Процедура - Очистить очередь исходящих сообщений
//
// Описание:
//  Выполняет очистку устаревших записей из очереди исходящих сообщений.
//  Удаляет обработанные и устаревшие сообщения в соответствии с настройками хранения.
//
Процедура ОчиститьОчередьИсходящихСообщений() Экспорт
		РегистрыСведений.инт_СообщенияКУдалению.ОчиститьОчередьИсходящихСообщений();
КонецПроцедуры

// Процедура - Очистить очередь входящих сообщений
//
// Описание:
//  Выполняет очистку устаревших записей из очереди входящих сообщений.
//  Удаляет обработанные и устаревшие сообщения в соответствии с настройками хранения.
//
Процедура ОчиститьОчередьВходящихСообщений() Экспорт
		РегистрыСведений.инт_СообщенияКУдалению.ОчиститьОчередьВходящихСообщений();
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции // BSLLS:EmptyRegion-off
#КонецОбласти
