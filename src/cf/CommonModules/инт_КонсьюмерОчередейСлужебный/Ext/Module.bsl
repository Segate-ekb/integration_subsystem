////////////////////////////////////////////////////////////////////////////////
// инт_КонсьюмерОчередейСлужебный
//
// Служебный модуль с функциями работы с компонентой Kafka для консьюмеров.
////////////////////////////////////////////////////////////////////////////////

#Область СлужебныйПрограммныйИнтерфейс

// Создаёт и инициализирует консьюмер Kafka.
//
// Параметры:
//  Брокеры          - Строка - Адреса брокеров Kafka через запятую
//  ГруппаКонсьюмеров - Строка - Consumer group ID
//  МассивТопиков    - Массив из Строка - Список топиков для подписки
//
// Возвращаемое значение:
//  AddIn, Неопределено - Компонента simpleKafka1C или Неопределено при ошибке
//
Функция СоздатьКонсьюмер(Брокеры, ГруппаКонсьюмеров, МассивТопиков) Экспорт
	
	Попытка
		Компонента = ПолучитьЭкземплярКомпоненты();
	Исключение
		ЗаписьЖурналаРегистрации(
			"ПодсистемаИнтеграции.КонсьюмерОчередей",
			УровеньЖурналаРегистрации.Ошибка,
			,
			,
			СтрШаблон("Ошибка подключения компоненты: %1", ОписаниеОшибки()));
		Возврат Неопределено;
	КонецПопытки;
	
	// Настраиваем параметры консьюмера
	Компонента.УстановитьПараметр("group.id", ГруппаКонсьюмеров);
	Компонента.УстановитьПараметр("auto.offset.reset", "earliest");
	Компонента.УстановитьПараметр("enable.auto.commit", "false");
	
	// Инициализируем консьюмер
	РезультатИнициализации = Компонента.ИнициализироватьКонсьюмера(Брокеры);
	
	Если НЕ РезультатИнициализации Тогда
		СообщениеОбОшибке = Компонента.ПолучитьСообщениеОбОшибке();
		ЗаписьЖурналаРегистрации(
			"ПодсистемаИнтеграции.КонсьюмерОчередей",
			УровеньЖурналаРегистрации.Ошибка,
			,
			,
			СтрШаблон("Ошибка инициализации консьюмера: %1", СообщениеОбОшибке));
		Возврат Неопределено;
	КонецЕсли;
	
	// Подписываемся на топики
	СписокТопиков = СтрСоединить(МассивТопиков, ",");
	РезультатПодписки = Компонента.Подписаться(СписокТопиков);
	
	Если НЕ РезультатПодписки Тогда
		СообщениеОбОшибке = Компонента.ПолучитьСообщениеОбОшибке();
		ЗаписьЖурналаРегистрации(
			"ПодсистемаИнтеграции.КонсьюмерОчередей",
			УровеньЖурналаРегистрации.Ошибка,
			,
			,
			СтрШаблон("Ошибка подписки на топики %1: %2", СписокТопиков, СообщениеОбОшибке));
		Компонента.ОстановитьКонсьюмер();
		Возврат Неопределено;
	КонецЕсли;
	
	ЗаписьЖурналаРегистрации(
		"ПодсистемаИнтеграции.КонсьюмерОчередей",
		УровеньЖурналаРегистрации.Информация,
		,
		,
		СтрШаблон("Консьюмер создан. Группа: %1, Топики: %2", ГруппаКонсьюмеров, СписокТопиков));
	
	Возврат Компонента;
	
КонецФункции

// Останавливает консьюмер и освобождает ресурсы.
//
// Параметры:
//  Компонента - AddIn - Компонента simpleKafka1C
//
Процедура ОстановитьКонсьюмер(Компонента) Экспорт
	
	Если Компонента = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Попытка
		Компонента.ОстановитьКонсьюмер();
	Исключение
		// Игнорируем ошибки при остановке
	КонецПопытки;
	
	Компонента = Неопределено;
	
КонецПроцедуры

// Формирует идентификатор consumer group.
//
// Параметры:
//  Суффикс - Строка - Суффикс для идентификатора (код подписчика или "async")
//
// Возвращаемое значение:
//  Строка - Consumer group ID в формате {GUID_ИБ}_{Суффикс}
//
Функция СформироватьИдентификаторГруппы(Суффикс) Экспорт
	
	ИдентификаторИБ = инт_КонсьюмерОчередейПовтИсп.ПолучитьИдентификаторИБ();
	
	Возврат СтрШаблон("%1_%2", ИдентификаторИБ, Суффикс);
	
КонецФункции

// Отправляет сообщение в Dead Letter Queue.
//
// Параметры:
//  Эндпоинт          - СправочникСсылка.инт_Эндпоинты - Эндпоинт Kafka
//  DLQТопик          - Строка - Имя DLQ топика
//  ОригинальноеТело  - Строка - Исходное тело сообщения
//  ОригинальныйТопик - Строка - Исходный топик
//  Смещение          - Число - Смещение в исходном топике
//  Раздел            - Число - Раздел в исходном топике
//  ОписаниеОшибки    - Строка - Текст ошибки обработки
//
Процедура ОтправитьВDLQ(Эндпоинт, DLQТопик, ОригинальноеТело, ОригинальныйТопик, Смещение, Раздел, ОписаниеОшибки) Экспорт
	
	// Формируем DLQ-сообщение
	DLQСообщение = Новый Структура;
	DLQСообщение.Вставить("original_topic", ОригинальныйТопик);
	DLQСообщение.Вставить("original_partition", Раздел);
	DLQСообщение.Вставить("original_offset", Смещение);
	DLQСообщение.Вставить("original_payload", ОригинальноеТело);
	DLQСообщение.Вставить("error_message", ОписаниеОшибки);
	DLQСообщение.Вставить("failed_at", Формат(ТекущаяДатаСеанса(), "ДФ=yyyy-MM-ddTHH:mm:ssZ"));
	
	// Сериализуем в JSON
	DLQТело = инт_КоннекторHTTP.ОбъектВJson(DLQСообщение);
	
	// Получаем адрес брокера
	Брокеры = Эндпоинт.АдресРесурса;
	
	Попытка
		// Отправляем в DLQ топик
		инт_РаботаСКафка.ОтправитьСообщение(DLQТело, Брокеры, DLQТопик);
		
		ЗаписьЖурналаРегистрации(
			"ПодсистемаИнтеграции.КонсьюмерОчередей.DLQ",
			УровеньЖурналаРегистрации.Информация,
			,
			,
			СтрШаблон("Сообщение отправлено в DLQ. Топик: %1, Исходный топик: %2, Смещение: %3",
				DLQТопик, ОригинальныйТопик, Смещение));
	Исключение
		ЗаписьЖурналаРегистрации(
			"ПодсистемаИнтеграции.КонсьюмерОчередей.DLQ",
			УровеньЖурналаРегистрации.Ошибка,
			,
			,
			СтрШаблон("Ошибка отправки в DLQ: %1", ОписаниеОшибки()));
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция ПолучитьЭкземплярКомпоненты()
	
	ПодключитьВнешнююКомпоненту(
		"ОбщийМакет.инт_simple_kafka", 
		"Integration", 
		ТипВнешнейКомпоненты.Native, 
		ТипПодключенияВнешнейКомпоненты.НеИзолированно);

	Попытка
		Компонента = Новый("AddIn.Integration.simpleKafka1C");
	Исключение
		СообщениеОбОшибке = "Ошибка при подключении компоненты <Simple Kafka 1C>!";
		ЗаписьЖурналаРегистрации(
			"ПодсистемаИнтеграции.КонсьюмерОчередей",
			УровеньЖурналаРегистрации.Ошибка,
			,
			,
			СообщениеОбОшибке);
		ВызватьИсключение СообщениеОбОшибке;
	КонецПопытки;
	
	// Настраиваем логирование
	НастроитьЛогированиеКомпоненты(Компонента);
	
	Возврат Компонента;
	
КонецФункции

Процедура НастроитьЛогированиеКомпоненты(Компонента)
	
	// Получаем каталог логов
	КаталогЛогов = Константы.инт_КаталогЛоговKafka.Получить();
	
	Если ПустаяСтрока(КаталогЛогов) Тогда
		Возврат;
	КонецЕсли;
	
	// Добавляем разделитель если нужно
	ПоследнийСимвол = Прав(КаталогЛогов, 1);
	Если ПоследнийСимвол <> "/" И ПоследнийСимвол <> "\" Тогда
		КаталогЛогов = КаталогЛогов + ПолучитьРазделительПути();
	КонецЕсли;
	
	Компонента.КаталогЛогов = КаталогЛогов;
	Компонента.ФорматИмениФайловЛога = "%Y%m%d_consumer";
	
	// Устанавливаем идентификатор клиента
	ИдентификаторКлиента = Константы.инт_ИдентификаторКлиентаKafka.Получить();
	Если ЗначениеЗаполнено(ИдентификаторКлиента) Тогда
		Компонента.УстановитьПараметр("client.id", ИдентификаторКлиента + "_consumer");
	КонецЕсли;
	
	// Уровень отладки
	УровеньОтладки = Константы.инт_УровеньОтладкиKafka.Получить();
	Если ЗначениеЗаполнено(УровеньОтладки) Тогда
		Компонента.УстановитьПараметр("debug", УровеньОтладки);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти
