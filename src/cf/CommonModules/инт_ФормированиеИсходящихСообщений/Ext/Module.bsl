////////////////////////////////////////////////////////////////////////////////
// Модуль: инт_ФормированиеИсходящихСообщений
//
// Описание:
//  Модуль управления процессом формирования исходящих сообщений в рамках подсистемы интеграции.
//  Реализует многопоточную обработку сообщений на этапе их формирования.
//
// Основные возможности:
//  - Запуск менеджера потоков формирования сообщений
//  - Создание и управление фоновыми заданиями для формирования сообщений
//  - Обработка сообщений пачками для оптимизации производительности
//  - Автоматическая очистка завершенных потоков (сборка мусора)
//  
//  Формирование сообщения включает:
//  - Выполнение обработчика потока данных для исходных данных
//  - Сериализацию данных в требуемый формат
//  - Валидацию сформированного сообщения по контракту (OpenAPI схеме)
//  - Подготовку сообщения к отправке подписчикам
//
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

// Процедура - Запуск менеджера потоков формирования сообщений
//
// Описание:
//  Запускает менеджер потоков для формирования исходящих сообщений.
//  Выполняет предварительную очистку завершенных потоков (сборка мусора),
//  затем создает новые фоновые потоки обработки в зависимости от текущей нагрузки.
//  
//  Количество создаваемых потоков определяется на основе:
//  - Количества сообщений в очереди на формирование
//  - Настроек максимального количества параллельных потоков
//  - Текущей загрузки системы
//
//  Вызывается регламентным заданием для периодического формирования накопленных сообщений.
//
Процедура ЗапускМенеджераПотоков() Экспорт
    РегистрыСведений.инт_МенеджерПотоковФормированияСообщений.СобратьМусор();
    
    КоличествоПотоковКСозданию = РегистрыСведений.инт_МенеджерПотоковФормированияСообщений.КоличествоПотоковКСозданию();
    Для Итератор=1 По КоличествоПотоковКСозданию Цикл
        СоздатьПотокФормированияСообщений();
    КонецЦикла;
КонецПроцедуры
#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Процедура - Создать поток формирования сообщений
//
// Описание:
//  Создает один фоновый поток для формирования пачки сообщений.
//  
//  Процесс выполнения:
//  1. Получает идентификаторы сообщений к формированию (размер пачки настраивается)
//  2. Если сообщений нет - завершает работу
//  3. Изменяет статус сообщений на "Формирование сообщения"
//  4. Запускает фоновое задание для обработки пачки
//  5. Регистрирует созданный поток в менеджере потоков
//  
//  При возникновении ошибки откатывает транзакцию и записывает информацию в журнал регистрации.
//
Процедура СоздатьПотокФормированияСообщений()
    КоличествоСообщенийВПачке = инт_ФормированиеИсходящихСообщенийПовтИсп.РазмерПачкиФормированияСообщений();
    МассивСообщений = РегистрыСведений.инт_ТекущийСтатусИсходящихСообщений.ПолучитьИдентификаторыСообщенийКФормированию(КоличествоСообщенийВПачке);
    
    Если МассивСообщений.Количество() = 0 Тогда
        // Нет сообщений для обработки.
    	Возврат;
    КонецЕсли;
    НачатьТранзакцию();
    Попытка
        РегистрыСведений.инт_ТекущийСтатусИсходящихСообщений.ЗаписатьСтатусСообщений(МассивСообщений, Перечисления.инт_СтатусыИсходящихСообщений.ФормированиеСообщения);
        МассивПараметров = Новый Массив;
        МассивПараметров.Добавить(МассивСообщений);
        Поток = ФоновыеЗадания.Выполнить("инт_ФормированиеИсходящихСообщенийСлужебный.ВыполнитьОбработкуСообщенийВПотоке", МассивПараметров, ,"Поток формирования исходящих сообщений.");
        РегистрыСведений.инт_МенеджерПотоковФормированияСообщений.ЗарегистрироватьПоток(Поток.УникальныйИдентификатор, МассивСообщений);
        ЗафиксироватьТранзакцию();
    Исключение
        ОтменитьТранзакцию();
        СообщениеОбОшибке = СтрШаблон("Ошибка при создании потока формирования сообщений.
        |
        |Информация об ошибке: %1", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
        ЗаписьЖурналаРегистрации("ПодсистемаИнтеграции.МенеджерПотоковФормированияСообщений", УровеньЖурналаРегистрации.Ошибка,,,СообщениеОбОшибке);
    КонецПопытки;
    
КонецПроцедуры
#КонецОбласти
