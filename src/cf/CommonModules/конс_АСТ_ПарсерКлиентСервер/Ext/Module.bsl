// Синтаксический анализатор (shift-reduce парсер МПА) встроенного языка BSL (1C:Enterprise)
//
// Модуль реализует синтаксический анализ (парсинг) потока лексем BSL
// на основе магазинного автомата (МПА) с shift-reduce стратегией.
//
// Модуль строит чистое AST-дерево без побочных эффектов (генерации кода).
// Семантические действия и кодогенерация выполняются отдельным проходом в компиляторе.
//
// Точки входа:
//   ВыполнитьЦиклПарсера     — выполнение цикла shift-reduce для одной лексемы
//   СобратьРезультатПарсинга  — сборка финального результата парсинга (AST)

#Область ПрограммныйИнтерфейс

// Выполняет цикл shift-reduce парсера для одной лексемы.
// Строит узлы AST-дерева без вызова семантических действий.
//
// Параметры:
//  ТекущаяЛексема - Структура - текущая лексема
//  СтекПарсера - Массив - стек состояний парсера
//  СтруктураМПА - Структура - таблицы переходов МПА
//  СоответствиеРедукций - Соответствие - правила редукции
//
// Возвращаемое значение:
//  Структура, Неопределено - последнее действие парсера, или Неопределено при ошибке
Функция ВыполнитьЦиклПарсера(ТекущаяЛексема, СтекПарсера, СтруктураМПА, СоответствиеРедукций) Экспорт
	
	ТекущееДействие = Новый Структура("ТипДействия", "Редукция");
	Пока ТекущееДействие.ТипДействия = "Редукция" Цикл
		ТекущееДействие = ПолучитьДействиеПарсера(ТекущаяЛексема, СтекПарсера, СтруктураМПА);
		
		Если ТекущееДействие = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;
		Если ТекущееДействие.ТипДействия = "Сдвиг" Тогда
			СтекПарсера.Вставить(0, Новый Структура("Терминал,Значение,НомерСтроки,Позиция", ТекущаяЛексема.Имя, ТекущаяЛексема.Значение, ТекущаяЛексема.НомерСтроки, ТекущаяЛексема.Позиция));
			СтекПарсера.Вставить(0, ТекущееДействие.Переход);
		ИначеЕсли ТекущееДействие.ТипДействия = "Редукция" Тогда
			ВыполнитьРедукцию(СтекПарсера, ТекущееДействие, СоответствиеРедукций, СтруктураМПА);
		ИначеЕсли ТекущееДействие.ТипДействия = "Завершение" Тогда
			СтекПарсера.Удалить(0);
		КонецЕсли;
	КонецЦикла;
	Возврат ТекущееДействие;
КонецФункции

// Собирает результат парсинга: формирует корневой узел AST,
// проверяет директивы и возвращает дерево без вызова семантических действий.
//
// Параметры:
//  ТекущееДействие - Структура, Неопределено - последнее действие парсера
//  СтекПарсера - Массив - стек состояний парсера
//  МассивОшибок - Массив - накопитель ошибок
//  МассивЛексем - Массив - массив распознанных лексем
//  ИспользуемыеТерминалы - Соответствие - использованные терминалы
//  РежимВыполнить - Булево - режим оператора "Выполнить"
//  ЕстьКритическаяОшибка - Булево - флаг наличия критической ошибки
//  СтекДиректив - Массив - стек директив препроцессора
//
// Возвращаемое значение:
//  Структура - результат парсинга: Узел (AST), МассивЛексем, Ошибки
Функция СобратьРезультатПарсинга(ТекущееДействие, СтекПарсера, МассивОшибок, МассивЛексем, ИспользуемыеТерминалы, РежимВыполнить, ЕстьКритическаяОшибка, СтекДиректив) Экспорт
	Результат = Новый Структура;
	ПроверитьДирективыКомпиляции(ИспользуемыеТерминалы, РежимВыполнить, МассивОшибок);
	ПроверитьНезакрытыеДирективы(СтекДиректив, МассивОшибок, ЕстьКритическаяОшибка);
	Если ТекущееДействие <> Неопределено Тогда
		СоставУзла = Новый Массив;
		Если СтекПарсера.Количество() > 0 Тогда
			СоставУзла.Добавить(СтекПарсера[0]);
		КонецЕсли;
		НовыйУзел = Новый Структура("Нетерминал,СоставУзла,Атрибуты", "S", СоставУзла, Новый Структура("КоличествоОпераций", 0));
		Результат.Вставить("Узел", НовыйУзел);
	КонецЕсли;
	Результат.Вставить("МассивЛексем", МассивЛексем);
	Результат.Вставить("Ошибки", МассивОшибок);
	Возврат Результат;
КонецФункции

#КонецОбласти // ПрограммныйИнтерфейс

#Область СлужебныеПроцедурыИФункции

// Определяет действие парсера для текущей лексемы по таблице переходов МПА.
Функция ПолучитьДействиеПарсера(Лексема, СтекСостояний, ДанныеПарсера)
	КлючТерминала = СтекСостояний[0] + "_" + Лексема.Имя;
	ДействиеПарсера = ДанныеПарсера.СоответствиеТерминалов[КлючТерминала];
	Возврат ДействиеПарсера;
КонецФункции

// Выполняет одну операцию редукции: извлекает символы из стека, формирует узел AST
// и помещает результат обратно в стек. Не вызывает семантические действия.
Процедура ВыполнитьРедукцию(СтекПарсера, ТекущееДействие, СоответствиеРедукций, СтруктураМПА)
	СимволыРедукции = СоответствиеРедукций[ТекущееДействие.Редукция].Символы;
	Нетерминал = СоответствиеРедукций[ТекущееДействие.Редукция].Нетерминал;
	СоставУзла = Новый Массив;
	Для Каждого ТекущийСимвол Из СимволыРедукции Цикл
		СтекПарсера.Удалить(0);
		СоставУзла.Вставить(0, СтекПарсера[0]);
		СтекПарсера.Удалить(0);
	КонецЦикла;
	КлючПерехода = СтекПарсера[0] + "_" + Нетерминал;
	ПереходПоНетерминалу = СтруктураМПА.СоответствиеНетерминалов[КлючПерехода];
	НовыйУзел = Новый Структура("Нетерминал,СоставУзла,Атрибуты,НомерСтроки", Нетерминал, СоставУзла, Новый Структура("КоличествоОпераций", 0), СоставУзла[0].НомерСтроки);
	СтекПарсера.Вставить(0, НовыйУзел);
	СтекПарсера.Вставить(0, ПереходПоНетерминалу.Переход);
КонецПроцедуры

// Проверяет наличие директив компиляции и добавляет соответствующее предупреждение или ошибку.
Процедура ПроверитьДирективыКомпиляции(ИспользуемыеТерминалы, РежимВыполнить, МассивОшибок)
	Если ИспользуемыеТерминалы["Спец_Директива"] = Неопределено Тогда
		Возврат;
	КонецЕсли;
	Если НЕ РежимВыполнить Тогда
		СообщениеОшибки = Новый Структура("Тип,Название,Строка", 1, НСтр("ru = 'Директивы компиляции в консоли кода не используются и будут проигнорированы'; en = 'Compilation directives in the code console are not used and will be ignored'", ТекущийЯзыкСистемы()));
	Иначе
		СообщениеОшибки = Новый Структура("Тип,Название,Строка", 0, НСтр("ru = 'Неизвестный оператор'; en = 'Unknown operator'", ТекущийЯзыкСистемы()));
	КонецЕсли;
	МассивОшибок.Добавить(СообщениеОшибки);
КонецПроцедуры

// Проверяет наличие незакрытых директив препроцессора в стеке.
Процедура ПроверитьНезакрытыеДирективы(СтекДиректив, МассивОшибок, ЕстьКритическаяОшибка)
	Если ЕстьКритическаяОшибка Тогда
		Возврат;
	КонецЕсли;
	Для Каждого ЭлементСтекаДиректив Из СтекДиректив Цикл
		Если ЭлементСтекаДиректив.Имя <> "ОПЕРАТОР" Тогда
			ДобавитьОшибкуДирективы(МассивОшибок, ЭлементСтекаДиректив.Директива, ЕстьКритическаяОшибка);
			Прервать;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

// Формирует структуру ошибки для некорректного синтаксиса препроцессора.
//
// Параметры:
//  СписокОшибок - Массив - накопитель ошибок
//  Директива - Структура - лексема директивы (НомерСтроки, Позиция)
//  ФлагОшибки - Булево - флаг наличия критической ошибки (модифицируется)
Процедура ДобавитьОшибкуДирективы(СписокОшибок, Директива, ФлагОшибки)
	СтруктураОшибки = Новый Структура("Тип,Название,Строка", 0, НСтр("ru = 'Некорректный синтаксис препроцессора ('; en = 'Incorrect preprocessor syntax ('", ТекущийЯзыкСистемы()) + Директива.НомерСтроки + ", " + Директива.Позиция + ")", Директива.НомерСтроки);
	СписокОшибок.Добавить(СтруктураОшибки);
	ФлагОшибки = Истина;
КонецПроцедуры

// Определяет возможность выполнения скомпилированного кода по наличию критических ошибок.
Функция ОпределитьВозможностьВыполнения(МассивОшибок)
	Для Каждого ЭлементОшибки Из МассивОшибок Цикл
		Если ЭлементОшибки.Тип = 0 Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЦикла;
	Возврат Истина;
КонецФункции

#КонецОбласти // СлужебныеПроцедурыИФункции
