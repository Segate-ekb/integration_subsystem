// Модуль: конс_СистемаТиповКлиентСервер
//
// Назначение: Формирование соответствия типов платформы 1С для просмотра переменных
// в отладчике. Каждый тип описывается структурой с именем, кодом, признаком коллекции,
// набором фиксированных свойств и расширяемых свойств.
//
// Данные загружаются из JSON-макетов конс_СловарьТиповRu / конс_СловарьТиповEn,
// содержащих 2064 описания типов для каждой локализации.
//
// Структура соответствия: Тип(ИмяТипа) или Строка → Структура:
//   Имя               - Строка - отображаемое имя типа
//   Код               - Число  - код типа (1=примитивный, 2=коллекция с ключами, 3=объект)
//   ЭтоКоллекция      - Булево - является ли тип коллекцией
//   Свойства          - Структура - фиксированные свойства типа (ключи без значений)
//   РасширяемыеСвойства - Массив - шаблоны свойств для динамических коллекций

#Область ПрограммныйИнтерфейс

// Формирует соответствие описаний типов для указанной локализации.
// Загружает данные из JSON-макета и строит соответствие,
// где ключ — объект Тип() или строка, а значение — описание типа.
//
// Параметры:
//  ВариантЯзыка - Строка - код языка ("ru" или "en")
//
// Возвращаемое значение:
//  Соответствие - Тип/Строка → Структура с описанием типа
Функция СформироватьСоответствиеТипов(ВариантЯзыка) Экспорт
	
	ИмяМакета = ?(ВариантЯзыка = "ru", "конс_СловарьТиповRu", "конс_СловарьТиповEn");
	ТекстJSON = ПолучитьОбщийМакет(ИмяМакета).ПолучитьТекст();
	
	Возврат ЗагрузитьТипыИзJSON(ТекстJSON);
	
КонецФункции

#КонецОбласти // ПрограммныйИнтерфейс

#Область СлужебныеПроцедурыИФункции

// Загружает массив описаний типов из JSON и строит соответствие типов.
//
// Параметры:
//  ТекстJSON - Строка - JSON-текст с массивом описаний типов
//
// Возвращаемое значение:
//  Соответствие - Тип/Строка → Структура описания типа
Функция ЗагрузитьТипыИзJSON(ТекстJSON)
	
	ЧтениеJSON = Новый ЧтениеJSON;
	ЧтениеJSON.УстановитьСтроку(ТекстJSON);
	МассивОписаний = ПрочитатьJSON(ЧтениеJSON, Истина);
	ЧтениеJSON.Закрыть();
	
	СоответствиеТипов = Новый Соответствие;
	
	Для Каждого Описание Из МассивОписаний Цикл
		ЗагрузитьОдинТип(СоответствиеТипов, Описание);
	КонецЦикла;
	
	Возврат СоответствиеТипов;
	
КонецФункции

// Загружает один тип из JSON-описания в соответствие.
//
// Параметры:
//  СоответствиеТипов - Соответствие - целевое соответствие типов
//  Описание - Соответствие - JSON-описание одного типа:
//    ТипИмя, Имя, Код, ЭтоКоллекция, Свойства[], РасширяемыеСвойства[]
//    Для строко-ключевых типов: СтроковыеКлючи[] вместо ТипИмя
Процедура ЗагрузитьОдинТип(СоответствиеТипов, Описание)
	
	// Построить структуру свойств
	СтруктураСвойств = Новый Структура;
	Свойства = Описание["Свойства"];
	Если Свойства <> Неопределено Тогда
		Для Каждого ИмяСвойства Из Свойства Цикл
			СтруктураСвойств.Вставить(ИмяСвойства);
		КонецЦикла;
	КонецЕсли;
	
	// Построить массив расширяемых свойств
	МассивРасширяемыхСвойств = Новый Массив;
	РасшСвойства = Описание["РасширяемыеСвойства"];
	Если РасшСвойства <> Неопределено Тогда
		Для Каждого ЭлементРасш Из РасшСвойства Цикл
			Если ТипЗнч(ЭлементРасш) = Тип("Соответствие") Тогда
				// Сложное расширяемое свойство — Структура с полями
				стСвойство = Новый Структура;
				Для Каждого КЗ Из ЭлементРасш Цикл
					стСвойство.Вставить(КЗ.Ключ, КЗ.Значение);
				КонецЦикла;
				МассивРасширяемыхСвойств.Добавить(стСвойство);
			Иначе
				// Простое расширяемое свойство — строка
				МассивРасширяемыхСвойств.Добавить(ЭлементРасш);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	// Построить описание типа
	стТип = Новый Структура("Имя,Код,ЭтоКоллекция",
		Описание["Имя"],
		Описание["Код"],
		Описание["ЭтоКоллекция"]);
	стТип.Вставить("Свойства", СтруктураСвойств);
	стТип.Вставить("РасширяемыеСвойства", МассивРасширяемыхСвойств);
	
	// Определить ключ и добавить в соответствие
	КлючТип = Описание["КлючТип"];
	Если КлючТип = "Строка" Тогда
		// Строко-ключевые типы — вставляются по каждому строковому ключу
		СтроковыеКлючи = Описание["СтроковыеКлючи"];
		Для Каждого Ключ Из СтроковыеКлючи Цикл
			СоответствиеТипов.Вставить(Ключ, стТип);
		КонецЦикла;
	Иначе
		// Тип-ключевые типы — вставляются по Тип("...")
		Попытка
			пТип = Тип(Описание["ТипИмя"]);
		Исключение
			Возврат;
		КонецПопытки;
		СоответствиеТипов.Вставить(пТип, стТип);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти // СлужебныеПроцедурыИФункции
