////////////////////////////////////////////////////////////////////////////////
// инт_РаботаСКафка
//
// В данном модуле собраны методы работы с ВК simple kafka
////////////////////////////////////////////////////////////////////////////////
#Область ПрограммныйИнтерфейс

Процедура ОтправитьСообщение(ОтправляемоеСообщение, Брокеры, Топик, НомерПартиции = -1, ИдентификаторСообщения = "", Заголовки = "") Экспорт

	Компонента = ПолучитьЭкземплярКомпоненты();
	
	// инициализируем подключение к брокеру
	// достаточно указать одного брокера из кластера, либо есть возможность перечислить брокеров через символ запятая
	РезультатИнициализации = Компонента.ИнициализироватьПродюсера(Брокеры);
	
	Если РезультатИнициализации Тогда
		РезультатОтправки = Компонента.ОтправитьСообщение(ОтправляемоеСообщение, Топик, НомерПартиции, ИдентификаторСообщения, Заголовки);
		Если Не РезультатОтправки = 0 Тогда
			СообщениеОбОшибке = СтрШаблон("Отправка сообщения не удалась.
			| Информация об ошибке: %1", Компонента.ПолучитьСообщениеОбОшибке());
			ЗаписьЖурналаРегистрации("ПодсистемаИнтеграции.РаботаСКафка",
			УровеньЖурналаРегистрации.Ошибка, , , СообщениеОбОшибке);
			ВызватьИсключение СообщениеОбОшибке;
		КонецЕсли;
	Иначе
		СообщениеОбОшибке = СтрШаблон("Не удалось инициализировать компоненту.
			| Информация об ошибке: %1", Компонента.ПолучитьСообщениеОбОшибке());
		ЗаписьЖурналаРегистрации("ПодсистемаИнтеграции.РаботаСКафка",
                                	УровеньЖурналаРегистрации.Ошибка, , , СообщениеОбОшибке);
		ВызватьИсключение СообщениеОбОшибке;
 
	КонецЕсли;
	
	Компонента.ОстановитьПродюсера();
	Компонента = Неопределено;

КонецПроцедуры

Функция ПолучитьСтруктуруСообщенияДляПакетнойОтправки() Экспорт
	Возврат инт_РаботаСКафкаПовтИсп.ПолучитьСтруктуруСообщенияДляПакетнойОтправки();
КонецФункции

Функция ПолучитьИнформациюОТопике(Брокеры, ИмяТопика) Экспорт
	
	Компонента = ПолучитьЭкземплярКомпоненты();
	РезультатJSON = Компонента.ПолучитьМетаданныеТопика(Брокеры, ИмяТопика);
	
	Если ПустаяСтрока(РезультатJSON) Тогда
		СообщениеОбОшибке = СтрШаблон("Не удалось получить информацию о топике %1.
		| Информация об ошибке: %2", ИмяТопика, Компонента.ПолучитьСообщениеОбОшибке());
		ЗаписьЖурналаРегистрации("ПодсистемаИнтеграции.РаботаСКафка",
						УровеньЖурналаРегистрации.Ошибка, , , СообщениеОбОшибке);
		ВызватьИсключение СообщениеОбОшибке;
	КонецЕсли;
	
	ДанныеТопика = инт_КоннекторHTTP.JsonВОбъект(РезультатJSON);
	
	Возврат ДанныеТопика;
КонецФункции

// Проверяет доступность брокера Kafka
//
// Параметры:
//  Брокеры - Строка - Адрес брокера (например, "localhost:9092")
//  Таймаут - Число - Таймаут ожидания в миллисекундах (по умолчанию 5000)
//
// Возвращаемое значение:
//  Структура - Результат проверки:
//   * Успех - Булево - Истина, если брокер доступен
//   * ОписаниеОшибки - Строка - Текст ошибки если недоступен
//   * ИнформацияОКластере - Структура, Неопределено - Данные о кластере при успехе
//
Функция ПроверитьДоступностьБрокера(Брокеры, Таймаут = 5000) Экспорт
	
	Результат = Новый Структура("Успех, ОписаниеОшибки, ИнформацияОКластере", Ложь, "", Неопределено);
	
	Попытка
		Компонента = ПолучитьЭкземплярКомпоненты();
		
		Если Компонента.ПроверитьДоступностьБрокера(Брокеры, Таймаут) Тогда
			// Получаем информацию о кластере
			РезультатJSON = Компонента.ПолучитьИнформациюОКластере(Брокеры);
			Если НЕ ПустаяСтрока(РезультатJSON) Тогда
				Результат.ИнформацияОКластере = инт_КоннекторHTTP.JsonВОбъект(РезультатJSON);
			КонецЕсли;
			Результат.Успех = Истина;
		Иначе
			Результат.ОписаниеОшибки = Компонента.ПолучитьСообщениеОбОшибке();
		КонецЕсли;
	Исключение
		Результат.ОписаниеОшибки = ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Проверяет существование топика в Kafka
//
// Параметры:
//  Брокеры - Строка - Адрес брокера
//  ИмяТопика - Строка - Имя топика
//
// Возвращаемое значение:
//  Структура - Результат проверки:
//   * Существует - Булево - Истина, если топик существует
//   * ОписаниеОшибки - Строка - Текст ошибки подключения (пустая строка если ОК)
//   * Метаданные - Структура, Неопределено - Метаданные топика при существовании
//
Функция ТопикСуществует(Брокеры, ИмяТопика) Экспорт
	
	Результат = Новый Структура("Существует, ОписаниеОшибки, Метаданные", Ложь, "", Неопределено);
	
	Попытка
		Компонента = ПолучитьЭкземплярКомпоненты();
		РезультатJSON = Компонента.ПолучитьМетаданныеТопика(Брокеры, ИмяТопика);
		
		Если ПустаяСтрока(РезультатJSON) Тогда
			Результат.ОписаниеОшибки = Компонента.ПолучитьСообщениеОбОшибке();
			Возврат Результат;
		КонецЕсли;
		
		ДанныеТопика = инт_КоннекторHTTP.JsonВОбъект(РезультатJSON);
		
		// Проверяем наличие ошибки "Unknown topic"
		ТекстОшибки = ДанныеТопика.Получить("error");
		Если ТекстОшибки <> Неопределено И СтрНайти(ТекстОшибки, "Unknown topic") > 0 Тогда
			Результат.Существует = Ложь;
		Иначе
			Результат.Существует = Истина;
			Результат.Метаданные = ДанныеТопика;
		КонецЕсли;
	Исключение
		Результат.ОписаниеОшибки = ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Создает топик в Kafka
//
// Параметры:
//  Брокеры - Строка - Адрес брокера
//  ИмяТопика - Строка - Имя создаваемого топика
//  КоличествоПартиций - Число - Количество партиций (по умолчанию 1)
//  ФакторРепликации - Число - Фактор репликации (по умолчанию 1)
//
// Возвращаемое значение:
//  Структура - Результат создания:
//   * Успех - Булево - Истина, если топик создан
//   * ОписаниеОшибки - Строка - Текст ошибки при неудаче
//
Функция СоздатьТопик(Брокеры, ИмяТопика, КоличествоПартиций = 1, ФакторРепликации = 1) Экспорт
	
	Результат = Новый Структура("Успех, ОписаниеОшибки", Ложь, "");
	
	Попытка
		Компонента = ПолучитьЭкземплярКомпоненты();
		
		Если Компонента.СоздатьТопик(Брокеры, ИмяТопика, КоличествоПартиций, ФакторРепликации) Тогда
			Результат.Успех = Истина;
			ЗаписьЖурналаРегистрации("ПодсистемаИнтеграции.РаботаСКафка",
				УровеньЖурналаРегистрации.Информация, , ,
				СтрШаблон("Топик %1 успешно создан (партиций: %2, репликация: %3)",
					ИмяТопика, КоличествоПартиций, ФакторРепликации));
		Иначе
			Результат.ОписаниеОшибки = Компонента.ПолучитьСообщениеОбОшибке();
			ЗаписьЖурналаРегистрации("ПодсистемаИнтеграции.РаботаСКафка",
				УровеньЖурналаРегистрации.Ошибка, , ,
				СтрШаблон("Ошибка создания топика %1: %2", ИмяТопика, Результат.ОписаниеОшибки));
		КонецЕсли;
	Исключение
		Результат.ОписаниеОшибки = ОписаниеОшибки();
		ЗаписьЖурналаРегистрации("ПодсистемаИнтеграции.РаботаСКафка",
			УровеньЖурналаРегистрации.Ошибка, , , Результат.ОписаниеОшибки);
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Получает настройки топика из Kafka
//
// Параметры:
//  Брокеры - Строка - Адрес брокера
//  ИмяТопика - Строка - Имя топика
//
// Возвращаемое значение:
//  Структура - Результат:
//   * Успех - Булево - Истина, если настройки получены
//   * ОписаниеОшибки - Строка - Текст ошибки
//   * Настройки - Соответствие - Настройки топика (retention.ms, cleanup.policy, etc.)
//
Функция ПолучитьНастройкиТопика(Брокеры, ИмяТопика) Экспорт
	
	Результат = Новый Структура("Успех, ОписаниеОшибки, Настройки", Ложь, "", Новый Соответствие);
	
	Попытка
		Компонента = ПолучитьЭкземплярКомпоненты();
		РезультатJSON = Компонента.ПолучитьНастройкиТопика(Брокеры, ИмяТопика);
		
		Если ПустаяСтрока(РезультатJSON) Тогда
			Результат.ОписаниеОшибки = Компонента.ПолучитьСообщениеОбОшибке();
			Возврат Результат;
		КонецЕсли;
		
		ДанныеНастроек = инт_КоннекторHTTP.JsonВОбъект(РезультатJSON);
		МассивНастроек = ДанныеНастроек.Получить("configs");
		
		Если МассивНастроек <> Неопределено Тогда
			Для Каждого Настройка Из МассивНастроек Цикл
				ИмяНастройки = Настройка.Получить("name");
				ЗначениеНастройки = Настройка.Получить("value");
				Если ИмяНастройки <> Неопределено Тогда
					Результат.Настройки.Вставить(ИмяНастройки, ЗначениеНастройки);
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		Результат.Успех = Истина;
	Исключение
		Результат.ОписаниеОшибки = ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Получает информацию о кластере Kafka
//
// Параметры:
//  Брокеры - Строка - Адрес брокера
//
// Возвращаемое значение:
//  Структура - Результат:
//   * Успех - Булево - Истина, если информация получена
//   * ОписаниеОшибки - Строка - Текст ошибки
//   * КоличествоБрокеров - Число - Количество брокеров в кластере
//   * КоличествоТопиков - Число - Количество топиков
//   * Брокеры - Массив - Информация о брокерах
//
Функция ПолучитьИнформациюОКластере(Брокеры) Экспорт
	
	Результат = Новый Структура("Успех, ОписаниеОшибки, КоличествоБрокеров, КоличествоТопиков, Брокеры",
		Ложь, "", 0, 0, Новый Массив);
	
	Попытка
		Компонента = ПолучитьЭкземплярКомпоненты();
		РезультатJSON = Компонента.ПолучитьИнформациюОКластере(Брокеры);
		
		Если ПустаяСтрока(РезультатJSON) Тогда
			Результат.ОписаниеОшибки = Компонента.ПолучитьСообщениеОбОшибке();
			Возврат Результат;
		КонецЕсли;
		
		ДанныеКластера = инт_КоннекторHTTP.JsonВОбъект(РезультатJSON);
		
		КолБрокеров = ДанныеКластера.Получить("brokers_count");
		Если КолБрокеров <> Неопределено Тогда
			Результат.КоличествоБрокеров = Число(КолБрокеров);
		КонецЕсли;
		
		КолТопиков = ДанныеКластера.Получить("topics_count");
		Если КолТопиков <> Неопределено Тогда
			Результат.КоличествоТопиков = Число(КолТопиков);
		КонецЕсли;
		
		МассивБрокеров = ДанныеКластера.Получить("brokers");
		Если МассивБрокеров <> Неопределено Тогда
			Результат.Брокеры = МассивБрокеров;
		КонецЕсли;
		
		Результат.Успех = Истина;
	Исключение
		Результат.ОписаниеОшибки = ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции
Функция ПолучитьЭкземплярКомпоненты()
	ПодключитьВнешнююКомпоненту("ОбщийМакет.инт_simple_kafka", "Integration", ТипВнешнейКомпоненты.Native, ТипПодключенияВнешнейКомпоненты.Изолированно);

	Попытка
		Компонента = Новый("AddIn.Integration.simpleKafka1C");
	Исключение
		СообщениеОбОшибке = "Ошибка при подключении компоненты <Simple Kafka 1C>!";
		ЗаписьЖурналаРегистрации("ПодсистемаИнтеграции.РаботаСКафка",
                                        УровеньЖурналаРегистрации.Ошибка, , , СообщениеОбОшибке);
		ВызватьИсключение СообщениеОбОшибке;
	КонецПопытки;
	
	Возврат Компонента;
КонецФункции

#КонецОбласти
