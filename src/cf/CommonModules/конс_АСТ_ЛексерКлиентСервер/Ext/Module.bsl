// Лексический анализатор (ДКА-лексер) встроенного языка BSL (1C:Enterprise)
//
// Модуль реализует лексический анализ (токенизацию) исходного кода BSL
// на основе детерминированного конечного автомата (ДКА).
//
// Точки входа:
//   СоздатьКонтекстЛексера  — инициализация состояния лексера
//   ПолучитьСледующуюЛексему — извлечение следующей лексемы из потока
//   СоздатьСтруктуруЛексемы  — преобразование лексемы в стандартную структуру

#Область ПрограммныйИнтерфейс

// Создаёт структуру контекста лексического анализатора (ДКА).
//
// Параметры:
//  ИсходныйКод - Строка - исходный код для лексического анализа
//  СоответствиеДКА - Соответствие - таблица переходов ДКА
//  СоответствиеЛексемПеревода - Соответствие - таблица перевода лексем (переносы строк)
//
// Возвращаемое значение:
//  Структура - контекст лексера
Функция СоздатьКонтекстЛексера(ИсходныйКод, СоответствиеДКА, СоответствиеЛексемПеревода) Экспорт
	КонтекстЛексера = Новый Структура;
	КонтекстЛексера.Вставить("ИсходныйКод", ИсходныйКод);
	КонтекстЛексера.Вставить("ДлинаКода", СтрДлина(ИсходныйКод));
	КонтекстЛексера.Вставить("ПозицияЛексера", 1);
	КонтекстЛексера.Вставить("НомерТекущейСтроки", 1);
	КонтекстЛексера.Вставить("ПозицияВСтроке", 1);
	КонтекстЛексера.Вставить("СоответствиеДКА", СоответствиеДКА);
	КонтекстЛексера.Вставить("СоответствиеЛексемПеревода", СоответствиеЛексемПеревода);
	КонтекстЛексера.Вставить("ЛексерЗавершен", Ложь);
	Возврат КонтекстЛексера;
КонецФункции

// Извлекает следующую лексему из исходного кода с помощью ДКА.
//
// Параметры:
//  КонтекстЛексера - Структура - состояние лексера, модифицируется при извлечении
//
// Возвращаемое значение:
//  Структура - лексема: Имя, Значение, НомерСтроки, Позиция
Функция ПолучитьСледующуюЛексему(КонтекстЛексера) Экспорт
	ЗначениеЛексемы = "";
	ТекущееСостояние = "S";
	ТекущийТерминал = "";
	НомерСтрокиЛексемы = КонтекстЛексера.НомерТекущейСтроки;
	НачалоЛексемы = КонтекстЛексера.ПозицияВСтроке;
	
	Пока Истина Цикл
		ТекущийСимвол = ПолучитьТекущийСимвол(КонтекстЛексера);
		ПереходДКА = ОпределитьПереходДКА(КонтекстЛексера.СоответствиеДКА, ТекущийСимвол, ТекущееСостояние);
		Если ПереходДКА = Неопределено Тогда
			ОбработатьОтсутствиеПереходаДКА(КонтекстЛексера, ТекущийСимвол, ТекущееСостояние, ЗначениеЛексемы, ТекущийТерминал, НомерСтрокиЛексемы, НачалоЛексемы);
			Прервать;
		КонецЕсли;
		ЗначениеЛексемы = ЗначениеЛексемы + ТекущийСимвол;
		ТекущееСостояние = ПереходДКА.СледСостояние;
		КонтекстЛексера.ПозицияЛексера = КонтекстЛексера.ПозицияЛексера + 1;
		КонтекстЛексера.ПозицияВСтроке = КонтекстЛексера.ПозицияВСтроке + 1;
	КонецЦикла;
	Возврат Новый Структура("Имя,Значение,НомерСтроки,Позиция", ТекущийТерминал, ЗначениеЛексемы, НомерСтрокиЛексемы, НачалоЛексемы);
КонецФункции

// Создаёт стандартную структуру лексемы из исходной структуры.
//
// Параметры:
//  ИсходнаяЛексема - Структура - лексема с полями Лексема, Значение, НомерСтроки, НачальнаяПозиция
//
// Возвращаемое значение:
//  Структура - лексема: Имя, Значение, НомерСтроки, Позиция
Функция СоздатьСтруктуруЛексемы(ИсходнаяЛексема) Экспорт
	НоваяЛексема = Новый Структура("Имя,Значение,НомерСтроки,Позиция");
	НоваяЛексема.Имя = ИсходнаяЛексема.Лексема;
	НоваяЛексема.Значение = ИсходнаяЛексема.Значение;
	НоваяЛексема.НомерСтроки = ИсходнаяЛексема.НомерСтроки;
	НоваяЛексема.Позиция = ИсходнаяЛексема.НачальнаяПозиция;
	Возврат НоваяЛексема;
КонецФункции

#КонецОбласти // ПрограммныйИнтерфейс

#Область СлужебныеПроцедурыИФункции

// Возвращает текущий символ исходного кода или 0 при достижении конца.
Функция ПолучитьТекущийСимвол(КонтекстЛексера)
	Если КонтекстЛексера.ПозицияЛексера > КонтекстЛексера.ДлинаКода Тогда
		Возврат 0;
	КонецЕсли;
	Возврат Сред(КонтекстЛексера.ИсходныйКод, КонтекстЛексера.ПозицияЛексера, 1);
КонецФункции

// Определяет переход ДКА для текущего символа и состояния.
Функция ОпределитьПереходДКА(СоответствиеДКА, ТекущийСимвол, ТекущееСостояние)
	Если ТекущийСимвол = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;
	КолонкаДКА = СоответствиеДКА[ТекущийСимвол];
	Если КолонкаДКА = Неопределено Тогда
		КолонкаДКА = СоответствиеДКА["\U"];
	КонецЕсли;
	Если КолонкаДКА = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	Возврат КолонкаДКА[ТекущееСостояние];
КонецФункции

// Обрабатывает ситуацию отсутствия перехода ДКА: определяет финальное состояние,
// формирует терминал лексемы (EOF, Err или выходной символ).
Процедура ОбработатьОтсутствиеПереходаДКА(КонтекстЛексера, ТекущийСимвол, ТекущееСостояние, ЗначениеЛексемы, ТекущийТерминал, НомерСтрокиЛексемы, НачалоЛексемы)
	КолонкаДКА = КонтекстЛексера.СоответствиеДКА["&!"];
	ФинальноеСостояние = КолонкаДКА[ТекущееСостояние];
	Если ФинальноеСостояние = Неопределено Тогда
		Если ТекущийСимвол = 0 Тогда
			ТекущийТерминал = "Спец_КонецФайла";
			НачалоЛексемы = КонтекстЛексера.ПозицияВСтроке;
			НомерСтрокиЛексемы = КонтекстЛексера.НомерТекущейСтроки;
			КонтекстЛексера.ЛексерЗавершен = Истина;
		Иначе
			ТекущийТерминал = "Err";
			КонтекстЛексера.ПозицияЛексера = КонтекстЛексера.ПозицияЛексера + 1;
			КонтекстЛексера.ПозицияВСтроке = КонтекстЛексера.ПозицияВСтроке + 1;
			ЗначениеЛексемы = ЗначениеЛексемы + ТекущийСимвол;
			НомерСтрокиЛексемы = КонтекстЛексера.НомерТекущейСтроки;
			НачалоЛексемы = КонтекстЛексера.ПозицияВСтроке - СтрДлина(ЗначениеЛексемы);
		КонецЕсли;
	Иначе
		ТекущийТерминал = ФинальноеСостояние.Вывод;
		Если КонтекстЛексера.СоответствиеЛексемПеревода[ТекущийТерминал] <> Неопределено Тогда
			НомерСтрокиЛексемы = КонтекстЛексера.НомерТекущейСтроки;
			КонтекстЛексера.НомерТекущейСтроки = КонтекстЛексера.НомерТекущейСтроки + 1;
			НачалоЛексемы = КонтекстЛексера.ПозицияВСтроке - СтрДлина(ЗначениеЛексемы);
			КонтекстЛексера.ПозицияВСтроке = 1;
		Иначе
			НомерСтрокиЛексемы = КонтекстЛексера.НомерТекущейСтроки;
			НачалоЛексемы = КонтекстЛексера.ПозицияВСтроке - СтрДлина(ЗначениеЛексемы);
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

#КонецОбласти // СлужебныеПроцедурыИФункции
