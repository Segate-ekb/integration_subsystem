////////////////////////////////////////////////////////////////////////////////
// конс_ПодключаемаяКонсольВызовСервера: Серверные функции для вызова с клиента
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

#Область РаботаСНастройками

// Получает настройки редактора из хранилища.
// 
// Возвращаемое значение:
//   Структура - См. конс_ПодключаемаяКонсольСервер.ПолучитьНастройкиИзХранилища
//
Функция ПолучитьНастройкиИзХранилища() Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПолучитьНастройкиИзХранилища();
	
КонецФункции

// Сохраняет настройки редактора в хранилище.
// 
// Параметры:
//   Настройки - Структура - настройки для сохранения
//
Процедура СохранитьНастройкиВХранилище(Настройки) Экспорт
	
	конс_ПодключаемаяКонсольСервер.СохранитьНастройкиВХранилище(Настройки);
	
КонецПроцедуры

#КонецОбласти

#Область ИнициализацияРедактора

// Инициализирует редактор на сервере.
// Заполняет реквизиты формы, необходимые для работы редактора.
// Устаревшая. Используйте конс_ПодключаемаяКонсольСервер.ИнициализироватьРедактор.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   УникальныйИдентификатор - УникальныйИдентификатор - идентификатор формы
//   Версия - Строка - версия обработки (по умолчанию "1.0")
//
Процедура ИнициализироватьРедактор(Форма, УникальныйИдентификатор, Версия = "1.0") Экспорт
	
	// Определяем путь к данным элемента HTML (должен быть привязан пользователем)
	Элемент = Форма.Элементы.Найти("HTML");
	ПутьКДанным = "";
	Если Элемент <> Неопределено И ЗначениеЗаполнено(Элемент.ПутьКДанным) Тогда
		ПутьКДанным = Элемент.ПутьКДанным;
	КонецЕсли;
	
	// Инициализируем структуру параметров редактора
	Форма.конс_СтруктураПараметровРедактораКода = Новый Структура;
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("ИмяПоляHTML", "HTML");
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("ПутьКДаннымПоляHTML", ПутьКДанным);
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("ВерсияОбработки", Версия);
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("ИсходникиЗагружены", Ложь);
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("АдресМакета", "");
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("АдресОбщихМодулей", "");
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("АдресНастроек", "");
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("АдресХраненияПеременных", "");
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("JSONПеременных", "");
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("JSONФункций", "");
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("JSONСниппетов", "");
	
	// Получаем данные макета src
	ДанныеМакета = конс_ПодключаемаяКонсольПовтИсп.ПолучитьДанныеМакетаИсходников();
	Если ДанныеМакета <> Неопределено Тогда
		Форма.конс_СтруктураПараметровРедактораКода.АдресМакета = ПоместитьВоВременноеХранилище(ДанныеМакета, УникальныйИдентификатор);
	КонецЕсли;
	
	// Получаем коллекцию общих модулей
	КоллекцияОбщихМодулей = конс_ПодключаемаяКонсольСервер.ПолучитьКоллекциюОбщихМодулей();
	Форма.конс_СтруктураПараметровРедактораКода.АдресОбщихМодулей = ПоместитьВоВременноеХранилище(КоллекцияОбщихМодулей, УникальныйИдентификатор);
	
	// Загружаем настройки
	конс_ПодключаемаяКонсольСервер.ПолучитьНастройкиИзХранилища();
	
КонецПроцедуры

// Возвращает список реквизитов формы, которые нужно добавить для работы редактора.
// 
// Возвращаемое значение:
//   Массив из Структура - описание реквизитов:
//     * Имя - Строка
//     * Тип - ОписаниеТипов
//     * Значение - Произвольный
//
Функция ПолучитьРеквизитыФормыРедактора() Экспорт
	
	Реквизиты = Новый Массив;
	
	// Единственный служебный реквизит - структура параметров
	Реквизиты.Добавить(Новый Структура("Имя, Тип, Значение", "конс_СтруктураПараметровРедактораКода", Неопределено, Новый Структура));
	
	Возврат Реквизиты;
	
КонецФункции

#КонецОбласти

#Область ВыполнениеКода

// Выполняет код на сервере.
// 
// Параметры:
//   Код - Строка - BSL-код для выполнения
//   РежимПоказаПеременных - ПеречислениеСсылка.конс_РежимПоказаПеременных - режим отображения результатов
//
// Возвращаемое значение:
//   Структура - результат выполнения
//
Функция ВыполнитьКодНаСервере(Код, РежимПоказаПеременных) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ВыполнитьКодНаСервере(Код, РежимПоказаПеременных);
	
КонецФункции

#КонецОбласти

#Область РаботаСПеременными

// Получает описание переменных для табло.
// 
// Параметры:
//   ЗначенияПеременных - Структура
//   АдресХраненияПеременных - Строка - возвращаемый адрес
//
// Возвращаемое значение:
//   Строка - JSON
//
Функция ПолучитьОписаниеПеременныхДляТабло(ЗначенияПеременных, АдресХраненияПеременных) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПолучитьОписаниеПеременныхДляТабло(ЗначенияПеременных, АдресХраненияПеременных);
	
КонецФункции

// Получает описание переменных для всплывающих подсказок.
// 
// Параметры:
//   ЗначенияПеременных - Структура
//
// Возвращаемое значение:
//   Строка - JSON
//
Функция ПолучитьОписаниеПеременныхДляПодсказок(ЗначенияПеременных) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПолучитьОписаниеПеременныхДляПодсказок(ЗначенияПеременных);
	
КонецФункции

// Раскрывает дочернее значение переменной для детализации в табло.
// 
// Параметры:
//   АдресХраненияПеременных - Строка - адрес хранилища
//   ИдентификаторПеременной - Строка - идентификатор переменной из события
//   ИмяПеременной - Строка - имя переменной для отображения
//   ПутьКДанным - Строка - путь к данным для раскрытия
//
// Возвращаемое значение:
//   Строка - JSON с описанием переменной, включая children
//
Функция РаскрытьПеременнуюВТабло(АдресХраненияПеременных, ИдентификаторПеременной, ИмяПеременной, ПутьКДанным) Экспорт
	
	Данные = ПолучитьИзВременногоХранилища(АдресХраненияПеременных);
	
	Если Данные = Неопределено Тогда
		Возврат "{}";
	КонецЕсли;
	
	ХранилищеПеременных = Данные.ХранилищеПеременных;
	КэшСсылок = Данные.КэшСсылок;
	
	// Определяем путь для вычисления
	Путь = ?(ЗначениеЗаполнено(ПутьКДанным), ПутьКДанным, ИдентификаторПеременной);
	
	// Вызываем серверную функцию для раскрытия переменной
	ОписаниеПеременной = конс_ПодключаемаяКонсольСервер.РаскрытьПеременнуюВТаблоСервер(
		ХранилищеПеременных,
		КэшСсылок,
		Путь,
		ИмяПеременной
	);
	
	Если ОписаниеПеременной = Неопределено Тогда
		Возврат "{}";
	КонецЕсли;
	
	// Формируем результат в формате, ожидаемом табло
	// Структура: {идентификатор_переменной: описание_переменной}
	Результат = Новый Структура;
	Результат.Вставить(ИдентификаторПеременной, ОписаниеПеременной);
	
	Запись = Новый ЗаписьJSON;
	Запись.УстановитьСтроку();
	ЗаписатьJSON(Запись, Результат);
	
	Возврат Запись.Закрыть();
	
КонецФункции

#КонецОбласти

#Область РаботаСМетаданными

// Получает коллекцию общих модулей.
// 
// Возвращаемое значение:
//   Массив
//
Функция ПолучитьКоллекциюОбщихМодулей() Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПолучитьКоллекциюОбщихМодулей();
	
КонецФункции

// Получает метаданные для автодополнения в редакторе.
// 
// Возвращаемое значение:
//   Структура
//
Функция ПолучитьМетаданныеДляРедактора() Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПолучитьМетаданныеДляРедактора();
	
КонецФункции

// Получает данные метаданных по запросу для контекстной подсказки.
// 
// Параметры:
//   ПараметрыЗапроса - Строка - строка запроса метаданных (например, "справочники", "справочники.номенклатура")
//
// Возвращаемое значение:
//   Структура, Неопределено - результат запроса:
//     * Данные - Строка - JSON с данными метаданных
//     * АдресОбновления - Строка - адрес для обновления в редакторе
//
Функция ПолучитьДанныеМетаданныхПоЗапросу(ПараметрыЗапроса) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПолучитьДанныеМетаданныхПоЗапросу(ПараметрыЗапроса);
	
КонецФункции

// Получает информацию об общем модуле для загрузки из исходников.
// 
// Параметры:
//   ИмяМодуля - Строка - имя модуля
//
// Возвращаемое значение:
//   Структура, Неопределено - информация о модуле:
//     * ИмяВКонфигураторе - Строка - точное имя модуля в конфигураторе
//     * Глобальный - Булево - является ли модуль глобальным
//
Функция ПолучитьИнформациюОбщегоМодуля(ИмяМодуля) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПолучитьИнформациюОбщегоМодуля(ИмяМодуля);
	
КонецФункции

// Получает информацию об объекте метаданных для загрузки модуля из исходников.
// 
// Параметры:
//   КоллекцияМетаданных - Строка - имя коллекции (обработки, справочники и т.д.)
//   ИмяОбъекта - Строка - имя объекта метаданных
//
// Возвращаемое значение:
//   Структура, Неопределено - информация об объекте:
//     * ИмяКаталога - Строка - имя каталога в выгрузке (DataProcessors, Catalogs и т.д.)
//     * ИмяОбъектаВКонфигураторе - Строка - точное имя объекта в конфигураторе
//     * ИмяКоллекцииРедактора - Строка - имя коллекции для редактора (dataProc, catalogs и т.д.)
//
Функция ПолучитьИнформациюОбъектаМетаданных(КоллекцияМетаданных, ИмяОбъекта) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПолучитьИнформациюОбъектаМетаданных(КоллекцияМетаданных, ИмяОбъекта);
	
КонецФункции

// Читает текст общего модуля из файла исходников.
// 
// Параметры:
//   КаталогИсходногоКода - Строка - путь к каталогу с исходниками
//   ИмяМодуля - Строка - имя модуля
//
// Возвращаемое значение:
//   Структура, Неопределено - данные модуля:
//     * ИмяМодуля - Строка - точное имя модуля
//     * ТекстМодуля - Строка - текст модуля
//     * Глобальный - Булево - является ли модуль глобальным
//
Функция ПрочитатьТекстОбщегоМодуля(КаталогИсходногоКода, ИмяМодуля) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПрочитатьТекстОбщегоМодуля(КаталогИсходногоКода, ИмяМодуля);
	
КонецФункции

// Читает текст модуля объекта (менеджера или объекта) из файла исходников.
// 
// Параметры:
//   КаталогИсходногоКода - Строка - путь к каталогу с исходниками
//   ТипМодуля - Строка - "manager" или "object"
//   КоллекцияМетаданных - Строка - имя коллекции (обработки, справочники и т.д.)
//   ИмяОбъекта - Строка - имя объекта метаданных
//
// Возвращаемое значение:
//   Структура, Неопределено - данные модуля:
//     * ТекстМодуля - Строка - текст модуля
//     * АдресЗагрузки - Строка - адрес для загрузки в редактор
//
Функция ПрочитатьТекстМодуляОбъекта(КаталогИсходногоКода, ТипМодуля, КоллекцияМетаданных, ИмяОбъекта) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПрочитатьТекстМодуляОбъекта(КаталогИсходногоКода, ТипМодуля, КоллекцияМетаданных, ИмяОбъекта);
	
КонецФункции

#КонецОбласти

#Область СлужебныеФункции

// Возвращает новую структуру для результата выполнения кода.
// 
// Возвращаемое значение:
//   Структура - См. конс_ПодключаемаяКонсольСервер.НовыйРезультатВыполнения
//
Функция НовыйРезультатВыполнения() Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.НовыйРезультатВыполнения();
	
КонецФункции

// Создаёт контекст для внешнего выполнения кода.
// См. конс_ПодключаемаяКонсольСервер.СоздатьКонтекстВыполнения
// 
// Параметры:
//   ИдентификаторФормы - УникальныйИдентификатор
//   РежимПоказаПеременных - ПеречислениеСсылка.конс_РежимПоказаПеременных
//
// Возвращаемое значение:
//   Структура - контекст выполнения
//
Функция СоздатьКонтекстВыполнения(ИдентификаторФормы, РежимПоказаПеременных = Неопределено) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.СоздатьКонтекстВыполнения(ИдентификаторФормы, РежимПоказаПеременных);
	
КонецФункции

// Формирует результат выполнения на основе контекста и информации об ошибке.
// См. конс_ПодключаемаяКонсольСервер.СформироватьРезультатВыполнения
// 
// Параметры:
//   ЗначенияПеременных - Структура
//   ИнформацияОбОшибке - Структура, Неопределено - разобранная информация об ошибке
//   АдресХраненияПеременных - Строка
//   РежимПоказаПеременных - ПеречислениеСсылка.конс_РежимПоказаПеременных
//
// Возвращаемое значение:
//   Структура - результат выполнения
//
Функция СформироватьРезультатВыполнения(ЗначенияПеременных, ИнформацияОбОшибке, АдресХраненияПеременных, РежимПоказаПеременных) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.СформироватьРезультатВыполнения(ЗначенияПеременных, ИнформацияОбОшибке, АдресХраненияПеременных, РежимПоказаПеременных);
	
КонецФункции

// Освобождает контекст выполнения.
// См. конс_ПодключаемаяКонсольСервер.ОсвободитьКонтекстВыполнения
// 
// Параметры:
//   АдресХраненияПеременных - Строка
//
Процедура ОсвободитьКонтекстВыполнения(АдресХраненияПеременных) Экспорт
	
	конс_ПодключаемаяКонсольСервер.ОсвободитьКонтекстВыполнения(АдресХраненияПеременных);
	
КонецПроцедуры

// Формирует код для сбора значений переменных.
// См. конс_ПодключаемаяКонсольСервер.СформироватьКодСбораПеременных
// 
// Параметры:
//   ИменаПеременных - Массив
//
// Возвращаемое значение:
//   Строка - код BSL для сбора переменных
//
Функция СформироватьКодСбораПеременных(ИменаПеременных) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.СформироватьКодСбораПеременных(ИменаПеременных);
	
КонецФункции

// Создаёт временное хранилище для переменных.
// 
// Параметры:
//   ИдентификаторФормы - УникальныйИдентификатор - идентификатор формы для привязки хранилища
//
// Возвращаемое значение:
//   Строка - адрес временного хранилища
//
Функция СоздатьВременноеХранилищеПеременных(ИдентификаторФормы) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.СоздатьВременноеХранилищеПеременных(ИдентификаторФормы);
	
КонецФункции

// Обрабатывает результат внешнего выполнения кода.
// Получает переменные из хранилища и формирует структуру результата.
// 
// Параметры:
//   АдресХраненияПеременных - Строка - адрес хранилища с переменными
//   ИнформацияОбОшибке - Структура, Неопределено - разобранная информация об ошибке
//   РежимПоказаПеременных - ПеречислениеСсылка.конс_РежимПоказаПеременных - режим отображения переменных
//
// Возвращаемое значение:
//   Структура - результат выполнения
//
Функция ОбработатьРезультатВнешнегоВыполнения(АдресХраненияПеременных, ИнформацияОбОшибке, РежимПоказаПеременных) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ОбработатьРезультатВнешнегоВыполнения(АдресХраненияПеременных, ИнформацияОбОшибке, РежимПоказаПеременных);
	
КонецФункции

// Возвращает текущую дату сеанса.
// Используется для получения даты на клиенте через серверный вызов.
// 
// Возвращаемое значение:
//   Дата
//
Функция ПолучитьТекущуюДатуСеанса() Экспорт
	
	Возврат ТекущаяДатаСеанса();
	
КонецФункции

#КонецОбласти

#КонецОбласти
