////////////////////////////////////////////////////////////////////////////////
// конс_ПодключаемаяКонсольВызовСервера: Серверные функции для вызова с клиента
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

#Область РаботаСНастройками

// Получает настройки редактора из хранилища.
// 
// Возвращаемое значение:
//   Структура - См. конс_ПодключаемаяКонсольСервер.ПолучитьНастройкиИзХранилища
//
Функция ПолучитьНастройкиИзХранилища() Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПолучитьНастройкиИзХранилища();
	
КонецФункции

// Сохраняет настройки редактора в хранилище.
// 
// Параметры:
//   Настройки - Структура - настройки для сохранения
//
Процедура СохранитьНастройкиВХранилище(Настройки) Экспорт
	
	конс_ПодключаемаяКонсольСервер.СохранитьНастройкиВХранилище(Настройки);
	
КонецПроцедуры

#КонецОбласти

#Область ИнициализацияРедактора

// Инициализирует редактор на сервере.
// Заполняет реквизиты формы, необходимые для работы редактора.
// Устаревшая. Используйте конс_ПодключаемаяКонсольСервер.ИнициализироватьРедактор.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   УникальныйИдентификатор - УникальныйИдентификатор - идентификатор формы
//   Версия - Строка - версия обработки (по умолчанию "1.0")
//
Процедура ИнициализироватьРедактор(Форма, УникальныйИдентификатор, Версия = "1.0") Экспорт
	
	// Определяем путь к данным элемента HTML (должен быть привязан пользователем)
	Элемент = Форма.Элементы.Найти("HTML");
	ПутьКДанным = "";
	Если Элемент <> Неопределено И ЗначениеЗаполнено(Элемент.ПутьКДанным) Тогда
		ПутьКДанным = Элемент.ПутьКДанным;
	КонецЕсли;
	
	// Инициализируем структуру параметров редактора
	Форма.конс_СтруктураПараметровРедактораКода = Новый Структура;
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("ИмяПоляHTML", "HTML");
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("ПутьКДаннымПоляHTML", ПутьКДанным);
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("ВерсияОбработки", Версия);
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("ИсходникиЗагружены", Ложь);
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("АдресМакета", "");
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("АдресОбщихМодулей", "");
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("АдресНастроек", "");
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("АдресХраненияПеременных", "");
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("JSONПеременных", "");
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("JSONФункций", "");
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("JSONСниппетов", "");
	Форма.конс_СтруктураПараметровРедактораКода.Вставить("АдресЗначенийПеременных", "");
	
	// Получаем данные макета src
	ДанныеМакета = конс_ПодключаемаяКонсольПовтИсп.ПолучитьДанныеМакетаИсходников();
	Если ДанныеМакета <> Неопределено Тогда
		Форма.конс_СтруктураПараметровРедактораКода.АдресМакета = ПоместитьВоВременноеХранилище(ДанныеМакета, УникальныйИдентификатор);
	КонецЕсли;
	
	// Получаем коллекцию общих модулей
	КоллекцияОбщихМодулей = конс_ПодключаемаяКонсольСервер.ПолучитьКоллекциюОбщихМодулей();
	Форма.конс_СтруктураПараметровРедактораКода.АдресОбщихМодулей = ПоместитьВоВременноеХранилище(КоллекцияОбщихМодулей, УникальныйИдентификатор);
	
	// Загружаем настройки
	конс_ПодключаемаяКонсольСервер.ПолучитьНастройкиИзХранилища();
	
КонецПроцедуры

// Возвращает список реквизитов формы, которые нужно добавить для работы редактора.
// 
// Возвращаемое значение:
//   Массив из Структура - описание реквизитов:
//     * Имя - Строка
//     * Тип - ОписаниеТипов
//     * Значение - Произвольный
//
Функция ПолучитьРеквизитыФормыРедактора() Экспорт
	
	Реквизиты = Новый Массив;
	
	// Единственный служебный реквизит - структура параметров
	Реквизиты.Добавить(Новый Структура("Имя, Тип, Значение", "конс_СтруктураПараметровРедактораКода", Неопределено, Новый Структура));
	
	Возврат Реквизиты;
	
КонецФункции

#КонецОбласти

#Область ВыполнениеКода

// Выполняет код на сервере.
// 
// Параметры:
//   Код - Строка - BSL-код для выполнения
//   РежимПоказаПеременных - ПеречислениеСсылка.конс_РежимПоказаПеременных - режим отображения результатов
//
// Возвращаемое значение:
//   Структура - результат выполнения
//
Функция ВыполнитьКодНаСервере(Код, РежимПоказаПеременных) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ВыполнитьКодНаСервере(Код, РежимПоказаПеременных);
	
КонецФункции

#КонецОбласти

#Область РаботаСПеременными

// Получает описание переменных отладки для табло из данных ВМ.
// 
// Параметры:
//   АдресПеременных - Строка - адрес данных отладки во временном хранилище
//   АдресХраненияПеременных - Строка - возвращаемый адрес хранилища переменных табло
//
// Возвращаемое значение:
//   Строка - JSON-описание переменных для табло
//
Функция ПолучитьОписаниеПеременныхОтладки(АдресПеременных, АдресХраненияПеременных) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПолучитьОписаниеПеременныхОтладки(
		АдресПеременных, АдресХраненияПеременных);
	
КонецФункции

// Получает описание переменных для табло.
// 
// Параметры:
//   ЗначенияПеременных - Структура
//   АдресХраненияПеременных - Строка - возвращаемый адрес
//
// Возвращаемое значение:
//   Строка - JSON
//
Функция ПолучитьОписаниеПеременныхДляТабло(ЗначенияПеременных, АдресХраненияПеременных) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПолучитьОписаниеПеременныхДляТабло(ЗначенияПеременных, АдресХраненияПеременных);
	
КонецФункции

// Получает описание переменных для всплывающих подсказок.
// 
// Параметры:
//   ЗначенияПеременных - Структура
//
// Возвращаемое значение:
//   Строка - JSON
//
Функция ПолучитьОписаниеПеременныхДляПодсказок(ЗначенияПеременных) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПолучитьОписаниеПеременныхДляПодсказок(ЗначенияПеременных);
	
КонецФункции

// Раскрывает дочернее значение переменной для детализации в табло.
// 
// Параметры:
//   АдресХраненияПеременных - Строка - адрес хранилища
//   ИдентификаторПеременной - Строка - идентификатор переменной из события
//   ИмяПеременной - Строка - имя переменной для отображения
//   ПутьКДанным - Строка - путь к данным для раскрытия
//
// Возвращаемое значение:
//   Строка - JSON с описанием переменной, включая children
//
Функция РаскрытьПеременнуюВТабло(АдресХраненияПеременных, ИдентификаторПеременной, ИмяПеременной, ПутьКДанным) Экспорт
	
	Данные = ПолучитьИзВременногоХранилища(АдресХраненияПеременных);
	
	Если Данные = Неопределено Тогда
		Возврат "{}";
	КонецЕсли;
	
	ХранилищеПеременных = Данные.ХранилищеПеременных;
	КэшСсылок = Данные.КэшСсылок;
	
	// Определяем путь для вычисления
	Путь = ?(ЗначениеЗаполнено(ПутьКДанным), ПутьКДанным, ИдентификаторПеременной);
	
	// Вызываем серверную функцию для раскрытия переменной
	ОписаниеПеременной = конс_ПодключаемаяКонсольСервер.РаскрытьПеременнуюВТаблоСервер(
		ХранилищеПеременных,
		КэшСсылок,
		Путь,
		ИмяПеременной
	);
	
	Если ОписаниеПеременной = Неопределено Тогда
		Возврат "{}";
	КонецЕсли;
	
	// Формируем результат в формате, ожидаемом табло
	// Структура: {идентификатор_переменной: описание_переменной}
	Результат = Новый Структура;
	Результат.Вставить(ИдентификаторПеременной, ОписаниеПеременной);
	
	Запись = Новый ЗаписьJSON;
	Запись.УстановитьСтроку();
	ЗаписатьJSON(Запись, Результат);
	
	Возврат Запись.Закрыть();
	
КонецФункции

#КонецОбласти

#Область РаботаСМетаданными

// Получает коллекцию общих модулей.
// 
// Возвращаемое значение:
//   Массив
//
Функция ПолучитьКоллекциюОбщихМодулей() Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПолучитьКоллекциюОбщихМодулей();
	
КонецФункции

// Получает метаданные для автодополнения в редакторе.
// 
// Возвращаемое значение:
//   Структура
//
Функция ПолучитьМетаданныеДляРедактора() Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПолучитьМетаданныеДляРедактора();
	
КонецФункции

// Получает данные метаданных по запросу для контекстной подсказки.
// 
// Параметры:
//   ПараметрыЗапроса - Строка - строка запроса метаданных (например, "справочники", "справочники.номенклатура")
//
// Возвращаемое значение:
//   Структура, Неопределено - результат запроса:
//     * Данные - Строка - JSON с данными метаданных
//     * АдресОбновления - Строка - адрес для обновления в редакторе
//
Функция ПолучитьДанныеМетаданныхПоЗапросу(ПараметрыЗапроса) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПолучитьДанныеМетаданныхПоЗапросу(ПараметрыЗапроса);
	
КонецФункции

// Получает информацию об общем модуле для загрузки из исходников.
// 
// Параметры:
//   ИмяМодуля - Строка - имя модуля
//
// Возвращаемое значение:
//   Структура, Неопределено - информация о модуле:
//     * ИмяВКонфигураторе - Строка - точное имя модуля в конфигураторе
//     * Глобальный - Булево - является ли модуль глобальным
//
Функция ПолучитьИнформациюОбщегоМодуля(ИмяМодуля) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПолучитьИнформациюОбщегоМодуля(ИмяМодуля);
	
КонецФункции

// Получает информацию об объекте метаданных для загрузки модуля из исходников.
// 
// Параметры:
//   КоллекцияМетаданных - Строка - имя коллекции (обработки, справочники и т.д.)
//   ИмяОбъекта - Строка - имя объекта метаданных
//
// Возвращаемое значение:
//   Структура, Неопределено - информация об объекте:
//     * ИмяКаталога - Строка - имя каталога в выгрузке (DataProcessors, Catalogs и т.д.)
//     * ИмяОбъектаВКонфигураторе - Строка - точное имя объекта в конфигураторе
//     * ИмяКоллекцииРедактора - Строка - имя коллекции для редактора (dataProc, catalogs и т.д.)
//
Функция ПолучитьИнформациюОбъектаМетаданных(КоллекцияМетаданных, ИмяОбъекта) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПолучитьИнформациюОбъектаМетаданных(КоллекцияМетаданных, ИмяОбъекта);
	
КонецФункции

// Читает текст общего модуля из файла исходников.
// 
// Параметры:
//   КаталогИсходногоКода - Строка - путь к каталогу с исходниками
//   ИмяМодуля - Строка - имя модуля
//
// Возвращаемое значение:
//   Структура, Неопределено - данные модуля:
//     * ИмяМодуля - Строка - точное имя модуля
//     * ТекстМодуля - Строка - текст модуля
//     * Глобальный - Булево - является ли модуль глобальным
//
Функция ПрочитатьТекстОбщегоМодуля(КаталогИсходногоКода, ИмяМодуля) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПрочитатьТекстОбщегоМодуля(КаталогИсходногоКода, ИмяМодуля);
	
КонецФункции

// Читает текст модуля объекта (менеджера или объекта) из файла исходников.
// 
// Параметры:
//   КаталогИсходногоКода - Строка - путь к каталогу с исходниками
//   ТипМодуля - Строка - "manager" или "object"
//   КоллекцияМетаданных - Строка - имя коллекции (обработки, справочники и т.д.)
//   ИмяОбъекта - Строка - имя объекта метаданных
//
// Возвращаемое значение:
//   Структура, Неопределено - данные модуля:
//     * ТекстМодуля - Строка - текст модуля
//     * АдресЗагрузки - Строка - адрес для загрузки в редактор
//
Функция ПрочитатьТекстМодуляОбъекта(КаталогИсходногоКода, ТипМодуля, КоллекцияМетаданных, ИмяОбъекта) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПрочитатьТекстМодуляОбъекта(КаталогИсходногоКода, ТипМодуля, КоллекцияМетаданных, ИмяОбъекта);
	
КонецФункции

#КонецОбласти

#Область СлужебныеФункции

// Возвращает новую структуру для результата выполнения кода.
// 
// Возвращаемое значение:
//   Структура - См. конс_ПодключаемаяКонсольСервер.НовыйРезультатВыполнения
//
Функция НовыйРезультатВыполнения() Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.НовыйРезультатВыполнения();
	
КонецФункции

// Создаёт контекст для внешнего выполнения кода.
// См. конс_ПодключаемаяКонсольСервер.СоздатьКонтекстВыполнения
// 
// Параметры:
//   ИдентификаторФормы - УникальныйИдентификатор
//   РежимПоказаПеременных - ПеречислениеСсылка.конс_РежимПоказаПеременных
//
// Возвращаемое значение:
//   Структура - контекст выполнения
//
Функция СоздатьКонтекстВыполнения(ИдентификаторФормы, РежимПоказаПеременных = Неопределено) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.СоздатьКонтекстВыполнения(ИдентификаторФормы, РежимПоказаПеременных);
	
КонецФункции

// Формирует результат выполнения на основе контекста и информации об ошибке.
// См. конс_ПодключаемаяКонсольСервер.СформироватьРезультатВыполнения
// 
// Параметры:
//   ЗначенияПеременных - Структура
//   ИнформацияОбОшибке - Структура, Неопределено - разобранная информация об ошибке
//   АдресХраненияПеременных - Строка
//   РежимПоказаПеременных - ПеречислениеСсылка.конс_РежимПоказаПеременных
//
// Возвращаемое значение:
//   Структура - результат выполнения
//
Функция СформироватьРезультатВыполнения(ЗначенияПеременных, ИнформацияОбОшибке, АдресХраненияПеременных, РежимПоказаПеременных) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.СформироватьРезультатВыполнения(ЗначенияПеременных, ИнформацияОбОшибке, АдресХраненияПеременных, РежимПоказаПеременных);
	
КонецФункции

// Освобождает контекст выполнения.
// См. конс_ПодключаемаяКонсольСервер.ОсвободитьКонтекстВыполнения
// 
// Параметры:
//   АдресХраненияПеременных - Строка
//
Процедура ОсвободитьКонтекстВыполнения(АдресХраненияПеременных) Экспорт
	
	конс_ПодключаемаяКонсольСервер.ОсвободитьКонтекстВыполнения(АдресХраненияПеременных);
	
КонецПроцедуры

// Формирует код для сбора значений переменных.
// См. конс_ПодключаемаяКонсольСервер.СформироватьКодСбораПеременных
// 
// Параметры:
//   ИменаПеременных - Массив
//
// Возвращаемое значение:
//   Строка - код BSL для сбора переменных
//
Функция СформироватьКодСбораПеременных(ИменаПеременных) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.СформироватьКодСбораПеременных(ИменаПеременных);
	
КонецФункции

// Создаёт временное хранилище для переменных.
// 
// Параметры:
//   ИдентификаторФормы - УникальныйИдентификатор - идентификатор формы для привязки хранилища
//
// Возвращаемое значение:
//   Строка - адрес временного хранилища
//
Функция СоздатьВременноеХранилищеПеременных(ИдентификаторФормы) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.СоздатьВременноеХранилищеПеременных(ИдентификаторФормы);
	
КонецФункции

// Обрабатывает результат внешнего выполнения кода.
// Получает переменные из хранилища и формирует структуру результата.
// 
// Параметры:
//   АдресХраненияПеременных - Строка - адрес хранилища с переменными
//   ИнформацияОбОшибке - Структура, Неопределено - разобранная информация об ошибке
//   РежимПоказаПеременных - ПеречислениеСсылка.конс_РежимПоказаПеременных - режим отображения переменных
//
// Возвращаемое значение:
//   Структура - результат выполнения
//
Функция ОбработатьРезультатВнешнегоВыполнения(АдресХраненияПеременных, ИнформацияОбОшибке, РежимПоказаПеременных) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ОбработатьРезультатВнешнегоВыполнения(АдресХраненияПеременных, ИнформацияОбОшибке, РежимПоказаПеременных);
	
КонецФункции

// Возвращает текущую дату сеанса.
// Используется для получения даты на клиенте через серверный вызов.
// 
// Возвращаемое значение:
//   Дата
//
Функция ПолучитьТекущуюДатуСеанса() Экспорт
	
	Возврат ТекущаяДатаСеанса();
	
КонецФункции

// Получает соответствие структур переменных для отображения в табло.
// 
// Параметры:
//   Адрес - Строка - адрес временного хранилища с данными переменных
//   ВычислениеВыражения - Булево - признак вычисления выражения
//   МассивВыражений - Массив - массив выражений для вычисления
//   АдресВМ - Строка - адрес виртуальной машины
//   ИдентификаторФормы - УникальныйИдентификатор - идентификатор формы
//   УровеньСтекаВызовов - Число - текущий уровень стека вызовов
//
// Возвращаемое значение:
//   Соответствие - соответствие структур переменных
//
Функция ПолучитьСоответствиеСтруктурПеременных(Адрес, ВычислениеВыражения, МассивВыражений, АдресВМ, ИдентификаторФормы, УровеньСтекаВызовов) Экспорт

	СоответствиеСтруктурПеременных = Новый Соответствие;
	ДанныеПеременных               = Неопределено;

	Если ЗначениеЗаполнено(Адрес) Тогда
		ДанныеПеременных = ?(ТипЗнч(Адрес) = Тип("Строка"), ПолучитьИзВременногоХранилища(Адрес), Адрес);
	КонецЕсли;
		
	Если ВычислениеВыражения Тогда
		Для Каждого Выражение Из МассивВыражений Цикл
			Если Не ЗначениеЗаполнено(АдресВМ) Тогда
				Прервать;
			КонецЕсли;
			
			Попытка
				ВычисленныеДанныеПеременных = конс_ПросмотрЗначенийКлиентСервер.ПолучитьДанныеПеременныхПоВыражению(Выражение, АдресВМ, УровеньСтекаВызовов);

				Если ДанныеПеременных = Неопределено Тогда
					ДанныеПеременных = ВычисленныеДанныеПеременных;
				Иначе
					Для Каждого КЗ Из ВычисленныеДанныеПеременных["Переменные"] Цикл
						ДанныеПеременных["Переменные"].Вставить(КЗ.Ключ, КЗ.Значение);
					КонецЦикла;
				КонецЕсли;
			Исключение
				Значение = Новый Структура("Значение,Код,Свойство,Тип,ЭтоКоллекция", ИнформацияОбОшибке().Описание, 1, Выражение, "", Ложь);
				СоответствиеСтруктурПеременных.Вставить(Выражение, Значение);
			КонецПопытки;
		КонецЦикла;
	КонецЕсли;
	
	Если ТипЗнч(АдресВМ) = Тип("Строка") Тогда
		Если ЗначениеЗаполнено(Адрес) Тогда
			ПоместитьВоВременноеХранилище(ДанныеПеременных, Адрес);
		Иначе
			Адрес = ПоместитьВоВременноеХранилище(ДанныеПеременных, ИдентификаторФормы);
		КонецЕсли;
	Иначе
		Адрес = ДанныеПеременных;
	КонецЕсли;
		
	Если ДанныеПеременных = Неопределено Тогда
		Возврат СоответствиеСтруктурПеременных;
	КонецЕсли;
	
	Для Каждого КЗ Из ДанныеПеременных["Переменные"] Цикл
		СоответствиеСтруктурПеременных.Вставить(КЗ.Ключ, конс_ПросмотрЗначенийКлиентСервер.ПолучитьСтруктуруПеременной(КЗ.Ключ, ДанныеПеременных));
	КонецЦикла;
				
	Возврат СоответствиеСтруктурПеременных;
		
КонецФункции

// Получает структуру переменной на сервере по имени и пути.
// 
// Параметры:
//   ИмяПеременной - Строка - имя переменной
//   Адрес - Строка - адрес временного хранилища
//   Путь - Строка - путь к элементу переменной
//   ПутьПоИндексу - Строка - путь по индексу
//
// Возвращаемое значение:
//   Структура - структура переменной
//
Функция ПолучитьСтруктуруПеременнойНаСервере(ИмяПеременной, Адрес, Путь, ПутьПоИндексу) Экспорт
	
	Возврат конс_ПросмотрЗначенийКлиентСервер.ПолучитьСтруктуруПеременной(ИмяПеременной, Адрес, Путь, ПутьПоИндексу);
	
КонецФункции

// Получает значение переменной на сервере по пути.
// 
// Параметры:
//   Адрес - Строка - адрес временного хранилища
//   ИмяПеременной - Строка - имя переменной
//   Путь - Строка - путь к элементу переменной
//   ПутьПоИндексу - Строка - путь по индексу
//
// Возвращаемое значение:
//   Произвольный - значение переменной
//
Функция ПолучитьЗначениеПеременнойНаСервере(Адрес, ИмяПеременной, Путь, ПутьПоИндексу) Экспорт

	ДанныеПеременных = ПолучитьИзВременногоХранилища(Адрес);
	
	Возврат конс_ПросмотрЗначенийКлиентСервер.ПолучитьПеременнуюПоПути(ДанныеПеременных["Переменные"], ИмяПеременной, Путь, ПутьПоИндексу);

КонецФункции

// Получает количество элементов коллекции на сервере.
// 
// Параметры:
//   ИмяПеременной - Строка - имя переменной
//   Адрес - Строка - адрес временного хранилища
//   Путь - Строка - путь к элементу переменной
//   ПутьПоИндексу - Строка - путь по индексу
//
// Возвращаемое значение:
//   Число - количество элементов коллекции
//
Функция ПолучитьКоличествоЭлементовКоллекцииНаСервере(ИмяПеременной, Адрес, Путь, ПутьПоИндексу) Экспорт
	
	Возврат конс_ПросмотрЗначенийКлиентСервер.ПолучитьКоличествоЭлементовКоллекции(ИмяПеременной, Адрес, Путь, ПутьПоИндексу);
	
КонецФункции

// Формирует адрес данных для передачи значения переменной.
// 
// Параметры:
//   Адрес - Строка - адрес временного хранилища
//   ИмяПеременной - Строка - имя переменной
//   Путь - Строка - путь к элементу переменной
//   ПутьПоИндексу - Строка - путь по индексу
//   Идентификатор - УникальныйИдентификатор - идентификатор формы
//
// Возвращаемое значение:
//   Строка - адрес временного хранилища с данными для передачи
//
Функция ПолучитьАдресДанныхДляПередачиСервер(Адрес, ИмяПеременной, Путь, ПутьПоИндексу, Идентификатор) Экспорт
	
	ДанныеДляПередачи = Новый Соответствие;
	Переменные        = Новый Соответствие;
	ДанныеПеременных  = ПолучитьИзВременногоХранилища(Адрес);
	
	Переменные.Вставить(ИмяПеременной + Путь, конс_ПросмотрЗначенийКлиентСервер.ПолучитьПеременнуюПоПути(ДанныеПеременных["Переменные"], ИмяПеременной, Путь, ПутьПоИндексу));
	
	ДанныеДляПередачи.Вставить("СтруктурыТипов", ДанныеПеременных["СтруктурыТипов"]);
	ДанныеДляПередачи.Вставить("Переменные",     Переменные);
	
	Возврат ПоместитьВоВременноеХранилище(ДанныеДляПередачи, Идентификатор);
	
КонецФункции

// Вычисляет выражение на виртуальной машине и возвращает результат в формате JSON
// для отображения в JS-диалоге выражений (ExpressionDialog).
// Возвращает JSON, совместимый с Treeview.
// 
// Параметры:
//   АдресВМ - Строка - адрес виртуальной машины во временном хранилище
//   Выражение - Строка - выражение для вычисления
//   УровеньСтекаВызовов - Число - уровень стека вызовов
//
// Возвращаемое значение:
//   Структура - Результат:
//     * JSON - Строка - JSON-описание переменных для Treeview
//     * АдресХраненияТабло - Строка - адрес хранилища для раскрытия подчинённых
//
Функция ВычислитьВыражениеВJSON(АдресВМ, Выражение, УровеньСтекаВызовов = 0) Экспорт
	
	Результат = Новый Структура("JSON, АдресХраненияТабло", "{}", "");
	
	Если Не ЗначениеЗаполнено(АдресВМ) ИЛИ Не ЗначениеЗаполнено(Выражение) Тогда
		Возврат Результат;
	КонецЕсли;
	
	Попытка
		ДанныеПеременных = конс_ПросмотрЗначенийКлиентСервер.ПолучитьДанныеПеременныхПоВыражению(
			Выражение, АдресВМ, УровеньСтекаВызовов);
	Исключение
		// При ошибке вычисления возвращаем ошибку как единственный элемент дерева
		ОписаниеОшибки = Новый Структура;
		ОписаниеОшибки.Вставить("label", Выражение);
		ОписаниеОшибки.Вставить("value", ИнформацияОбОшибке().Описание);
		ОписаниеОшибки.Вставить("type", "Ошибка");
		ОписаниеОшибки.Вставить("path", "");
		ОписаниеОшибки.Вставить("class", "final");
		
		ОтветОшибки = Новый Структура;
		ОтветОшибки.Вставить("error_0", ОписаниеОшибки);
		
		Запись = Новый ЗаписьJSON;
		Запись.УстановитьСтроку();
		ЗаписатьJSON(Запись, ОтветОшибки);
		Результат.JSON = Запись.Закрыть();
		Возврат Результат;
	КонецПопытки;
	
	Если ДанныеПеременных = Неопределено Тогда
		Возврат Результат;
	КонецЕсли;
	
	// Формируем структуру значений переменных из результата вычисления
	СоответствиеПеременных = ДанныеПеременных["Переменные"];
	Если СоответствиеПеременных = Неопределено Тогда
		Возврат Результат;
	КонецЕсли;
	
	ЗначенияПеременных = Новый Структура;
	СоответствиеИмен = Новый Соответствие;
	Индекс = 0;
	Для Каждого КлючЗначение Из СоответствиеПеременных Цикл
		// Ключи Соответствия могут быть произвольными выражениями (точки, скобки и т.д.),
		// а Структура допускает только идентификаторы — используем безопасный ключ
		БезопасныйКлюч = "_expr" + XMLСтрока(Индекс);
		ЗначенияПеременных.Вставить(БезопасныйКлюч, КлючЗначение.Значение);
		СоответствиеИмен.Вставить(БезопасныйКлюч, КлючЗначение.Ключ);
		Индекс = Индекс + 1;
	КонецЦикла;
	
	АдресХраненияТабло = "";
	JSONСтрока = конс_ПодключаемаяКонсольСервер.ПолучитьОписаниеПеременныхДляТабло(
		ЗначенияПеременных, АдресХраненияТабло);
	
	// Восстановить оригинальные имена выражений в JSON-метках (label)
	Для Каждого КлючЗначение Из СоответствиеИмен Цикл
		ВрЗапись = Новый ЗаписьJSON;
		ВрЗапись.УстановитьСтроку();
		ЗаписатьJSON(ВрЗапись, КлючЗначение.Значение);
		JSONИмя = ВрЗапись.Закрыть();
		JSONИмяВнутри = Сред(JSONИмя, 2, СтрДлина(JSONИмя) - 2);
		JSONСтрока = СтрЗаменить(JSONСтрока,
			"""label"":""" + КлючЗначение.Ключ + """",
			"""label"":""" + JSONИмяВнутри + """");
	КонецЦикла;
	
	Результат.JSON = JSONСтрока;
	Результат.АдресХраненияТабло = АдресХраненияТабло;
	
	Возврат Результат;
	
КонецФункции

// Получает страницу данных коллекции в формате JSON для CollectionDialog.
// 
// Параметры:
//   Адрес - Строка - адрес данных для передачи
//   НомерСтраницы - Число - номер страницы (с 0)
//   РазмерСтраницы - Число - количество элементов на странице
//
// Возвращаемое значение:
//   Строка - JSON: {columns: [{name, title}], rows: [{col: val}], totalItems: N}
//
Функция ПолучитьСтраницуКоллекцииJSON(Адрес, НомерСтраницы = 0, РазмерСтраницы = 100) Экспорт
	
	Результат = Новый Структура("columns, rows, totalItems");
	Результат.columns = Новый Массив;
	Результат.rows = Новый Массив;
	Результат.totalItems = 0;
	
	Если Не ЗначениеЗаполнено(Адрес) Тогда
		Запись = Новый ЗаписьJSON;
		Запись.УстановитьСтроку();
		ЗаписатьJSON(Запись, Результат);
		Возврат Запись.Закрыть();
	КонецЕсли;
	
	ДанныеДляПередачи = ПолучитьИзВременногоХранилища(Адрес);
	
	Если ДанныеДляПередачи = Неопределено Тогда
		Запись = Новый ЗаписьJSON;
		Запись.УстановитьСтроку();
		ЗаписатьJSON(Запись, Результат);
		Возврат Запись.Закрыть();
	КонецЕсли;
	
	СоответствиеПеременных = ДанныеДляПередачи["Переменные"];
	СтруктурыТипов = ДанныеДляПередачи["СтруктурыТипов"];
	
	// На текущем этапе получаем первую переменную (коллекцию)
	Для Каждого КлючЗначение Из СоответствиеПеременных Цикл
		
		ИмяПеременной = КлючЗначение.Ключ;
		ЗначениеПеременной = КлючЗначение.Значение;
		
		Если ТипЗнч(ЗначениеПеременной) = Тип("ТаблицаЗначений") Тогда
			
			// Колонки
			Для Каждого Колонка Из ЗначениеПеременной.Колонки Цикл
				КолонкаОписание = Новый Структура("name, title");
				КолонкаОписание.name = Колонка.Имя;
				КолонкаОписание.title = ?(ЗначениеЗаполнено(Колонка.Заголовок), Колонка.Заголовок, Колонка.Имя);
				Результат.columns.Добавить(КолонкаОписание);
			КонецЦикла;
			
			// Строки с постраничным выводом
			Результат.totalItems = ЗначениеПеременной.Количество();
			НачальныйИндекс = НомерСтраницы * РазмерСтраницы;
			КонечныйИндекс = Мин(НачальныйИндекс + РазмерСтраницы, Результат.totalItems);
			
			Для Инд = НачальныйИндекс По КонечныйИндекс - 1 Цикл
				СтрокаДанных = Новый Соответствие;
				Для Каждого Колонка Из ЗначениеПеременной.Колонки Цикл
					ЗначениеЯчейки = ЗначениеПеременной[Инд][Колонка.Имя];
					СтрокаДанных.Вставить(Колонка.Имя,
						конс_ПросмотрЗначенийКлиентСервер.ПолучитьСтроковоеПредставлениеЗначения(ЗначениеЯчейки));
				КонецЦикла;
				Результат.rows.Добавить(СтрокаДанных);
			КонецЦикла;
			
		ИначеЕсли ТипЗнч(ЗначениеПеременной) = Тип("Массив") Тогда
			
			Результат.columns.Добавить(Новый Структура("name, title", "Значение", "Значение"));
			Результат.totalItems = ЗначениеПеременной.Количество();
			НачальныйИндекс = НомерСтраницы * РазмерСтраницы;
			КонечныйИндекс = Мин(НачальныйИндекс + РазмерСтраницы, Результат.totalItems);
			
			Для Инд = НачальныйИндекс По КонечныйИндекс - 1 Цикл
				СтрокаДанных = Новый Соответствие;
				СтрокаДанных.Вставить("Значение",
					конс_ПросмотрЗначенийКлиентСервер.ПолучитьСтроковоеПредставлениеЗначения(ЗначениеПеременной[Инд]));
				Результат.rows.Добавить(СтрокаДанных);
			КонецЦикла;
			
		ИначеЕсли ТипЗнч(ЗначениеПеременной) = Тип("Структура")
			ИЛИ ТипЗнч(ЗначениеПеременной) = Тип("Соответствие") Тогда
			
			Результат.columns.Добавить(Новый Структура("name, title", "Ключ", "Ключ"));
			Результат.columns.Добавить(Новый Структура("name, title", "Значение", "Значение"));
			Результат.totalItems = ЗначениеПеременной.Количество();
			НачальныйИндекс = НомерСтраницы * РазмерСтраницы;
			КонечныйИндекс = Мин(НачальныйИндекс + РазмерСтраницы, Результат.totalItems);
			
			Инд = 0;
			Для Каждого КлючЗначениеЭлемента Из ЗначениеПеременной Цикл
				Если Инд >= НачальныйИндекс И Инд < КонечныйИндекс Тогда
					СтрокаДанных = Новый Соответствие;
					СтрокаДанных.Вставить("Ключ", Строка(КлючЗначениеЭлемента.Ключ));
					СтрокаДанных.Вставить("Значение",
						конс_ПросмотрЗначенийКлиентСервер.ПолучитьСтроковоеПредставлениеЗначения(КлючЗначениеЭлемента.Значение));
					Результат.rows.Добавить(СтрокаДанных);
				КонецЕсли;
				Инд = Инд + 1;
				Если Инд >= КонечныйИндекс Тогда
					Прервать;
				КонецЕсли;
			КонецЦикла;
			
		КонецЕсли;
		
		Прервать; // Обрабатываем только первую переменную
		
	КонецЦикла;
	
	Запись = Новый ЗаписьJSON;
	Запись.УстановитьСтроку();
	ЗаписатьJSON(Запись, Результат);
	Возврат Запись.Закрыть();
	
КонецФункции

#КонецОбласти

#Область Отладка

// Компилирует BSL-код и инициализирует виртуальную машину для отладки.
// 
// Параметры:
//   ИсходныйКод - Строка - исходный код BSL
//   ИдентификаторФормы - УникальныйИдентификатор - идентификатор формы
//   АдресЗначенийПеременных - Строка - адрес временного хранилища со значениями внешних переменных
//
// Возвращаемое значение:
//   Структура - результат компиляции с адресами ВМ
//
Функция СкомпилироватьИЗапуститьОтладку(ИсходныйКод, ИдентификаторФормы, АдресЗначенийПеременных = "", ПредварительныеЛексемыJSON = "") Экспорт
	
	// Получаем значения переменных из временного хранилища
	ЗначенияПеременных = Неопределено;
	Если ЗначениеЗаполнено(АдресЗначенийПеременных) Тогда
		ЗначенияПеременных = ПолучитьИзВременногоХранилища(АдресЗначенийПеременных);
	КонецЕсли;
	
	Возврат конс_ПодключаемаяКонсольСервер.СкомпилироватьИЗапуститьОтладку(ИсходныйКод, ИдентификаторФормы, ЗначенияПеременных, ПредварительныеЛексемыJSON);
	
КонецФункции

// Продолжает выполнение виртуальной машины до следующей точки останова.
// 
// Параметры:
//   АдресВМ - Строка - адрес ВМ во временном хранилище
//   АдресПеременных - Строка - адрес переменных во временном хранилище
//   ТочкиОстанова - Соответствие - соответствие номеров строк-точек останова
//   МаксимальнаяГлубинаОстановки - Число, Неопределено - максимальная глубина стека вызовов для остановки
//   ОстановкаПоОшибке - Булево - останавливать ли при ошибке
//
Процедура ПродолжитьОтладку(АдресВМ, АдресПеременных, ТочкиОстанова, МаксимальнаяГлубинаОстановки = Неопределено, ОстановкаПоОшибке = Истина) Экспорт
	
	конс_ПодключаемаяКонсольСервер.ПродолжитьОтладку(АдресВМ, АдресПеременных, ТочкиОстанова, МаксимальнаяГлубинаОстановки, ОстановкаПоОшибке);
	
КонецПроцедуры

// Получает текущее состояние виртуальной машины.
// 
// Параметры:
//   АдресВМ - Строка - адрес ВМ во временном хранилище
//
// Возвращаемое значение:
//   Структура - состояние ВМ
//
Функция ПолучитьСостояниеОтладки(АдресВМ) Экспорт
	
	Возврат конс_ПодключаемаяКонсольСервер.ПолучитьСостояниеОтладки(АдресВМ);
	
КонецФункции

// Завершает выполнение виртуальной машины.
// 
// Параметры:
//   АдресВМ - Строка - адрес ВМ во временном хранилище
//
Процедура ЗавершитьОтладку(АдресВМ) Экспорт
	
	конс_ПодключаемаяКонсольСервер.ЗавершитьОтладкуВМ(АдресВМ);
	
КонецПроцедуры

#КонецОбласти

#Область РаботаСФайлами

// Читает содержимое текстового файла на сервере.
// 
// Параметры:
//   ПутьКФайлу - Строка - полный путь к файлу
//   Кодировка - КодировкаТекста - кодировка файла (по умолчанию UTF8)
//
// Возвращаемое значение:
//   Структура - результат чтения:
//     * Успешно - Булево - признак успешного чтения
//     * Содержимое - Строка - содержимое файла (если успешно)
//     * ОшибкаПодробно - Строка - описание ошибки (если неуспешно)
//
Функция ПрочитатьТекстовыйФайл(ПутьКФайлу, Кодировка = Неопределено) Экспорт
	
	Результат = Новый Структура("Успешно, Содержимое, ОшибкаПодробно", Ложь, "", "");
	
	Попытка
		ФайлНаДиске = Новый Файл(ПутьКФайлу);
		Если Не ФайлНаДиске.Существует() Тогда
			Результат.ОшибкаПодробно = "Файл не найден: " + ПутьКФайлу;
			Возврат Результат;
		КонецЕсли;
		
		Если Кодировка = Неопределено Тогда
			Кодировка = КодировкаТекста.UTF8;
		КонецЕсли;
		
		Чтение = Новый ЧтениеТекста(ПутьКФайлу, Кодировка);
		Результат.Содержимое = Чтение.Прочитать();
		Чтение.Закрыть();
		Результат.Успешно = Истина;
	Исключение
		Результат.ОшибкаПодробно = ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Выполняет предзагрузку таблиц переходов лексера и парсера в кэш сессии.
// Вызывается при включении режима отладки (до нажатия "Старт"), чтобы
// к моменту первого запуска отладки таблицы уже были построены.
// Результат кэшируется в конс_ТаблицыПереходовПовтИсп (DuringSession).
//
// Возвращаемое значение:
//   Булево - Истина если таблицы успешно загружены
//
Функция ПредзагрузитьТаблицыПерехода() Экспорт
	
	Попытка
		конс_ТаблицыПереходовПовтИсп.ПолучитьДанныеТаблицПерехода();
		Возврат Истина;
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

#КонецОбласти

#КонецОбласти
