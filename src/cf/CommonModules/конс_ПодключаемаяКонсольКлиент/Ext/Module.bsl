////////////////////////////////////////////////////////////////////////////////
// конс_ПодключаемаяКонсольКлиент: Клиентский API для подключения редактора кода
////////////////////////////////////////////////////////////////////////////////
// 
// МИНИМАЛЬНОЕ ПОДКЛЮЧЕНИЕ РЕДАКТОРА (3 строки):
// 
// 1. Добавить на форму элемент типа ПолеHTML с именем "HTML"
//    (событие ДокументСформирован → HTMLДокументСформирован)
// 
// 2. В ПриСозданииНаСервере:
//    конс_ПодключаемаяКонсольСервер.ИнициализироватьРедактор(ЭтотОбъект, УникальныйИдентификатор);
// 
// 3. В ПриОткрытии:
//    конс_ПодключаемаяКонсольКлиент.ПодключитьРедактор(ЭтаФорма);
// 
// 4. В HTMLДокументСформирован:
//    конс_ПодключаемаяКонсольКлиент.ОбработчикДокументСформирован(ЭтаФорма);
// 
// РАБОТА С ТЕКСТОМ:
//    Текст = конс_ПодключаемаяКонсольКлиент.ПолучитьТекст(ЭтаФорма);
//    конс_ПодключаемаяКонсольКлиент.УстановитьТекст(ЭтаФорма, Текст);
// 
// ВЫПОЛНЕНИЕ КОДА:
//    конс_ПодключаемаяКонсольКлиент.ВыполнитьКод(ЭтаФорма);
// 
// ПЕРЕОПРЕДЕЛЕНИЕ НАСТРОЕК (в ПриСозданииНаСервере):
//    Параметры = Новый Структура("ПереопределитьНастройки", Новый Структура("КартаКода", Ложь));
//    конс_ПодключаемаяКонсольСервер.ИнициализироватьРедактор(ЭтотОбъект, УникальныйИдентификатор, Параметры);
//
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

#Область Инициализация

// Подключает редактор кода к форме.
// Вызывать в обработчике ПриОткрытии формы.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения - форма с полем HTML редактора
//   ИмяПоляHTML - Строка - имя элемента ПолеHTML на форме. 
//                          Если не указано - берется из реквизита конс_ИмяПоляHTML или "HTML"
//
// Пример:
//   конс_ПодключаемаяКонсольКлиент.ПодключитьРедактор(ЭтаФорма);
//
Процедура ПодключитьРедактор(Форма, ИмяПоляHTML = Неопределено) Экспорт
	
	НачатьИнициализациюРедактора(Форма, ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML));
	
КонецПроцедуры

// Обработчик события ДокументСформирован поля HTML.
// Вызывать из обработчика события ДокументСформирован.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   ИмяПоляHTML - Строка - если не указано, берется из формы
//
// Пример:
//   &НаКлиенте
//   Процедура HTMLДокументСформирован(Элемент)
//       конс_ПодключаемаяКонсольКлиент.ОбработчикДокументСформирован(ЭтаФорма);
//   КонецПроцедуры
//
Процедура ОбработчикДокументСформирован(Форма, ИмяПоляHTML = Неопределено) Экспорт
	
	ОбработчикOnReady(Форма, ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML));
	
КонецПроцедуры

// Обработчик события ПриНажатии поля HTML.
// Вызывать из обработчика события ПриНажатии (OnClick).
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   ДанныеСобытия - Структура
//   ИмяПоляHTML - Строка - если не указано, берется из формы
//
// Пример:
//   &НаКлиенте
//   Процедура HTMLПриНажатии(Элемент, ДанныеСобытия, СтандартнаяОбработка)
//       конс_ПодключаемаяКонсольКлиент.ОбработчикПриНажатии(ЭтаФорма, ДанныеСобытия);
//   КонецПроцедуры
//
Процедура ОбработчикПриНажатии(Форма, ДанныеСобытия, ИмяПоляHTML = Неопределено) Экспорт
	
	ОбработчикOnClick(Форма, ДанныеСобытия, ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML));
	
КонецПроцедуры

#КонецОбласти

#Область РаботаСТекстом

// Получает текст из редактора.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   ИмяПоляHTML - Строка
//
// Возвращаемое значение:
//   Строка - текст из редактора
//
Функция ПолучитьТекст(Форма, ИмяПоляHTML = Неопределено) Экспорт
	
	Возврат View(Форма, ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML)).getText();
	
КонецФункции

// Устанавливает текст в редактор.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   Текст - Строка - текст для установки
//   Позиция - Число - позиция курсора (0 - в начало, -1 - в конец)
//   ИмяПоляHTML - Строка
//   УчитыватьОтступПервойСтроки - Булево
//
Процедура УстановитьТекст(Форма, Текст, Позиция = 0, ИмяПоляHTML = Неопределено, УчитыватьОтступПервойСтроки = Ложь) Экспорт
	
	View(Форма, ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML)).setText(Текст, Позиция, УчитыватьОтступПервойСтроки);
	
КонецПроцедуры

// Очищает текст в редакторе.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   ИмяПоляHTML - Строка
//
Процедура ОчиститьТекст(Форма, ИмяПоляHTML = Неопределено) Экспорт
	
	View(Форма, ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML)).eraseText();
	
КонецПроцедуры

// Вставляет текст в текущую позицию курсора.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   Текст - Строка
//   ИмяПоляHTML - Строка
//
Процедура ВставитьТекст(Форма, Текст, ИмяПоляHTML = Неопределено) Экспорт
	
	View(Форма, ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML)).insertText(Текст);
	
КонецПроцедуры

// Получает выделенный текст.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   ИмяПоляHTML - Строка
//
// Возвращаемое значение:
//   Строка - выделенный текст
//
Функция ПолучитьВыделенныйТекст(Форма, ИмяПоляHTML = Неопределено) Экспорт
	
	Возврат View(Форма, ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML)).getSelectedText();
	
КонецФункции

#КонецОбласти

#Область ПользовательскиеОбъектыИМетоды

// Загружает пользовательские переменные и функции в редактор.
// Вызывать после готовности редактора (в обработчике ДокументСформирован).
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   ИмяПоляHTML - Строка
//
// Пример:
//   // В ПриСозданииНаСервере:
//   конс_ПодключаемаяКонсольСервер.ДобавитьПеременную(ЭтотОбъект, "_Товар", "Справочник.Номенклатура");
//   конс_ПодключаемаяКонсольСервер.ДобавитьПеременную(ЭтотОбъект, "_Клиент", СсылкаНаКонтрагента);
//   конс_ПодключаемаяКонсольСервер.ДобавитьФункциюВКонтекст(ЭтотОбъект, 
//       "ВычислитьСкидку", "Вычисляет скидку", "(Сумма: Число): Число");
//
//   // В HTMLДокументСформирован:
//   конс_ПодключаемаяКонсольКлиент.ЗагрузитьПользовательскийКонтекст(ЭтаФорма);
//
Процедура ЗагрузитьПользовательскийКонтекст(Форма, ИмяПоляHTML = Неопределено) Экспорт
	
	ИмяПоля = ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML);
	Параметры = Форма.конс_СтруктураПараметровРедактораКода;
	
	// Загружаем переменные
	Попытка
		JSONПеременных = Параметры.JSONПеременных;
		Если ЗначениеЗаполнено(JSONПеременных) Тогда
			JSONПеременных = "{""customObjects"":" + JSONПеременных + "}";
			View(Форма, ИмяПоля).updateMetadata(JSONПеременных);
		КонецЕсли;
	Исключение
		// Ошибка загрузки
	КонецПопытки;
	
	// Загружаем функции
	Попытка
		JSONФункций = Параметры.JSONФункций;
		Если ЗначениеЗаполнено(JSONФункций) Тогда
			JSONФункций = "{""customFunctions"":" + JSONФункций + "}";
			View(Форма, ИмяПоля).updateCustomFunctions(JSONФункций);
		КонецЕсли;
	Исключение
		// Ошибка загрузки
	КонецПопытки;
	
	// Загружаем сниппеты
	Попытка
		JSONСниппетов = Параметры.JSONСниппетов;
		Если ЗначениеЗаполнено(JSONСниппетов) Тогда
			JSONСниппетов = "{""snippets"":" + JSONСниппетов + "}";
			View(Форма, ИмяПоля).updateSnippets(JSONСниппетов);
		КонецЕсли;
	Исключение
		// Ошибка загрузки
	КонецПопытки;
	
КонецПроцедуры

// Загружает пользовательские объекты в редактор для автодополнения.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   JSONОбъектов - Строка - JSON строка из СериализоватьОбъекты()
//   ИмяПоляHTML - Строка
//
// Возвращаемое значение:
//   Булево - успешность загрузки
//
// Пример:
//   // На сервере:
//   Объекты = конс_ПодключаемаяКонсольСервер.НоваяКоллекцияОбъектов();
//   конс_ПодключаемаяКонсольСервер.ДобавитьОбъект(Объекты, "_Заказ");
//   конс_ПодключаемаяКонсольСервер.ДобавитьСвойство(Построитель, "Номер", "Номер заказа");
//   JSON = конс_ПодключаемаяКонсольСервер.СериализоватьОбъекты(Объекты);
//
//   // На клиенте:
//   конс_ПодключаемаяКонсольКлиент.ЗагрузитьПользовательскиеОбъекты(ЭтаФорма, JSON);
//
Функция ЗагрузитьПользовательскиеОбъекты(Форма, JSONОбъектов, ИмяПоляHTML = Неопределено) Экспорт
	
	Попытка
		Результат = View(Форма, ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML)).updateMetadata(JSONОбъектов);
		Возврат (ТипЗнч(Результат) = Тип("Булево") И Результат);
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

// Загружает пользовательские функции в редактор для автодополнения.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   JSONФункций - Строка - JSON строка из СериализоватьФункции()
//   ИмяПоляHTML - Строка
//
// Возвращаемое значение:
//   Булево - успешность загрузки
//
// Пример:
//   // На сервере:
//   Функции = конс_ПодключаемаяКонсольСервер.НоваяКоллекцияФункций();
//   Построитель = конс_ПодключаемаяКонсольСервер.ДобавитьФункцию(Функции, "ВычислитьСумму");
//   конс_ПодключаемаяКонсольСервер.ОписаниеФункции(Построитель, "Вычисляет сумму двух чисел");
//   конс_ПодключаемаяКонсольСервер.ВозвращаемоеЗначение(Построитель, "Число");
//   конс_ПодключаемаяКонсольСервер.ДобавитьСигнатуру(Построитель, "default", "(А: Число, Б: Число): Число");
//   конс_ПодключаемаяКонсольСервер.ОписаниеПараметра(Построитель, "А", "Первое слагаемое");
//   конс_ПодключаемаяКонсольСервер.ОписаниеПараметра(Построитель, "Б", "Второе слагаемое");
//   JSON = конс_ПодключаемаяКонсольСервер.СериализоватьФункции(Функции);
//
//   // На клиенте:
//   конс_ПодключаемаяКонсольКлиент.ЗагрузитьПользовательскиеФункции(ЭтаФорма, JSON);
//
Функция ЗагрузитьПользовательскиеФункции(Форма, JSONФункций, ИмяПоляHTML = Неопределено) Экспорт
	
	Попытка
		Результат = View(Форма, ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML)).updateCustomFunctions(JSONФункций);
		Возврат (ТипЗнч(Результат) = Тип("Булево") И Результат);
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

#КонецОбласти

#Область ВыполнениеКода

// Выполняет код из редактора.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   НаСервере - Булево - выполнять на сервере (Истина) или на клиенте (Ложь)
//   ИмяПоляHTML - Строка - имя элемента HTML
//   РежимПоказаПеременных - ПеречислениеСсылка.конс_РежимПоказаПеременных - режим отображения переменных
//
Процедура ВыполнитьКод(Форма, НаСервере = Истина, ИмяПоляHTML = Неопределено, РежимПоказаПеременных = Неопределено) Экспорт

	Если РежимПоказаПеременных = Неопределено Тогда
		РежимПоказаПеременных = ПредопределенноеЗначение("Перечисление.конс_РежимПоказаПеременных.НеОтображать");
	КонецЕсли;
	
	ИмяПоля = ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML);
	Код = ПолучитьТекстСКодомПросмотраПеременных(Форма, ИмяПоля, РежимПоказаПеременных);
	
	Если НаСервере Тогда
		Результат = конс_ПодключаемаяКонсольВызовСервера.ВыполнитьКодНаСервере(Код, РежимПоказаПеременных);
	Иначе
		Результат = ВыполнитьКодНаКлиенте(Код, РежимПоказаПеременных);
	КонецЕсли;
	
	ОбработатьРезультат(Форма, Результат, ИмяПоля);
	
КонецПроцедуры

// Подготавливает код для выполнения, добавляя сбор значений переменных.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   ФильтрПеременных - Массив, Неопределено - имена переменных для сбора.
//                      Если Неопределено - собираются все переменные из редактора.
//                      Если пустой массив - переменные не собираются.
//   ИмяПоляHTML - Строка
//
// Возвращаемое значение:
//   Строка - код с добавленным сбором переменных
//
// Пример:
//   // Собрать все переменные:
//   Код = конс_ПодключаемаяКонсольКлиент.ПодготовитьКодСПеременными(ЭтаФорма);
//   
//   // Собрать только указанные:
//   Код = конс_ПодключаемаяКонсольКлиент.ПодготовитьКодСПеременными(ЭтаФорма, Новый Массив({"а", "б", "Результат"}));
//   
//   // Без сбора переменных:
//   Код = конс_ПодключаемаяКонсольКлиент.ПодготовитьКодСПеременными(ЭтаФорма, Новый Массив);
//
Функция ПодготовитьКодСПеременными(Форма, ФильтрПеременных = Неопределено, ИмяПоляHTML = Неопределено) Экспорт
	
	ИмяПоля = ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML);
	Код = ПолучитьТекст(Форма, ИмяПоля);
	
	// Определяем какие переменные собирать
	Если ФильтрПеременных <> Неопределено Тогда
		Переменные = ФильтрПеременных;
	Иначе
		Переменные = ПолучитьИменаПеременных(Форма, ИмяПоля);
	КонецЕсли;
	
	Если Переменные = Неопределено Или Переменные.Количество() = 0 Тогда
		Возврат Код;
	КонецЕсли;
	
	ПС = Символы.ПС;
	
	Для Каждого Имя Из Переменные Цикл
		Код = Код + ПС + "Попытка ЗначенияПеременных.Вставить(""" + Имя + """,Вычислить(""" + Имя + """)); Исключение КонецПопытки;" + ПС;
	КонецЦикла;
	
	Возврат Код;
	
КонецФункции

// Обрабатывает результат выполнения кода.
// Показывает ошибку или значения переменных в зависимости от результата.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   Результат - Структура - результат от ВыполнитьКодНаСервере/ВыполнитьКодНаКлиенте
//   ИмяПоляHTML - Строка
//
// Пример:
//   Результат = конс_ПодключаемаяКонсольВызовСервера.ВыполнитьКодНаСервере(Код, 1);
//   конс_ПодключаемаяКонсольКлиент.ОбработатьРезультат(ЭтаФорма, Результат);
//
Процедура ОбработатьРезультат(Форма, Результат, ИмяПоляHTML = Неопределено) Экспорт
	
	ИмяПоля = ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML);
	
	// Очищаем предыдущие маркеры
	ОчиститьМаркерыОшибок(Форма, ИмяПоля);
	
	Если Результат.Успешно Тогда
		ОбработатьУспешноеВыполнениеПубличный(Форма, Результат, ИмяПоля);
	Иначе
		ОбработатьОшибкуВыполненияПубличный(Форма, Результат, ИмяПоля);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ВнешнееВыполнениеКода

// Получает список переменных из кода в редакторе.
// 
// Используйте этот метод для получения имён переменных, объявленных в коде,
// например, для отображения селектора переменных перед выполнением.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения - форма с редактором
//   ИмяПоляHTML - Строка - имя элемента HTML (необязательный, по умолчанию ищется автоматически)
//   ФильтрПеременных - Массив, Неопределено - массив имён переменных для фильтрации.
//                      Если не указано или пустой - возвращаются все переменные.
//                      Если указан - возвращаются только переменные с указанными именами.
//
// Возвращаемое значение:
//   Массив из Строка - имена переменных, найденных в коде
//
// Пример:
//   // Получить все переменные:
//   МассивПеременных = конс_ПодключаемаяКонсольКлиент.ПолучитьПеременныеИзКода(ЭтаФорма);
//
//   // Получить только определённые переменные:
//   Фильтр = Новый Массив;
//   Фильтр.Добавить("Результат");  
//   Фильтр.Добавить("Сумма");
//   МассивПеременных = конс_ПодключаемаяКонсольКлиент.ПолучитьПеременныеИзКода(ЭтаФорма, , Фильтр);
//
Функция ПолучитьПеременныеИзКода(Форма, ИмяПоляHTML = Неопределено, ФильтрПеременных = Неопределено) Экспорт
	
	ИмяПоля = ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML);
	
	Если ФильтрПеременных = Неопределено Тогда
		ФильтрПеременных = Новый Массив;
	КонецЕсли;
	
	// Преобразуем фильтр к верхнему регистру для сравнения без учёта регистра
	ВрегМассив = Новый Массив;
	Для Каждого ЭлементМассива Из ФильтрПеременных Цикл
		ВрегМассив.Добавить(Врег(ЭлементМассива));
	КонецЦикла;
	
	// Получаем имена переменных из редактора
	Переменные = View(Форма, ИмяПоля).getVarsNames();
	
	МассивИмен = Новый Массив;
	Если Переменные.length > 0 Тогда
		Для Индекс = 0 По Переменные.length - 1 Цикл
			ИмяПеременной = Переменные["" + Индекс + ""];
			// Если фильтр задан, проверяем вхождение
			Если ВрегМассив.Количество() > 0 И ВрегМассив.Найти(Врег(ИмяПеременной)) = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			МассивИмен.Добавить(ИмяПеременной);
		КонецЦикла;
	КонецЕсли;
	
	Возврат МассивИмен;
	
КонецФункции

// Получает код для внешнего выполнения с объявлением ЗначенияПеременных и сбором переменных.
// 
// Используйте этот метод, когда хотите выполнить код через свой собственный оператор Выполнить,
// а не через ВыполнитьКод. Код автоматически объявляет ЗначенияПеременных, собирает переменные
// и помещает их во временное хранилище.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   РежимПоказаПеременных - ПеречислениеСсылка.конс_РежимПоказаПеременных - режим отображения переменных
//   ИмяПоляHTML - Строка - имя элемента HTML (необязательный)
//   ФильтрПеременных - Массив, Неопределено - массив имён переменных для анализа.
//                      Если не указано или пустой - анализируются все переменные.
//                      Если указан - анализируются только переменные с указанными именами.
//
// Возвращаемое значение:
//   Структура - данные для выполнения:
//     * Код - Строка - полный код для выполнения (с инициализацией и сохранением переменных)
//     * ИсходныйКод - Строка - оригинальный код без модификаций
//     * АдресХраненияПеременных - Строка - адрес временного хранилища для получения переменных
//     * ИменаПеременных - Массив - имена переменных для сбора
//     * СмещениеСтрок - Число - количество служебных строк в начале кода (для коррекции номеров строк в ошибках)
//     * РежимПоказаПеременных - ПеречислениеСсылка.конс_РежимПоказаПеременных - режим показа
//
// Пример:
//   // Анализ всех переменных:
//   ДанныеКода = конс_ПодключаемаяКонсольКлиент.ПолучитьКодДляВнешнегоВыполнения(
//       ЭтаФорма, ПредопределенноеЗначение("Перечисление.конс_РежимПоказаПеременных.ВТабло"));
//
//   // Анализ только указанных переменных:
//   ФильтрПеременных = Новый Массив;
//   ФильтрПеременных.Добавить("Результат");
//   ФильтрПеременных.Добавить("Сумма");
//   ДанныеКода = конс_ПодключаемаяКонсольКлиент.ПолучитьКодДляВнешнегоВыполнения(
//       ЭтаФорма, ПредопределенноеЗначение("Перечисление.конс_РежимПоказаПеременных.ВТабло"), , ФильтрПеременных);
//   
//   ИнфоОшибки = Неопределено;
//   Попытка
//       Выполнить(ДанныеКода.Код);
//   Исключение
//       ИнфоОшибки = ИнформацияОбОшибке();
//   КонецПопытки;
//   
//   конс_ПодключаемаяКонсольКлиент.ОбработатьРезультатВнешнегоВыполнения(
//       ЭтаФорма, ДанныеКода, ИнфоОшибки);
//
Функция ПолучитьКодДляВнешнегоВыполнения(Форма, РежимПоказаПеременных, ИмяПоляHTML = Неопределено, ФильтрПеременных = Неопределено) Экспорт
	
	ИмяПоля = ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML);
	ИсходныйКод = ПолучитьТекст(Форма, ИмяПоля);
	
	// Создаём временное хранилище для результата на сервере
	АдресХраненияПеременных = конс_ПодключаемаяКонсольВызовСервера.СоздатьВременноеХранилищеПеременных(Форма.УникальныйИдентификатор);
	
	Результат = Новый Структура;
	Результат.Вставить("ИсходныйКод", ИсходныйКод);
	Результат.Вставить("АдресХраненияПеременных", АдресХраненияПеременных);
	Результат.Вставить("ИменаПеременных", Новый Массив);
	Результат.Вставить("Код", ИсходныйКод);
	Результат.Вставить("СмещениеСтрок", 0); // Количество служебных строк в начале кода
	Результат.Вставить("РежимПоказаПеременных", РежимПоказаПеременных);
	
	Если Не РежимПоказаПеременных = ПредопределенноеЗначение("Перечисление.конс_РежимПоказаПеременных.НеОтображать") Тогда
		
		// Получаем имена переменных из редактора с учётом фильтра
		МассивИмен = ПолучитьПеременныеИзКода(Форма, ИмяПоля, ФильтрПеременных);
		Результат.ИменаПеременных = МассивИмен;
		
		ПС = Символы.ПС;
		
		// Код инициализации - добавляется ПОСЛЕ пользовательского кода
		// чтобы номера строк в редакторе совпадали с номерами при выполнении
		КодИнициализации = ПС + "ЗначенияПеременных = Новый Структура;";
		КодИнициализации = КодИнициализации + ПС + "__конс_АдресХраненияПеременных__ = """ + АдресХраненияПеременных + """;";
		// СмещениеСтрок = 0, служебные строки теперь в конце!
		
		// Код сбора переменных
		КодСбора = "";
		Для Каждого Имя Из МассивИмен Цикл
			КодСбора = КодСбора + ПС + "Попытка ЗначенияПеременных.Вставить(""" + Имя + """, Вычислить(""" + Имя + """)); Исключение КонецПопытки;";
		КонецЦикла;
		
		// Код сохранения результата в хранилище
		КодСохранения = ПС + "ПоместитьВоВременноеХранилище(ЗначенияПеременных, __конс_АдресХраненияПеременных__);";
		
		// Собираем полный код: сначала пользовательский, потом служебный
		Результат.Код = ИсходныйКод + КодИнициализации + КодСбора + КодСохранения;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Обрабатывает результат внешнего выполнения кода.
// 
// Вызывайте этот метод после выполнения кода, полученного через ПолучитьКодДляВнешнегоВыполнения.
// Метод получит переменные из хранилища и отобразит их в табло/подсказках или покажет ошибку.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   ДанныеКода - Структура - структура, полученная от ПолучитьКодДляВнешнегоВыполнения
//   ИнформацияОбОшибке - ИнформацияОбОшибке, Неопределено - ошибка выполнения
//   ИмяПоляHTML - Строка
//
// Пример:
//   ДанныеКода = конс_ПодключаемаяКонсольКлиент.ПолучитьКодДляВнешнегоВыполнения(ЭтаФорма);
//   ИнфоОшибки = Неопределено;
//   
//   Попытка
//       Выполнить(ДанныеКода.Код);
//   Исключение
//       ИнфоОшибки = ИнформацияОбОшибке();
//   КонецПопытки;
//   
//   конс_ПодключаемаяКонсольКлиент.ОбработатьРезультатВнешнегоВыполнения(
//       ЭтаФорма, ДанныеКода, ИнфоОшибки);
//
Процедура ОбработатьРезультатВнешнегоВыполнения(Форма, ДанныеКода, ИнформацияОбОшибке, ИмяПоляHTML = Неопределено) Экспорт
	
	// Разбираем информацию об ошибке для передачи на сервер
	РазобраннаяИнформацияОбОшибке = РазобратьИнформациюОбОшибкеКлиент(ИнформацияОбОшибке);
	
	// Получаем переменные из хранилища и формируем результат на сервере
	Результат = конс_ПодключаемаяКонсольВызовСервера.ОбработатьРезультатВнешнегоВыполнения(
		ДанныеКода.АдресХраненияПеременных,
		РазобраннаяИнформацияОбОшибке,
		ДанныеКода.РежимПоказаПеременных);
	
	// Используем стандартный обработчик
	ОбработатьРезультат(Форма, Результат, ИмяПоляHTML);
	
КонецПроцедуры

// Разбирает информацию об ошибке в структуру для передачи на сервер.
// Парсит ПодробноеПредставлениеОшибки с конца к началу, чтобы найти строку выполняемого кода.
// 
// Параметры:
//   ИнфоОшибки - ИнформацияОбОшибке
//
// Возвращаемое значение:
//   Структура, Неопределено - разобранная информация или Неопределено
//
Функция РазобратьИнформациюОбОшибкеКлиент(ИнфоОшибки) Экспорт
	
	Если ИнфоОшибки = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// Получаем полный стек ошибки
	ПолныйТекст = ПодробноеПредставлениеОшибки(ИнфоОшибки);
	
	// Парсим стек ошибки с конца к началу
	Возврат РазобратьСтекОшибки(ПолныйТекст, ИнфоОшибки.Описание);
	
КонецФункции

// Разбирает стек ошибки из ПодробноеПредставлениеОшибки.
// Делегирует в общий клиент-серверный модуль.
// 
// Параметры:
//   ПолныйТекст - Строка - результат ПодробноеПредставлениеОшибки
//   ОписаниеОшибки - Строка - текст ошибки (первопричина)
//
// Возвращаемое значение:
//   Структура - разобранная информация об ошибке
//
Функция РазобратьСтекОшибки(ПолныйТекст, ОписаниеОшибки)
	
	Возврат конс_ПодключаемаяКонсольКлиентСервер.РазобратьСтекОшибки(ПолныйТекст, ОписаниеОшибки);
	
КонецФункции

// Примечание: Функции ИзвлечьОписаниеОтНачалаДоИндекса и ИзвлечьОписаниеОшибкиИзСтрок
// перенесены в конс_ПодключаемаяКонсольКлиентСервер

#КонецОбласти

#Область НастройкиРедактора

// Применяет настройки к редактору.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   Настройки - Структура - настройки из хранилища
//   ИмяПоляHTML - Строка
//
Процедура ПрименитьНастройки(Форма, Настройки, ИмяПоляHTML = Неопределено) Экспорт
	
	ИмяПоляHTML = ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML);
	
	// Тема
	Если Настройки.Свойство("Тема") И ЗначениеЗаполнено(Настройки.Тема) Тогда
		ИмяТемы = СоответствиеТем().Получить(Настройки.Тема);
		Если ИмяТемы <> Неопределено Тогда
			View(Форма, ИмяПоляHTML).setTheme(ИмяТемы);
		КонецЕсли;
	КонецЕсли;
	
	// Быстрые подсказки
	Если Настройки.Свойство("БыстрыеПодсказки") Тогда
		View(Форма, ИмяПоляHTML).enableQuickSuggestions(Настройки.БыстрыеПодсказки);
	КонецЕсли;
	
	// Карта кода
	Если Настройки.Свойство("КартаКода") Тогда
		View(Форма, ИмяПоляHTML).minimap(Настройки.КартаКода);
	КонецЕсли;
	
	// Пробелы и табуляции
	Если Настройки.Свойство("ПробелыИТабуляции") Тогда
		View(Форма, ИмяПоляHTML).renderWhitespace(Настройки.ПробелыИТабуляции);
	КонецЕсли;
	
	// Строка состояния
	Если Настройки.Свойство("СтрокаСостояния") Тогда
		Если Настройки.СтрокаСостояния Тогда
			View(Форма, ИмяПоляHTML).showStatusBar();
		Иначе
			View(Форма, ИмяПоляHTML).hideStatusBar();
		КонецЕсли;
	КонецЕсли;
	
	// Язык подсказок
	Если Настройки.Свойство("ЯзыкПодсказок") И Настройки.ЯзыкПодсказок = "en" Тогда
		View(Форма, ИмяПоляHTML).switchLang();
	КонецЕсли;
	
	// Загрузка сниппетов из файла шаблонов (.st)
	Если Настройки.Свойство("ПутьКШаблонамКода") И ЗначениеЗаполнено(Настройки.ПутьКШаблонамКода) Тогда
		ЗагрузитьСниппетыИзФайла(Форма, Настройки.ПутьКШаблонамКода, ИмяПоляHTML);
	КонецЕсли;
	
КонецПроцедуры

// Загружает сниппеты из файла шаблонов 1С (.st).
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   ПутьКФайлу - Строка - полный путь к файлу .st
//   ИмяПоляHTML - Строка
//
// Пример:
//   конс_ПодключаемаяКонсольКлиент.ЗагрузитьСниппетыИзФайла(ЭтаФорма, "C:\Шаблоны\МоиШаблоны.st");
//
Процедура ЗагрузитьСниппетыИзФайла(Форма, ПутьКФайлу, ИмяПоляHTML = Неопределено) Экспорт
	
	ИмяПоляHTML = ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML);
	
	Попытка
		ФайлШаблона = Новый Файл(ПутьКФайлу);
		Если Не ФайлШаблона.Существует() Тогда
			Возврат;
		КонецЕсли;
		
		Чтение = Новый ЧтениеТекста(ПутьКФайлу, КодировкаТекста.UTF8);
		СодержимоеФайла = "";
		Строка = Чтение.ПрочитатьСтроку();
		
		Пока Строка <> Неопределено Цикл
			СодержимоеФайла = СодержимоеФайла + Строка + Символы.ПС;
			Строка = Чтение.ПрочитатьСтроку();
		КонецЦикла;
		
		Чтение.Закрыть();
		
		// parseSnippets преобразует формат .st в сниппеты редактора
		View(Форма, ИмяПоляHTML).parseSnippets(СодержимоеФайла);
	Исключение
		// Файл недоступен или ошибка чтения - игнорируем
	КонецПопытки;
	
КонецПроцедуры

// Загружает сниппеты из JSON строки.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   JSONСниппетов - Строка - JSON в формате {"snippets": {...}}
//   ИмяПоляHTML - Строка
//
// Возвращаемое значение:
//   Булево - успешность загрузки
//
// Пример JSON:
//   {
//     "snippets": {
//       "МойШаблон": {
//         "prefix": "МойШаблон",
//         "body": "Сообщить(\"${0:текст}\");",
//         "description": "Вывод сообщения"
//       }
//     }
//   }
//
Функция ЗагрузитьСниппетыИзJSON(Форма, JSONСниппетов, ИмяПоляHTML = Неопределено) Экспорт
	
	Попытка
		Результат = View(Форма, ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML)).updateSnippets(JSONСниппетов);
		Возврат (ТипЗнч(Результат) = Тип("Булево") И Результат);
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

// Устанавливает тему редактора.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   ИмяТемы - Строка - "СветлаяТема", "ТёмнаяТема", и т.д.
//   ИмяПоляHTML - Строка
//
Процедура УстановитьТему(Форма, ИмяТемы, ИмяПоляHTML = Неопределено) Экспорт
	
	ТемаРедактора = СоответствиеТем().Получить(ИмяТемы);
	Если ТемаРедактора <> Неопределено Тогда
		View(Форма, ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML)).setTheme(ТемаРедактора);
	КонецЕсли;
	
КонецПроцедуры

// Включает/выключает режим "Только чтение".
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   ТолькоЧтение - Булево
//   ИмяПоляHTML - Строка
//
Процедура УстановитьРежимТолькоЧтение(Форма, ТолькоЧтение, ИмяПоляHTML = Неопределено) Экспорт
	
	View(Форма, ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML)).setReadOnly(ТолькоЧтение);
	
КонецПроцедуры

// Устанавливает режим языка редактора.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   РежимЯзыка - Строка - "bsl", "bsl_query", "dcs_query", "xml", "json", "yaml"
//   ИмяПоляHTML - Строка
//
// Пример:
//   конс_ПодключаемаяКонсольКлиент.УстановитьРежимЯзыка(ЭтаФорма, "json");
//
Процедура УстановитьРежимЯзыка(Форма, РежимЯзыка, ИмяПоляHTML = Неопределено) Экспорт
	
	View(Форма, ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML)).setLanguageMode(РежимЯзыка);
	
КонецПроцедуры

// Открывает форму настроек редактора.
//
Процедура ОткрытьНастройкиРедактора() Экспорт
	
	ОткрытьФорму("ОбщаяФорма.конс_НастройкиПодключаемойКонсолиКода");
	
КонецПроцедуры

#КонецОбласти

#Область ВыводВТабло

// Показывает результат выполнения в табло редактора.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   JSONОписаниеПеременных - Строка - JSON с описанием переменных
//   ИмяПоляHTML - Строка
//
Процедура ПоказатьПеременныеВТабло(Форма, JSONОписаниеПеременных, ИмяПоляHTML = "HTML") Экспорт
	
	View(Форма, ИмяПоляHTML).showVariablesDescription(JSONОписаниеПеременных);
	
КонецПроцедуры

// Показывает переменные во всплывающих подсказках.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   JSONОписаниеПеременных - Строка - JSON с описанием переменных
//   ИмяПоляHTML - Строка
//
Процедура ПоказатьПеременныеВПодсказках(Форма, JSONОписаниеПеременных, ИмяПоляHTML = "HTML") Экспорт
	
	View(Форма, ИмяПоляHTML).setCustomHovers(JSONОписаниеПеременных);
	
	Если JSONОписаниеПеременных <> "{}" Тогда
		ПоказатьСообщениеВРедакторе(Форма, "Выполнено. Наведите курсор на переменную для просмотра значения", ИмяПоляHTML);
	КонецЕсли;
	
КонецПроцедуры

// Показывает сообщение в редакторе (через CodeLens).
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   Текст - Строка - текст сообщения
//   ИмяПоляHTML - Строка
//
Процедура ПоказатьСообщениеВРедакторе(Форма, Текст, ИмяПоляHTML = "HTML") Экспорт
	
	View(Форма, ИмяПоляHTML).setCustomCodeLenses("[{""lineNumber"": 1,""column"": 1,""text"": """ + Текст + """}]");
	
КонецПроцедуры

// Помечает строку с ошибкой в редакторе.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   НомерСтроки - Число
//   НомерКолонки - Число
//   ИмяПоляHTML - Строка
//
Процедура ПометитьОшибку(Форма, НомерСтроки, НомерКолонки = 1, ИмяПоляHTML = "HTML") Экспорт
	
	View(Форма, ИмяПоляHTML).markError(НомерСтроки, НомерКолонки);
	
КонецПроцедуры

// Получает имена переменных из кода в редакторе.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   ИмяПоляHTML - Строка
//
// Возвращаемое значение:
//   Массив - массив имен переменных
//
Функция ПолучитьИменаПеременных(Форма, ИмяПоляHTML = "HTML") Экспорт
	
	Результат = Новый Массив;
	
	Попытка
		Переменные = View(Форма, ИмяПоляHTML).getVarsNames();
		
		Если Переменные <> Неопределено И Переменные.length > 0 Тогда
			Для Индекс = 0 По Переменные.length - 1 Цикл
				Результат.Добавить(Переменные["" + Индекс + ""]);
			КонецЦикла;
		КонецЕсли;
	Исключение
		// Игнорируем ошибку
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Показывает ошибку в редакторе.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   ТекстОшибки - Строка
//   НомерСтроки - Число - номер строки с ошибкой (0 - не выделять)
//   НомерКолонки - Число
//   ИмяПоляHTML - Строка
//
Процедура ПоказатьОшибку(Форма, ТекстОшибки, НомерСтроки = 0, НомерКолонки = 1, ИмяПоляHTML = "HTML") Экспорт
	
	Сообщение = Новый СообщениеПользователю;
	Сообщение.Текст = ТекстОшибки;
	Сообщение.Сообщить();
	
	Если НомерСтроки > 0 Тогда
		View(Форма, ИмяПоляHTML).markError(НомерСтроки, НомерКолонки);
	КонецЕсли;
	
КонецПроцедуры

// Очищает маркеры ошибок.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   ИмяПоляHTML - Строка
//
Процедура ОчиститьМаркерыОшибок(Форма, ИмяПоляHTML = "HTML") Экспорт
	
	View(Форма, ИмяПоляHTML).setCustomCodeLenses("[]");
	
КонецПроцедуры

#КонецОбласти

#Область РаботаСОшибками

// Создает структуру описания ошибки выполнения из ИнформацияОбОшибке.
// 
// Параметры:
//   ИнфоОшибки - ИнформацияОбОшибке - объект ошибки из блока Исключение
//
// Возвращаемое значение:
//   Структура - Описание ошибки:
//     * Описание - Строка - текст ошибки
//     * НомерСтроки - Число - номер строки (0 если неизвестно)
//     * НомерКолонки - Число - номер колонки (1 по умолчанию)
//     * ИмяМодуля - Строка - имя модуля где произошла ошибка
//     * ИсходнаяСтрока - Строка - исходный код строки с ошибкой
//     * Причина - Структура, Неопределено - вложенная ошибка (причина)
//
// Пример:
//   Попытка
//       Выполнить(Код);
//   Исключение
//       ОписаниеОшибки = конс_ПодключаемаяКонсольКлиент.РазобратьИнформациюОбОшибке(ИнформацияОбОшибке());
//       конс_ПодключаемаяКонсольКлиент.ПоказатьОшибкуВыполнения(ЭтаФорма, ОписаниеОшибки);
//   КонецПопытки;
//
Функция РазобратьИнформациюОбОшибке(ИнфоОшибки) Экспорт
	
	// Используем общую логику с РазобратьИнформациюОбОшибкеКлиент
	Возврат РазобратьИнформациюОбОшибкеКлиент(ИнфоОшибки);
	
КонецФункции

// Создает пустую структуру описания ошибки.
// Делегирует в общий клиент-серверный модуль.
// 
// Возвращаемое значение:
//   Структура - Пустое описание ошибки
//
Функция НовоеОписаниеОшибки() Экспорт
	
	Возврат конс_ПодключаемаяКонсольКлиентСервер.НовоеОписаниеОшибки();
	
КонецФункции

// Показывает ошибку выполнения в редакторе.
// Принимает структуру описания ошибки от РазобратьИнформациюОбОшибке().
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   ОписаниеОшибки - Структура - описание ошибки (см. РазобратьИнформациюОбОшибке)
//   ПоказыватьПричину - Булево - показывать ли первопричину вместо верхнего уровня
//   ИмяПоляHTML - Строка
//
// Пример:
//   Попытка
//       Выполнить(Код);
//   Исключение
//       ОписаниеОшибки = конс_ПодключаемаяКонсольКлиент.РазобратьИнформациюОбОшибке(ИнформацияОбОшибке());
//       конс_ПодключаемаяКонсольКлиент.ПоказатьОшибкуВыполнения(ЭтаФорма, ОписаниеОшибки, Истина);
//   КонецПопытки;
//
Процедура ПоказатьОшибкуВыполнения(Форма, ОписаниеОшибки, ПоказыватьПричину = Истина, ИмяПоляHTML = Неопределено) Экспорт
	
	ИмяПоля = ПолучитьИмяПоляHTML(Форма, ИмяПоляHTML);
	
	// Очищаем предыдущие маркеры
	ОчиститьМаркерыОшибок(Форма, ИмяПоля);
	
	// Формируем полное описание ошибки со стеком
	ТекстОшибки = СформироватьТекстОшибкиСоСтеком(ОписаниеОшибки);
	
	// Показываем сообщение
	Сообщение = Новый СообщениеПользователю;
	Сообщение.Текст = ТекстОшибки;
	Сообщение.Сообщить();
	
	// Помечаем строку в редакторе - используем НомерСтроки из структуры
	// (он уже указывает на строку выполняемого кода, если ЭтоВыполняемыйКод = Истина)
	НомерСтроки = ОписаниеОшибки.НомерСтроки;
	НомерКолонки = ОписаниеОшибки.НомерКолонки;
	
	Если НомерСтроки > 0 Тогда
		View(Форма, ИмяПоля).markError(НомерСтроки, НомерКолонки);
	КонецЕсли;
	
КонецПроцедуры

// Формирует текст ошибки со стеком вызовов.
// 
// Параметры:
//   ОписаниеОшибки - Структура - описание ошибки
//
// Возвращаемое значение:
//   Строка - текст ошибки со стеком
//
Функция СформироватьТекстОшибкиСоСтеком(ОписаниеОшибки) Экспорт
	
	// Извлекаем чистый текст ошибки (без позиции)
	ТекстОшибки = ИзвлечьЧистыйТекстОшибки(ОписаниеОшибки.Описание);
	
	// Стек вызовов уже собран при парсинге
	Если ОписаниеОшибки.Свойство("СтекВызовов") И ОписаниеОшибки.СтекВызовов.Количество() > 0 Тогда
		ТекстОшибки = ТекстОшибки + Символы.ПС + Символы.ПС + "Стек вызовов:";
		Для Каждого ЭлементСтека Из ОписаниеОшибки.СтекВызовов Цикл
			ТекстОшибки = ТекстОшибки + Символы.ПС + "  " + ЭлементСтека;
		КонецЦикла;
	КонецЕсли;
	
	Возврат ТекстОшибки;
	
КонецФункции

// Извлекает чистый текст ошибки без позиции {Модуль(строка,колонка)}:
//
Функция ИзвлечьЧистыйТекстОшибки(ОписаниеОшибки)
	
	Текст = ОписаниеОшибки;
	
	// Убираем префикс вида {Модуль(строка,колонка)}:
	ПозицияДвоеточия = СтрНайти(Текст, "}:");
	Если ПозицияДвоеточия > 0 И Лев(Текст, 1) = "{" Тогда
		Текст = СокрЛ(Сред(Текст, ПозицияДвоеточия + 2));
	КонецЕсли;
	
	Возврат Текст;
	
КонецФункции

// Получает корневую (первоначальную) причину ошибки.
// 
// Параметры:
//   ОписаниеОшибки - Структура - описание ошибки
//
// Возвращаемое значение:
//   Структура - Корневая причина ошибки
//
Функция ПолучитьКорневуюПричину(ОписаниеОшибки) Экспорт
	
	Если ОписаниеОшибки = Неопределено Или ОписаниеОшибки.Причина = Неопределено Тогда
		Возврат ОписаниеОшибки;
	КонецЕсли;
	
	Возврат ПолучитьКорневуюПричину(ОписаниеОшибки.Причина);
	
КонецФункции

#КонецОбласти

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область ОбратнаяСовместимость

// Устаревшая. Использовать ПодключитьРедактор.
Процедура НачатьИнициализациюРедактора(Форма, ИмяПоляHTML = "HTML", ОписаниеОповещенияОЗавершении = Неопределено) Экспорт
	
	КонтекстИнициализации = Новый Структура;
	КонтекстИнициализации.Вставить("Форма", Форма);
	КонтекстИнициализации.Вставить("ИмяПоляHTML", ИмяПоляHTML);
	КонтекстИнициализации.Вставить("ОписаниеОповещенияОЗавершении", ОписаниеОповещенияОЗавершении);
	
	Оповещение = Новый ОписаниеОповещения("ПослеПодключенияРасширенияФайлов", ЭтотОбъект, КонтекстИнициализации);
	НачатьПодключениеРасширенияРаботыСФайлами(Оповещение);
	
КонецПроцедуры

// Устаревшая. Использовать ОбработчикДокументСформирован.
Процедура ОбработчикOnReady(Форма, ИмяПоляHTML = "HTML") Экспорт
	
	Если Форма.конс_СтруктураПараметровРедактораКода.ИсходникиЗагружены Тогда
		#Если ВебКлиент Тогда
			Если ВебДокументДоступен(Форма, ИмяПоляHTML) Тогда
				ИнициализироватьРедакторКлиент(Форма, ИмяПоляHTML);
			КонецЕсли;
		#Иначе
			ИнициализироватьРедакторКлиент(Форма, ИмяПоляHTML);
		#КонецЕсли
	КонецЕсли;
	
КонецПроцедуры

// Устаревшая. Использовать ОбработчикПриНажатии.
Процедура ОбработчикOnClick(Форма, ДанныеСобытия, ИмяПоляHTML = "HTML") Экспорт
	
	Если ДанныеСобытия <> Неопределено И ДанныеСобытия.Event <> Неопределено Тогда
		Событие = ДанныеСобытия.Event.eventData1C;
		Если Событие <> Неопределено Тогда
			ОбработатьСобытиеРедактора(Форма, Событие, ИмяПоляHTML);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиОповещений

Процедура ПослеПодключенияРасширенияФайлов(Подключено, КонтекстИнициализации) Экспорт
	
	Если Подключено Тогда
		НачатьИзвлечениеИсходников(КонтекстИнициализации);
	Иначе
		#Если ВебКлиент Тогда
			// Для веб-клиента попробуем использовать внешний URL
			ИспользоватьВнешнийURL(КонтекстИнициализации);
		#Иначе
			ПоказатьПредупреждение(, "Не удалось подключить расширение работы с файлами");
		#КонецЕсли
	КонецЕсли;
	
КонецПроцедуры

Процедура ПослеПолученияКаталогаВременныхФайлов(ИмяКаталога, КонтекстИнициализации) Экспорт
	
	КонтекстИнициализации.Вставить("КаталогИсходников", ИмяКаталога + "bsl_console\");
	Оповещение = Новый ОписаниеОповещения("ПослеСозданияКаталога", ЭтотОбъект, КонтекстИнициализации);
	НачатьСозданиеКаталога(Оповещение, КонтекстИнициализации.КаталогИсходников);
	
КонецПроцедуры

Процедура ПослеСозданияКаталога(ИмяКаталога, КонтекстИнициализации) Экспорт
	
	Оповещение = Новый ОписаниеОповещения("ПослеПроверкиСуществованияКаталога", ЭтотОбъект, КонтекстИнициализации);
	ФайлНаДиске = Новый Файл(КонтекстИнициализации.КаталогИсходников);
	ФайлНаДиске.НачатьПроверкуСуществования(Оповещение);
	
КонецПроцедуры

Процедура ПослеПроверкиСуществованияКаталога(Существует, КонтекстИнициализации) Экспорт
	
	Если Существует Тогда
		Оповещение = Новый ОписаниеОповещения("ПослеПроверкиСуществованияФайлаВерсии", ЭтотОбъект, КонтекстИнициализации);
		ВерсияОбработки = КонтекстИнициализации.Форма.конс_СтруктураПараметровРедактораКода.ВерсияОбработки;
		ФайлНаДиске = Новый Файл(КонтекстИнициализации.КаталогИсходников + ВерсияОбработки + ".ver");
		ФайлНаДиске.НачатьПроверкуСуществования(Оповещение);
	Иначе
		ПоказатьПредупреждение(, "Не удалось создать каталог для исходников");
	КонецЕсли;
	
КонецПроцедуры

Процедура ПослеПроверкиСуществованияФайлаВерсии(Существует, КонтекстИнициализации) Экспорт
	
	Если Существует Тогда
		Оповещение = Новый ОписаниеОповещения("ПослеПроверкиСуществованияИндексногоФайла", ЭтотОбъект, КонтекстИнициализации);
		ФайлНаДиске = Новый Файл(КонтекстИнициализации.КаталогИсходников + "index.html");
		ФайлНаДиске.НачатьПроверкуСуществования(Оповещение);
	Иначе
		ИзвлечьИсходникиНаКлиенте(КонтекстИнициализации);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПослеПроверкиСуществованияИндексногоФайла(Существует, КонтекстИнициализации) Экспорт
	
	Если Существует Тогда
		ИндексныйФайл = ИндексныйФайл(КонтекстИнициализации);
		Оповещение = Новый ОписаниеОповещения("ПослеКопированияИндексногоФайла", ЭтотОбъект, КонтекстИнициализации);
		НачатьКопированиеФайла(Оповещение, КонтекстИнициализации.КаталогИсходников + "index.html", ИндексныйФайл);
	Иначе
		ИзвлечьИсходникиНаКлиенте(КонтекстИнициализации);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПослеКопированияИндексногоФайла(СкопированныйФайл, КонтекстИнициализации) Экспорт
	
	Форма = КонтекстИнициализации.Форма;
	
	// Получаем путь к данным (имя реквизита) из элемента формы
	КонтекстПоля = ПолучитьКонтекстПоля(Форма, КонтекстИнициализации.ИмяПоляHTML);
	Если ЗначениеЗаполнено(КонтекстПоля.ПутьКДанным) Тогда
		Форма[КонтекстПоля.ПутьКДанным] = СкопированныйФайл;
	КонецЕсли;
	Форма.конс_СтруктураПараметровРедактораКода.ИсходникиЗагружены = Истина;
	
КонецПроцедуры

Процедура ПослеЗаписиФайлаМакета(КонтекстИнициализации) Экспорт
	
	Попытка
		Файл = Новый ЧтениеZipФайла(КонтекстИнициализации.КаталогИсходников + "bsl_console.zip");
		Файл.ИзвлечьВсе(КонтекстИнициализации.КаталогИсходников);
		
		ВерсияОбработки = КонтекстИнициализации.Форма.конс_СтруктураПараметровРедактораКода.ВерсияОбработки;
		ФайлВерсии = Новый ЗаписьТекста(КонтекстИнициализации.КаталогИсходников + ВерсияОбработки + ".ver");
		ФайлВерсии.ЗаписатьСтроку(XMLСтрока(конс_ПодключаемаяКонсольВызовСервера.ПолучитьТекущуюДатуСеанса()));
		ФайлВерсии.Закрыть();
		
		ИндексныйФайл = ИндексныйФайл(КонтекстИнициализации);
		Оповещение = Новый ОписаниеОповещения("ПослеКопированияИндексногоФайла", ЭтотОбъект, КонтекстИнициализации);
		НачатьКопированиеФайла(Оповещение, КонтекстИнициализации.КаталогИсходников + "index.html", ИндексныйФайл);
	Исключение
		ПоказатьПредупреждение(, "Не удалось извлечь исходники: " + ОписаниеОшибки());
	КонецПопытки;
	
КонецПроцедуры

Процедура ПослеУдаленияВременныхФайлов(КонтекстИнициализации) Экспорт
	
	Оповещение = Новый ОписаниеОповещения("ПослеЗаписиФайлаМакета", ЭтотОбъект, КонтекстИнициализации);
	ИмяФайла = КонтекстИнициализации.КаталогИсходников + "bsl_console.zip";
	ДанныеМакета = ПолучитьИзВременногоХранилища(КонтекстИнициализации.Форма.конс_СтруктураПараметровРедактораКода.АдресМакета);
	ДанныеМакета.НачатьЗапись(Оповещение, ИмяФайла);
	
КонецПроцедуры

#КонецОбласти

#Область ВспомогательныеФункции

// Получает объект defaultView документа HTML-редактора.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения - форма с полем HTML
//   ЭлементИлиИмя - Строка, ЭлементФормы - элемент формы или его имя
//
// Возвращаемое значение:
//   Произвольный - объект defaultView документа
//
Функция View(Форма, ЭлементИлиИмя)
	
	Контекст = ПолучитьКонтекстПоля(Форма, ЭлементИлиИмя);
	
	Возврат Контекст.Элемент.Документ.defaultView;
	
КонецФункции

Функция ИндексныйФайл(КонтекстИнициализации)
	
	Возврат КонтекстИнициализации.КаталогИсходников + Формат(ТекущаяУниверсальнаяДатаВМиллисекундах(), "ЧГ=0") + ".html";
	
КонецФункции

Процедура НачатьИзвлечениеИсходников(КонтекстИнициализации)
	
	#Если ВебКлиент Тогда
		ИспользоватьВнешнийURL(КонтекстИнициализации);
	#Иначе
		Оповещение = Новый ОписаниеОповещения("ПослеПолученияКаталогаВременныхФайлов", ЭтотОбъект, КонтекстИнициализации);
		НачатьПолучениеКаталогаВременныхФайлов(Оповещение);
	#КонецЕсли
	
КонецПроцедуры

Процедура ИспользоватьВнешнийURL(КонтекстИнициализации)
	
	Форма = КонтекстИнициализации.Форма;
	
	// Получаем путь к данным (имя реквизита) из элемента формы
	КонтекстПоля = ПолучитьКонтекстПоля(Форма, КонтекстИнициализации.ИмяПоляHTML);
	Если ЗначениеЗаполнено(КонтекстПоля.ПутьКДанным) Тогда
		Форма[КонтекстПоля.ПутьКДанным] = "https://salexdv.github.io/bsl_console/src/index.html";
	КонецЕсли;
	Форма.конс_СтруктураПараметровРедактораКода.ИсходникиЗагружены = Истина;
	
КонецПроцедуры

Процедура ИзвлечьИсходникиНаКлиенте(КонтекстИнициализации)
	
	Оповещение = Новый ОписаниеОповещения("ПослеУдаленияВременныхФайлов", ЭтотОбъект, КонтекстИнициализации);
	НачатьУдалениеФайлов(Оповещение, КонтекстИнициализации.КаталогИсходников, "*.*");
	
КонецПроцедуры

Функция ВебДокументДоступен(Форма, ЭлементИлиИмя)
	
	Попытка
		Контекст = ПолучитьКонтекстПоля(Форма, ЭлементИлиИмя);
		Если Контекст.Элемент = Неопределено Тогда
			Возврат Ложь;
		КонецЕсли;
		Возврат Контекст.Элемент.Документ.defaultView <> Неопределено;
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

Процедура ИнициализироватьРедакторКлиент(Форма, ИмяПоляHTML)
	
	Инфо = Новый СистемнаяИнформация;
	
	View(Форма, ИмяПоляHTML).init(Инфо.ВерсияПриложения);
	View(Форма, ИмяПоляHTML).setLanguageMode("bsl");
	View(Форма, ИмяПоляHTML).setOption("autoResizeEditorLayout", Истина);
	View(Форма, ИмяПоляHTML).setOption("renderQueryDelimiters", Истина);
	View(Форма, ИмяПоляHTML).setOption("generateModificationEvent", Истина);
	View(Форма, ИмяПоляHTML).hideScrollX();
	View(Форма, ИмяПоляHTML).hideScrollY();
	
	// Применяем настройки пользователя (из формы, если есть, или загружаем с сервера)
	Настройки = Неопределено;
	Попытка
		АдресНастроек = Форма.конс_СтруктураПараметровРедактораКода.АдресНастроек;
		Если ЗначениеЗаполнено(АдресНастроек) Тогда
			Настройки = ПолучитьИзВременногоХранилища(АдресНастроек);
		КонецЕсли;
	Исключение
		// Ошибка получения настроек
	КонецПопытки;
	
	Если Настройки = Неопределено Тогда
		Настройки = конс_ПодключаемаяКонсольВызовСервера.ПолучитьНастройкиИзХранилища();
	КонецЕсли;
	
	ПрименитьНастройки(Форма, Настройки, ИмяПоляHTML);
	
	// Обновляем список общих модулей
	ОбновитьСписокОбщихМодулей(Форма, ИмяПоляHTML);
	
КонецПроцедуры

Процедура ОбновитьСписокОбщихМодулей(Форма, ИмяПоляHTML)
	
	Попытка
		View(Форма, ИмяПоляHTML).clearMetadata();
		
		АдресОбщихМодулей = Форма.конс_СтруктураПараметровРедактораКода.АдресОбщихМодулей;
		Если ЗначениеЗаполнено(АдресОбщихМодулей) Тогда
			// Получаем JSON строку из хранилища
			ОбщиеМодулиJSON = ПолучитьИзВременногоХранилища(АдресОбщихМодулей);
			// Передаём JSON строку напрямую - updateMetadata ожидает JSON
			View(Форма, ИмяПоляHTML).updateMetadata(ОбщиеМодулиJSON, "commonModules.items");
		КонецЕсли;
	Исключение
		// Игнорируем ошибку - метаданные не критичны
		Возврат;
	КонецПопытки;
	
КонецПроцедуры

Функция СоответствиеТем()
	
	Темы = Новый Соответствие;
	Темы.Вставить("СветлаяТема", "bsl-white");
	Темы.Вставить("ТемнаяТема", "bsl-dark");
	Темы.Вставить("ТемнаяТемаПлюс", "hc-dark");
	Темы.Вставить("СветлаяТемаПлюс", "hc-light");
	
	Возврат Темы;
	
КонецФункции

#КонецОбласти

#Область ОбработкаСобытийРедактора

Процедура ОбработатьСобытиеРедактора(Форма, Событие, ИмяПоляHTML)
	
	Если Событие = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ИмяСобытия = Событие.event;
	
	Если ИмяСобытия = "EVENT_CONTENT_CHANGED" Тогда
		Форма.Модифицированность = Истина;
	КонецЕсли;
	
	Если ИмяСобытия = "EVENT_ON_LINK_CLICK" Тогда
		Если СтрНайти(Событие.params.href, "e1cib") > 0 Тогда
			ПерейтиПоНавигационнойСсылке(Событие.params.href);
		КонецЕсли;
	КонецЕсли;
	
	Если ИмяСобытия = "EVENT_GET_VARIABLE_DATA" Тогда
		ОбработатьСобытиеРаскрытияПеременной(Форма, Событие.params, ИмяПоляHTML);
	КонецЕсли;
	
	Если ИмяСобытия = "EVENT_GET_METADATA" Тогда
		ОбработатьСобытиеПолученияМетаданных(Форма, Событие.params, ИмяПоляHTML);
	КонецЕсли;
	
	Если ИмяСобытия = "EVENT_QUERY_CONSTRUCT" Тогда
		ОбработатьСобытиеКонструктораЗапроса(Форма, Событие.params, ИмяПоляHTML);
	КонецЕсли;
	
	Если ИмяСобытия = "EVENT_FORMAT_CONSTRUCT" Тогда
		ОбработатьСобытиеКонструктораФорматнойСтроки(Форма, Событие.params, ИмяПоляHTML);
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбработатьСобытиеПолученияМетаданных(Форма, Параметры, ИмяПоляHTML)
	
	ПараметрыЗапроса = НРег(Параметры.metadata);
	Триггер = Параметры.trigger;
	ДанныеОбновлены = Ложь;
	
	// Проверяем, не запрос ли это модуля (общего или объекта/менеджера)
	Если СтрНачинаетсяС(ПараметрыЗапроса, "module.") Тогда
		// Попытка загрузки модуля из исходников
		ДанныеОбновлены = ЗагрузитьМодульИзИсходников(Форма, ПараметрыЗапроса, ИмяПоляHTML);
		
		// Если модуль загружен, завершаем обработку
		Если ДанныеОбновлены Тогда
			Если Триггер = "suggestion" Тогда
				View(Форма, ИмяПоляHTML).triggerSuggestions();
			КонецЕсли;
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	// Получаем данные метаданных с сервера
	РезультатЗапроса = конс_ПодключаемаяКонсольВызовСервера.ПолучитьДанныеМетаданныхПоЗапросу(ПараметрыЗапроса);
	
	Если РезультатЗапроса <> Неопределено И ЗначениеЗаполнено(РезультатЗапроса.Данные) Тогда
		
		Результат = View(Форма, ИмяПоляHTML).updateMetadata(
			РезультатЗапроса.Данные,
			РезультатЗапроса.АдресОбновления
		);
		
		ДанныеОбновлены = (ТипЗнч(Результат) = Тип("Булево") И Результат);
		
	КонецЕсли;
	
	// Вызываем автодополнение, если это был триггер suggestion
	Если Триггер = "suggestion" И ДанныеОбновлены Тогда
		View(Форма, ИмяПоляHTML).triggerSuggestions();
	КонецЕсли;
	
	// Обновляем сниппет, если это был триггер snippet
	Если Триггер = "snippet" Тогда
		Попытка
			View(Форма, ИмяПоляHTML).updateSnippetByGUID(Параметры.snippet_guid);
		Исключение
			// Метод может отсутствовать
		КонецПопытки;
	КонецЕсли;
	
КонецПроцедуры

// Загружает модуль из файлов исходного кода конфигурации.
// Поддерживает форматы:
//   - module.ИмяОбщегоМодуля (2 части) - общий модуль
//   - module.manager.КоллекцияМетаданных.ИмяОбъекта (4 части) - модуль менеджера
//   - module.object.КоллекцияМетаданных.ИмяОбъекта (4 части) - модуль объекта
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//   ПараметрыЗапроса - Строка - строка запроса модуля
//   ИмяПоляHTML - Строка
//
// Возвращаемое значение:
//   Булево - Истина, если модуль успешно загружен
//
Функция ЗагрузитьМодульИзИсходников(Форма, ПараметрыЗапроса, ИмяПоляHTML)
	
	// Получаем путь к исходникам из настроек
	КаталогИсходногоКода = ПолучитьПутьКИсходникамКонфигурации(Форма);
	
	Если Не ЗначениеЗаполнено(КаталогИсходногоКода) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// Разбираем запрос на части
	ЧастиЗапроса = СтрРазделить(ПараметрыЗапроса, ".");
	КоличествоЧастей = ЧастиЗапроса.Количество();
	
	Если КоличествоЧастей < 2 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// Определяем тип модуля по количеству частей и второму элементу
	Если КоличествоЧастей = 2 Тогда
		// Общий модуль: module.ИмяМодуля
		Возврат ЗагрузитьОбщийМодульИзИсходников(Форма, КаталогИсходногоКода, ЧастиЗапроса[1], ИмяПоляHTML);
		
	ИначеЕсли КоличествоЧастей = 4 Тогда
		// Модуль менеджера или объекта: module.manager|object.КоллекцияМетаданных.ИмяОбъекта
		ТипМодуля = НРег(ЧастиЗапроса[1]);
		
		Если ТипМодуля = "manager" Или ТипМодуля = "object" Тогда
			Возврат ЗагрузитьМодульМенеджераИлиОбъектаИзИсходников(
				Форма, КаталогИсходногоКода, ТипМодуля, ЧастиЗапроса[2], ЧастиЗапроса[3], ИмяПоляHTML);
		КонецЕсли;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

// Загружает общий модуль из исходников.
Функция ЗагрузитьОбщийМодульИзИсходников(Форма, КаталогИсходногоКода, ИмяМодуля, ИмяПоляHTML)
	
	// Получаем текст модуля с сервера (сервер читает файл)
	РезультатЗагрузки = конс_ПодключаемаяКонсольВызовСервера.ПрочитатьТекстОбщегоМодуля(КаталогИсходногоКода, ИмяМодуля);
	
	Если РезультатЗагрузки = Неопределено Тогда
		Возврат Ложь;
	КонецЕсли;

	// Парсим модуль редактором
	Попытка
		РезультатПарсинга = View(Форма, ИмяПоляHTML).parseCommonModule(РезультатЗагрузки.ИмяМодуля, РезультатЗагрузки.ТекстМодуля, РезультатЗагрузки.Глобальный);
		Возврат Истина;
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

// Загружает модуль менеджера или объекта из исходников.
Функция ЗагрузитьМодульМенеджераИлиОбъектаИзИсходников(Форма, КаталогИсходногоКода, ТипМодуля, КоллекцияМетаданных, ИмяОбъекта, ИмяПоляHTML)
	
	// Получаем текст модуля с сервера (сервер читает файл)
	РезультатЗагрузки = конс_ПодключаемаяКонсольВызовСервера.ПрочитатьТекстМодуляОбъекта(
		КаталогИсходногоКода, ТипМодуля, КоллекцияМетаданных, ИмяОбъекта);
	
	Если РезультатЗагрузки = Неопределено Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// Парсим модуль редактором
	Попытка
		РезультатПарсинга = View(Форма, ИмяПоляHTML).parseMetadataModule(РезультатЗагрузки.ТекстМодуля, РезультатЗагрузки.АдресЗагрузки);
		Возврат Истина;
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

// Получает путь к исходникам конфигурации из настроек.
// 
// Параметры:
//   Форма - ФормаКлиентскогоПриложения
//
// Возвращаемое значение:
//   Строка - путь к каталогу с исходниками или пустая строка
//
Функция ПолучитьПутьКИсходникамКонфигурации(Форма)
	
	Попытка
		АдресНастроек = Форма.конс_СтруктураПараметровРедактораКода.АдресНастроек;
		Если Не ЗначениеЗаполнено(АдресНастроек) Тогда
			Возврат "";
		КонецЕсли;
		
		Настройки = ПолучитьИзВременногоХранилища(АдресНастроек);
		Если Настройки = Неопределено Тогда
			Возврат "";
		КонецЕсли;
		
		ПутьКИсходникам = "";
		Если Настройки.Свойство("ПутьКИсходникамКонфигурации") Тогда
			ПутьКИсходникам = Настройки.ПутьКИсходникамКонфигурации;
		КонецЕсли;
		
		// Нормализуем путь
		Если ЗначениеЗаполнено(ПутьКИсходникам) Тогда
			РазделительПути = ПолучитьРазделительПути();
			ПутьКИсходникам = СокрЛП(ПутьКИсходникам);
			Если Прав(ПутьКИсходникам, 1) <> РазделительПути Тогда
				ПутьКИсходникам = ПутьКИсходникам + РазделительПути;
			КонецЕсли;
		КонецЕсли;
		
		Возврат ПутьКИсходникам;
		
	Исключение
		Возврат "";
	КонецПопытки;
	
КонецФункции

Процедура ОбработатьСобытиеРаскрытияПеременной(Форма, Параметры, ИмяПоляHTML)
	
	ИмяПеременной = Параметры.variableName;
	ИдентификаторПеременной = Параметры.variableId;
	ПутьКДанным = Параметры.variablePath;
	
	// Очищаем путь от undefined
	ПутьКДанным = СтрЗаменить(ПутьКДанным, "undefined", "");
	
	// Получаем адрес хранения переменных из структуры параметров
	АдресХраненияПеременных = "";
	Попытка
		АдресХраненияПеременных = Форма.конс_СтруктураПараметровРедактораКода.АдресХраненияПеременных;
	Исключение
		Возврат;
	КонецПопытки;
	
	Если Не ЗначениеЗаполнено(АдресХраненияПеременных) Тогда
		Возврат;
	КонецЕсли;
	
	// Раскрываем переменную на сервере
	Описание = конс_ПодключаемаяКонсольВызовСервера.РаскрытьПеременнуюВТабло(
		АдресХраненияПеременных,
		ИдентификаторПеременной,
		ИмяПеременной,
		ПутьКДанным
	);
	
	Если ЗначениеЗаполнено(Описание) И Описание <> "{}" Тогда
		View(Форма, ИмяПоляHTML).updateVariableDescription(ИдентификаторПеременной, Описание);
	КонецЕсли;
	
КонецПроцедуры

#Область КонструкторЗапроса

Процедура ОбработатьСобытиеКонструктораЗапроса(Форма, ПараметрыЗапроса, ИмяПоляHTML)
	
	КонтекстВызова = Новый Структура("Форма, ИмяПоляHTML", Форма, ИмяПоляHTML);
	
	Если ПараметрыЗапроса = Неопределено Тогда
		Оповещение = Новый ОписаниеОповещения("ВопросСоздатьНовыйЗапросЗавершение", ЭтотОбъект, КонтекстВызова);
		ТекстВопроса = "Не найден текст запроса." + Символы.ПС + "Создать новый запрос?";
		ПоказатьВопрос(Оповещение, ТекстВопроса, РежимДиалогаВопрос.ДаНет);
	Иначе
		КонтекстВызова.Вставить("Range", ПараметрыЗапроса.range);
		ТекстЗапроса = ПодготовитьТекстЗапроса(ПараметрыЗапроса.text);
		ОткрытьКонструкторЗапросаВнутренний(ТекстЗапроса, КонтекстВызова);
	КонецЕсли;
	
КонецПроцедуры

Процедура ВопросСоздатьНовыйЗапросЗавершение(Ответ, КонтекстВызова) Экспорт
	
	Если Ответ = КодВозвратаДиалога.Да Тогда
		ОткрытьКонструкторЗапросаВнутренний("", КонтекстВызова);
	КонецЕсли;
	
КонецПроцедуры

Функция ПодготовитьТекстЗапроса(Текст)
	
	ТекстЗапроса = СтрЗаменить(Текст, "|", "");
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, """""", "$");
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, """", "");
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "$", """");
	
	Возврат ТекстЗапроса;
	
КонецФункции

Процедура ОткрытьКонструкторЗапросаВнутренний(ТекстЗапроса, КонтекстВызова)
	
	Конструктор = Новый КонструкторЗапроса();
	
	Если ЗначениеЗаполнено(ТекстЗапроса) Тогда
		Попытка
			Конструктор.Текст = ТекстЗапроса;
		Исключение
			Инфо = ИнформацияОбОшибке();
			ПоказатьПредупреждение(, "Ошибка в тексте запроса:" + Символы.ПС + Инфо.Причина.Описание);
			Возврат;
		КонецПопытки;
	КонецЕсли;
	
	Оповещение = Новый ОписаниеОповещения("ПриЗакрытииКонструктораЗапросаЗавершение", ЭтотОбъект, КонтекстВызова);
	Конструктор.Показать(Оповещение);
	
КонецПроцедуры

Процедура ПриЗакрытииКонструктораЗапросаЗавершение(Текст, КонтекстВызова) Экспорт
	
	Если Текст <> Неопределено Тогда
		
		// Проверяем режим запроса
		Попытка
			РежимЗапроса = View(КонтекстВызова.Форма, КонтекстВызова.ИмяПоляHTML).queryMode;
		Исключение
			РежимЗапроса = Ложь;
		КонецПопытки;
		
		Если Не РежимЗапроса Тогда
			Текст = СтрЗаменить(Текст, Символы.ПС, Символы.ПС + "|");
			Текст = СтрЗаменить(Текст, """", """""");
			Текст = """" + Текст + """";
		КонецЕсли;
		
		Range = Неопределено;
		Если КонтекстВызова.Свойство("Range") Тогда
			Range = КонтекстВызова.Range;
		КонецЕсли;
		
		// Используем setText с позицией (range) для вставки в нужное место
		View(КонтекстВызова.Форма, КонтекстВызова.ИмяПоляHTML).setText(Текст, Range, Истина);
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область КонструкторФорматнойСтроки

Процедура ОбработатьСобытиеКонструктораФорматнойСтроки(Форма, ПараметрыСтроки, ИмяПоляHTML)
	
	КонтекстВызова = Новый Структура("Форма, ИмяПоляHTML", Форма, ИмяПоляHTML);
	
	Если ПараметрыСтроки = Неопределено Тогда
		Оповещение = Новый ОписаниеОповещения("ВопросСоздатьНовуюФорматнуюСтрокуЗавершение", ЭтотОбъект, КонтекстВызова);
		ТекстВопроса = "Форматная строка не найдена." + Символы.ПС + "Создать новую форматную строку?";
		ПоказатьВопрос(Оповещение, ТекстВопроса, РежимДиалогаВопрос.ДаНет);
	Иначе
		КонтекстВызова.Вставить("Range", ПараметрыСтроки.range);
		ФорматнаяСтрока = СтрЗаменить(СтрЗаменить(ПараметрыСтроки.text, "|", ""), """", "");
		ОткрытьКонструкторФорматнойСтрокиВнутренний(ФорматнаяСтрока, КонтекстВызова);
	КонецЕсли;
	
КонецПроцедуры

Процедура ВопросСоздатьНовуюФорматнуюСтрокуЗавершение(Ответ, КонтекстВызова) Экспорт
	
	Если Ответ = КодВозвратаДиалога.Да Тогда
		ОткрытьКонструкторФорматнойСтрокиВнутренний("", КонтекстВызова);
	КонецЕсли;
	
КонецПроцедуры

Процедура ОткрытьКонструкторФорматнойСтрокиВнутренний(ФорматнаяСтрока, КонтекстВызова)
	
	Конструктор = Новый КонструкторФорматнойСтроки();
	
	Если ЗначениеЗаполнено(ФорматнаяСтрока) Тогда
		Попытка
			Конструктор.Текст = ФорматнаяСтрока;
		Исключение
			Инфо = ИнформацияОбОшибке();
			ПоказатьПредупреждение(, "Ошибка в тексте форматной строки:" + Символы.ПС + Инфо.Причина.Описание);
			Возврат;
		КонецПопытки;
	КонецЕсли;
	
	Оповещение = Новый ОписаниеОповещения("ПриЗакрытииКонструктораФорматнойСтрокиЗавершение", ЭтотОбъект, КонтекстВызова);
	Конструктор.Показать(Оповещение);
	
КонецПроцедуры

Процедура ПриЗакрытииКонструктораФорматнойСтрокиЗавершение(ФорматнаяСтрока, КонтекстВызова) Экспорт
	
	Если ФорматнаяСтрока <> Неопределено Тогда
		ФорматнаяСтрока = СтрЗаменить(ФорматнаяСтрока, "'", "");
		ФорматнаяСтрока = """" + ФорматнаяСтрока + """";
		
		Range = Неопределено;
		Если КонтекстВызова.Свойство("Range") Тогда
			Range = КонтекстВызова.Range;
		КонецЕсли;
		
		// Используем setText с позицией (range) для вставки в нужное место
		View(КонтекстВызова.Форма, КонтекстВызова.ИмяПоляHTML).setText(ФорматнаяСтрока, Range, Ложь);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область ВыполнениеКода

Функция ПолучитьТекстСКодомПросмотраПеременных(Форма, ИмяПоляHTML, РежимПоказаПеременных)
	
	Код = ПолучитьТекст(Форма, ИмяПоляHTML);
	
	Если Не РежимПоказаПеременных = ПредопределенноеЗначение("Перечисление.конс_РежимПоказаПеременных.НеОтображать") Тогда
		
		Переменные = View(Форма, ИмяПоляHTML).getVarsNames();
		
		Если Переменные.length > 0 Тогда
			
			ПС = Символы.ПС;
			
			Для Индекс = 0 По Переменные.length - 1 Цикл
				Имя = Переменные["" + Индекс + ""];
				Код = Код + ПС + "Попытка ЗначенияПеременных.Вставить(""" + Имя + """,Вычислить(""" + Имя + """)); Исключение КонецПопытки;" + ПС;
			КонецЦикла;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Код;
	
КонецФункции

Функция ВыполнитьКодНаКлиенте(Код, РежимПоказаПеременных)
	
	Результат = конс_ПодключаемаяКонсольВызовСервера.НовыйРезультатВыполнения();
	Результат.РежимПоказаПеременных = РежимПоказаПеременных;
	ЗначенияПеременных = Новый Структура;
	
	Попытка
		Выполнить(Код);
		Результат.Успешно = Истина;
		
		Попытка
			Если РежимПоказаПеременных = ПредопределенноеЗначение("Перечисление.конс_РежимПоказаПеременных.ВТабло") Тогда
				АдресПеременных = "";
				Результат.ОписаниеПеременных = конс_ПодключаемаяКонсольВызовСервера.ПолучитьОписаниеПеременныхДляТабло(ЗначенияПеременных, АдресПеременных);
				Результат.АдресХраненияПеременных = АдресПеременных;
			ИначеЕсли РежимПоказаПеременных = ПредопределенноеЗначение("Перечисление.конс_РежимПоказаПеременных.ВПодсказках") Тогда
				Результат.ОписаниеПеременных = конс_ПодключаемаяКонсольВызовСервера.ПолучитьОписаниеПеременныхДляПодсказок(ЗначенияПеременных);
			Иначе
				Результат.ОписаниеПеременных = "";
			КонецЕсли;
		Исключение
			Результат.ОписаниеПеременных = "";
		КонецПопытки;
		
	Исключение
		ИнфоОшибки = ИнформацияОбОшибке();
		Результат.ИсходнаяСтрока = ИнфоОшибки.ИсходнаяСтрока;
		Если ИнфоОшибки.Причина <> Неопределено Тогда
			Результат.ОписаниеОшибки = ИнфоОшибки.Причина.Описание;
		Иначе
			Результат.ОписаниеОшибки = ИнфоОшибки.Описание;
		КонецЕсли;
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

Процедура ОбработатьРезультатВыполнения(Форма, Результат, ИмяПоляHTML)
	
	// Устаревшая - для обратной совместимости
	ОбработатьРезультат(Форма, Результат, ИмяПоляHTML);
	
КонецПроцедуры

// Обрабатывает ошибку выполнения с использованием нового API
Процедура ОбработатьОшибкуВыполненияПубличный(Форма, Результат, ИмяПоляHTML)
	
	// Используем новую структурированную информацию об ошибке, если есть
	Если Результат.Свойство("ИнформацияОбОшибке") И Результат.ИнформацияОбОшибке <> Неопределено Тогда
		ПоказатьОшибкуВыполнения(Форма, Результат.ИнформацияОбОшибке, Истина, ИмяПоляHTML);
	Иначе
		// Старый способ через строку
		ОбработатьОшибкуВыполнения(Форма, Результат, ИмяПоляHTML);
	КонецЕсли;
	
КонецПроцедуры

// Старый метод обработки ошибок (для обратной совместимости)
Процедура ОбработатьОшибкуВыполнения(Форма, Результат, ИмяПоляHTML)
	
	Ошибка = РазобратьОшибку(Результат.ОписаниеОшибки);
	
	НомерСтроки = Ошибка.НомерСтроки;
	НомерКолонки = Ошибка.НомерКолонки;
	
	Если НомерСтроки = 0 Тогда
		НомерСтроки = ИзвлечьНомерСтрокиИзОписания(Результат.ОписаниеОшибки);
	КонецЕсли;
	
	ПоказатьОшибку(Форма, Ошибка.ТекстОшибки, НомерСтроки, НомерКолонки, ИмяПоляHTML);
	
КонецПроцедуры

// Обрабатывает успешное выполнение с показом переменных
Процедура ОбработатьУспешноеВыполнениеПубличный(Форма, Результат, ИмяПоляHTML)
	
	// Сохраняем адрес хранения переменных для последующего раскрытия
	Попытка
		Если Результат.Свойство("АдресХраненияПеременных") Тогда
			Форма.конс_СтруктураПараметровРедактораКода.АдресХраненияПеременных = Результат.АдресХраненияПеременных;
		КонецЕсли;
	Исключение
		// Ошибка сохранения
	КонецПопытки;
	
	Если Не ЗначениеЗаполнено(Результат.ОписаниеПеременных) Тогда
		ПоказатьСообщениеВРедакторе(Форма, "Код успешно выполнен", ИмяПоляHTML);
		Возврат;
	КонецЕсли;
	
	РежимПоказа = Результат.РежимПоказаПеременных;
	
	Если РежимПоказа = ПредопределенноеЗначение("Перечисление.конс_РежимПоказаПеременных.ВТабло") Тогда
		ПоказатьПеременныеВТабло(Форма, Результат.ОписаниеПеременных, ИмяПоляHTML);
	ИначеЕсли РежимПоказа = ПредопределенноеЗначение("Перечисление.конс_РежимПоказаПеременных.ВПодсказках") Тогда
		ПоказатьПеременныеВПодсказках(Форма, Результат.ОписаниеПеременных, ИмяПоляHTML);
	Иначе
		// Не отображать
	КонецЕсли;
	
КонецПроцедуры

// Старый метод (для обратной совместимости)
Процедура ОбработатьУспешноеВыполнение(Форма, Результат, ИмяПоляHTML)
	
	Если Не ЗначениеЗаполнено(Результат.ОписаниеПеременных) Тогда
		Возврат;
	КонецЕсли;
	
	Если Результат.РежимПоказаПеременных = ПредопределенноеЗначение("Перечисление.конс_РежимПоказаПеременных.ВТабло") Тогда
		ПоказатьПеременныеВТабло(Форма, Результат.ОписаниеПеременных, ИмяПоляHTML);
		Возврат;
	КонецЕсли;
	
	Если Результат.РежимПоказаПеременных = ПредопределенноеЗначение("Перечисление.конс_РежимПоказаПеременных.ВПодсказках") Тогда
		View(Форма, ИмяПоляHTML).setCustomHovers(Результат.ОписаниеПеременных);
		Если Результат.ОписаниеПеременных <> "{}" Тогда
			View(Форма, ИмяПоляHTML).setCustomCodeLenses("[{""lineNumber"": 1,""column"": 1,""text"": ""Для просмотра значений наведите курсор на переменную""}]");
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Функция РазобратьОшибку(ОписаниеОшибки)
	
	Ошибка = Новый Структура("ТекстОшибки, НомерСтроки, НомерКолонки", ОписаниеОшибки, 0, 1);
	
	ПозицияРазделителя = СтрНайти(ОписаниеОшибки, ":");
	
	Если ПозицияРазделителя > 0 Тогда
		
		Ошибка.ТекстОшибки = СокрЛП(Сред(ОписаниеОшибки, ПозицияРазделителя + 1));
		
		СтрокаОшибки = Лев(ОписаниеОшибки, ПозицияРазделителя - 1);
		СтрокаОшибки = СтрЗаменить(СтрокаОшибки, "{", "");
		СтрокаОшибки = СтрЗаменить(СтрокаОшибки, "(", "");
		СтрокаОшибки = СтрЗаменить(СтрокаОшибки, ")", "");
		СтрокаОшибки = СтрЗаменить(СтрокаОшибки, "}", "");
		
		Подстроки = СтрЗаменить(СтрокаОшибки, ",", Символы.ПС);
		
		Ошибка.НомерСтроки = БезопасноеПреобразованиеВЧисло(СтрПолучитьСтроку(Подстроки, 1), 0);
		Ошибка.НомерКолонки = БезопасноеПреобразованиеВЧисло(СтрПолучитьСтроку(Подстроки, 2), 1);
		
	КонецЕсли;
	
	Возврат Ошибка;
	
КонецФункции

// Безопасно преобразует строку в число.
// Делегирует в общий клиент-серверный модуль.
//
Функция БезопасноеПреобразованиеВЧисло(Знач Строка, ЗначениеПоУмолчанию)
	
	Возврат конс_ПодключаемаяКонсольКлиентСервер.БезопасноеПреобразованиеВЧисло(Строка, ЗначениеПоУмолчанию);
	
КонецФункции

Функция ИзвлечьНомерСтрокиИзОписания(ОписаниеОшибки)
	
	НомерСтроки = 0;
	ОткрывающаяСкобка = СтрНайти(ОписаниеОшибки, "(");
	
	Если ОткрывающаяСкобка > 0 Тогда
		
		ЗакрывающаяСкобка = СтрНайти(ОписаниеОшибки, ")", , ОткрывающаяСкобка);
		
		Если ЗакрывающаяСкобка > 0 Тогда
			
			Позиция = Сред(ОписаниеОшибки, ОткрывающаяСкобка + 1, ЗакрывающаяСкобка - ОткрывающаяСкобка - 1);
			Подстроки = СтрРазделить(Позиция, ",");
			
			Если Подстроки.Количество() > 0 Тогда
				НомерСтроки = БезопасноеПреобразованиеВЧисло(Подстроки[0], 0);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат НомерСтроки;
	
КонецФункции

// Получает контекст элемента формы HTML-редактора.
// Принимает либо имя элемента (строку), либо сам элемент формы.
// Возвращает структуру с элементом, его именем и путём к данным.
//
// Параметры:
//   Форма - ФормаКлиентскогоПриложения - форма с полем HTML
//   ЭлементИлиИмя - Строка, ЭлементФормы, Неопределено - элемент формы или его имя.
//                   Если Неопределено - берётся из реквизита конс_ИмяПоляHTML или "HTML"
//
// Возвращаемое значение:
//   Структура - контекст элемента:
//     * Элемент - ЭлементФормы - элемент формы типа ПолеHTML
//     * ИмяЭлемента - Строка - имя элемента на форме
//     * ПутьКДанным - Строка - путь к данным (имя реквизита формы)
//
Функция ПолучитьКонтекстПоля(Форма, ЭлементИлиИмя)
	
	Результат = Новый Структура("Элемент, ИмяЭлемента, ПутьКДанным", Неопределено, "", "");
	
	// Определяем элемент формы
	Если ТипЗнч(ЭлементИлиИмя) = Тип("Строка") Тогда
		// Передано имя элемента
		Результат.ИмяЭлемента = ЭлементИлиИмя;
		Результат.Элемент = Форма.Элементы.Найти(ЭлементИлиИмя);
	ИначеЕсли ЭлементИлиИмя = Неопределено Тогда
		// Не передано - берём из реквизита формы
		Результат.ИмяЭлемента = ПолучитьИмяПоляHTML(Форма, Неопределено);
		Результат.Элемент = Форма.Элементы.Найти(Результат.ИмяЭлемента);
	Иначе
		// Передан сам элемент формы
		Результат.Элемент = ЭлементИлиИмя;
		Результат.ИмяЭлемента = ЭлементИлиИмя.Имя;
	КонецЕсли;
	
	// Получаем путь к данным из структуры параметров (на клиенте свойство элемента недоступно)
	Попытка
		Результат.ПутьКДанным = Форма.конс_СтруктураПараметровРедактораКода.ПутьКДаннымПоляHTML;
	Исключение
		// Структура параметров не инициализирована
		Результат.ПутьКДанным = "";
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Получает имя поля HTML для формы.
// Принимает строку, элемент формы или Неопределено.
// Если передан элемент формы - возвращает его имя.
// Если передана строка - возвращает её.
// Если Неопределено - берёт из структуры параметров или возвращает "HTML".
//
Функция ПолучитьИмяПоляHTML(Форма, ЭлементИлиИмя)
	
	// Если передан элемент формы - вернём его имя
	Если ЭлементИлиИмя <> Неопределено И ТипЗнч(ЭлементИлиИмя) <> Тип("Строка") Тогда
		Возврат ЭлементИлиИмя.Имя;
	КонецЕсли;
	
	// Если передана строка - вернём её
	Если ЭлементИлиИмя <> Неопределено Тогда
		Возврат ЭлементИлиИмя;
	КонецЕсли;
	
	// Берём из структуры параметров формы
	Попытка
		РеквизитИмя = Форма.конс_СтруктураПараметровРедактораКода.ИмяПоляHTML;
		Если ЗначениеЗаполнено(РеквизитИмя) Тогда
			Возврат РеквизитИмя;
		КонецЕсли;
	Исключение
		// Реквизит отсутствует - это нормально
	КонецПопытки;
	
	Возврат "HTML";
	
КонецФункции

// Извлекает позицию из описания ошибки выполняемого кода.
// Делегирует в общий клиент-серверный модуль.
// Формат: {(строка,колонка)}:...
//
Функция ИзвлечьПозициюВыполняемогоКода(ОписаниеОшибки)
	
	Возврат конс_ПодключаемаяКонсольКлиентСервер.ИзвлечьПозициюВыполняемогоКода(ОписаниеОшибки);
	
КонецФункции

// Извлекает позицию из описания ошибки с именем модуля.
// Делегирует в общий клиент-серверный модуль.
// Формат: {<ИмяМодуля>(строка,колонка)}:...
// Например: {<Неизвестный модуль>(1,11)}:
//
Функция ИзвлечьПозициюИзМодульнойОшибки(ОписаниеОшибки)
	
	Возврат конс_ПодключаемаяКонсольКлиентСервер.ИзвлечьПозициюИзМодульнойОшибки(ОписаниеОшибки);
	
КонецФункции

#КонецОбласти

#КонецОбласти
