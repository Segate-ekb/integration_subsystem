ТаблицаЗначений = Новый ТаблицаЗначений();
ТаблицаЗначений.Колонки.Добавить("label", Новый ОписаниеТипов("Строка"));
ТаблицаЗначений.Колонки.Добавить("value", Новый ОписаниеТипов("Число"));

Запрос = Новый Запрос;
Запрос.Текст = "ВЫБРАТЬ
|	инт_ТекущийСтатусВходящихСообщений.ИдентификаторСообщения КАК ИдентификаторСообщения
|ПОМЕСТИТЬ ВыборкаТребуемыхВходящих
|ИЗ
|	РегистрСведений.инт_ТекущийСтатусВходящихСообщений КАК инт_ТекущийСтатусВходящихСообщений
|ГДЕ
|	инт_ТекущийСтатусВходящихСообщений.СтатусСообщения = ЗНАЧЕНИЕ(Перечисление.инт_СтатусыВходящихСообщений.новый)
|
|ОБЪЕДИНИТЬ
|
|ВЫБРАТЬ
|	инт_ТекущийСтатусВходящихСообщений.ИдентификаторСообщения
|ИЗ
|	РегистрСведений.инт_ТекущийСтатусВходящихСообщений КАК инт_ТекущийСтатусВходящихСообщений
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.инт_ОчередьВходящихСообщений КАК инт_ОчередьВходящихСообщений
|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.инт_ПотокиДанных КАК инт_ПотокиДанных
|			ПО инт_ОчередьВходящихСообщений.ПотокДанных = инт_ПотокиДанных.Ссылка
|		ПО инт_ТекущийСтатусВходящихСообщений.ИдентификаторСообщения = инт_ОчередьВходящихСообщений.ИдентификаторСообщения
|			И (инт_ТекущийСтатусВходящихСообщений.СтатусСообщения = ЗНАЧЕНИЕ(Перечисление.инт_СтатусыВходящихСообщений.ОшибкаОбработки))
|ГДЕ
|	инт_ПотокиДанных.КоличествоПопытокОбработки > инт_ТекущийСтатусВходящихСообщений.КоличествоПопыток
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	инт_ТекущийСтатусИсходящихСообщений.ИдентификаторСообщения КАК ИдентификаторСообщения
|ПОМЕСТИТЬ ВыборкаТребуемыхИсходящих
|ИЗ
|	РегистрСведений.инт_ТекущийСтатусИсходящихСообщений КАК инт_ТекущийСтатусИсходящихСообщений
|ГДЕ
|	инт_ТекущийСтатусИсходящихСообщений.СтатусСообщения = ЗНАЧЕНИЕ(Перечисление.инт_СтатусыИсходящихСообщений.новый)
|
|ОБЪЕДИНИТЬ
|
|ВЫБРАТЬ
|	инт_ТекущийСтатусИсходящихСообщений.ИдентификаторСообщения
|ИЗ
|	РегистрСведений.инт_ТекущийСтатусИсходящихСообщений КАК инт_ТекущийСтатусИсходящихСообщений
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.инт_ОчередьИсходящихСообщений КАК инт_ОчередьИсходящихСообщений
|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.инт_ПотокиДанных КАК инт_ПотокиДанных
|			ПО инт_ОчередьИсходящихСообщений.ПотокДанных = инт_ПотокиДанных.Ссылка
|		ПО инт_ТекущийСтатусИсходящихСообщений.ИдентификаторСообщения = инт_ОчередьИсходящихСообщений.ИдентификаторСообщения
|			И (инт_ТекущийСтатусИсходящихСообщений.СтатусСообщения = ЗНАЧЕНИЕ(Перечисление.инт_СтатусыИсходящихСообщений.ОшибкаФормирования)
|				ИЛИ инт_ТекущийСтатусИсходящихСообщений.СтатусСообщения = ЗНАЧЕНИЕ(Перечисление.инт_СтатусыИсходящихСообщений.ОшибкаОтправки))
|ГДЕ
|	инт_ПотокиДанных.КоличествоПопытокОбработки > инт_ТекущийСтатусИсходящихСообщений.КоличествоПопыток
|;
|
|////////////////////////////////////////////////////////////////////////////////
|// Новые сообщения к рассылке (по всем типам подписчиков)
|ВЫБРАТЬ
|	Статус.ИдентификаторСообщения КАК ИдентификаторСообщения,
|	Статус.Подписчик КАК Подписчик
|ПОМЕСТИТЬ ПромежуточныйИтогРассылаемых
|ИЗ
|	РегистрСведений.инт_ТекущийСтатусРассылкиСообщений КАК Статус
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.инт_ПодписчикиHTTP КАК Подписчики
|		ПО Статус.Подписчик = Подписчики.Ссылка
|ГДЕ
|	Статус.СтатусСообщения = ЗНАЧЕНИЕ(Перечисление.инт_СтатусыРассылкиИсходящихСообщений.Новый)
|	ИЛИ (Статус.СтатусСообщения = ЗНАЧЕНИЕ(Перечисление.инт_СтатусыРассылкиИсходящихСообщений.ОшибкаОбработки)
|		И Статус.КоличествоПопыток < Подписчики.КоличествоПопытокОтправки)
|
|ОБЪЕДИНИТЬ ВСЕ
|
|ВЫБРАТЬ
|	Статус.ИдентификаторСообщения,
|	Статус.Подписчик
|ИЗ
|	РегистрСведений.инт_ТекущийСтатусРассылкиСообщений КАК Статус
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.инт_ПодписчикиJRPC КАК Подписчики
|		ПО Статус.Подписчик = Подписчики.Ссылка
|ГДЕ
|	Статус.СтатусСообщения = ЗНАЧЕНИЕ(Перечисление.инт_СтатусыРассылкиИсходящихСообщений.Новый)
|	ИЛИ (Статус.СтатусСообщения = ЗНАЧЕНИЕ(Перечисление.инт_СтатусыРассылкиИсходящихСообщений.ОшибкаОбработки)
|		И Статус.КоличествоПопыток < Подписчики.КоличествоПопытокОтправки)
|
|ОБЪЕДИНИТЬ ВСЕ
|
|ВЫБРАТЬ
|	Статус.ИдентификаторСообщения,
|	Статус.Подписчик
|ИЗ
|	РегистрСведений.инт_ТекущийСтатусРассылкиСообщений КАК Статус
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.инт_ПодписчикиПодсистемаИнтеграции КАК Подписчики
|		ПО Статус.Подписчик = Подписчики.Ссылка
|ГДЕ
|	Статус.СтатусСообщения = ЗНАЧЕНИЕ(Перечисление.инт_СтатусыРассылкиИсходящихСообщений.Новый)
|	ИЛИ (Статус.СтатусСообщения = ЗНАЧЕНИЕ(Перечисление.инт_СтатусыРассылкиИсходящихСообщений.ОшибкаОбработки)
|		И Статус.КоличествоПопыток < Подписчики.КоличествоПопытокОтправки)
|
|ОБЪЕДИНИТЬ ВСЕ
|
|ВЫБРАТЬ
|	Статус.ИдентификаторСообщения,
|	Статус.Подписчик
|ИЗ
|	РегистрСведений.инт_ТекущийСтатусРассылкиСообщений КАК Статус
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.инт_ПодписчикиKafka КАК Подписчики
|		ПО Статус.Подписчик = Подписчики.Ссылка
|ГДЕ
|	Статус.СтатусСообщения = ЗНАЧЕНИЕ(Перечисление.инт_СтатусыРассылкиИсходящихСообщений.Новый)
|	ИЛИ (Статус.СтатусСообщения = ЗНАЧЕНИЕ(Перечисление.инт_СтатусыРассылкиИсходящихСообщений.ОшибкаОбработки)
|		И Статус.КоличествоПопыток < Подписчики.КоличествоПопытокОтправки)
|
|ОБЪЕДИНИТЬ ВСЕ
|
|ВЫБРАТЬ
|	Статус.ИдентификаторСообщения,
|	Статус.Подписчик
|ИЗ
|	РегистрСведений.инт_ТекущийСтатусРассылкиСообщений КАК Статус
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.инт_ПодписчикиRabbitMQ КАК Подписчики
|		ПО Статус.Подписчик = Подписчики.Ссылка
|ГДЕ
|	Статус.СтатусСообщения = ЗНАЧЕНИЕ(Перечисление.инт_СтатусыРассылкиИсходящихСообщений.Новый)
|	ИЛИ (Статус.СтатусСообщения = ЗНАЧЕНИЕ(Перечисление.инт_СтатусыРассылкиИсходящихСообщений.ОшибкаОбработки)
|		И Статус.КоличествоПопыток < Подписчики.КоличествоПопытокОтправки)
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	""incomingQueue"" КАК label,
|	КОЛИЧЕСТВО(ВыборкаТребуемыхВходящих.ИдентификаторСообщения) КАК value
|ИЗ
|	ВыборкаТребуемыхВходящих КАК ВыборкаТребуемыхВходящих
|
|ОБЪЕДИНИТЬ ВСЕ
|
|ВЫБРАТЬ
|	""outcomingQueue"",
|	КОЛИЧЕСТВО(ВыборкаТребуемыхИсходящих.ИдентификаторСообщения)
|ИЗ
|	ВыборкаТребуемыхИсходящих КАК ВыборкаТребуемыхИсходящих
|
|ОБЪЕДИНИТЬ ВСЕ
|
|ВЫБРАТЬ
|	""outcomingFormingQueue"",
|	КОЛИЧЕСТВО(ПромежуточныйИтогРассылаемых.ИдентификаторСообщения)
|ИЗ
|	ПромежуточныйИтогРассылаемых КАК ПромежуточныйИтогРассылаемых";
Результат = Запрос.Выполнить();

ТаблицаЗначений = Результат.Выгрузить();
