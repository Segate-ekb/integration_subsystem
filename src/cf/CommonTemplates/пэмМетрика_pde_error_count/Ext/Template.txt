// Метрика: Количество сообщений с ошибками
// Лейблы: flow_name, error_type, direction

ТаблицаЗначений = Новый ТаблицаЗначений;
ТаблицаЗначений.Колонки.Добавить("flow_name", Новый ОписаниеТипов("Строка"));
ТаблицаЗначений.Колонки.Добавить("error_type", Новый ОписаниеТипов("Строка"));
ТаблицаЗначений.Колонки.Добавить("direction", Новый ОписаниеТипов("Строка"));
ТаблицаЗначений.Колонки.Добавить("value", Новый ОписаниеТипов("Число"));

Запрос = Новый Запрос;
Запрос.Текст =
"ВЫБРАТЬ
|	ПотокиДанных.Наименование КАК flow_name,
|	""formation_error"" КАК error_type,
|	""outgoing"" КАК direction,
|	КОЛИЧЕСТВО(Статус.ИдентификаторСообщения) КАК value
|ИЗ
|	РегистрСведений.инт_ТекущийСтатусИсходящихСообщений КАК Статус
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.инт_ОчередьИсходящихСообщений КАК Очередь
|		ПО Статус.ИдентификаторСообщения = Очередь.ИдентификаторСообщения
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.инт_ПотокиДанных КАК ПотокиДанных
|		ПО Очередь.ПотокДанных = ПотокиДанных.Ссылка
|ГДЕ
|	Статус.СтатусСообщения = ЗНАЧЕНИЕ(Перечисление.инт_СтатусыИсходящихСообщений.ОшибкаФормирования)
|СГРУППИРОВАТЬ ПО
|	ПотокиДанных.Наименование
|
|ОБЪЕДИНИТЬ ВСЕ
|
|ВЫБРАТЬ
|	ПотокиДанных.Наименование,
|	""send_error"",
|	""outgoing"",
|	КОЛИЧЕСТВО(Статус.ИдентификаторСообщения)
|ИЗ
|	РегистрСведений.инт_ТекущийСтатусИсходящихСообщений КАК Статус
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.инт_ОчередьИсходящихСообщений КАК Очередь
|		ПО Статус.ИдентификаторСообщения = Очередь.ИдентификаторСообщения
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.инт_ПотокиДанных КАК ПотокиДанных
|		ПО Очередь.ПотокДанных = ПотокиДанных.Ссылка
|ГДЕ
|	Статус.СтатусСообщения = ЗНАЧЕНИЕ(Перечисление.инт_СтатусыИсходящихСообщений.ОшибкаОтправки)
|СГРУППИРОВАТЬ ПО
|	ПотокиДанных.Наименование
|
|ОБЪЕДИНИТЬ ВСЕ
|
|ВЫБРАТЬ
|	ПотокиДанных.Наименование,
|	""processing_error"",
|	""incoming"",
|	КОЛИЧЕСТВО(Статус.ИдентификаторСообщения)
|ИЗ
|	РегистрСведений.инт_ТекущийСтатусВходящихСообщений КАК Статус
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.инт_ОчередьВходящихСообщений КАК Очередь
|		ПО Статус.ИдентификаторСообщения = Очередь.ИдентификаторСообщения
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.инт_ПотокиДанных КАК ПотокиДанных
|		ПО Очередь.ПотокДанных = ПотокиДанных.Ссылка
|ГДЕ
|	Статус.СтатусСообщения = ЗНАЧЕНИЕ(Перечисление.инт_СтатусыВходящихСообщений.ОшибкаОбработки)
|СГРУППИРОВАТЬ ПО
|	ПотокиДанных.Наименование";

Результат = Запрос.Выполнить();
Если НЕ Результат.Пустой() Тогда
	ТаблицаЗначений = Результат.Выгрузить();
КонецЕсли;
