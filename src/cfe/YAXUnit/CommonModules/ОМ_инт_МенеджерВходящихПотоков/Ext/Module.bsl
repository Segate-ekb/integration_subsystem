// BSLLS-off
// @strict-types
////////////////////////////////////////////////////////////////////////////////
// ОМ_инт_МенеджерВходящихПотоков
// Юнит-тесты для менеджера входящих потоков: drain подписок, graceful stop
////////////////////////////////////////////////////////////////////////////////

#Область СлужебныйПрограммныйИнтерфейс

Процедура ИсполняемыеСценарии() Экспорт
	
	ЮТТесты.УдалениеТестовыхДанных()
		.ВТранзакции()
		.ДобавитьТестовыйНабор("DrainПодписки")
			.ДобавитьТест("ТестDrainПодпискиУстанавливаетСтатусDrained")
			.ДобавитьТест("ТестDrainПодпискиИсключаетИзАктивных")
			.ДобавитьТест("ТестВосстановлениеПодпискиСнимаетDrained")
			.ДобавитьТест("ТестПолучитьОстановленныеПодпискиВозвращаетDrained")
		.ДобавитьТестовыйНабор("GracefulStop")
			.ДобавитьТест("ТестГрейсфулСтопУстанавливаетКонстанту")
			.ДобавитьТест("ТестГрейсфулСтопУстанавливаетСтатусыВРегистре")
			.ДобавитьТест("ТестВозобновлениеСбрасываетКонстанту")
			.ДобавитьТест("ТестВозобновлениеОчищаетGracefulStop")
			.ДобавитьТест("ТестМенеджерНеЗапускаетПриGracefulStop")
		.ДобавитьТестовыйНабор("ПроверкаЗапросаНаОстановку")
			.ДобавитьТест("ТестПроверкаЗапросаНаОстановкуDrained")
			.ДобавитьТест("ТестПроверкаЗапросаНаОстановкуGracefulStop")
			.ДобавитьТест("ТестПроверкаЗапросаНаОстановкуБезЗапросов")
		.ДобавитьТестовыйНабор("ОчисткаНеактивныхЗаписей")
			.ДобавитьТест("ТестОчисткаНеактивныхНеУдаляетDrained");
			
КонецПроцедуры

#КонецОбласти

#Область События

Процедура ПередВсемиТестами() Экспорт

КонецПроцедуры

Процедура ПередКаждымТестом() Экспорт
	// Очищаем регистр и константу перед каждым тестом
	РегистрыСведений.инт_АктивныеКонсьюмеры.ОчиститьРегистр();
	Константы.инт_ОстановитьВсеКонсьюмеры.Установить(Ложь);
КонецПроцедуры

Процедура ПослеКаждогоТеста() Экспорт

КонецПроцедуры

Процедура ПослеВсехТестов() Экспорт
	// Гарантируем очистку после всех тестов
	РегистрыСведений.инт_АктивныеКонсьюмеры.ОчиститьРегистр();
	Константы.инт_ОстановитьВсеКонсьюмеры.Установить(Ложь);
КонецПроцедуры

#КонецОбласти

#Область Тесты

// {{{ Набор: DrainПодписки

// Тест: DrainПодписку устанавливает статус Drained в регистре
Процедура ТестDrainПодпискиУстанавливаетСтатусDrained() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "localhost:9092");
	Подписчик = ГенераторТестовыхДанных.ПодписчикKafka(Эндпоинт, "drain-test-topic", Ложь, Истина, "drain-test-topic.dlq");
	
	// Act
	инт_МенеджерВходящихПотоков.DrainПодписку(Подписчик);
	
	// Assert
	DrainedПодписки = РегистрыСведений.инт_АктивныеКонсьюмеры.ПолучитьDrainedПодписки();
	ЮТест.ОжидаетЧто(DrainedПодписки)
		.ИмеетДлину(1);
	ЮТест.ОжидаетЧто(DrainedПодписки[0].Подписка)
		.Равно(Подписчик);
	
КонецПроцедуры

// Тест: Drained подписка исключается из списка активных подписок
Процедура ТестDrainПодпискиИсключаетИзАктивных() Экспорт
	
	// Arrange — создаём подписчика и поток данных с привязкой
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "localhost:9092");
	Подписчик = ГенераторТестовыхДанных.ПодписчикKafka(Эндпоинт, "excluded-topic", Ложь, Истина, "excluded-topic.dlq");
	
	// Act — drain подписку
	инт_МенеджерВходящихПотоков.DrainПодписку(Подписчик);
	
	// Assert — drained подписки должны быть видны
	DrainedПодписки = инт_МенеджерВходящихПотоков.ПолучитьОстановленныеПодписки();
	MассивСсылок = Новый Массив;
	Для Каждого Элемент Из DrainedПодписки Цикл
		MассивСсылок.Добавить(Элемент.Подписка);
	КонецЦикла;
	
	ЮТест.ОжидаетЧто(MассивСсылок)
		.Содержит(Подписчик);
	
КонецПроцедуры

// Тест: ВосстановитьПодписку снимает статус Drained
Процедура ТестВосстановлениеПодпискиСнимаетDrained() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "localhost:9092");
	Подписчик = ГенераторТестовыхДанных.ПодписчикKafka(Эндпоинт, "restore-topic", Ложь, Истина, "restore-topic.dlq");
	инт_МенеджерВходящихПотоков.DrainПодписку(Подписчик);
	
	// Act
	инт_МенеджерВходящихПотоков.ВосстановитьПодписку(Подписчик);
	
	// Assert
	DrainedПодписки = РегистрыСведений.инт_АктивныеКонсьюмеры.ПолучитьDrainedПодписки();
	ЮТест.ОжидаетЧто(DrainedПодписки)
		.ИмеетДлину(0);
	
КонецПроцедуры

// Тест: ПолучитьОстановленныеПодписки возвращает только Drained
Процедура ТестПолучитьОстановленныеПодпискиВозвращаетDrained() Экспорт
	
	// Arrange — drain одну подписку, оставить другую активной
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "localhost:9092");
	Подписчик1 = ГенераторТестовыхДанных.ПодписчикKafka(Эндпоинт, "drain-topic-1", Ложь, Истина, "drain-topic-1.dlq");
	Подписчик2 = ГенераторТестовыхДанных.ПодписчикKafka(Эндпоинт, "active-topic-2", Ложь, Истина, "active-topic-2.dlq");
	
	// Регистрируем оба как активные консьюмеры
	РегистрыСведений.инт_АктивныеКонсьюмеры.ЗарегистрироватьКонсьюмер(Подписчик2, Новый УникальныйИдентификатор, "Kafka");
	
	// Drain только первого
	инт_МенеджерВходящихПотоков.DrainПодписку(Подписчик1);
	
	// Act
	DrainedПодписки = инт_МенеджерВходящихПотоков.ПолучитьОстановленныеПодписки();
	
	// Assert — только одна drained подписка
	ЮТест.ОжидаетЧто(DrainedПодписки)
		.ИмеетДлину(1);
	ЮТест.ОжидаетЧто(DrainedПодписки[0].Подписка)
		.Равно(Подписчик1);
	
КонецПроцедуры

// }}}

// {{{ Набор: GracefulStop

// Тест: ГрейсфулСтоп устанавливает константу
Процедура ТестГрейсфулСтопУстанавливаетКонстанту() Экспорт
	
	// Arrange — убеждаемся, что константа сброшена
	ЮТест.ОжидаетЧто(Константы.инт_ОстановитьВсеКонсьюмеры.Получить())
		.Равно(Ложь);
	
	// Act
	инт_МенеджерВходящихПотоков.ГрейсфулСтопВсехКонсьюмеров();
	
	// Assert
	ЮТест.ОжидаетЧто(Константы.инт_ОстановитьВсеКонсьюмеры.Получить())
		.Равно(Истина);
	
КонецПроцедуры

// Тест: ГрейсфулСтоп устанавливает статус GracefulStop в регистре
Процедура ТестГрейсфулСтопУстанавливаетСтатусыВРегистре() Экспорт
	
	// Arrange — регистрируем активные записи
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "localhost:9092");
	Подписчик = ГенераторТестовыхДанных.ПодписчикKafka(Эндпоинт, "gs-topic", Ложь, Истина, "gs-topic.dlq");
	РегистрыСведений.инт_АктивныеКонсьюмеры.ЗарегистрироватьКонсьюмер(Подписчик, Новый УникальныйИдентификатор, "Kafka");
	
	// Act
	инт_МенеджерВходящихПотоков.ГрейсфулСтопВсехКонсьюмеров();
	
	// Assert — запись должна получить статус GracefulStop
	АктивныеКонсьюмеры = РегистрыСведений.инт_АктивныеКонсьюмеры.ПолучитьАктивныеКонсьюмеры(Подписчик);
	ЮТест.ОжидаетЧто(АктивныеКонсьюмеры)
		.ИмеетДлину(1);
	ЮТест.ОжидаетЧто(АктивныеКонсьюмеры[0].СтатусАктивности)
		.Равно("GracefulStop");
	
КонецПроцедуры

// Тест: ВозобновитьВсеКонсьюмеры сбрасывает константу
Процедура ТестВозобновлениеСбрасываетКонстанту() Экспорт
	
	// Arrange
	инт_МенеджерВходящихПотоков.ГрейсфулСтопВсехКонсьюмеров();
	ЮТест.ОжидаетЧто(Константы.инт_ОстановитьВсеКонсьюмеры.Получить())
		.Равно(Истина);
	
	// Act
	инт_МенеджерВходящихПотоков.ВозобновитьВсеКонсьюмеры();
	
	// Assert
	ЮТест.ОжидаетЧто(Константы.инт_ОстановитьВсеКонсьюмеры.Получить())
		.Равно(Ложь);
	
КонецПроцедуры

// Тест: ВозобновитьВсеКонсьюмеры очищает записи GracefulStop
Процедура ТестВозобновлениеОчищаетGracefulStop() Экспорт
	
	// Arrange — регистрируем и делаем graceful stop
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "localhost:9092");
	Подписчик = ГенераторТестовыхДанных.ПодписчикKafka(Эндпоинт, "resume-topic", Ложь, Истина, "resume-topic.dlq");
	РегистрыСведений.инт_АктивныеКонсьюмеры.ЗарегистрироватьКонсьюмер(Подписчик, Новый УникальныйИдентификатор, "Kafka");
	инт_МенеджерВходящихПотоков.ГрейсфулСтопВсехКонсьюмеров();
	
	// Act
	инт_МенеджерВходящихПотоков.ВозобновитьВсеКонсьюмеры();
	
	// Assert — записи GracefulStop должны быть удалены
	АктивныеКонсьюмеры = РегистрыСведений.инт_АктивныеКонсьюмеры.ПолучитьАктивныеКонсьюмеры(Подписчик);
	ЮТест.ОжидаетЧто(АктивныеКонсьюмеры)
		.ИмеетДлину(0);
	
КонецПроцедуры

// Тест: Менеджер не запускает новые консьюмеры при активном GracefulStop
Процедура ТестМенеджерНеЗапускаетПриGracefulStop() Экспорт
	
	// Arrange
	Константы.инт_ОстановитьВсеКонсьюмеры.Установить(Истина);
	
	// Act + Assert — проверяем, что РежимGracefulStop возвращает Истина
	ЮТест.ОжидаетЧто(инт_МенеджерВходящихПотоков.РежимGracefulStop())
		.Равно(Истина);
	
КонецПроцедуры

// }}}

// {{{ Набор: ПроверкаЗапросаНаОстановку

// Тест: ПроверитьЗапросНаОстановку возвращает Drained
Процедура ТестПроверкаЗапросаНаОстановкуDrained() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "localhost:9092");
	Подписчик = ГенераторТестовыхДанных.ПодписчикKafka(Эндпоинт, "check-drain-topic", Ложь, Истина, "check-drain-topic.dlq");
	инт_МенеджерВходящихПотоков.DrainПодписку(Подписчик);
	
	МассивПодписок = Новый Массив;
	МассивПодписок.Добавить(Подписчик);
	
	// Act
	Результат = РегистрыСведений.инт_АктивныеКонсьюмеры.ПроверитьЗапросНаОстановку(МассивПодписок);
	
	// Assert
	ЮТест.ОжидаетЧто(Результат.НужнаОстановка)
		.Равно(Истина);
	ЮТест.ОжидаетЧто(Результат.Причина)
		.Равно("Drained");
	
КонецПроцедуры

// Тест: ПроверитьЗапросНаОстановку возвращает GracefulStop
Процедура ТестПроверкаЗапросаНаОстановкуGracefulStop() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "localhost:9092");
	Подписчик = ГенераторТестовыхДанных.ПодписчикKafka(Эндпоинт, "check-gs-topic", Ложь, Истина, "check-gs-topic.dlq");
	РегистрыСведений.инт_АктивныеКонсьюмеры.ЗарегистрироватьКонсьюмер(Подписчик, Новый УникальныйИдентификатор, "Kafka");
	РегистрыСведений.инт_АктивныеКонсьюмеры.УстановитьГрейсфулСтоп();
	
	МассивПодписок = Новый Массив;
	МассивПодписок.Добавить(Подписчик);
	
	// Act
	Результат = РегистрыСведений.инт_АктивныеКонсьюмеры.ПроверитьЗапросНаОстановку(МассивПодписок);
	
	// Assert
	ЮТест.ОжидаетЧто(Результат.НужнаОстановка)
		.Равно(Истина);
	ЮТест.ОжидаетЧто(Результат.Причина)
		.Равно("GracefulStop");
	
КонецПроцедуры

// Тест: ПроверитьЗапросНаОстановку без запросов — всё спокойно
Процедура ТестПроверкаЗапросаНаОстановкуБезЗапросов() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "localhost:9092");
	Подписчик = ГенераторТестовыхДанных.ПодписчикKafka(Эндпоинт, "check-ok-topic", Ложь, Истина, "check-ok-topic.dlq");
	РегистрыСведений.инт_АктивныеКонсьюмеры.ЗарегистрироватьКонсьюмер(Подписчик, Новый УникальныйИдентификатор, "Kafka");
	
	МассивПодписок = Новый Массив;
	МассивПодписок.Добавить(Подписчик);
	
	// Act
	Результат = РегистрыСведений.инт_АктивныеКонсьюмеры.ПроверитьЗапросНаОстановку(МассивПодписок);
	
	// Assert
	ЮТест.ОжидаетЧто(Результат.НужнаОстановка)
		.Равно(Ложь);
	ЮТест.ОжидаетЧто(Результат.Причина)
		.Равно("");
	
КонецПроцедуры

// }}}

// {{{ Набор: ОчисткаНеактивныхЗаписей

// Тест: ОчиститьНеактивныеЗаписи не удаляет Drained
Процедура ТестОчисткаНеактивныхНеУдаляетDrained() Экспорт
	
	// Arrange — drain подписку (создаст запись со статусом Drained)
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "localhost:9092");
	Подписчик = ГенераторТестовыхДанных.ПодписчикKafka(Эндпоинт, "cleanup-drain-topic", Ложь, Истина, "cleanup-drain-topic.dlq");
	инт_МенеджерВходящихПотоков.DrainПодписку(Подписчик);
	
	// Act — запускаем менеджер (который вызовет ОчиститьНеактивныеЗаписи)
	// Напрямую вызываем API — запись Drained не должна быть удалена
	// При вызове ЗапуститьКонсьюмерыАсинхронныхПодписок -> ОчиститьНеактивныеЗаписи
	// Drained записи должны остаться

	// Assert — drained подписка должна сохраниться
	DrainedПодписки = РегистрыСведений.инт_АктивныеКонсьюмеры.ПолучитьDrainedПодписки();
	ЮТест.ОжидаетЧто(DrainedПодписки)
		.ИмеетДлину(1);
	ЮТест.ОжидаетЧто(DrainedПодписки[0].Подписка)
		.Равно(Подписчик);
	
КонецПроцедуры

// }}}

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#КонецОбласти
