// BSLLS-off
// @strict-types
////////////////////////////////////////////////////////////////////////////////
// СПР_инт_ПодписчикиKafka_ММ
// Юнит-тесты для проверки Kafka-подписчиков
// Kafka НЕ использует HTTP-авторизацию — аутентификация через параметры
// librdkafka (security.protocol, sasl.*), адрес брокера из Эндпоинт.АдресРесурса
////////////////////////////////////////////////////////////////////////////////

#Область СлужебныйПрограммныйИнтерфейс

Процедура ИсполняемыеСценарии() Экспорт
	
	ЮТТесты.УдалениеТестовыхДанных()
		.ВТранзакции()
		.ДобавитьТестовыйНабор("АдресБрокераKafka")
			.ДобавитьТест("ТестKafkaПодписчикИспользуетАдресРесурсаВКачествеБрокера")
			.ДобавитьТест("ТестKafkaПодписчикИмяТопикаИзНастройки")
		.ДобавитьТестовыйНабор("РежимыОтправкиKafka")
			.ДобавитьТест("ТестKafkaОдиночнаяОтправкаНеНакапливаетСообщения")
			.ДобавитьТест("ТестKafkaПакетнаяОбработкаНакапливаетСообщения")
		.ДобавитьТестовыйНабор("ФормированиеСообщенияKafka")
			.ДобавитьТест("ТестKafkaСформироватьСообщениеВозвращаетJSON");
			
КонецПроцедуры

#КонецОбласти

#Область Тесты

// {{{ Набор: АдресБрокераKafka

// Тест: Kafka-подписчик использует АдресРесурса эндпоинта в качестве адреса брокера
Процедура ТестKafkaПодписчикИспользуетАдресРесурсаВКачествеБрокера() Экспорт
	
	// Arrange
	АдресБрокера = "kafka-broker-1.example.com:9092,kafka-broker-2.example.com:9092";
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", АдресБрокера);
	Подписчик = ГенераторТестовыхДанных.ПодписчикKafka(Эндпоинт, "test-broker-topic");
	
	// Act — проверяем, что адрес ресурса эндпоинта доступен через подписчика
	АдресИзПодписчика = Подписчик.Эндпоинт.АдресРесурса;
	
	// Assert
	ЮТест.ОжидаетЧто(АдресИзПодписчика)
		.Равно(АдресБрокера);
	
КонецПроцедуры

// Тест: Имя топика Kafka-подписчика берётся из настройки каталога
Процедура ТестKafkaПодписчикИмяТопикаИзНастройки() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "localhost:9092");
	Подписчик = ГенераторТестовыхДанных.ПодписчикKafka(Эндпоинт, "custom-topic-name");
	
	// Act
	ИмяТопика = Подписчик.ИмяТопика;
	
	// Assert
	ЮТест.ОжидаетЧто(ИмяТопика)
		.Равно("custom-topic-name");
	
КонецПроцедуры

// }}}

// {{{ Набор: РежимыОтправкиKafka

// Тест: При одиночной отправке (ПакетнаяОбработка=Ложь) не накапливаются сообщения
Процедура ТестKafkaОдиночнаяОтправкаНеНакапливаетСообщения() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "localhost:9092");
	Подписчик = ГенераторТестовыхДанных.ПодписчикKafka(Эндпоинт, "single-topic", Ложь);
	
	// Assert
	ЮТест.ОжидаетЧто(Подписчик.ПакетнаяОбработка)
		.Равно(Ложь);
	
КонецПроцедуры

// Тест: При пакетной обработке (ПакетнаяОбработка=Истина) накапливаются сообщения
Процедура ТестKafkaПакетнаяОбработкаНакапливаетСообщения() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "localhost:9092");
	Подписчик = ГенераторТестовыхДанных.ПодписчикKafka(Эндпоинт, "batch-topic", Истина);
	
	// Assert
	ЮТест.ОжидаетЧто(Подписчик.ПакетнаяОбработка)
		.Равно(Истина);
	
КонецПроцедуры

// }}}

// {{{ Набор: ФормированиеСообщенияKafka

// Тест: СформироватьСообщение преобразует данные в JSON
Процедура ТестKafkaСформироватьСообщениеВозвращаетJSON() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "localhost:9092");
	Подписчик = ГенераторТестовыхДанных.ПодписчикKafka(Эндпоинт);
	
	ДанныеСообщения = Новый Соответствие;
	ДанныеСообщения.Вставить("event", "order_created");
	ДанныеСообщения.Вставить("payload", "test_data");
	
	ИдентификаторСообщения = Новый УникальныйИдентификатор;
	
	// Act
	Сообщение = Справочники.инт_ПодписчикиKafka.СформироватьСообщение(ДанныеСообщения, Подписчик, ИдентификаторСообщения);
	
	// Assert
	ЮТест.ОжидаетЧто(Сообщение)
		.ИмеетТип("Строка")
		.Заполнено()
		.Содержит("event")
		.Содержит("order_created");
	
КонецПроцедуры

// }}}

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#КонецОбласти
