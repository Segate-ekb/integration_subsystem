// BSLLS-off
// @strict-types
////////////////////////////////////////////////////////////////////////////////
// СПР_инт_ПодписчикиJRPC_ММ
// Юнит-тесты проверки авторизации эндпоинтов для JRPC-подписчиков
////////////////////////////////////////////////////////////////////////////////

#Область СлужебныйПрограммныйИнтерфейс

Процедура ИсполняемыеСценарии() Экспорт
	
	ЮТТесты.УдалениеТестовыхДанных()
		.ВТранзакции()
		.ДобавитьТестовыйНабор("АвторизацияЭндпоинтаJRPC")
			.ДобавитьТест("ТестJRPCПодписчикСBasicАвторизациейПолучаетКорректнуюСессию")
			.ДобавитьТест("ТестJRPCПодписчикСBearerАвторизациейПолучаетКорректнуюСессию")
			.ДобавитьТест("ТестJRPCПодписчикСApiKeyАвторизациейПолучаетКорректнуюСессию")
			.ДобавитьТест("ТестJRPCПодписчикСDigestАвторизациейПолучаетКорректнуюСессию")
			.ДобавитьТест("ТестJRPCПодписчикБезАвторизации")
		.ДобавитьТестовыйНабор("ПараметрыСоединенияJRPC")
			.ДобавитьТест("ТестJRPCПараметрыСоединенияСодержатАдресРесурса")
			.ДобавитьТест("ТестJRPCПараметрыСоединенияТаймаут");
			
КонецПроцедуры

#КонецОбласти

#Область Тесты

// {{{ Набор: АвторизацияЭндпоинтаJRPC

// Тест: JRPC-подписчик с Basic авторизацией получает корректную сессию
Процедура ТестJRPCПодписчикСBasicАвторизациейПолучаетКорректнуюСессию() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтBasic("jrpc_user", "jrpc_pass", "https://jrpc.example.com/rpc");
	Подписчик = ГенераторТестовыхДанных.ПодписчикJRPC(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert
	Аутентификация = ПараметрыСоединения.Сессия.Аутентификация;
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("Basic")
		.Свойство("Пользователь").Равно("jrpc_user")
		.Свойство("Пароль").Равно("jrpc_pass");

КонецПроцедуры

// Тест: JRPC-подписчик с Bearer авторизацией получает корректную сессию
Процедура ТестJRPCПодписчикСBearerАвторизациейПолучаетКорректнуюСессию() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтBearer("jrpc_bearer_token_xyz");
	Подписчик = ГенераторТестовыхДанных.ПодписчикJRPC(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert
	Аутентификация = ПараметрыСоединения.Сессия.Аутентификация;
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("Bearer")
		.Свойство("Токен").Равно("jrpc_bearer_token_xyz");

КонецПроцедуры

// Тест: JRPC-подписчик с ApiKey авторизацией получает корректную сессию
Процедура ТестJRPCПодписчикСApiKeyАвторизациейПолучаетКорректнуюСессию() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтApiKey("X-JRPC-Key", "jrpc_api_key_secret");
	Подписчик = ГенераторТестовыхДанных.ПодписчикJRPC(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert
	Аутентификация = ПараметрыСоединения.Сессия.Аутентификация;
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("ApiKey")
		.Свойство("ИмяЗаголовка").Равно("X-JRPC-Key")
		.Свойство("Значение").Равно("jrpc_api_key_secret");

КонецПроцедуры

// Тест: JRPC-подписчик с Digest авторизацией получает корректную сессию
Процедура ТестJRPCПодписчикСDigestАвторизациейПолучаетКорректнуюСессию() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтDigest("digest_jrpc", "digest_jrpc_pass");
	Подписчик = ГенераторТестовыхДанных.ПодписчикJRPC(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert
	Аутентификация = ПараметрыСоединения.Сессия.Аутентификация;
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("Digest")
		.Свойство("Пользователь").Равно("digest_jrpc")
		.Свойство("Пароль").Равно("digest_jrpc_pass");

КонецПроцедуры

// Тест: JRPC-подписчик без авторизации — сессия не содержит аутентификации
Процедура ТестJRPCПодписчикБезАвторизации() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "https://public-jrpc.example.com/rpc");
	Подписчик = ГенераторТестовыхДанных.ПодписчикJRPC(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(ПараметрыСоединения.Сессия.Аутентификация)
		.Равно(Неопределено);

КонецПроцедуры

// }}}

// {{{ Набор: ПараметрыСоединенияJRPC

// Тест: Параметры соединения содержат адрес ресурса из эндпоинта JRPC-подписчика
Процедура ТестJRPCПараметрыСоединенияСодержатАдресРесурса() Экспорт
	
	// Arrange
	АдресТест = "https://jrpc-service.example.com/api/rpc";
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтBasic("u", "p", АдресТест);
	Подписчик = ГенераторТестовыхДанных.ПодписчикJRPC(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(ПараметрыСоединения.АдресРесурса)
		.Равно(АдресТест);

КонецПроцедуры

// Тест: Пользовательский таймаут из эндпоинта JRPC-подписчика
Процедура ТестJRPCПараметрыСоединенияТаймаут() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "https://slow-jrpc.example.com", Истина, 90);
	Подписчик = ГенераторТестовыхДанных.ПодписчикJRPC(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(ПараметрыСоединения.Таймаут)
		.Равно(90);

КонецПроцедуры

// }}}

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#КонецОбласти
