// BSLLS-off
// @strict-types
////////////////////////////////////////////////////////////////////////////////
// ОМ_инт_РаботаСКафка
// Юнит-тесты для проверки авторизации Kafka
// Тестирование метода УстановитьПараметрыАвторизации
//
// Подход: создаём реальный экземпляр внешней компоненты simpleKafka1C,
// вызываем УстановитьПараметрыАвторизации, затем через ПолучитьПараметры()
// получаем JSON установленных параметров и сравниваем с эталонными значениями.
////////////////////////////////////////////////////////////////////////////////

#Область СлужебныйПрограммныйИнтерфейс

Процедура ИсполняемыеСценарии() Экспорт
	
	ЮТТесты.УдалениеТестовыхДанных()
		.ВТранзакции()
		.ДобавитьТестовыйНабор("РаннийВозврат")
			.ДобавитьТест("ТестПустойЭндпоинтНеУстанавливаетПараметры")
			.ДобавитьТест("ТестАнонимныйЭндпоинтНеУстанавливаетПараметры")
		.ДобавитьТестовыйНабор("ПроверкаПараметровАвторизации")
			.ДобавитьТест("ТестBasicАвторизация_УстанавливаетSASL_PLAIN")
			.ДобавитьТест("ТестDigestАвторизация_УстанавливаетSCRAM_SHA_512")
			.ДобавитьТест("ТестApiKeyАвторизация_УстанавливаетSASL_PLAINСApiKey")
			.ДобавитьТест("ТестBearerАвторизация_УстанавливаетOAUTHBEARER")
			.ДобавитьТест("ТестTlsАвторизация_УстанавливаетSSL");
			
КонецПроцедуры

#КонецОбласти

#Область Тесты

// {{{ Набор: РаннийВозврат

// Тест: При пустом эндпоинте метод не устанавливает никаких параметров
Процедура ТестПустойЭндпоинтНеУстанавливаетПараметры() Экспорт
	
	// Arrange
	Компонента = ПолучитьКомпоненту();
	
	// Act
	инт_РаботаСКафка.УстановитьПараметрыАвторизации(Компонента, Неопределено);
	
	// Assert — параметры не должны быть установлены
	Параметры = ПолучитьУстановленныеПараметры(Компонента);
	ЮТест.ОжидаетЧто(Параметры.Количество(), "Не должно быть установленных параметров авторизации").Равно(0);
	
КонецПроцедуры

// Тест: При анонимной авторизации метод не устанавливает параметры
Процедура ТестАнонимныйЭндпоинтНеУстанавливаетПараметры() Экспорт
	
	// Arrange
	Компонента = ПолучитьКомпоненту();
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "kafka-broker:9092");
	
	// Act
	инт_РаботаСКафка.УстановитьПараметрыАвторизации(Компонента, Эндпоинт);
	
	// Assert — анонимный тип = plaintext, параметры не устанавливаются
	Параметры = ПолучитьУстановленныеПараметры(Компонента);
	ЮТест.ОжидаетЧто(Параметры.Количество(), "Анонимный: параметры не должны устанавливаться").Равно(0);
	
КонецПроцедуры

// }}}

// {{{ Набор: ПроверкаПараметровАвторизации

// Тест: Basic авторизация устанавливает security.protocol=sasl_ssl, sasl.mechanism=PLAIN,
//       sasl.username и sasl.password
Процедура ТестBasicАвторизация_УстанавливаетSASL_PLAIN() Экспорт
	
	// Arrange
	Компонента = ПолучитьКомпоненту();
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтBasic("kafka_user", "kafka_pass", "kafka:9092");
	
	// Act
	инт_РаботаСКафка.УстановитьПараметрыАвторизации(Компонента, Эндпоинт);
	
	// Assert
	Параметры = ПолучитьУстановленныеПараметры(Компонента);
	ЮТест.ОжидаетЧто(Параметры.Получить("security.protocol")).Равно("sasl_ssl");
	ЮТест.ОжидаетЧто(Параметры.Получить("sasl.mechanism")).Равно("PLAIN");
	ЮТест.ОжидаетЧто(Параметры.Получить("sasl.username")).Равно("kafka_user");
	ЮТест.ОжидаетЧто(Параметры.Получить("sasl.password")).Равно("kafka_pass");
	
КонецПроцедуры

// Тест: Digest авторизация устанавливает security.protocol=sasl_ssl, sasl.mechanism=SCRAM-SHA-512,
//       sasl.username и sasl.password
Процедура ТестDigestАвторизация_УстанавливаетSCRAM_SHA_512() Экспорт
	
	// Arrange
	Компонента = ПолучитьКомпоненту();
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтDigest("scram_user", "scram_pass", "kafka:9092");
	
	// Act
	инт_РаботаСКафка.УстановитьПараметрыАвторизации(Компонента, Эндпоинт);
	
	// Assert
	Параметры = ПолучитьУстановленныеПараметры(Компонента);
	ЮТест.ОжидаетЧто(Параметры.Получить("security.protocol")).Равно("sasl_ssl");
	ЮТест.ОжидаетЧто(Параметры.Получить("sasl.mechanism")).Равно("SCRAM-SHA-512");
	ЮТест.ОжидаетЧто(Параметры.Получить("sasl.username")).Равно("scram_user");
	ЮТест.ОжидаетЧто(Параметры.Получить("sasl.password")).Равно("scram_pass");
	
КонецПроцедуры

// Тест: ApiKey авторизация устанавливает SASL/PLAIN с ИмяЗаголовка→username, Значение→password
Процедура ТестApiKeyАвторизация_УстанавливаетSASL_PLAINСApiKey() Экспорт
	
	// Arrange
	Компонента = ПолучитьКомпоненту();
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтApiKey("API-Key-Name", "api_key_value", "kafka:9092");
	
	// Act
	инт_РаботаСКафка.УстановитьПараметрыАвторизации(Компонента, Эндпоинт);
	
	// Assert
	Параметры = ПолучитьУстановленныеПараметры(Компонента);
	ЮТест.ОжидаетЧто(Параметры.Получить("security.protocol")).Равно("sasl_ssl");
	ЮТест.ОжидаетЧто(Параметры.Получить("sasl.mechanism")).Равно("PLAIN");
	ЮТест.ОжидаетЧто(Параметры.Получить("sasl.username")).Равно("API-Key-Name");
	ЮТест.ОжидаетЧто(Параметры.Получить("sasl.password")).Равно("api_key_value");
	
КонецПроцедуры

// Тест: Bearer авторизация устанавливает OAUTHBEARER/OIDC параметры
Процедура ТестBearerАвторизация_УстанавливаетOAUTHBEARER() Экспорт
	
	// Arrange
	Компонента = ПолучитьКомпоненту();
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтBearer("oauth_client_id_token", "kafka:9092");
	
	// Act
	инт_РаботаСКафка.УстановитьПараметрыАвторизации(Компонента, Эндпоинт);
	
	// Assert — проверяем основные OIDC параметры
	Параметры = ПолучитьУстановленныеПараметры(Компонента);
	ЮТест.ОжидаетЧто(Параметры.Получить("security.protocol")).Равно("sasl_ssl");
	ЮТест.ОжидаетЧто(Параметры.Получить("sasl.mechanism")).Равно("OAUTHBEARER");
	ЮТест.ОжидаетЧто(Параметры.Получить("sasl.oauthbearer.method")).Равно("oidc");
	ЮТест.ОжидаетЧто(Параметры.Получить("sasl.oauthbearer.client.id")).Равно("oauth_client_id_token");
	
КонецПроцедуры

// Тест: Tls авторизация устанавливает security.protocol=ssl
Процедура ТестTlsАвторизация_УстанавливаетSSL() Экспорт
	
	// Arrange
	Компонента = ПолучитьКомпоненту();
	Эндпоинт = СоздатьТестовыйЭндпоинтTls();
	
	// Act
	инт_РаботаСКафка.УстановитьПараметрыАвторизации(Компонента, Эндпоинт);
	
	// Assert
	Параметры = ПолучитьУстановленныеПараметры(Компонента);
	ЮТест.ОжидаетЧто(Параметры.Получить("security.protocol")).Равно("ssl");
	
	// Проверяем наличие пути к файлу сертификата (точный путь зависит от ОС)
	ПутьСертификата = Параметры.Получить("ssl.certificate.location");
	ЮТест.ОжидаетЧто(ПутьСертификата, "ssl.certificate.location должен содержать путь к cert.pem").Заполнено();
	
	// Проверяем пароль приватного ключа
	ЮТест.ОжидаетЧто(Параметры.Получить("ssl.key.password")).Равно("test_cert_password");
	
КонецПроцедуры

// }}}

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Создаёт экземпляр внешней компоненты simpleKafka1C.
// Если компонента не доступна — тест пропускается.
//
// Возвращаемое значение:
//  AddIn - Экземпляр компоненты
//
Функция ПолучитьКомпоненту()
	
	Попытка
		ПодключитьВнешнююКомпоненту("ОбщийМакет.инт_simple_kafka", "IntegrationTest",
			ТипВнешнейКомпоненты.Native, ТипПодключенияВнешнейКомпоненты.НеИзолированно);
		Компонента = Новый("AddIn.IntegrationTest.simpleKafka1C");
	Исключение
		ЮТест.Пропустить("Внешняя компонента simpleKafka1C не доступна: " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;
	
	Возврат Компонента;
	
КонецФункции

// Получает установленные параметры компоненты в виде Соответствия.
// Вызывает Компонента.ПолучитьПараметры() и парсит результат JSON.
//
// Параметры:
//  Компонента - AddIn - Экземпляр внешней компоненты
//
// Возвращаемое значение:
//  Соответствие - Ключ: имя параметра, Значение: значение параметра
//
Функция ПолучитьУстановленныеПараметры(Компонента)
	
	Результат = Новый Соответствие;
	
	ПараметрыJSON = Компонента.ПолучитьПараметры();
	Если ПустаяСтрока(ПараметрыJSON) Тогда
		Возврат Результат;
	КонецЕсли;
	
	Данные = инт_КоннекторHTTP.JsonВОбъект(ПараметрыJSON);
	МассивПараметров = Данные.Получить("parameters");
	
	Если МассивПараметров <> Неопределено Тогда
		Для Каждого Параметр Из МассивПараметров Цикл
			Результат.Вставить(Параметр.Получить("key"), Параметр.Получить("value"));
		КонецЦикла;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Создаёт тестовый эндпоинт Tls с корректными ключами безопасного хранилища
// для авторизации Kafka (Tls_Сертификат, Tls_ПарольСертификата).
//
// Возвращаемое значение:
//  СправочникСсылка.инт_Эндпоинты - Ссылка на эндпоинт
//
Функция СоздатьТестовыйЭндпоинтTls()
	
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Tls", "kafka-ssl:9093");
	
	// Записываем тестовые данные с правильными ключами для Kafka TLS
	УстановитьПривилегированныйРежим(Истина);
	
	// Тестовый клиентский сертификат (ДвоичныеДанные) — запишем простую строку как двоичные данные
	ТестовыйСертификат = ПолучитьДвоичныеДанныеИзСтроки("-----BEGIN CERTIFICATE-----\nTEST\n-----END CERTIFICATE-----");
	инт_РаботаСБезопаснымХранилищем.ЗаписатьДанныеВБезопасноеХранилище(Эндпоинт, ТестовыйСертификат, "Tls_Сертификат");
	
	// Пароль приватного ключа (Строка)
	инт_РаботаСБезопаснымХранилищем.ЗаписатьДанныеВБезопасноеХранилище(Эндпоинт, "test_cert_password", "Tls_ПарольСертификата");
	
	// Тестовый приватный ключ (ДвоичныеДанные)
	ТестовыйКлюч = ПолучитьДвоичныеДанныеИзСтроки("-----BEGIN PRIVATE KEY-----\nTEST\n-----END PRIVATE KEY-----");
	инт_РаботаСБезопаснымХранилищем.ЗаписатьДанныеВБезопасноеХранилище(Эндпоинт, ТестовыйКлюч, "Kafka_КлючСертификата");
	
	УстановитьПривилегированныйРежим(Ложь);
	
	Возврат Эндпоинт;
	
КонецФункции

#КонецОбласти

