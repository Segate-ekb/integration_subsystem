// BSLLS-off
// @strict-types
////////////////////////////////////////////////////////////////////////////////
// СПР_инт_ПодписчикиHTTP_ММ
// Юнит-тесты проверки авторизации эндпоинтов для HTTP-подписчиков
////////////////////////////////////////////////////////////////////////////////

#Область СлужебныйПрограммныйИнтерфейс

Процедура ИсполняемыеСценарии() Экспорт
	
	ЮТТесты.УдалениеТестовыхДанных()
		.ВТранзакции()
		.ДобавитьТестовыйНабор("АвторизацияЭндпоинтаHTTP")
			.ДобавитьТест("ТестHTTPПодписчикСBasicАвторизациейПолучаетКорректнуюСессию")
			.ДобавитьТест("ТестHTTPПодписчикСBearerАвторизациейПолучаетКорректнуюСессию")
			.ДобавитьТест("ТестHTTPПодписчикСApiKeyАвторизациейПолучаетКорректнуюСессию")
			.ДобавитьТест("ТестHTTPПодписчикСDigestАвторизациейПолучаетКорректнуюСессию")
			.ДобавитьТест("ТестHTTPПодписчикБезАвторизации")
		.ДобавитьТестовыйНабор("ПараметрыСоединенияHTTP")
			.ДобавитьТест("ТестHTTPПараметрыСоединенияСодержатАдресРесурса")
			.ДобавитьТест("ТестHTTPПараметрыСоединенияSSLФлаг")
			.ДобавитьТест("ТестHTTPПараметрыСоединенияТаймаут")
		.ДобавитьТестовыйНабор("ФормированиеСообщенияHTTP")
			.ДобавитьТест("ТестHTTPСформироватьСообщениеВозвращаетJSON");
			
КонецПроцедуры

#КонецОбласти

#Область Тесты

// {{{ Набор: АвторизацияЭндпоинтаHTTP

// Тест: HTTP-подписчик с Basic авторизацией получает корректную сессию
Процедура ТестHTTPПодписчикСBasicАвторизациейПолучаетКорректнуюСессию() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтBasic("http_user", "http_pass", "https://api.example.com");
	Подписчик = ГенераторТестовыхДанных.ПодписчикHTTP(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert
	Аутентификация = ПараметрыСоединения.Сессия.Аутентификация;
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("Basic")
		.Свойство("Пользователь").Равно("http_user")
		.Свойство("Пароль").Равно("http_pass");
	
КонецПроцедуры

// Тест: HTTP-подписчик с Bearer авторизацией получает корректную сессию
Процедура ТестHTTPПодписчикСBearerАвторизациейПолучаетКорректнуюСессию() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтBearer("http_bearer_token_abc");
	Подписчик = ГенераторТестовыхДанных.ПодписчикHTTP(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert
	Аутентификация = ПараметрыСоединения.Сессия.Аутентификация;
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("Bearer")
		.Свойство("Токен").Равно("http_bearer_token_abc");
	
КонецПроцедуры

// Тест: HTTP-подписчик с ApiKey авторизацией получает корректную сессию
Процедура ТестHTTPПодписчикСApiKeyАвторизациейПолучаетКорректнуюСессию() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтApiKey("X-Custom-Key", "http_api_secret");
	Подписчик = ГенераторТестовыхДанных.ПодписчикHTTP(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert
	Аутентификация = ПараметрыСоединения.Сессия.Аутентификация;
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("ApiKey")
		.Свойство("ИмяЗаголовка").Равно("X-Custom-Key")
		.Свойство("Значение").Равно("http_api_secret");
	
КонецПроцедуры

// Тест: HTTP-подписчик с Digest авторизацией получает корректную сессию
Процедура ТестHTTPПодписчикСDigestАвторизациейПолучаетКорректнуюСессию() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтDigest("digest_http_user", "digest_http_pass");
	Подписчик = ГенераторТестовыхДанных.ПодписчикHTTP(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert
	Аутентификация = ПараметрыСоединения.Сессия.Аутентификация;
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("Digest")
		.Свойство("Пользователь").Равно("digest_http_user")
		.Свойство("Пароль").Равно("digest_http_pass");
	
КонецПроцедуры

// Тест: HTTP-подписчик без авторизации — сессия не содержит аутентификации
Процедура ТестHTTPПодписчикБезАвторизации() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "https://public.api.com");
	Подписчик = ГенераторТестовыхДанных.ПодписчикHTTP(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(ПараметрыСоединения.Сессия.Аутентификация)
		.Равно(Неопределено);
	
КонецПроцедуры

// }}}

// {{{ Набор: ПараметрыСоединенияHTTP

// Тест: Параметры соединения содержат адрес ресурса из эндпоинта подписчика
Процедура ТестHTTPПараметрыСоединенияСодержатАдресРесурса() Экспорт
	
	// Arrange
	АдресТест = "https://test-http-service.example.com/api/v2";
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтBasic("u", "p", АдресТест);
	Подписчик = ГенераторТестовыхДанных.ПодписчикHTTP(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(ПараметрыСоединения.АдресРесурса)
		.Равно(АдресТест);
	
КонецПроцедуры

// Тест: Флаг проверки SSL корректно передаётся в параметры соединения
Процедура ТестHTTPПараметрыСоединенияSSLФлаг() Экспорт
	
	// Arrange — отключённая проверка SSL
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "https://self-signed.example.com", Ложь, 30);
	Подписчик = ГенераторТестовыхДанных.ПодписчикHTTP(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(ПараметрыСоединения.ПроверятьSSL)
		.Равно(Ложь);
	
КонецПроцедуры

// Тест: Пользовательский таймаут из эндпоинта передаётся в параметры
Процедура ТестHTTPПараметрыСоединенияТаймаут() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "https://slow.example.com", Истина, 60);
	Подписчик = ГенераторТестовыхДанных.ПодписчикHTTP(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(ПараметрыСоединения.Таймаут)
		.Равно(60);
	
КонецПроцедуры

// }}}

// {{{ Набор: ФормированиеСообщенияHTTP

// Тест: СформироватьСообщение возвращает JSON-строку
Процедура ТестHTTPСформироватьСообщениеВозвращаетJSON() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтBasic("u", "p");
	Подписчик = ГенераторТестовыхДанных.ПодписчикHTTP(Эндпоинт);
	
	ДанныеСообщения = Новый Соответствие;
	ДанныеСообщения.Вставить("key", "value");
	
	ИдентификаторСообщения = Новый УникальныйИдентификатор;
	
	// Act
	Сообщение = Справочники.инт_ПодписчикиHTTP.СформироватьСообщение(ДанныеСообщения, Подписчик, ИдентификаторСообщения);
	
	// Assert
	ЮТест.ОжидаетЧто(Сообщение)
		.ИмеетТип("Строка")
		.Заполнено()
		.Содержит("key")
		.Содержит("value");
	
КонецПроцедуры

// }}}

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#КонецОбласти
