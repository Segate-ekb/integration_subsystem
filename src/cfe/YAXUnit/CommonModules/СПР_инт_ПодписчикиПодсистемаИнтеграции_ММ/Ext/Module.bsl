// BSLLS-off
// @strict-types
////////////////////////////////////////////////////////////////////////////////
// СПР_инт_ПодписчикиПодсистемаИнтеграции_ММ
// Юнит-тесты проверки авторизации эндпоинтов для подписчиков ПодсистемаИнтеграции
// URL по шаблону: {base}/hs/api/v1/{flow}/{msgId} с сессионной авторизацией
////////////////////////////////////////////////////////////////////////////////

#Область СлужебныйПрограммныйИнтерфейс

Процедура ИсполняемыеСценарии() Экспорт
	
	ЮТТесты.УдалениеТестовыхДанных()
		.ВТранзакции()
		.ДобавитьТестовыйНабор("АвторизацияЭндпоинтаПодсистемаИнтеграции")
			.ДобавитьТест("ТестПодсистемаИнтеграцииСBasicАвторизациейПолучаетКорректнуюСессию")
			.ДобавитьТест("ТестПодсистемаИнтеграцииСBearerАвторизациейПолучаетКорректнуюСессию")
			.ДобавитьТест("ТестПодсистемаИнтеграцииСApiKeyАвторизациейПолучаетКорректнуюСессию")
			.ДобавитьТест("ТестПодсистемаИнтеграцииСDigestАвторизациейПолучаетКорректнуюСессию")
			.ДобавитьТест("ТестПодсистемаИнтеграцииБезАвторизации")
		.ДобавитьТестовыйНабор("ПараметрыСоединенияПодсистемаИнтеграции")
			.ДобавитьТест("ТестПараметрыСоединенияСодержатАдресРесурсаБазы")
			.ДобавитьТест("ТестПараметрыСоединенияТаймаут");
			
КонецПроцедуры

#КонецОбласти

#Область Тесты

// {{{ Набор: АвторизацияЭндпоинтаПодсистемаИнтеграции

// Тест: Подписчик ПодсистемаИнтеграции с Basic авторизацией
Процедура ТестПодсистемаИнтеграцииСBasicАвторизациейПолучаетКорректнуюСессию() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтBasic("int_user", "int_pass", "https://remote-base.example.com");
	Подписчик = ГенераторТестовыхДанных.ПодписчикПодсистемаИнтеграции(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert
	Аутентификация = ПараметрыСоединения.Сессия.Аутентификация;
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("Basic")
		.Свойство("Пользователь").Равно("int_user")
		.Свойство("Пароль").Равно("int_pass");
	
КонецПроцедуры

// Тест: Подписчик ПодсистемаИнтеграции с Bearer авторизацией
Процедура ТестПодсистемаИнтеграцииСBearerАвторизациейПолучаетКорректнуюСессию() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтBearer("int_bearer_token_abc");
	Подписчик = ГенераторТестовыхДанных.ПодписчикПодсистемаИнтеграции(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert
	Аутентификация = ПараметрыСоединения.Сессия.Аутентификация;
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("Bearer")
		.Свойство("Токен").Равно("int_bearer_token_abc");
	
КонецПроцедуры

// Тест: Подписчик ПодсистемаИнтеграции с ApiKey авторизацией
Процедура ТестПодсистемаИнтеграцииСApiKeyАвторизациейПолучаетКорректнуюСессию() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтApiKey("X-Integration-Key", "int_api_key_secret");
	Подписчик = ГенераторТестовыхДанных.ПодписчикПодсистемаИнтеграции(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert
	Аутентификация = ПараметрыСоединения.Сессия.Аутентификация;
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("ApiKey")
		.Свойство("ИмяЗаголовка").Равно("X-Integration-Key")
		.Свойство("Значение").Равно("int_api_key_secret");
	
КонецПроцедуры

// Тест: Подписчик ПодсистемаИнтеграции с Digest авторизацией
Процедура ТестПодсистемаИнтеграцииСDigestАвторизациейПолучаетКорректнуюСессию() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтDigest("digest_int_user", "digest_int_pass");
	Подписчик = ГенераторТестовыхДанных.ПодписчикПодсистемаИнтеграции(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert
	Аутентификация = ПараметрыСоединения.Сессия.Аутентификация;
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("Digest")
		.Свойство("Пользователь").Равно("digest_int_user")
		.Свойство("Пароль").Равно("digest_int_pass");
	
КонецПроцедуры

// Тест: Подписчик ПодсистемаИнтеграции без авторизации
Процедура ТестПодсистемаИнтеграцииБезАвторизации() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "https://public-base.example.com");
	Подписчик = ГенераторТестовыхДанных.ПодписчикПодсистемаИнтеграции(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(ПараметрыСоединения.Сессия.Аутентификация)
		.Равно(Неопределено);
	
КонецПроцедуры

// }}}

// {{{ Набор: ПараметрыСоединенияПодсистемаИнтеграции

// Тест: Адрес ресурса используется как базовый URL для формирования пути /hs/api/v1/{flow}/{msgId}
Процедура ТестПараметрыСоединенияСодержатАдресРесурсаБазы() Экспорт
	
	// Arrange
	АдресБазы = "https://remote-1c-base.example.com";
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтBasic("u", "p", АдресБазы);
	Подписчик = ГенераторТестовыхДанных.ПодписчикПодсистемаИнтеграции(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert — адрес ресурса должен быть базовым URL
	ЮТест.ОжидаетЧто(ПараметрыСоединения.АдресРесурса)
		.Равно(АдресБазы);
	
КонецПроцедуры

// Тест: Таймаут эндпоинта подписчика ПодсистемаИнтеграции
Процедура ТестПараметрыСоединенияТаймаут() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "https://slow-remote-base.example.com", Истина, 120);
	Подписчик = ГенераторТестовыхДанных.ПодписчикПодсистемаИнтеграции(Эндпоинт);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(ПараметрыСоединения.Таймаут)
		.Равно(120);
	
КонецПроцедуры

// }}}

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#КонецОбласти
