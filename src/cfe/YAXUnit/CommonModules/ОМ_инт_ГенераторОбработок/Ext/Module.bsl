// BSLLS-off
// @strict-types

/////////////////////////////////////////////////////////////////////////////////
// Тесты для общего модуля инт_ГенераторОбработок
// Проверка разбора кода на блоки и формирования модуля объекта.
/////////////////////////////////////////////////////////////////////////////////

#Область СлужебныйПрограммныйИнтерфейс

Процедура ИсполняемыеСценарии() Экспорт
	
	ЮТТесты
		.ДобавитьТестовыйНабор("РазобратьКодНаБлоки")
			.ДобавитьТест("РазобратьКод_ТолькоТело")
			.ДобавитьТест("РазобратьКод_ТолькоПроцедура")
			.ДобавитьТест("РазобратьКод_ПроцедураИТело")
			.ДобавитьТест("РазобратьКод_ФункцияИТело")
			.ДобавитьТест("РазобратьКод_НесколькоПроцедурИТело")
			.ДобавитьТест("РазобратьКод_НезакрытыйБлокСтановитсяТелом")
			.ДобавитьТест("РазобратьКод_ПустойКод")
		.ДобавитьТестовыйНабор("СформироватьМодульОбъекта")
			.ДобавитьТест("Модуль_ТолькоТело_СодержитОбработать")
			.ДобавитьТест("Модуль_СПроцедурой_ПроцедураНаУровнеМодуля")
			.ДобавитьТест("Модуль_СДопПеременными_СодержитОтветИПостПроцессинг")
		;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// {{{ РазобратьКодНаБлоки

Процедура РазобратьКод_ТолькоТело() Экспорт
	
	// Arrange
	Код = "Результат.Вставить(""Ключ"", ИсходныеДанные.Наименование);";
	
	// Act
	Блоки = инт_ГенераторОбработок.РазобратьКодНаБлоки(Код);
	
	// Assert
	ЮТест.ОжидаетЧто(Блоки.БлокиПроцедур.Количество()).Равно(0);
	ЮТест.ОжидаетЧто(Блоки.ТелоКода).Содержит("Результат.Вставить");
	
КонецПроцедуры

Процедура РазобратьКод_ТолькоПроцедура() Экспорт
	
	// Arrange
	Код = "Процедура МояПроцедура()
	|	Сообщить(""Привет"");
	|КонецПроцедуры";
	
	// Act
	Блоки = инт_ГенераторОбработок.РазобратьКодНаБлоки(Код);
	
	// Assert
	ЮТест.ОжидаетЧто(Блоки.БлокиПроцедур.Количество()).Равно(1);
	ЮТест.ОжидаетЧто(Блоки.БлокиПроцедур[0]).Содержит("Процедура МояПроцедура");
	ЮТест.ОжидаетЧто(Блоки.ТелоКода).Равно("");
	
КонецПроцедуры

Процедура РазобратьКод_ПроцедураИТело() Экспорт
	
	// Arrange
	Код = "Процедура Помощник(Значение)
	|	Результат.Вставить(""helper"", Значение);
	|КонецПроцедуры
	|
	|Помощник(ИсходныеДанные.Наименование);";
	
	// Act
	Блоки = инт_ГенераторОбработок.РазобратьКодНаБлоки(Код);
	
	// Assert
	ЮТест.ОжидаетЧто(Блоки.БлокиПроцедур.Количество()).Равно(1);
	ЮТест.ОжидаетЧто(Блоки.БлокиПроцедур[0]).Содержит("Процедура Помощник");
	ЮТест.ОжидаетЧто(Блоки.ТелоКода).Содержит("Помощник(ИсходныеДанные");
	
КонецПроцедуры

Процедура РазобратьКод_ФункцияИТело() Экспорт
	
	// Arrange
	Код = "Функция ПолучитьЗначение(Ключ)
	|	Возврат ИсходныеДанные[Ключ];
	|КонецФункции
	|
	|Результат.Вставить(""val"", ПолучитьЗначение(""Имя""));";
	
	// Act
	Блоки = инт_ГенераторОбработок.РазобратьКодНаБлоки(Код);
	
	// Assert
	ЮТест.ОжидаетЧто(Блоки.БлокиПроцедур.Количество()).Равно(1);
	ЮТест.ОжидаетЧто(Блоки.БлокиПроцедур[0]).Содержит("Функция ПолучитьЗначение");
	ЮТест.ОжидаетЧто(Блоки.ТелоКода).Содержит("ПолучитьЗначение(""Имя"")");
	
КонецПроцедуры

Процедура РазобратьКод_НесколькоПроцедурИТело() Экспорт
	
	// Arrange
	Код = "Функция Сумма(А, Б)
	|	Возврат А + Б;
	|КонецФункции
	|
	|Процедура Логировать(Сообщение)
	|	// пока ничего
	|КонецПроцедуры
	|
	|Результат.Вставить(""итого"", Сумма(1, 2));";
	
	// Act
	Блоки = инт_ГенераторОбработок.РазобратьКодНаБлоки(Код);
	
	// Assert
	ЮТест.ОжидаетЧто(Блоки.БлокиПроцедур.Количество()).Равно(2);
	ЮТест.ОжидаетЧто(Блоки.БлокиПроцедур[0]).Содержит("Функция Сумма");
	ЮТест.ОжидаетЧто(Блоки.БлокиПроцедур[1]).Содержит("Процедура Логировать");
	ЮТест.ОжидаетЧто(Блоки.ТелоКода).Содержит("Сумма(1, 2)");
	
КонецПроцедуры

Процедура РазобратьКод_НезакрытыйБлокСтановитсяТелом() Экспорт
	
	// Arrange — процедура без КонецПроцедуры
	Код = "Процедура Незавершённая()
	|	Сообщить(""тест"");";
	
	// Act
	Блоки = инт_ГенераторОбработок.РазобратьКодНаБлоки(Код);
	
	// Assert — незакрытый блок попадает в тело кода
	ЮТест.ОжидаетЧто(Блоки.БлокиПроцедур.Количество()).Равно(0);
	ЮТест.ОжидаетЧто(Блоки.ТелоКода).Содержит("Процедура Незавершённая");
	
КонецПроцедуры

Процедура РазобратьКод_ПустойКод() Экспорт
	
	// Arrange
	Код = "";
	
	// Act
	Блоки = инт_ГенераторОбработок.РазобратьКодНаБлоки(Код);
	
	// Assert
	ЮТест.ОжидаетЧто(Блоки.БлокиПроцедур.Количество()).Равно(0);
	ЮТест.ОжидаетЧто(Блоки.ТелоКода).Равно("");
	
КонецПроцедуры

// }}}

// {{{ СформироватьМодульОбъекта

Процедура Модуль_ТолькоТело_СодержитОбработать() Экспорт
	
	// Arrange
	Код = "Результат.Вставить(""key"", ИсходныеДанные.Наименование);";
	
	// Act
	Результат = инт_ГенераторОбработок.СформироватьМодульОбъекта(Код);
	Модуль = Результат.ТекстМодуля;
	
	// Assert
	ЮТест.ОжидаетЧто(Модуль).Содержит("Перем Результат Экспорт;");
	ЮТест.ОжидаетЧто(Модуль).Содержит("Перем ИсходныеДанные;");
	ЮТест.ОжидаетЧто(Модуль).Содержит("Функция Обработать(пИсходныеДанные) Экспорт");
	ЮТест.ОжидаетЧто(Модуль).Содержит("Возврат Результат;");
	ЮТест.ОжидаетЧто(Модуль).Содержит("КонецФункции");
	ЮТест.ОжидаетЧто(Модуль).Содержит("Результат.Вставить");
	
КонецПроцедуры

Процедура Модуль_СПроцедурой_ПроцедураНаУровнеМодуля() Экспорт
	
	// Arrange
	Код = "Функция МояФункция()
	|	Возврат 42;
	|КонецФункции
	|
	|Результат.Вставить(""answer"", МояФункция());";
	
	// Act
	Результат = инт_ГенераторОбработок.СформироватьМодульОбъекта(Код);
	Модуль = Результат.ТекстМодуля;
	
	// Assert — функция на уровне модуля (вне Обработать)
	ЮТест.ОжидаетЧто(Модуль).Содержит("Функция МояФункция()");
	ЮТест.ОжидаетЧто(Модуль).Содержит("Возврат 42;");
	// Тело кода внутри Обработать
	ЮТест.ОжидаетЧто(Модуль).Содержит("МояФункция()");
	
КонецПроцедуры

Процедура Модуль_СДопПеременными_СодержитОтветИПостПроцессинг() Экспорт
	
	// Arrange
	ДопПеременные = Новый Структура("Ответ", "");
	Код = "Сообщить(Ответ.КодСостояния);";
	
	// Act
	Результат = инт_ГенераторОбработок.СформироватьМодульОбъекта(Код, ДопПеременные);
	Модуль = Результат.ТекстМодуля;
	
	// Assert
	ЮТест.ОжидаетЧто(Модуль).Содержит("Перем Ответ;");
	ЮТест.ОжидаетЧто(Модуль).Содержит("Процедура ОбработатьПостПроцессинг(пОтвет, пИсходныеДанные) Экспорт");
	ЮТест.ОжидаетЧто(Модуль).Содержит("Ответ = пОтвет;");
	
КонецПроцедуры

// }}}

#КонецОбласти
