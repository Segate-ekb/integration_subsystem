//©///////////////////////////////////////////////////////////////////////////©//
//
//  Copyright 2021-2025 BIA-Technologies Limited Liability Company
//
//  Licensed under the Apache License, Version 2.0 (the "License");
//  you may not use this file except in compliance with the License.
//  You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
//  Unless required by applicable law or agreed to in writing, software
//  distributed under the License is distributed on an "AS IS" BASIS,
//  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//  See the License for the specific language governing permissions and
//  limitations under the License.
//
//©///////////////////////////////////////////////////////////////////////////©//

#Область СлужебныйПрограммныйИнтерфейс

// ПараметрыЗапуска
//  Возвращает загруженные параметры запуска тестирования
// Параметры:
//  ПараметрыЗапускаСтрокой - Строка - Строка с параметрами запуска. 
//                                     Содержит ключ запуска и строку с конфигурационным файлом. 
//                                     Формат строки "RunUnitTests=/путь/к/конфигурационному/файлу", 
//                                     где ключ указывается обязательно, а путь - по желанию
//  Обработчик - ОписаниеОповещения
// 
// Возвращаемое значение:
//  см. ЮТФабрика.ПараметрыЗапуска
Функция ПараметрыЗапуска(Знач ПараметрыЗапускаСтрокой, Обработчик) Экспорт
	
	Попытка
		
		ПараметрыЗапускаПредприятия = ПараметрыЗапускаПредприятия(ПараметрыЗапускаСтрокой);
		Параметры = ПрочитатьПараметрыЗапуска(ПараметрыЗапускаПредприятия, Обработчик);
		
	Исключение
		
		ЮТРегистрацияОшибокСлужебный.ЗарегистрироватьОшибкуИнициализацииДвижка(ИнформацияОбОшибке(), "Ошибка чтения параметров запуска");
		Параметры = ЮТФабрика.ПараметрыЗапуска();
		
	КонецПопытки;
	
	Возврат Параметры;
	
КонецФункции

Функция ПараметрыТестированияПоУмолчанию() Экспорт
	
	ПараметрыТестирования = ЮТФабрика.ПараметрыЗапуска();
	ЮТСобытияСлужебный.УстановитьПараметрыЗапускаПоУмолчанию(ПараметрыТестирования);
	
	Возврат ПараметрыТестирования;
	
КонецФункции

Функция КлючЗапуска() Экспорт
	
	Возврат "RunUnitTests";
	
КонецФункции

Функция ЕстьПараметрыЗапускаТестов() Экспорт
	
	Если ПустаяСтрока(ПараметрЗапуска) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	ПараметрыЗапускаПредприятия = ПараметрыЗапускаПредприятия(ПараметрЗапуска);
	Возврат ПараметрыЗапускаПредприятия.Получить(КлючЗапускаНРег()) <> Неопределено;
	
КонецФункции

Функция ПараметрыЗапускаИзФайла(ИмяФайла, Обработчик) Экспорт
	
	Параметры = Новый Соответствие;
	Параметры.Вставить(КлючЗапускаНРег(), ИмяФайла);
	Возврат ПрочитатьПараметрыЗапуска(Параметры, Обработчик);
	
КонецФункции

Функция ФайлПараметровЗапускаТестирования() Экспорт
	
	ПараметрыЗапускаПредприятия = ПараметрыЗапускаПредприятия(ПараметрЗапуска);
	ИмяФайла = ПараметрыЗапускаПредприятия.Получить(КлючЗапускаНРег());
	
	Если ЗначениеЗаполнено(ИмяФайла) И ТипЗнч(ИмяФайла) = Тип("Строка") Тогда
		Возврат ИмяФайла;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Функции для получения констант проверки абсолютных путей

// МаксимальнаяДлинаСтрокиДляЧисла
//  Возвращает максимальную длину строки для преобразования в число
// 
// Возвращаемое значение:
//  Число - Максимальная длина строки для числа (20)
Функция МаксимальнаяДлинаСтрокиДляЧисла()
	Возврат 20;
КонецФункции

// МинимальнаяДлинаПутиWindows
//  Возвращает минимальную длину для пути вида C:\
// 
// Возвращаемое значение:
//  Число - Минимальная длина пути Windows (3)
Функция МинимальнаяДлинаПутиWindows()
	Возврат 3;
КонецФункции

// ПозицияДвоеточияWindows
//  Возвращает позицию двоеточия в пути C:\
// 
// Возвращаемое значение:
//  Число - Позиция двоеточия в пути Windows (2)
Функция ПозицияДвоеточияWindows()
	Возврат 2;
КонецФункции

// ПозицияСлешаWindows
//  Возвращает позицию слеша в пути C:\
// 
// Возвращаемое значение:
//  Число - Позиция слеша в пути Windows (3)
Функция ПозицияСлешаWindows()
	Возврат 3;
КонецФункции

// МинимальнаяДлинаСетевогоПути
//  Возвращает минимальную длину для сетевого пути \\
// 
// Возвращаемое значение:
//  Число - Минимальная длина сетевого пути (2)
Функция МинимальнаяДлинаСетевогоПути()
	Возврат 2;
КонецФункции

// РазрешитьОтносительныеПутиВПараметрах
//  Разрешает относительные пути во всех параметрах запуска
// Параметры:
//  ПараметрыТестирования - Структура - Параметры тестирования для обработки
Процедура РазрешитьОтносительныеПутиВПараметрах(ПараметрыТестирования)
	
	workspacePath = ЮТКоллекции.ЗначениеСтруктуры(ПараметрыТестирования, "workspacePath", "");
	projectPath = ЮТКоллекции.ЗначениеСтруктуры(ПараметрыТестирования, "projectPath", "");
	
	// Разрешаем основные пути
	РазрешитьОсновныеПути(ПараметрыТестирования, workspacePath, projectPath);
	
	// Разрешаем пути в логировании
	РазрешитьПутиЛогирования(ПараметрыТестирования, workspacePath, projectPath);
	
	// Разрешаем пути в множественных отчетах
	РазрешитьПутиОтчетов(ПараметрыТестирования, workspacePath, projectPath);
	
КонецПроцедуры

// РазрешитьОсновныеПути
//  Разрешает относительные пути в основных параметрах
// Параметры:
//  ПараметрыТестирования - Структура - Параметры тестирования для обработки
//  workspacePath - Строка - Путь к рабочему каталогу
//  projectPath - Строка - Путь к проекту
Процедура РазрешитьОсновныеПути(ПараметрыТестирования, workspacePath, projectPath)
	
	Если ПараметрыТестирования.Свойство("reportPath") И ЗначениеЗаполнено(ПараметрыТестирования.reportPath) Тогда
		ПараметрыТестирования.reportPath = РазрешитьОтносительныйПуть(ПараметрыТестирования.reportPath, workspacePath, projectPath);
	КонецЕсли;
	
	Если ПараметрыТестирования.Свойство("exitCode") И ЗначениеЗаполнено(ПараметрыТестирования.exitCode) Тогда
		ПараметрыТестирования.exitCode = РазрешитьОтносительныйПуть(ПараметрыТестирования.exitCode, workspacePath, projectPath);
	КонецЕсли;
	
КонецПроцедуры

// РазрешитьПутиЛогирования
//  Разрешает относительные пути в параметрах логирования
// Параметры:
//  ПараметрыТестирования - Структура - Параметры тестирования для обработки
//  workspacePath - Строка - Путь к рабочему каталогу
//  projectPath - Строка - Путь к проекту
Процедура РазрешитьПутиЛогирования(ПараметрыТестирования, workspacePath, projectPath)
	
	Если ПараметрыТестирования.Свойство("logging") И ТипЗнч(ПараметрыТестирования.logging) = Тип("Структура") Тогда
		Если ПараметрыТестирования.logging.Свойство("file") И ЗначениеЗаполнено(ПараметрыТестирования.logging.file) Тогда
			ПараметрыТестирования.logging.file = РазрешитьОтносительныйПуть(ПараметрыТестирования.logging.file, workspacePath, projectPath);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

// РазрешитьПутиОтчетов
//  Разрешает относительные пути в параметрах отчетов
// Параметры:
//  ПараметрыТестирования - Структура - Параметры тестирования для обработки
//  workspacePath - Строка - Путь к рабочему каталогу
//  projectPath - Строка - Путь к проекту
Процедура РазрешитьПутиОтчетов(ПараметрыТестирования, workspacePath, projectPath)
	
	Если ПараметрыТестирования.Свойство("reports") И ТипЗнч(ПараметрыТестирования.reports) = Тип("Массив") Тогда
		Для Каждого Отчет Из ПараметрыТестирования.reports Цикл
			Если ТипЗнч(Отчет) = Тип("Структура") И Отчет.Свойство("path") И ЗначениеЗаполнено(Отчет.path) Тогда
				Отчет.path = РазрешитьОтносительныйПуть(Отчет.path, workspacePath, projectPath);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

// ПрочитатьПараметрыЗапуска
// 	Читает параметры из строки запуска
// Параметры:
//  ПараметрыЗапускаПредприятия - Соответствие из Произвольный - Соответствие параметров запуска предприятия полученные из `ПараметрЗапуска`
//  Обработчик - ОписаниеОповещения
// 
// Возвращаемое значение:
//  см. ЮТФабрика.ПараметрыЗапуска
Функция ПрочитатьПараметрыЗапуска(ПараметрыЗапускаПредприятия, Обработчик)
	
	ПараметрыТестирования = ЮТФабрика.ПараметрыЗапуска();
	ЗагруженныеПараметрыТестирования = ПереданныеПараметрыТестирования(ПараметрыЗапускаПредприятия);
	
	ВыполнятьТестирование = ЮТКоллекции.ЗначениеСтруктуры(ЗагруженныеПараметрыТестирования, "ВыполнятьМодульноеТестирование", Ложь);
	
	Если ВыполнятьТестирование Тогда
		ЮТСобытияСлужебный.УстановитьПараметрыЗапускаПоУмолчанию(ПараметрыТестирования);
		ДополнитьПараметрыПрочитанными(ПараметрыТестирования, ЗагруженныеПараметрыТестирования);
		// Обратная совместимость для новых множественных отчетов
		Если (ПараметрыТестирования.reports = Неопределено ИЛИ ПараметрыТестирования.reports.Количество() = 0)
			И ЗначениеЗаполнено(ПараметрыТестирования.reportFormat) Тогда
			ЭлементОтчета = Новый Структура;
			ЭлементОтчета.Вставить("format", ПараметрыТестирования.reportFormat);
			Если ЗначениеЗаполнено(ПараметрыТестирования.reportPath) Тогда
				ЭлементОтчета.Вставить("path", ПараметрыТестирования.reportPath);
			КонецЕсли;
			ПараметрыТестирования.reports.Добавить(ЭлементОтчета);
		КонецЕсли;
		
		// Разрешаем относительные пути
		РазрешитьОтносительныеПутиВПараметрах(ПараметрыТестирования);
	КонецЕсли;
	
	ЮТАсинхроннаяОбработкаСлужебныйКлиент.ВызватьОбработчик(Обработчик, Параметрытестирования);
	Возврат Параметрытестирования;
	
КонецФункции

// ОбработатьБулевПараметр
//  Обрабатывает булев параметр запуска тестов
// Параметры:
//  ПараметрЗапускаТестов - Булево - Булев параметр запуска
//  Параметры - Структура - Структура параметров (изменяется)
// 
// Возвращаемое значение:
//  Булево - Истина, если нужно запускать тесты
Функция ОбработатьБулевПараметр(ПараметрЗапускаТестов, Параметры)
	
	ЗапускатьТесты = ПараметрЗапускаТестов;
	Если ЗапускатьТесты Тогда
		// RunUnitTests without value
		Параметры = Новый Структура("showReport, closeAfterTests");
		Параметры.showReport = Истина;
		Параметры.closeAfterTests = Ложь;
	КонецЕсли;
	
	Возврат ЗапускатьТесты;
	
КонецФункции

// ОбработатьСтроковыйПараметр
//  Обрабатывает строковый параметр запуска тестов
// Параметры:
//  ПараметрЗапускаТестов - Строка - Строковый параметр запуска
//  Параметры - Структура - Структура параметров (изменяется)
// 
// Возвращаемое значение:
//  Булево - Истина, если нужно запускать тесты
Функция ОбработатьСтроковыйПараметр(ПараметрЗапускаТестов, Параметры)
	
	ЗначениеНРег = НРег(ПараметрЗапускаТестов);
	
	Если ЗначениеНРег = "true" ИЛИ ЗначениеНРег = "истина" Тогда
		Возврат Истина;
	ИначеЕсли ЗначениеНРег = "false" ИЛИ ЗначениеНРег = "ложь" Тогда
		Возврат Ложь;
	ИначеЕсли ЗначениеЗаполнено(ПараметрЗапускаТестов) Тогда
		// Path to file
		Параметры = ПрочитатьКонфигурационныйФайл(ПараметрЗапускаТестов);
		Если Параметры = Неопределено Тогда
			Параметры = Новый Структура;
		КонецЕсли;
		Возврат Истина;
	Иначе
		// Неизвестное строковое значение
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции

Функция ПереданныеПараметрыТестирования(ПараметрыЗапускаПредприятия) Экспорт
	
	ПараметрЗапускаТестов = ЮТКоллекции.ЗначениеСоответствия(ПараметрыЗапускаПредприятия, КлючЗапускаНРег(), Ложь);
	
	ТипПараметра = ТипЗнч(ПараметрЗапускаТестов);
	
	ЗапускатьТесты = Ложь;
	Параметры = Новый Структура;
	
	Если ТипПараметра = Тип("Булево") Тогда
		ЗапускатьТесты = ОбработатьБулевПараметр(ПараметрЗапускаТестов, Параметры);
	ИначеЕсли ТипПараметра = Тип("Строка") Тогда
		ЗапускатьТесты = ОбработатьСтроковыйПараметр(ПараметрЗапускаТестов, Параметры);
	Иначе
		// Неизвестный тип параметра
		ЗапускатьТесты = Ложь;
	КонецЕсли;
	
	Параметры.Вставить("ВыполнятьМодульноеТестирование", ЗапускатьТесты);
	
	Если ЗапускатьТесты Тогда
		// Парсим дополнительные параметры из командной строки
		ДополнительныеПараметры = ПарсингДополнительныхПараметров(ПараметрыЗапускаПредприятия);
		СлитьПараметры(Параметры, ДополнительныеПараметры);
	КонецЕсли;
	
	Возврат Параметры;
	
КонецФункции

Функция ПараметрыЗапускаПредприятия(ПараметрыЗапускаСтрокой) Экспорт
	
	ПарыКлючЗначение = ЮТСтроки.РазделитьСтроку(ПараметрыЗапускаСтрокой, ";");
	
	ПараметрыЗапускаПредприятия = Новый Соответствие;
	
	Для Каждого Пара Из ПарыКлючЗначение Цикл
		
		Если ПустаяСтрока(Пара) Тогда
			Продолжить;
		КонецЕсли;
		
		КлючЗначение = ЮТСтроки.РазделитьСтроку(Пара, "=");
		Ключ = НРег(КлючЗначение[0]);
		
		Если КлючЗначение.Количество() = 1 Тогда
			ПараметрыЗапускаПредприятия.Вставить(Ключ, Истина);
		Иначе
			ПараметрыЗапускаПредприятия.Вставить(Ключ, КлючЗначение[1]);
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат ПараметрыЗапускаПредприятия;
	
КонецФункции

Функция ПрочитатьКонфигурационныйФайл(ПутьКФайлу)
	
#Если НЕ ВебКлиент Тогда
	
	Если ЮТОбщий.УстановленБезопасныйРежим() Тогда
		ВызватьИсключение "Расширение подключено в безопасном режиме. Чтение конфигурационного файла недоступно";
	КонецЕсли;
	
	ДанныеФайла = Неопределено;
	
	Попытка
		
		Текст = ЮТФайлы.ДанныеТекстовогоФайла(ПутьКФайлу);
		
		Если ЗначениеЗаполнено(Текст) Тогда
			ДанныеФайла = ЮТОбщий.ЗначениеИзJSON(Текст);
		КонецЕсли;
		
	Исключение
		
		ВызватьИсключение;
		
	КонецПопытки;
	
	Возврат ДанныеФайла;
	
#Иначе
	// будут использованы параметры по умолчанию
	Возврат Новый Структура;
#КонецЕсли

КонецФункции

Процедура ДополнитьПараметрыПрочитанными(Параметры, ДанныеДополнения)
	
	Для Каждого Параметр Из ДанныеДополнения Цикл
		
		Если НЕ Параметры.Свойство(Параметр.Ключ) Тогда
			Продолжить;
		КонецЕсли;
		
		Параметры[Параметр.Ключ] = Параметр.Значение;
		
	КонецЦикла;
	
КонецПроцедуры

Функция КлючЗапускаНРег() Экспорт
	
	Возврат НРег(КлючЗапуска());
	
КонецФункции

// ПарсингДополнительныхПараметров
//  Парсит дополнительные параметры из командной строки (после RunUnitTests)
// Параметры:
//  ПараметрыЗапускаПредприятия - Соответствие - Параметры запуска предприятия
// 
// Возвращаемое значение:
//  Структура - Дополнительные параметры из командной строки
Функция ПарсингДополнительныхПараметров(ПараметрыЗапускаПредприятия) Экспорт
	
	ДополнительныеПараметры = Новый Структура;
	КлючЗапуска = КлючЗапускаНРег();
	
	Для Каждого Параметр Из ПараметрыЗапускаПредприятия Цикл
		
		Если Параметр.Ключ = КлючЗапуска Тогда
			Продолжить; // Пропускаем основной ключ RunUnitTests
		КонецЕсли;
		
		// Преобразуем значения в правильные типы
		Значение = ПреобразоватьЗначениеПараметра(Параметр.Значение);
		ДополнительныеПараметры.Вставить(Параметр.Ключ, Значение);
		
	КонецЦикла;
	
	Возврат ДополнительныеПараметры;
	
КонецФункции

// СлитьПараметры
//  Сливает параметры с приоритетом дополнительных параметров
// Параметры:
//  БазовыеПараметры - Структура - Базовые параметры (изменяется)
//  ДополнительныеПараметры - Структура - Дополнительные параметры (приоритетные)
Процедура СлитьПараметры(БазовыеПараметры, ДополнительныеПараметры) Экспорт
	
	Для Каждого Параметр Из ДополнительныеПараметры Цикл
		
		// Переопределяем параметр, если он существует в базовых или добавляем новый
		БазовыеПараметры.Вставить(Параметр.Ключ, Параметр.Значение);
		
	КонецЦикла;
	
КонецПроцедуры

// ПреобразоватьЗначениеПараметра
//  Преобразует строковое значение параметра в соответствующий тип
// Параметры:
//  ЗначениеСтрокой - Строка - Значение параметра в виде строки
// 
// Возвращаемое значение:
//  Произвольный - Преобразованное значение
Функция ПреобразоватьЗначениеПараметра(ЗначениеСтрокой) Экспорт
	
	Если ТипЗнч(ЗначениеСтрокой) <> Тип("Строка") Тогда
		Возврат ЗначениеСтрокой;
	КонецЕсли;
	
	ЗначениеНРег = НРег(ЗначениеСтрокой);
	
	// Преобразуем булевы значения
	Если ЗначениеНРег = "true" ИЛИ ЗначениеНРег = "истина" Тогда
		Возврат Истина;
	ИначеЕсли ЗначениеНРег = "false" ИЛИ ЗначениеНРег = "ложь" Тогда
		Возврат Ложь;
	Иначе
		// Не булево значение, продолжаем обработку
	КонецЕсли;
	
	// Пытаемся преобразовать в число
	// Проверяем, что строка содержит только цифры, точку и знак минус
	Если СтрДлина(ЗначениеСтрокой) > 0 И СтрДлина(ЗначениеСтрокой) <= МаксимальнаяДлинаСтрокиДляЧисла() Тогда
		Если ЮТСтроки.ЭтоЧисловаяСтрока(ЗначениеСтрокой) Тогда
			Число = Число(ЗначениеСтрокой);
			// Проверяем, что преобразование прошло успешно
			Если НЕ (Число = 0 И ЗначениеСтрокой <> "0" И ЗначениеСтрокой <> "0.0") Тогда
				Возврат Число;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	// Возвращаем как строку
	Возврат ЗначениеСтрокой;
	
КонецФункции

// РазрешитьОтносительныйПуть
//  Разрешает относительный путь с учетом приоритета базовых каталогов
// Параметры:
//  Путь - Строка - Путь для разрешения
//  workspacePath - Строка - Путь к рабочему каталогу (приоритет 1)
//  projectPath - Строка - Путь к проекту (приоритет 2)
// 
// Возвращаемое значение:
//  Строка - Разрешенный путь
Функция РазрешитьОтносительныйПуть(Путь, workspacePath = "", projectPath = "") Экспорт
	
	Если ПустаяСтрока(Путь) Тогда
		Возврат Путь;
	КонецЕсли;
	
#Если НЕ ВебКлиент Тогда
	
	// Если путь абсолютный, возвращаем как есть
	Если ЭтоАбсолютныйПуть(Путь) Тогда
		Возврат Путь;
	КонецЕсли;
	
	// Определяем базовый каталог по приоритету
	БазовыйКаталог = "";
	
	Если ЗначениеЗаполнено(workspacePath) Тогда
		БазовыйКаталог = workspacePath;
	ИначеЕсли ЗначениеЗаполнено(projectPath) Тогда
		БазовыйКаталог = projectPath;
	Иначе
		// Используем каталог программы
		БазовыйКаталог = ".";
	КонецЕсли;
	
	// Объединяем пути
	Возврат ЮТФайлы.ОбъединитьПути(БазовыйКаталог, Путь);
	
#Иначе
	
	// В веб-клиенте не можем работать с путями
	Возврат Путь;
	
#КонецЕсли
	
КонецФункции

// ЭтоАбсолютныйПутьWindows
//  Проверяет, является ли путь абсолютным в Windows
// 
// Параметры:
//  Путь - Строка - Проверяемый путь
// 
// Возвращаемое значение:
//  Булево - Истина, если путь абсолютный в Windows
Функция ЭтоАбсолютныйПутьWindows(Путь)
	
	Возврат СтрДлина(Путь) >= МинимальнаяДлинаПутиWindows()
		И Сред(Путь, ПозицияДвоеточияWindows(), 1) = ":"
		И Сред(Путь, ПозицияСлешаWindows(), 1) = "\";
	
КонецФункции

// ЭтоСетевойПутьWindows
//  Проверяет, является ли путь сетевым в Windows
// 
// Параметры:
//  Путь - Строка - Проверяемый путь
// 
// Возвращаемое значение:
//  Булево - Истина, если путь сетевой в Windows
Функция ЭтоСетевойПутьWindows(Путь)
	
	Возврат СтрДлина(Путь) >= МинимальнаяДлинаСетевогоПути()
		И Лев(Путь, МинимальнаяДлинаСетевогоПути()) = "\\";
	
КонецФункции

// Проверяет, является ли путь абсолютным
// 
// Параметры:
//  Путь - Строка - Проверяемый путь
// 
// Возвращаемое значение:
//  Булево - Истина, если путь абсолютный
Функция ЭтоАбсолютныйПуть(Путь)
	
	Если ПустаяСтрока(Путь) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	#Если НЕ ВебКлиент Тогда
		Если ЮТОкружение.ЭтоWindows() Тогда
			// В Windows абсолютный путь начинается с буквы диска и двоеточия (C:\)
			// или с двух обратных слешей (\\server\)
			Если ЭтоАбсолютныйПутьWindows(Путь) Тогда
				Возврат Истина;
			КонецЕсли;
			
			Если ЭтоСетевойПутьWindows(Путь) Тогда
				Возврат Истина;
			КонецЕсли;
		Иначе
			// В Unix/Linux абсолютный путь начинается с "/"
			Если Лев(Путь, 1) = "/" Тогда
				Возврат Истина;
			КонецЕсли;
		КонецЕсли;
	#КонецЕсли
	
	Возврат Ложь;
	
КонецФункции

#КонецОбласти
