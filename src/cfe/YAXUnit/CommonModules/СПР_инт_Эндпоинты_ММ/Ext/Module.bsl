// BSLLS-off
// @strict-types
////////////////////////////////////////////////////////////////////////////////
// СПР_инт_Эндпоинты_ММ
// Юнит-тесты для модуля менеджера справочника инт_Эндпоинты
////////////////////////////////////////////////////////////////////////////////

#Область СлужебныйПрограммныйИнтерфейс

Процедура ИсполняемыеСценарии() Экспорт
	
	ЮТТесты.УдалениеТестовыхДанных()
		.ВТранзакции()
		.ДобавитьТестовыйНабор("ПолучитьАутентификацию")
			.ДобавитьТест("ТестПолучитьАутентификациюBasic")
			.ДобавитьТест("ТестПолучитьАутентификациюDigest")
			.ДобавитьТест("ТестПолучитьАутентификациюBearer")
			.ДобавитьТест("ТестПолучитьАутентификациюApiKey")
			.ДобавитьТест("ТестПолучитьАутентификациюTls")
			.ДобавитьТест("ТестПолучитьАутентификациюАнонимный")
			.ДобавитьТест("ТестПолучитьАутентификациюBasicКонкретныеДанные")
			.ДобавитьТест("ТестПолучитьАутентификациюDigestКонкретныеДанные")
			.ДобавитьТест("ТестПолучитьАутентификациюНеизвестныйТип")
		.ДобавитьТестовыйНабор("СтруктураПараметровСоединения")
			.ДобавитьТест("ТестСтруктураПараметровСоединения")
			.ДобавитьТест("ТестСтруктураПараметровСоединенияПоУмолчанию")
			.ДобавитьТест("ТестСтруктураПараметровСоединенияSSL")
			.ДобавитьТест("ТестСтруктураПараметровСоединенияКастомныйТаймаут")
			.ДобавитьТест("ТестСтруктураПараметровСоединенияСессияСодержитАутентификацию")
		.ДобавитьТестовыйНабор("АутентификацияВСессии")
			.ДобавитьТест("ТестСессияBasicСодержитКорректнуюАутентификацию")
			.ДобавитьТест("ТестСессияBearerСодержитКорректнуюАутентификацию")
			.ДобавитьТест("ТестСессияApiKeyСодержитКорректнуюАутентификацию")
			.ДобавитьТест("ТестСессияАнонимнаяБезАутентификации");
			
КонецПроцедуры

#КонецОбласти

#Область Тесты

// {{{ Набор: ПолучитьАутентификацию

// Тест: Получить аутентификацию Basic возвращает структуру с типом Basic
Процедура ТестПолучитьАутентификациюBasic() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтBasic("testuser", "testpass");
	
	// Act
	Аутентификация = Справочники.инт_Эндпоинты.ПолучитьАутентификацию(Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("Basic")
		.Свойство("Пользователь").Равно("testuser")
		.Свойство("Пароль").Равно("testpass");
	
КонецПроцедуры

// Тест: Получить аутентификацию Digest возвращает структуру с типом Digest
Процедура ТестПолучитьАутентификациюDigest() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Digest");
	
	// Act
	Аутентификация = Справочники.инт_Эндпоинты.ПолучитьАутентификацию(Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("Digest")
		.Свойство("Пользователь").Заполнено()
		.Свойство("Пароль").Заполнено();
	
КонецПроцедуры

// Тест: Получить аутентификацию Bearer возвращает структуру с типом Bearer
Процедура ТестПолучитьАутентификациюBearer() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтBearer("test_token_12345");
	
	// Act
	Аутентификация = Справочники.инт_Эндпоинты.ПолучитьАутентификацию(Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("Bearer")
		.Свойство("Токен").Равно("test_token_12345");
	
КонецПроцедуры

// Тест: Получить аутентификацию ApiKey возвращает структуру с типом ApiKey
Процедура ТестПолучитьАутентификациюApiKey() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтApiKey("X-API-Key", "my_secret_key");
	
	// Act
	Аутентификация = Справочники.инт_Эндпоинты.ПолучитьАутентификацию(Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("ApiKey")
		.Свойство("ИмяЗаголовка").Равно("X-API-Key")
		.Свойство("Значение").Равно("my_secret_key");
	
КонецПроцедуры

// Тест: Получить аутентификацию Tls возвращает структуру с типом Tls
Процедура ТестПолучитьАутентификациюTls() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Tls");
	
	// Act
	Аутентификация = Справочники.инт_Эндпоинты.ПолучитьАутентификацию(Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.ИмеетСвойство("Тип")
		.ИмеетСвойство("Сертификат")
		.ИмеетСвойство("ПарольСертификата")
		.Свойство("Тип").Равно("Tls");
	
КонецПроцедуры

// Тест: Получить аутентификацию для анонимного типа возвращает Неопределено
Процедура ТестПолучитьАутентификациюАнонимный() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный");
	
	// Act
	Аутентификация = Справочники.инт_Эндпоинты.ПолучитьАутентификацию(Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(Аутентификация)
		.Равно(Неопределено);
	
КонецПроцедуры

// Тест: Basic аутентификация с конкретными данными, отличными от значений по умолчанию
Процедура ТестПолучитьАутентификациюBasicКонкретныеДанные() Экспорт
	
	// Arrange
	Пользователь = "admin_" + ЮТест.Данные().СлучайнаяСтрока(5);
	Пароль = "secret_" + ЮТест.Данные().СлучайнаяСтрока(8);
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтBasic(Пользователь, Пароль);
	
	// Act
	Аутентификация = Справочники.инт_Эндпоинты.ПолучитьАутентификацию(Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("Basic")
		.Свойство("Пользователь").Равно(Пользователь)
		.Свойство("Пароль").Равно(Пароль);
	
КонецПроцедуры

// Тест: Digest аутентификация с конкретными пользователем и паролем
Процедура ТестПолучитьАутентификациюDigestКонкретныеДанные() Экспорт
	
	// Arrange
	Пользователь = "digest_user_" + ЮТест.Данные().СлучайнаяСтрока(5);
	Пароль = "digest_pass_" + ЮТест.Данные().СлучайнаяСтрока(8);
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтDigest(Пользователь, Пароль);
	
	// Act
	Аутентификация = Справочники.инт_Эндпоинты.ПолучитьАутентификацию(Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("Digest")
		.Свойство("Пользователь").Равно(Пользователь)
		.Свойство("Пароль").Равно(Пароль);
	
КонецПроцедуры

// Тест: Неизвестный тип авторизации вызывает исключение
Процедура ТестПолучитьАутентификациюНеизвестныйТип() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный");
	
	// Подменяем тип авторизации на пустую ссылку перечисления
	ЭндпоинтОбъект = Эндпоинт.ПолучитьОбъект();
	ЭндпоинтОбъект.ТипАвторизации = Перечисления.инт_ТипыАвторизации.ПустаяСсылка();
	ЭндпоинтОбъект.Записать();
	
	// Act + Assert
	ЮТест.ОжидаетЧто(Справочники.инт_Эндпоинты)
		.Метод("ПолучитьАутентификацию")
		.Параметр(Эндпоинт)
		.ВыбрасываетИсключение("не задан алгоритм заполнения аутентификации");
	
КонецПроцедуры

// }}}

// {{{ Набор: СтруктураПараметровСоединения

// Тест: Структура параметров соединения содержит все необходимые поля
Процедура ТестСтруктураПараметровСоединения() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтBasic("user", "pass", "https://api.example.com");
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(ПараметрыСоединения)
		.ИмеетТип("Структура")
		.Свойство("АдресРесурса").Равно("https://api.example.com")
		.Свойство("Сессия").ИмеетТип("Структура")
		.Свойство("ПроверятьSSL").ИмеетТип("Булево")
		.Свойство("Таймаут").ИмеетТип("Число");
	
	// Проверяем, что сессия содержит аутентификацию
	ЮТест.ОжидаетЧто(ПараметрыСоединения.Сессия)
		.ИмеетСвойство("Аутентификация");
	
КонецПроцедуры

// Тест: Таймаут по умолчанию равен 30, если не задан
Процедура ТестСтруктураПараметровСоединенияПоУмолчанию() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "https://test.example.com", Истина, 0);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(ПараметрыСоединения.Таймаут)
		.Равно(30);
	
КонецПроцедуры

// Тест: ПроверятьSSL передаётся из эндпоинта
Процедура ТестСтруктураПараметровСоединенияSSL() Экспорт
	
	// Arrange — создаём эндпоинт без проверки SSL
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "https://self-signed.example.com", Ложь, 30);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(ПараметрыСоединения.ПроверятьSSL)
		.Равно(Ложь);
	
КонецПроцедуры

// Тест: Пользовательский таймаут сохраняется в параметрах
Процедура ТестСтруктураПараметровСоединенияКастомныйТаймаут() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный", "https://slow.example.com", Истина, 120);
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(ПараметрыСоединения.Таймаут)
		.Равно(120);
	
КонецПроцедуры

// Тест: Сессия содержит аутентификацию, соответствующую типу эндпоинта
Процедура ТестСтруктураПараметровСоединенияСессияСодержитАутентификацию() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтBearer("session_test_token");
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Эндпоинт);
	
	// Assert — сессия содержит Bearer-аутентификацию
	ЮТест.ОжидаетЧто(ПараметрыСоединения.Сессия.Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("Bearer")
		.Свойство("Токен").Равно("session_test_token");
	
КонецПроцедуры

// }}}

// {{{ Набор: АутентификацияВСессии

// Тест: Сессия с Basic аутентификацией в структуре параметров
Процедура ТестСессияBasicСодержитКорректнуюАутентификацию() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтBasic("session_user", "session_pass");
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Эндпоинт);
	
	// Assert
	Аутентификация = ПараметрыСоединения.Сессия.Аутентификация;
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("Basic")
		.Свойство("Пользователь").Равно("session_user")
		.Свойство("Пароль").Равно("session_pass");
	
КонецПроцедуры

// Тест: Сессия с Bearer аутентификацией в структуре параметров
Процедура ТестСессияBearerСодержитКорректнуюАутентификацию() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтBearer("bearer_session_token");
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Эндпоинт);
	
	// Assert
	Аутентификация = ПараметрыСоединения.Сессия.Аутентификация;
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("Bearer")
		.Свойство("Токен").Равно("bearer_session_token");
	
КонецПроцедуры

// Тест: Сессия с ApiKey аутентификацией в структуре параметров
Процедура ТестСессияApiKeyСодержитКорректнуюАутентификацию() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.ЭндпоинтApiKey("Authorization", "key_123");
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Эндпоинт);
	
	// Assert
	Аутентификация = ПараметрыСоединения.Сессия.Аутентификация;
	ЮТест.ОжидаетЧто(Аутентификация)
		.ИмеетТип("Структура")
		.Свойство("Тип").Равно("ApiKey")
		.Свойство("ИмяЗаголовка").Равно("Authorization")
		.Свойство("Значение").Равно("key_123");
	
КонецПроцедуры

// Тест: Анонимная сессия не содержит аутентификации
Процедура ТестСессияАнонимнаяБезАутентификации() Экспорт
	
	// Arrange
	Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Анонимный");
	
	// Act
	ПараметрыСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Эндпоинт);
	
	// Assert
	ЮТест.ОжидаетЧто(ПараметрыСоединения.Сессия.Аутентификация)
		.Равно(Неопределено);
	
КонецПроцедуры

// }}}

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#КонецОбласти

