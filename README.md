# Подсистема интеграции

[![Статус порога качества](https://sonar.1cdevelopers.ru/api/project_badges/measure?project=integration_subsystem&metric=alert_status&token=sqb_4fd736b1dca04cda6252313b25beafd7fb501a90)](https://sonar.1cdevelopers.ru/dashboard?id=integration_subsystem)

Подсистема интеграции для 1С:Предприятие 8.3 - универсальное решение для оптимизации процесса разработки интеграций с внешними системами.

## Описание

Подсистема создана для оптимизации процесса разработки новых интеграций, предоставляя готовый инфраструктурный слой для обмена сообщениями.

### Основные задачи и возможности

- **Инфраструктурный слой** - берет на себя формирование, отправку и получение сообщений
- **Контроль потоков данных**
  - Проверка соблюдения контрактов при приеме и формировании сообщений (OpenAPI 3.0)
  - Мониторинг состояния подсистемы при помощи Prometheus
- **Многопоточность из коробки** - формирование и отправка сообщений в несколько потоков
- **Минимальное вмешательство** в код основной конфигурации для внедрения
- **Произвольные обработчики** - гибкая настройка логики обработки сообщений
- **Очереди сообщений** - надежная доставка с повторными попытками
- **Поддержка различных протоколов** - HTTP, RabbitMQ, JSON-RPC 2.0

## Оглавление

- [Внедрение и первоначальная настройка](#внедрение-и-первоначальная-настройка)
- [Архитектура](#архитектура)
- [Потоки данных](#потоки-данных)
- [Подписчики](#подписчики)
- [Валидация](#валидация)
- [Мониторинг](#мониторинг)
- [API документация](#api-документация)
- [Примеры использования](#примеры-использования)
- [Планы на будущее](#планы-на-будущее)
- [Разработчикам](#разработчикам)

## Внедрение и первоначальная настройка

### Требования

- Платформа 1С:Предприятие 8.3.24 или выше
- Права администратора для настройки подсистемы

### Быстрый старт

1. Загрузите подсистему в конфигурацию
2. Выполните обновление конфигурации базы данных
3. Настройте регламентные задания:
   - `инт_ФормированиеИсходящихСообщений` - формирование сообщений
   - `инт_ОтправкаИсходящихСообщений` - отправка сообщений подписчикам
   - `инт_ОбработкаВходящихСообщений` - обработка входящих сообщений
4. Настройте параметры подсистемы через форму "Настройки общих параметров интеграций"

Подробная инструкция доступна в [документации](doc/Writerside/topics/setup.md).

## Архитектура

### Основные компоненты

- **Очередь исходящих сообщений** (`инт_ОчередьИсходящихСообщений`) - регистрация сообщений к отправке
- **Менеджер потоков формирования** - управление многопоточным формированием сообщений
- **Менеджер потоков отправки** - управление многопоточной отправкой сообщений
- **Очередь входящих сообщений** (`инт_ОчередьВходящихСообщений`) - прием и обработка входящих сообщений
- **Справочник потоков данных** (`инт_ПотокиДанных`) - настройка логики обработки сообщений
- **Справочник подписчиков** (`инт_Подписчики`) - настройка получателей сообщений
- **Справочник схем** (`инт_Схемы`) - хранение OpenAPI схем для валидации

### Жизненный цикл исходящего сообщения

1. **Регистрация** - вызов `РегистрыСведений.инт_ОчередьИсходящихСообщений.ЗарегистрироватьСообщение()`
2. **Формирование** - выполнение обработчика потока, сериализация, валидация
3. **Отправка** - передача сообщения всем подписчикам потока
4. **Пост-обработка** - обработка ответов от подписчиков (опционально)

## Потоки данных

Поток данных - это именованный канал обмена сообщениями с определенной логикой обработки.

### Типы потоков

- **Исходящий** - отправка сообщений из информационной базы во внешние системы
- **Входящий** - прием сообщений от внешних систем

### Настройка потока

Каждый поток включает:
- **Код и наименование** - уникальный идентификатор потока
- **Направление** - исходящий или входящий
- **Обработчик** - текст программного кода на встроенном языке
- **Схема валидации** - ссылка на OpenAPI схему (опционально)
- **Режим обработки** - синхронный или асинхронный
- **Подписчики** - список получателей (только для исходящих потоков)

## Подписчики

Каждый исходящий поток может обладать несколькими подписчиками. Подписчики - это системы, которые получают сообщения из потока.

Для каждого подписчика могут быть заданы свои правила сериализации и валидации сообщений.

### Типы подписчиков

На данный момент реализованы следующие типы подписчиков:

- **Произвольный HTTP** - отправка POST/GET запросов на произвольный URL
- **Подсистема интеграции** - обмен с другой ИБ, где внедрена эта же подсистема
- **RabbitMQ** - публикация сообщений в очередь RabbitMQ
- **JSON-RPC 2.0** - отправка сообщений по протоколу JSON-RPC 2.0

### Настройка подписчика

Каждый подписчик включает:
- **Наименование** - произвольное имя подписчика
- **Тип подписчика** - один из поддерживаемых типов
- **Эндпоинт** - ссылка на настройки подключения (URL, порт, авторизация)
- **Правила сериализации** - преобразование данных в требуемый формат
- **Схема валидации** - контракт для проверки сообщений

### Пост-обработка ответов

Для каждого подписчика можно задать обработчик ответов. Обработчик ответов - это произвольный код, который будет вызван после отправки сообщения.
В обработчик будет передан ответ от подписчика, а также ссылка на исходные данные сообщения.

## Валидация

В подсистеме реализован механизм валидации сообщений при приеме и отправке. Валидация происходит на основе контрактов, которые описывают структуру сообщения.

### OpenAPI 3.0

Формат описания контрактов - OpenAPI 3.0.0 (бывший Swagger).

Для хранения данных схем реализован справочник `инт_Схемы`. В нем хранится информация о схеме и сама схема в формате JSON.
Также реализовано кэширование схем, размещенных в удаленных источниках.

### Валидация сообщений

- **Исходящие сообщения** - проверка перед отправкой подписчикам
- **Входящие сообщения** - проверка при приеме от внешних систем
- **Результаты валидации** - логирование ошибок в журнал регистрации

## Мониторинг

Основные метрики собираются при помощи Prometheus. 

### Эндпоинт метрик

Для сбора метрик реализован HTTP-сервис:

```
http://<адрес_сервера>/integration_subsystem/hs/prometheus/polling
```

Сервис возвращает данные в формате Prometheus.

### Метрики

- `pde_queue_length` - количество сообщений в очереди (для каждой очереди отдельно)
- `int_message_processing_time` - время обработки сообщений
- `int_message_sending_time` - время отправки сообщений
- `int_errors_count` - количество ошибок при обработке

## API документация

Подробная документация по HTTP и программному API доступна в файле [API.md](API.md).

### HTTP API

Подсистема предоставляет два HTTP-сервиса:

1. **Integration API** - прием входящих сообщений от внешних систем
   - Endpoint: `http://<сервер>/integration_subsystem/hs/integration/{flow_id}`
   - Поддержка POST-запросов с JSON-данными
   - Health check endpoint: `/testping`

2. **Prometheus API** - экспорт метрик для мониторинга
   - Endpoint: `http://<сервер>/integration_subsystem/hs/prometheus/polling`
   - Формат: text/plain (Prometheus format)

### Программный API

Основные функции для работы с подсистемой:

```bsl
// Регистрация исходящего сообщения
ИдентификаторСообщения = РегистрыСведений.инт_ОчередьИсходящихСообщений
    .ЗарегистрироватьСообщение(ИсходныеДанные, ПотокДанных);

// Обработка входящего сообщения
инт_ОбработкаВходящихПотоков.ОбработкаВходящегоСообщенияПоПотоку(
    Сообщение, ПотокДанных);
```

Полная документация с примерами в [API.md](API.md).

## Примеры использования

### Создание исходящего потока

1. Создайте новый предопределенный элемент справочника `инт_ПотокиДанных`
2. Определите моменты триггера для отправки сообщений (например, при записи документа)
3. Добавьте в момент триггера вызов регистрации сообщения:

```bsl
РегистрыСведений.инт_ОчередьИсходящихСообщений.ЗарегистрироватьСообщение(
    ИсходныеДанные,  // Ссылка на документ или структура
    ПотокДанных       // Справочники.инт_ПотокиДанных.МойПоток
);
```

4. Заполните в режиме предприятия:
   - Направление потока: "Исходящий"
   - Текст обработчика (функция преобразования данных)
5. Добавьте подписчиков в табличную часть "Подписчики"

### Создание входящего потока

1. Создайте элемент справочника `инт_ПотокиДанных` с направлением "Входящий"
2. Напишите обработчик для обработки входящих данных
3. Настройте HTTP-сервис `integration` для приема сообщений
4. Внешние системы отправляют сообщения на URL:

```
http://<адрес_сервера>/integration_subsystem/hs/integration/<код_потока>
```

### Пример обработчика исходящего потока

```bsl
// Параметры:
//  ИсходныеДанные - ЛюбаяСсылка - исходные данные для формирования сообщения
//
// Возвращаемое значение:
//  Структура - сформированное сообщение для отправки
//
Функция Обработчик(ИсходныеДанные) Экспорт
    
    Сообщение = Новый Структура;
    Сообщение.Вставить("documentId", Строка(ИсходныеДанные.УникальныйИдентификатор()));
    Сообщение.Вставить("number", ИсходныеДанные.Номер);
    Сообщение.Вставить("date", ИсходныеДанные.Дата);
    Сообщение.Вставить("amount", ИсходныеДанные.СуммаДокумента);
    
    Возврат Сообщение;
    
КонецФункции
```

## Планы на будущее

- [ ] Добавить возможность приема сообщений в несколько потоков
- [ ] Расширить поддержку протокола JSON-RPC 2.0
- [ ] Улучшить поддержку протокола AMQP и RabbitMQ
- [ ] Добавить версионирование обработчиков потоков в GIT
- [ ] Добавить поддержку AsyncAPI для описания контрактов
- [ ] Добавить валидацию не только payload, но и метаданных сообщений
- [x] Добавить поддержку внешних систем мониторинга (Prometheus)
- [ ] Добавить динамические подписки на события по потокам
- [ ] Добавить синтаксическую подсказку по полям требуемых объектов на основании схемы контракта
- [ ] Реализовать WebSocket подписчика
- [ ] Добавить графический редактор схем интеграции

## Разработчикам

Информация для разработчиков подсистемы доступна по ссылке [CONTRIBUTING.md](CONTRIBUTING.md)

### Участие в проекте

Мы приветствуем вклад в развитие проекта! Пожалуйста, ознакомьтесь с руководством [CONTRIBUTING.md](CONTRIBUTING.md) перед началом работы.

### Структура проекта

- `src/cf/` - конфигурация 1С
- `doc/` - документация проекта
- `tests/` - автоматизированные тесты
- `examples/` - примеры использования
- [API.md](API.md) - документация HTTP и программного API
- [README.md](README.md) - общее описание проекта
- [CONTRIBUTING.md](CONTRIBUTING.md) - руководство для разработчиков

## Лицензия

Проект распространяется под лицензией GPL-3.0. Подробности в файле [LICENSE](LICENSE).
