---
outline: deep
---

# Очереди сообщений

Подсистема использует **очереди сообщений** для надёжной асинхронной доставки данных.

## Принцип работы

```
┌─────────────────┐                    ┌─────────────────┐
│  Регистрация    │                    │  Обработка      │
│  сообщения      │───────────────────▶│  фоновым        │
│  (синхронно)    │   Очередь          │  заданием       │
└─────────────────┘                    └─────────────────┘
```

**Преимущества:**
- Операция регистрации быстрая и не блокирует пользователя
- Отказоустойчивость — сообщения не теряются при сбоях
- Масштабируемость — несколько фоновых заданий обрабатывают очередь параллельно

## Регистры очередей

### инт_ОчередьИсходящихСообщений

Основная очередь для исходящих сообщений.

| Измерение | Тип | Описание |
|-----------|-----|----------|
| `ИдентификаторСообщения` | УникальныйИдентификатор | Уникальный ID сообщения |

| Ресурс | Тип | Описание |
|--------|-----|----------|
| `ПотокДанных` | СправочникСсылка.инт_ПотокиДанных | Поток обработки |
| `ИсходныеДанные` | Строка | Сериализованное представление исходных данных (ЗначениеВСтрокуВнутр) |
| `СформированноеСообщение` | ХранилищеЗначения | Готовое сообщение |

### инт_ОчередьОтправкиИсходящихСообщений

Очередь для рассылки сообщений подписчикам (сообщение × подписчик).

| Измерение | Тип | Описание |
|-----------|-----|----------|
| `ИдентификаторСообщения` | УникальныйИдентификатор | ID сообщения |
| `Подписчик` | СправочникСсылка.инт_Подписчики | Получатель |

### инт_ОчередьВходящихСообщений

Очередь входящих сообщений от внешних систем.

| Измерение | Тип | Описание |
|-----------|-----|----------|
| `ИдентификаторСообщения` | УникальныйИдентификатор | ID сообщения |

| Ресурс | Тип | Описание |
|--------|-----|----------|
| `ПотокДанных` | СправочникСсылка.инт_ПотокиДанных | Поток обработки |
| `ТелоСообщения` | ХранилищеЗначения | JSON-данные сообщения |

## Регистрация сообщения

### Базовый вызов

```bsl
ИдентификаторСообщения = РегистрыСведений.инт_ОчередьИсходящихСообщений.ЗарегистрироватьСообщение(
    ИсходныеДанные,   // Ссылка на объект или ФиксированнаяСтруктура
    ПотокДанных,      // СправочникСсылка.инт_ПотокиДанных
    РегистрироватьДубль  // Булево, по умолчанию Ложь
);
```

### Параметры

| Параметр | Тип | Описание |
|----------|-----|----------|
| `ИсходныеДанные` | Ссылка/ФиксированнаяСтруктура | Данные для формирования сообщения |
| `ПотокДанных` | СправочникСсылка | Поток для обработки |
| `РегистрироватьДубль` | Булево | `Ложь` — дубли игнорируются |

### Возвращаемое значение

- `УникальныйИдентификатор` — ID зарегистрированного сообщения
- `Неопределено` — если регистрация не выполнена (поток неактивен, дубль)

### Пример использования

```bsl
// В модуле объекта документа
Процедура ОбработкаПроведения(Отказ, Режим)
    // ... проведение документа ...
    
    // Регистрация сообщения для отправки
    ПотокДанных = Справочники.инт_ПотокиДанных.ЭкспортЗаказов;
    РегистрыСведений.инт_ОчередьИсходящихСообщений.ЗарегистрироватьСообщение(
        Ссылка,
        ПотокДанных
    );
КонецПроцедуры
```

## Защита от дублей

Подсистема автоматически рассчитывает хэш исходных данных и хранит его в регистре `инт_ХешиОбъектов`.

При `РегистрироватьДубль = Ложь`:
- Если хэш не изменился — сообщение **не регистрируется**
- Если хэш изменился — регистрируется новое сообщение

```bsl
// Принудительная регистрация дубля
РегистрыСведений.инт_ОчередьИсходящихСообщений.ЗарегистрироватьСообщение(
    ДокументСсылка,
    ПотокДанных,
    Истина  // РегистрироватьДубль = Истина
);
```

## Статусы сообщений

### Исходящие сообщения

Перечисление `инт_СтатусыИсходящихСообщений`:

| Статус | Описание |
|--------|----------|
| `Новый` | Зарегистрировано, ожидает формирования |
| `ФормированиеСообщения` | Формируется фоновым заданием |
| `ОшибкаФормирования` | Ошибка при выполнении обработчика |
| `ГотовоКОтправке` | Сформировано, ожидает рассылки |
| `ПомещеноВОчередьОтправки` | Добавлено в очередь для подписчиков |
| `Отправлено` | Доставлено всем подписчикам |
| `ОшибкаОтправки` | Ошибка при отправке |

### Статусы рассылки (по подписчикам)

Перечисление `инт_СтатусыРассылкиИсходящихСообщений`:

| Статус | Описание |
|--------|----------|
| `Новый` | Ожидает отправки |
| `ВПроцессеОтправки` | Отправляется |
| `Отправлено` | Успешно доставлено |
| `ОшибкаОтправки` | Ошибка, будет повтор |

## Регистры статусов

### инт_ТекущийСтатусИсходящихСообщений

Хранит **текущий** статус каждого сообщения:

```bsl
// Получение текущего статуса
Статус = РегистрыСведений.инт_ТекущийСтатусИсходящихСообщений.ПолучитьСтатус(
    ИдентификаторСообщения
);
```

### инт_ИсторияСтатусовИсходящихСообщений

Хранит **полную историю** изменения статусов:

| Измерение | Описание |
|-----------|----------|
| `ИдентификаторСообщения` | ID сообщения |
| `ДатаИзменения` | Метка времени |

| Ресурс | Описание |
|--------|----------|
| `Статус` | Новый статус |
| `Комментарий` | Текст ошибки или примечание |

## Удаление сообщений

```bsl
// Удаление сообщения и всей связанной информации
РегистрыСведений.инт_ОчередьИсходящихСообщений.УдалитьСообщениеИзОчередиПоИдентификатору(
    ИдентификаторСообщения
);
```

Удаляются записи из:
- `инт_ОчередьИсходящихСообщений`
- `инт_ТекущийСтатусИсходящихСообщений`
- `инт_ИсторияСтатусовИсходящихСообщений`
- `инт_ОчередьОтправкиИсходящихСообщений`

## Регламентная очистка

Регламентное задание `инт_ОчисткаУстаревшихСообщений` удаляет успешно отправленные сообщения старше заданного срока.

## Получение данных сообщения

```bsl
// Получение данных сообщения по идентификатору
ДанныеСообщения = РегистрыСведений.инт_ОчередьИсходящихСообщений.ПолучитьДанныеОчередиПоИдентификатору(
    ИдентификаторСообщения,
    "ИсходныеДанные, ПотокДанных, СформированноеСообщение"  // Список полей через запятую
);

// Результат: Структура
// - ИсходныеДанные: Ссылка
// - ПотокДанных: СправочникСсылка
// - СформированноеСообщение: Соответствие (десериализованное)
```

## Рекомендации

::: tip Момент регистрации
Регистрируйте сообщения в обработчиках проведения документов или подписках на события. Это гарантирует, что сообщение будет создано только для успешно записанных данных.
:::

::: tip Мониторинг очередей
Настройте алерты на метрику `pde_queue_length` для раннего обнаружения проблем с обработкой очередей. Подробнее о метриках и настройке алертов см. [Мониторинг и метрики](/concepts/monitoring).
:::

::: warning Большие объёмы
При массовой регистрации сообщений (загрузка данных) используйте пакетную обработку и контролируйте размер очереди.
:::

## Следующие шаги

- [Многопоточность](/concepts/multithreading) — параллельная обработка очередей
- [Валидация](/concepts/validation) — проверка сообщений
- [Подписчики](/concepts/subscribers) — типы подписчиков
- [Мониторинг и метрики](/concepts/monitoring) — Prometheus-метрики и алерты
