# API Documentation / Документация API

## Содержание

- [HTTP-сервис integration](#http-сервис-integration)
- [HTTP-сервис Prometheus](#http-сервис-prometheus)
- [Программный API](#программный-api)

---

## HTTP-сервис integration

HTTP-сервис для приема входящих сообщений от внешних систем.

### Базовый URL

```
http://<сервер>/integration_subsystem/hs/integration/
```

### Методы

#### POST /{flow_id}

Принимает входящее сообщение для указанного потока данных.

**Параметры пути:**
- `flow_id` (обязательный) - код (идентификатор) входящего потока данных

**Заголовки:**
- `Content-Type: application/json` - формат тела запроса

**Тело запроса:**
JSON-документ с данными сообщения. Структура определяется обработчиком потока.

**Пример запроса:**

```http
POST /integration_subsystem/hs/integration/order_create HTTP/1.1
Host: server.example.com
Content-Type: application/json

{
  "orderId": "12345",
  "customer": "ООО Рога и Копыта",
  "items": [
    {
      "sku": "PROD-001",
      "quantity": 5,
      "price": 10000
    }
  ],
  "totalAmount": 50000
}
```

**Ответы:**

| Код | Описание |
|-----|----------|
| 200 | Сообщение успешно принято и обработано |
| 400 | Некорректный запрос или данные (ошибка валидации) |
| 404 | Поток данных не найден или неактивен |
| 500 | Внутренняя ошибка при обработке сообщения |

**Пример успешного ответа (200):**

```json
{
  "success": true,
  "messageId": "550e8400-e29b-41d4-a716-446655440000"
}
```

#### GET /testping

Проверка доступности сервиса (health check).

**Пример запроса:**

```http
GET /integration_subsystem/hs/integration/testping HTTP/1.1
Host: server.example.com
```

**Ответы:**

| Код | Описание |
|-----|----------|
| 200 | Сервис доступен и работает |

---

## HTTP-сервис Prometheus

HTTP-сервис для предоставления метрик в формате Prometheus.

### Базовый URL

```
http://<сервер>/integration_subsystem/hs/prometheus/
```

### Методы

#### GET /polling

Получает метрики работы подсистемы интеграции в формате Prometheus.

**Заголовки запроса:**
- `Accept: text/plain` - формат ответа
- `User-Agent: Prometheus/2.x` (рекомендуется)

**Пример запроса:**

```http
GET /integration_subsystem/hs/prometheus/polling HTTP/1.1
Host: server.example.com
Accept: text/plain
User-Agent: Prometheus/2.37.0
```

**Ответы:**

| Код | Описание |
|-----|----------|
| 200 | Метрики успешно сформированы |
| 204 | Нет доступных метрик |
| 400 | Некорректный запрос (неверные заголовки) |
| 405 | Неподдерживаемый формат Accept |

**Пример ответа (200):**

```
# HELP pde_queue_length Количество сообщений в очереди
# TYPE pde_queue_length gauge
pde_queue_length{queue="outgoing",status="new"} 42
pde_queue_length{queue="outgoing",status="in_progress"} 5
pde_queue_length{queue="incoming",status="new"} 15
pde_queue_length{queue="sending",status="pending"} 8

# HELP int_message_processing_time Время обработки сообщений в миллисекундах
# TYPE int_message_processing_time histogram
int_message_processing_time_sum{flow="order_create"} 12450.5
int_message_processing_time_count{flow="order_create"} 127

# HELP int_errors_count Количество ошибок при обработке
# TYPE int_errors_count counter
int_errors_count{flow="order_create",type="validation"} 3
int_errors_count{flow="order_create",type="processing"} 1
```

### Доступные метрики

| Метрика | Тип | Описание | Метки |
|---------|-----|----------|-------|
| `pde_queue_length` | gauge | Количество сообщений в очереди | queue, status |
| `int_message_processing_time` | histogram | Время обработки сообщений (мс) | flow |
| `int_message_sending_time` | histogram | Время отправки сообщений (мс) | flow, subscriber |
| `int_errors_count` | counter | Количество ошибок | flow, type |
| `int_validation_failures` | counter | Ошибки валидации | flow |

### Настройка Prometheus

Добавьте в конфигурацию Prometheus (`prometheus.yml`):

```yaml
scrape_configs:
  - job_name: '1c_integration_subsystem'
    scrape_interval: 30s
    scrape_timeout: 10s
    static_configs:
      - targets: ['your-1c-server:port']
    metrics_path: '/integration_subsystem/hs/prometheus/polling'
```

---

## Программный API

API для работы с подсистемой интеграции из встроенного языка 1С.

### Регистрация исходящего сообщения

Регистрирует сообщение в очереди для отправки подписчикам.

```bsl
// Синтаксис
РегистрыСведений.инт_ОчередьИсходящихСообщений.ЗарегистрироватьСообщение(
    ИсходныеДанные,
    ПотокДанных,
    РегистрироватьДубль
)

// Параметры:
//   ИсходныеДанные - ОпределяемыйТип.инт_ИсходныеДанные - Ссылка на объект или структура с данными
//   ПотокДанных - СправочникСсылка.инт_ПотокиДанных - Поток для отправки сообщения
//   РегистрироватьДубль - Булево - Регистрировать ли дубли (по умолчанию Ложь)
//
// Возвращаемое значение:
//   УникальныйИдентификатор - Идентификатор зарегистрированного сообщения
//   Неопределено - Если произошла ошибка
```

**Пример использования:**

```bsl
Процедура ПриЗаписи(Отказ)
    
    Если Не ДополнительныеСвойства.Свойство("ОтключитьИнтеграцию") Тогда
        
        ПотокДанных = Справочники.инт_ПотокиДанных.ОтправкаЗаказа;
        
        ИдентификаторСообщения = РегистрыСведений.инт_ОчередьИсходящихСообщений
            .ЗарегистрироватьСообщение(Ссылка, ПотокДанных);
        
        Если ИдентификаторСообщения <> Неопределено Тогда
            // Сообщение успешно зарегистрировано
        КонецЕсли;
        
    КонецЕсли;
    
КонецПроцедуры
```

### Обработка входящего сообщения

Обрабатывает входящее сообщение по указанному потоку.

```bsl
// Синтаксис
инт_ОбработкаВходящихПотоков.ОбработкаВходящегоСообщенияПоПотоку(
    Сообщение,
    ПотокДанных,
    ИдентификаторСообщения
)

// Параметры:
//   Сообщение - Соответствие, Структура, Строка - Данные входящего сообщения
//   ПотокДанных - СправочникСсылка.инт_ПотокиДанных - Входящий поток данных
//   ИдентификаторСообщения - УникальныйИдентификатор - ID сообщения (опционально)
```

**Пример использования:**

```bsl
Процедура ОбработатьВнешнийЗапрос(ДанныеJSON)
    
    ПотокДанных = Справочники.инт_ПотокиДанных.ПолучениеЗаказа;
    
    ЧтениеJSON = Новый ЧтениеJSON;
    ЧтениеJSON.УстановитьСтроку(ДанныеJSON);
    Сообщение = ПрочитатьJSON(ЧтениеJSON);
    
    инт_ОбработкаВходящихПотоков.ОбработкаВходящегоСообщенияПоПотоку(
        Сообщение,
        ПотокДанных
    );
    
КонецПроцедуры
```

### Удаление сообщения из очереди

Удаляет сообщение и всю связанную с ним информацию.

```bsl
// Синтаксис
РегистрыСведений.инт_ОчередьИсходящихСообщений
    .УдалитьСообщениеИзОчередиПоИдентификатору(ИдентификаторСообщения)

// Параметры:
//   ИдентификаторСообщения - УникальныйИдентификатор - ID сообщения
```

### Получение подписчиков потока

Получает список подписчиков для указанного потока.

```bsl
// Синтаксис
МассивПодписчиков = Справочники.инт_ПотокиДанных
    .ПолучитьПодписчиковПоПотоку(ПотокДанных)

// Параметры:
//   ПотокДанных - СправочникСсылка.инт_ПотокиДанных - Поток данных
//
// Возвращаемое значение:
//   Массив из СправочникСсылка.инт_Подписчики - Подписчики потока
```

---

## Обработчики потоков

### Обработчик исходящего потока

Функция преобразования исходных данных в сообщение.

```bsl
// Сигнатура обработчика
Функция Обработчик(ИсходныеДанные) Экспорт
    
    // ИсходныеДанные - ссылка на объект (документ, справочник и т.д.)
    //                 или структура с данными
    
    Сообщение = Новый Структура;
    // ... формирование структуры сообщения ...
    
    Возврат Сообщение; // Структура или Соответствие
    
КонецФункции
```

**Пример:**

```bsl
Функция СформироватьСообщениеДляЗаказа(ИсходныеДанные) Экспорт
    
    Документ = ИсходныеДанные; // ДокументСсылка.ЗаказКлиента
    
    Сообщение = Новый Структура;
    Сообщение.Вставить("orderId", Строка(Документ.УникальныйИдентификатор()));
    Сообщение.Вставить("number", Документ.Номер);
    Сообщение.Вставить("date", Формат(Документ.Дата, "ДФ=yyyy-MM-dd"));
    Сообщение.Вставить("customer", Документ.Контрагент.Наименование);
    Сообщение.Вставить("totalAmount", Документ.СуммаДокумента);
    
    // Формирование позиций заказа
    Товары = Новый Массив;
    Для Каждого СтрокаТовара Из Документ.Товары Цикл
        Товар = Новый Структура;
        Товар.Вставить("sku", СтрокаТовара.Номенклатура.Артикул);
        Товар.Вставить("name", СтрокаТовара.Номенклатура.Наименование);
        Товар.Вставить("quantity", СтрокаТовара.Количество);
        Товар.Вставить("price", СтрокаТовара.Цена);
        Товары.Добавить(Товар);
    КонецЦикла;
    Сообщение.Вставить("items", Товары);
    
    Возврат Сообщение;
    
КонецФункции
```

### Обработчик входящего потока

Процедура обработки входящего сообщения.

```bsl
// Сигнатура обработчика
Процедура Обработчик(СоответствиеСообщения, РазрешитьФиксациюИзменений) Экспорт
    
    // СоответствиеСообщения - Соответствие - десериализованное сообщение
    // РазрешитьФиксациюИзменений - Булево - разрешена ли запись данных
    
    // ... обработка сообщения ...
    
КонецПроцедуры
```

**Пример:**

```bsl
Процедура ОбработатьВходящийЗаказ(СоответствиеСообщения, РазрешитьФиксациюИзменений) Экспорт
    
    // Создание нового заказа
    ДокументОбъект = Документы.ЗаказКлиента.СоздатьДокумент();
    
    // Заполнение реквизитов
    ДокументОбъект.Дата = ТекущаяДатаСеанса();
    ДокументОбъект.ВнешнийИдентификатор = СоответствиеСообщения["orderId"];
    
    // Поиск контрагента
    Контрагент = Справочники.Контрагенты.НайтиПоНаименованию(
        СоответствиеСообщения["customer"]
    );
    ДокументОбъект.Контрагент = Контрагент;
    
    // Заполнение табличной части
    Для Каждого ЭлементТовара Из СоответствиеСообщения["items"] Цикл
        СтрокаТовара = ДокументОбъект.Товары.Добавить();
        СтрокаТовара.Номенклатура = Справочники.Номенклатура.НайтиПоКоду(
            ЭлементТовара["sku"]
        );
        СтрокаТовара.Количество = ЭлементТовара["quantity"];
        СтрокаТовара.Цена = ЭлементТовара["price"];
    КонецЦикла;
    
    // Запись документа
    Если РазрешитьФиксациюИзменений Тогда
        ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение);
    КонецЕсли;
    
КонецПроцедуры
```

---

## Коды ошибок

### HTTP-сервис integration

| Код | Причина | Решение |
|-----|---------|---------|
| 400 | Некорректный JSON | Проверьте синтаксис JSON |
| 400 | Ошибка валидации по схеме | Проверьте соответствие данных схеме OpenAPI |
| 404 | Поток не найден | Проверьте код потока в URL |
| 404 | Поток неактивен | Активируйте поток в справочнике |
| 500 | Ошибка в обработчике потока | Проверьте логи, исправьте обработчик |

### HTTP-сервис Prometheus

| Код | Причина | Решение |
|-----|---------|---------|
| 204 | Нет метрик | Проверьте настройки метрик |
| 400 | Неверные заголовки | Добавьте Accept: text/plain |
| 405 | Неподдерживаемый Accept | Используйте Accept: text/plain |

---

## Безопасность

### Аутентификация

HTTP-сервисы поддерживают следующие методы аутентификации:

1. **Basic Authentication**
   ```http
   Authorization: Basic base64(username:password)
   ```

2. **Bearer Token**
   ```http
   Authorization: Bearer <token>
   ```

3. **Встроенная аутентификация 1С**
   - Используются учетные данные информационной базы

### Рекомендации

- Используйте HTTPS для защиты передаваемых данных
- Ограничьте доступ к HTTP-сервисам на уровне веб-сервера
- Настройте аутентификацию для всех внешних подключений
- Регулярно проверяйте журналы регистрации на наличие подозрительной активности

---

## Поддержка

При возникновении проблем:

1. Проверьте журнал регистрации 1С (события "ПодсистемаИнтеграции.*")
2. Убедитесь в корректности настроек потоков и подписчиков
3. Проверьте доступность внешних систем
4. Обратитесь к [документации проекта](README.md)
5. Создайте issue в репозитории проекта
