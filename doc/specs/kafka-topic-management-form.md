# Спецификация: Общая форма управления топиками Kafka

## Статус: В разработке

## Обзор

Создание общей формы `инт_УправлениеТопикамиKafka` для централизованного управления топиками Kafka: создание, проверка существования, настройка параметров, управление DLQ и ручное управление оффсетами консьюмеров.

## Мотивация

Текущее управление топиками привязано к форме подписчика `инт_ПодписчикиKafka.ФормаЭлемента`. Это неудобно, т.к.:
- Для управления топиком нужно открывать конкретного подписчика
- DLQ топик указывается строкой без возможности проверки/создания
- Нет инструмента для управления оффсетами консьюмеров

## Компоненты

### 1. Общая форма `инт_УправлениеТопикамиKafka`

**Синоним**: `(инт) Управление топиками Kafka`

#### Макет

```
┌──────────────────────────────────────────────────────────────┐
│ Командная панель: [Тест подключения] [Обновить информацию]   │
│                                                              │
│ Эндпоинт: [_________________________]                       │
│                                                              │
│ [Страницы: Управление топиком | Консьюмеры и оффсеты]       │
│                                                              │
│ ═══ Страница «Управление топиком» ═══                        │
│                                                              │
│ ┌─ Основной топик ──────────────────────────────────────────┐│
│ │ Имя топика: [___________] ● Статус  [Проверить] [Создать] ││
│ │                                                           ││
│ │ ┌─ Создание (видна если топик НЕ существует) ──────────┐  ││
│ │ │ Количество партиций: [3]  Фактор репликации: [1]     │  ││
│ │ └─────────────────────────────────────────────────────┘  ││
│ │                                                           ││
│ │ ┌─ Параметры топика (если существует, сворачиваемая) ──┐  ││
│ │ │ Настройка        │ Значение │ Изменён │ Исходное     │  ││
│ │ │ retention.ms     │ 604800   │         │ 604800       │  ││
│ │ │ ...              │          │         │              │  ││
│ │ │                        [Сохранить настройки топика]   │  ││
│ │ └──────────────────────────────────────────────────────┘  ││
│ └───────────────────────────────────────────────────────────┘│
│                                                              │
│ ┌─ DLQ топик ───────────────────────────────────────────────┐│
│ │ Имя DLQ топика: [________] ● Статус [Проверить] [Создать] ││
│ │                                                           ││
│ │ ┌─ Создание DLQ (видна если DLQ НЕ существует) ────────┐  ││
│ │ │ Партиций: [1]  Фактор репликации: [1]                │  ││
│ │ └──────────────────────────────────────────────────────┘  ││
│ │                                                           ││
│ │ ┌─ Параметры DLQ (если существует, сворачиваемая) ─────┐  ││
│ │ │ Настройка        │ Значение │ Изменён │ Исходное     │  ││
│ │ │ ...              │          │         │              │  ││
│ │ │                        [Сохранить настройки DLQ]      │  ││
│ │ └──────────────────────────────────────────────────────┘  ││
│ └───────────────────────────────────────────────────────────┘│
│                                                              │
│ ┌─ Партиции (если основной топик существует) ───────────────┐│
│ │ Партиция │ Лидер │ High WM │ Low WM │ Сообщений          ││
│ │ 0        │ 1     │ 12345   │ 0      │ 12345              ││
│ └───────────────────────────────────────────────────────────┘│
│                                                              │
│ ═══ Страница «Консьюмеры и оффсеты» ═══                     │
│                                                              │
│ Consumer Group: [___________] [Загрузить оффсеты]            │
│                                                              │
│ ┌─ Оффсеты ─────────────────────────────────────────────────┐│
│ │ Партиция │ Текущий оффсет │ High WM │ Lag │ Новый оффсет ││
│ │ 0        │ 12000          │ 12345   │ 345 │ [_____]       ││
│ │ 1        │ 5678           │ 5678    │ 0   │ [_____]       ││
│ │                                                           ││
│ │ [На начало] [На конец] [Применить оффсеты]                ││
│ └───────────────────────────────────────────────────────────┘│
└──────────────────────────────────────────────────────────────┘
```

#### Реквизиты формы

| Имя | Тип | Описание |
|-----|-----|----------|
| `Эндпоинт` | СправочникСсылка.инт_Эндпоинты | Эндпоинт (брокер Kafka) |
| `ИмяТопика` | Строка(255) | Имя основного топика |
| `СтатусТопика` | Число | 0-неизвестен, 1-существует, 2-не существует, 3-ошибка |
| `ИнформацияОТопике` | Строка | Текст статуса основного топика |
| `КоличествоПартиций` | Число(5,0) | Для создания основного топика |
| `ФакторРепликации` | Число(3,0) | Для создания основного топика |
| `НастройкиТопика` | ТаблицаЗначений | Настройки основного топика (КлючНастройки, ЗначениеНастройки, Изменено, ИсходноеЗначение) |
| `ИмяDLQТопика` | Строка(255) | Имя DLQ топика |
| `СтатусDLQТопика` | Число | 0-неизвестен, 1-существует, 2-не существует, 3-ошибка |
| `ИнформацияОDLQТопике` | Строка | Текст статуса DLQ топика |
| `КоличествоПартицийDLQ` | Число(5,0) | Для создания DLQ |
| `ФакторРепликацииDLQ` | Число(3,0) | Для создания DLQ |
| `НастройкиDLQ` | ТаблицаЗначений | Настройки DLQ (КлючНастройки, ЗначениеНастройки, Изменено, ИсходноеЗначение) |
| `Партиции` | ТаблицаЗначений | Информация о партициях (НомерПартиции, Лидер, HighWatermark, LowWatermark, КоличествоСообщений) |
| `ИмяГруппыКонсьюмеров` | Строка(255) | Имя consumer group |
| `Оффсеты` | ТаблицаЗначений | Оффсеты (НомерПартиции, ТекущийОффсет, HighWatermark, Лаг, НовыйОффсет) |

#### Команды формы

| Команда | Действие |
|---------|----------|
| `ТестПодключения` | Проверка доступности брокера |
| `ОбновитьИнформацию` | Обновить статус топика, партиций, настроек |
| `ПроверитьТопик` | Проверить существование основного топика |
| `СоздатьТопик` | Создать основной топик |
| `СохранитьНастройкиТопика` | Сохранить изменённые настройки топика |
| `ПроверитьDLQ` | Проверить существование DLQ топика |
| `СоздатьDLQ` | Создать DLQ топик |
| `СохранитьНастройкиDLQ` | Сохранить изменённые настройки DLQ |
| `ЗагрузитьОффсеты` | Загрузить оффсеты для выбранной группы |
| `НаНачало` | Перемотать оффсеты всех партиций на начало (Low Watermark) |
| `НаКонец` | Перемотать оффсеты всех партиций на конец (High Watermark) |
| `ПрименитьОффсеты` | Применить новые оффсеты из колонки «Новый оффсет» |

#### Параметры формы (открытие)

| Параметр | Тип | Описание |
|----------|-----|----------|
| `Эндпоинт` | СправочникСсылка.инт_Эндпоинты | Предзаполнение эндпоинта |
| `ИмяТопика` | Строка | Предзаполнение имени топика |
| `ИмяDLQТопика` | Строка | Предзаполнение имени DLQ |

### 2. Новые методы в `инт_РаботаСКафка`

```bsl
// Получает оффсеты consumer group для топика
//
// Параметры:
//  Брокеры               - Строка - Адрес брокеров
//  ИмяГруппыКонсьюмеров  - Строка - Consumer group ID
//  ИмяТопика             - Строка - Имя топика
//  Эндпоинт              - СправочникСсылка.инт_Эндпоинты - Эндпоинт (опционально)
//
// Возвращаемое значение:
//  Структура:
//   * Успех - Булево
//   * ОписаниеОшибки - Строка
//   * Оффсеты - Массив из Структура (partition, offset, high_watermark, lag)
//
Функция ПолучитьОффсетыКонсьюмера(Брокеры, ИмяГруппыКонсьюмеров, ИмяТопика, Эндпоинт = Неопределено) Экспорт

// Устанавливает оффсет для partition в consumer group
//
// Параметры:
//  Брокеры               - Строка - Адрес брокеров
//  ИмяГруппыКонсьюмеров  - Строка - Consumer group ID
//  ИмяТопика             - Строка - Имя топика
//  НомерПартиции         - Число - Номер партиции
//  НовыйОффсет           - Число - Новое значение оффсета
//  Эндпоинт              - СправочникСсылка.инт_Эндпоинты - Эндпоинт (опционально)
//
// Возвращаемое значение:
//  Структура:
//   * Успех - Булево
//   * ОписаниеОшибки - Строка
//
Функция УстановитьОффсетКонсьюмера(Брокеры, ИмяГруппыКонсьюмеров, ИмяТопика, НомерПартиции, НовыйОффсет, Эндпоинт = Неопределено) Экспорт

// Получает информацию о партициях топика (watermarks)
//
// Параметры:
//  Брокеры   - Строка - Адрес брокеров
//  ИмяТопика - Строка - Имя топика
//  Эндпоинт  - СправочникСсылка.инт_Эндпоинты - Эндпоинт (опционально)
//
// Возвращаемое значение:
//  Структура:
//   * Успех - Булево
//   * ОписаниеОшибки - Строка
//   * Партиции - Массив из Структура (partition, leader, high_watermark, low_watermark, messages_count)
//
Функция ПолучитьИнформациюОПартициях(Брокеры, ИмяТопика, Эндпоинт = Неопределено) Экспорт
```

### 3. Регистрация в конфигурации

Добавить в `Configuration.xml`:
```xml
<CommonForm>инт_УправлениеТопикамиKafka</CommonForm>
```

## Порядок внедрения

1. Добавить новые методы в `инт_РаботаСКафка`
2. Создать метаданные общей формы (`.xml`)
3. Создать `Form.xml` (визуальная структура)
4. Создать `Module.bsl` (логика формы)
5. Зарегистрировать в `Configuration.xml`
6. Написать тесты
