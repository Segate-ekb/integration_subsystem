# Спецификация: Полиморфные подписчики

## Обзор

Рефакторинг архитектуры подписчиков: замена единого справочника `инт_Подписчики` (God Object) на набор типизированных справочников, связанных через `ОпределяемыйТип`. Каждый справочник инкапсулирует логику отправки в модуле менеджера.

## Проблемы текущей архитектуры

1. **God Object** — справочник `инт_Подписчики` содержит реквизиты для всех типов (~60% пустых для каждого конкретного типа)
2. **Switch/case dispatch** — выбор логики через `Перечисления.инт_ТипыПодписчиков.ОбщийМодульОбработкиСообщенийПоТипуПодписчика()`
3. **Размазанная логика** — код отправки в отдельных общих модулях `инт_РаботаССообщениями*`
4. **Дублирование** — эндпоинт хранился и в подписчике, и в топике Kafka

## Целевая архитектура

```
инт_ПотокиДанных
├─ ПодписчикиПотока (ТЧ)
│   └─ Подписчик: ОпределяемыйТип.инт_Подписчик
│        ├─ СправочникСсылка.инт_ПодписчикиHTTP
│        ├─ СправочникСсылка.инт_ПодписчикиJRPC
│        ├─ СправочникСсылка.инт_ПодписчикиПодсистемаИнтеграции
│        ├─ СправочникСсылка.инт_ПодписчикиKafka
│        └─ СправочникСсылка.инт_ПодписчикиRabbitMQ
                    │
                    ▼
Каждый справочник реализует интерфейс в МодулеМенеджера:
├─ СформироватьСообщение(Данные, Подписчик, УИД) → Строка
└─ ОтправитьСообщение(Сообщение, ОтложенныеДействия)
```

---

## 1. Новые объекты метаданных

### 1.1. ОпределяемыйТип.инт_Подписчик

Составной тип для полиморфной ссылки на любой справочник подписчика.

```xml
<Type>
    <v8:Type>cfg:CatalogRef.инт_ПодписчикиHTTP</v8:Type>
    <v8:Type>cfg:CatalogRef.инт_ПодписчикиJRPC</v8:Type>
    <v8:Type>cfg:CatalogRef.инт_ПодписчикиПодсистемаИнтеграции</v8:Type>
    <v8:Type>cfg:CatalogRef.инт_ПодписчикиKafka</v8:Type>
    <v8:Type>cfg:CatalogRef.инт_ПодписчикиRabbitMQ</v8:Type>
</Type>
```

### 1.2. ОбщийМодуль.инт_ПодписчикиОбщий

Модуль-диспетчер для вызова методов типизированных справочников подписчиков.

> **Примечание**: БСП отсутствует, используем `ТипЗнч()` для определения типа.

```bsl
#Область ПрограммныйИнтерфейс

// Формирует сообщение для отправки подписчику
//
// Параметры:
//  ДанныеСообщения - Соответствие - Данные для сериализации
//  Подписчик - ОпределяемыйТип.инт_Подписчик - Ссылка на подписчика
//  ИдентификаторСообщения - УникальныйИдентификатор - УИД сообщения
//
// Возвращаемое значение:
//  Строка - Сериализованное сообщение
//
Функция СформироватьСообщение(ДанныеСообщения, Подписчик, ИдентификаторСообщения) Экспорт
    
    ТипПодписчика = ТипЗнч(Подписчик);
    
    Если ТипПодписчика = Тип("СправочникСсылка.инт_ПодписчикиHTTP") Тогда
        Возврат Справочники.инт_ПодписчикиHTTP.СформироватьСообщение(ДанныеСообщения, Подписчик, ИдентификаторСообщения);
        
    ИначеЕсли ТипПодписчика = Тип("СправочникСсылка.инт_ПодписчикиJRPC") Тогда
        Возврат Справочники.инт_ПодписчикиJRPC.СформироватьСообщение(ДанныеСообщения, Подписчик, ИдентификаторСообщения);
        
    ИначеЕсли ТипПодписчика = Тип("СправочникСсылка.инт_ПодписчикиПодсистемаИнтеграции") Тогда
        Возврат Справочники.инт_ПодписчикиПодсистемаИнтеграции.СформироватьСообщение(ДанныеСообщения, Подписчик, ИдентификаторСообщения);
        
    ИначеЕсли ТипПодписчика = Тип("СправочникСсылка.инт_ПодписчикиKafka") Тогда
        Возврат Справочники.инт_ПодписчикиKafka.СформироватьСообщение(ДанныеСообщения, Подписчик, ИдентификаторСообщения);
        
    ИначеЕсли ТипПодписчика = Тип("СправочникСсылка.инт_ПодписчикиRabbitMQ") Тогда
        Возврат Справочники.инт_ПодписчикиRabbitMQ.СформироватьСообщение(ДанныеСообщения, Подписчик, ИдентификаторСообщения);
        
    Иначе
        ВызватьИсключение СтрШаблон("Неизвестный тип подписчика: %1", ТипПодписчика);
    КонецЕсли;
    
КонецФункции

// Отправляет сообщение подписчику
//
// Параметры:
//  Сообщение - Структура - Данные сообщения (ИдентификаторСообщения, Подписчик, СформированноеСообщение)
//  ОтложенныеДействия - Соответствие - Для пакетной обработки
//
Процедура ОтправитьСообщение(Сообщение, ОтложенныеДействия) Экспорт
    
    Подписчик = Сообщение.Подписчик;
    ТипПодписчика = ТипЗнч(Подписчик);
    
    Если ТипПодписчика = Тип("СправочникСсылка.инт_ПодписчикиHTTP") Тогда
        Справочники.инт_ПодписчикиHTTP.ОтправитьСообщение(Сообщение, ОтложенныеДействия);
        
    ИначеЕсли ТипПодписчика = Тип("СправочникСсылка.инт_ПодписчикиJRPC") Тогда
        Справочники.инт_ПодписчикиJRPC.ОтправитьСообщение(Сообщение, ОтложенныеДействия);
        
    ИначеЕсли ТипПодписчика = Тип("СправочникСсылка.инт_ПодписчикиПодсистемаИнтеграции") Тогда
        Справочники.инт_ПодписчикиПодсистемаИнтеграции.ОтправитьСообщение(Сообщение, ОтложенныеДействия);
        
    ИначеЕсли ТипПодписчика = Тип("СправочникСсылка.инт_ПодписчикиKafka") Тогда
        Справочники.инт_ПодписчикиKafka.ОтправитьСообщение(Сообщение, ОтложенныеДействия);
        
    ИначеЕсли ТипПодписчика = Тип("СправочникСсылка.инт_ПодписчикиRabbitMQ") Тогда
        Справочники.инт_ПодписчикиRabbitMQ.ОтправитьСообщение(Сообщение, ОтложенныеДействия);
        
    Иначе
        ВызватьИсключение СтрШаблон("Неизвестный тип подписчика: %1", ТипПодписчика);
    КонецЕсли;
    
КонецПроцедуры

// Возвращает параметры повтора для подписчика
//
// Параметры:
//  Подписчик - ОпределяемыйТип.инт_Подписчик - Ссылка на подписчика
//
// Возвращаемое значение:
//  Структура - КоличествоПопытокОтправки, ПаузаМеждуПопытками
//
Функция ПолучитьПараметрыПовтора(Подписчик) Экспорт
    
    Результат = Новый Структура;
    Результат.Вставить("КоличествоПопытокОтправки", Подписчик.КоличествоПопытокОтправки);
    Результат.Вставить("ПаузаМеждуПопытками", Подписчик.ПаузаМеждуПопытками);
    
    Возврат Результат;
    
КонецФункции

#КонецОбласти
```

---

## 2. Справочники подписчиков

### 2.1. Общие реквизиты (во всех справочниках)

| Имя | Тип | Описание | Значение по умолчанию |
|-----|-----|----------|----------------------|
| `Активен` | Булево | Флаг активности | Истина |
| `КоличествоПопытокОтправки` | Число(2,0) | Количество повторных попыток | 3 |
| `ПаузаМеждуПопытками` | Число(10,0) | Пауза между попытками (сек) | 60 |

### 2.2. Табличная часть ПостПроцессинг (HTTP, JRPC, ПодсистемаИнтеграции)

| Имя | Тип | Описание |
|-----|-----|----------|
| `КодСостояния` | Число(3,0) | HTTP-код ответа |
| `Обработчик` | Строка(0) | BSL-код обработчика |

---

### 2.3. Справочник инт_ПодписчикиHTTP

**Синоним**: (инт) Подписчики HTTP

**Специфичные реквизиты**:

| Имя | Тип | Описание |
|-----|-----|----------|
| `Эндпоинт` | СправочникСсылка.инт_Эндпоинты | HTTP-сервер |
| `СпособПередачиИдентификатораСообщения` | ПеречислениеСсылка.инт_СпособыПередачиПараметровПоHTTP | В пути/заголовке/параметре |
| `СпособПередачиИдентификатораПотока` | ПеречислениеСсылка.инт_СпособыПередачиПараметровПоHTTP | В пути/заголовке/параметре |

**Табличные части**: ПостПроцессинг

**Модуль менеджера**:

```bsl
#Область ПрограммныйИнтерфейс

Функция ПолучитьТипОтправки() Экспорт
    Возврат Перечисления.инт_ТипОтправки.HTTP;
КонецФункции

Функция СформироватьСообщение(ДанныеСообщения, Подписчик, ИдентификаторСообщения) Экспорт
    Возврат инт_КоннекторHTTP.ОбъектВJson(ДанныеСообщения);
КонецФункции

Процедура ОтправитьСообщение(Сообщение, ОтложенныеДействия) Экспорт
    
    Подписчик = Сообщение.Подписчик;
    
    СтруктураПараметровСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
    
    // Формируем URL с учётом способа передачи параметров
    URL = СформироватьURL(Подписчик, Сообщение.ИдентификаторСообщения, Сообщение.ИдентификаторПотока);
    Заголовки = СформироватьЗаголовки(Подписчик, Сообщение.ИдентификаторСообщения, Сообщение.ИдентификаторПотока);
    
    Ответ = инт_КоннекторHTTP.Post(URL, Сообщение.СформированноеСообщение, Заголовки, СтруктураПараметровСоединения);
    
    // Постобработка по коду ответа
    ВыполнитьПостПроцессинг(Подписчик, Ответ);
    
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция СформироватьURL(Подписчик, ИдентификаторСообщения, ИдентификаторПотока)
    // Реализация формирования URL с учётом СпособПередачиИдентификатора*
КонецФункции

Функция СформироватьЗаголовки(Подписчик, ИдентификаторСообщения, ИдентификаторПотока)
    // Реализация формирования заголовков
КонецФункции

Процедура ВыполнитьПостПроцессинг(Подписчик, Ответ)
    // Поиск обработчика по коду ответа в ТЧ ПостПроцессинг
    // Выполнение BSL-кода обработчика
КонецПроцедуры

#КонецОбласти
```

---

### 2.4. Справочник инт_ПодписчикиJRPC

**Синоним**: (инт) Подписчики JSON-RPC 2.0

**Специфичные реквизиты**:

| Имя | Тип | Описание |
|-----|-----|----------|
| `Эндпоинт` | СправочникСсылка.инт_Эндпоинты | HTTP-сервер JSON-RPC |

**Табличные части**: ПостПроцессинг

**Модуль менеджера**:

```bsl
#Область ПрограммныйИнтерфейс

Функция СформироватьСообщение(ДанныеСообщения, Подписчик, ИдентификаторСообщения) Экспорт
    
    // Формат JSON-RPC 2.0
    СообщениеJRPC = Новый Структура;
    СообщениеJRPC.Вставить("jsonrpc", "2.0");
    СообщениеJRPC.Вставить("method", "processMessage");
    СообщениеJRPC.Вставить("params", ДанныеСообщения);
    СообщениеJRPC.Вставить("id", Строка(ИдентификаторСообщения));
    
    Возврат инт_КоннекторHTTP.ОбъектВJson(СообщениеJRPC);
    
КонецФункции

Процедура ОтправитьСообщение(Сообщение, ОтложенныеДействия) Экспорт
    
    Подписчик = Сообщение.Подписчик;
    
    СтруктураПараметровСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
    
    Заголовки = Новый Соответствие;
    Заголовки.Вставить("Content-Type", "application/json");
    
    Ответ = инт_КоннекторHTTP.Post(
        Подписчик.Эндпоинт.АдресРесурса, 
        Сообщение.СформированноеСообщение, 
        Заголовки, 
        СтруктураПараметровСоединения
    );
    
КонецПроцедуры

#КонецОбласти
```

---

### 2.5. Справочник инт_ПодписчикиПодсистемаИнтеграции

**Синоним**: (инт) Подписчики Подсистема интеграции

**Специфичные реквизиты**:

| Имя | Тип | Описание |
|-----|-----|----------|
| `Эндпоинт` | СправочникСсылка.инт_Эндпоинты | HTTP-сервис подсистемы интеграции |
| `ИдентификаторПотокаПриёмника` | Строка(36) | UUID потока в базе-приёмнике |

**Табличные части**: ПостПроцессинг

**Модуль менеджера**:

```bsl
#Область ПрограммныйИнтерфейс

Функция СформироватьСообщение(ДанныеСообщения, Подписчик, ИдентификаторСообщения) Экспорт
    Возврат инт_КоннекторHTTP.ОбъектВJson(ДанныеСообщения);
КонецФункции

Процедура ОтправитьСообщение(Сообщение, ОтложенныеДействия) Экспорт
    
    Подписчик = Сообщение.Подписчик;
    
    СтруктураПараметровСоединения = Справочники.инт_Эндпоинты.СтруктураПараметровСоединения(Подписчик.Эндпоинт);
    
    // URL по шаблону подсистемы интеграции
    URL = СтрШаблон("%1/hs/integration/v1/incoming/%2", 
        Подписчик.Эндпоинт.АдресРесурса,
        Подписчик.ИдентификаторПотокаПриёмника);
    
    Заголовки = Новый Соответствие;
    Заголовки.Вставить("X-Message-ID", Строка(Сообщение.ИдентификаторСообщения));
    
    инт_КоннекторHTTP.Post(URL, Сообщение.СформированноеСообщение, Заголовки, СтруктураПараметровСоединения);
    
КонецПроцедуры

#КонецОбласти
```

---

### 2.6. Справочник инт_ПодписчикиKafka

**Синоним**: (инт) Подписчики Kafka

**Специфичные реквизиты**:

| Имя | Тип | Описание |
|-----|-----|----------|
| `Эндпоинт` | СправочникСсылка.инт_Эндпоинты | Kafka брокер (bootstrap servers) |
| `ИмяТопика` | Строка(255) | Имя топика в Kafka |
| `ПакетнаяОбработка` | Булево | Отправка пакетом в конце обработки потока |

**Табличные части**: Нет

**Модуль менеджера**:

```bsl
#Область ПрограммныйИнтерфейс

Функция СформироватьСообщение(ДанныеСообщения, Подписчик, ИдентификаторСообщения) Экспорт
    // TODO: Поддержка Protobuf, Avro
    Возврат инт_КоннекторHTTP.ОбъектВJson(ДанныеСообщения);
КонецФункции

Процедура ОтправитьСообщение(Сообщение, ОтложенныеДействия) Экспорт
    
    Подписчик = Сообщение.Подписчик;
    
    Если Подписчик.ПакетнаяОбработка Тогда
        // Накапливаем сообщения для пакетной отправки
        МассивСообщений = ОтложенныеДействия.Получить(Подписчик);
        Если МассивСообщений = Неопределено Тогда
            МассивСообщений = Новый Массив;
            ОтложенныеДействия.Вставить(Подписчик, МассивСообщений);
        КонецЕсли;
        
        СтруктураСообщения = инт_РаботаСКафка.ПолучитьСтруктуруСообщенияДляПакетнойОтправки();
        СтруктураСообщения.message = Сообщение.СформированноеСообщение;
        МассивСообщений.Добавить(СтруктураСообщения);
    Иначе
        Брокеры = Подписчик.Эндпоинт.АдресРесурса;
        инт_РаботаСКафка.ОтправитьСообщение(Сообщение.СформированноеСообщение, Брокеры, Подписчик.ИмяТопика);
    КонецЕсли;
    
КонецПроцедуры

// Отправка накопленного пакета (вызывается в конце обработки потока)
Процедура ОтправитьПакет(Подписчик, МассивСообщений) Экспорт
    
    Брокеры = Подписчик.Эндпоинт.АдресРесурса;
    инт_РаботаСКафка.ОтправитьСообщенияПакетом(МассивСообщений, Брокеры, Подписчик.ИмяТопика);
    
КонецПроцедуры

#КонецОбласти
```

---

### 2.7. Справочник инт_ПодписчикиRabbitMQ

**Синоним**: (инт) Подписчики RabbitMQ

**Специфичные реквизиты**:

| Имя | Тип | Описание |
|-----|-----|----------|
| `Эндпоинт` | СправочникСсылка.инт_Эндпоинты | RabbitMQ брокер |
| `Exchange` | Строка(255) | Имя exchange |
| `RoutingKey` | Строка(255) | Routing key для маршрутизации |
| `Queue` | Строка(255) | Имя очереди (опционально) |

**Табличные части**: Нет

**Модуль менеджера**:

```bsl
#Область ПрограммныйИнтерфейс

Функция СформироватьСообщение(ДанныеСообщения, Подписчик, ИдентификаторСообщения) Экспорт
    Возврат инт_КоннекторHTTP.ОбъектВJson(ДанныеСообщения);
КонецФункции

Процедура ОтправитьСообщение(Сообщение, ОтложенныеДействия) Экспорт
    ВызватьИсключение "Отправка в RabbitMQ не реализована";
КонецПроцедуры

#КонецОбласти
```

---

## 3. Изменения существующих объектов

### 3.1. Справочник инт_ПотокиДанных

**Изменение ТЧ ПодписчикиПотока**:

```xml
<!-- Было -->
<Type>
    <v8:Type>cfg:CatalogRef.инт_Подписчики</v8:Type>
</Type>

<!-- Стало -->
<Type>
    <v8:TypeSet>cfg:DefinedType.инт_Подписчик</v8:TypeSet>
</Type>
```

### 3.2. Регистр инт_ОчередьОтправкиИсходящихСообщений

**Изменение измерения Подписчик**:

```xml
<!-- Было -->
<Type>
    <v8:Type>cfg:CatalogRef.инт_Подписчики</v8:Type>
</Type>

<!-- Стало -->
<Type>
    <v8:TypeSet>cfg:DefinedType.инт_Подписчик</v8:TypeSet>
</Type>
```

### 3.3. Регистр инт_ТекущийСтатусРассылкиСообщений

**Изменение измерения Подписчик** — аналогично п.3.2.

### 3.4. Модуль инт_ОтправкаИсходящихСообщенийПовтИсп

**Удалить** функцию `ОбщийМодульОбработкиСообщенийПоТипуПодписчика()` (switch/case).

**Заменить вызовы**:

```bsl
// Было
Модуль = инт_ОтправкаИсходящихСообщенийПовтИсп.ОбщийМодульОбработкиСообщенийПоТипуПодписчика(ТипПодписчика);
Модуль.ОтправитьСообщение(Сообщение, ОтложенныеДействия);

// Стало
инт_ПодписчикиОбщий.ОтправитьСообщение(Сообщение, ОтложенныеДействия);
```

### 3.5. Модуль инт_ОчередьОтправкиИсходящихСообщений

**Изменить группировку потоков**:

```bsl
// Было: итерация по Перечисления.инт_ТипыПодписчиков
Для Каждого ТипПодписчика Из Перечисления.инт_ТипыПодписчиков Цикл
    ...
КонецЦикла;

// Стало: единый запрос без группировки по типу
// Тип определяется автоматически через ТипЗнч() в инт_ПодписчикиОбщий
```

---

## 4. Удаляемые объекты

| Тип | Имя | Причина удаления |
|-----|-----|------------------|
| Справочник | `инт_Подписчики` | Заменён на 5 типизированных справочников |
| Перечисление | `инт_ТипыПодписчиков` | Тип определяется справочником |
| ОбщийМодуль | `инт_РаботаССообщениямиKafka` | Логика в МодулеМенеджера справочника |
| ОбщийМодуль | `инт_РаботаССообщениямиПроизвольныйHTTP` | Логика в МодулеМенеджера справочника |
| ОбщийМодуль | `инт_РаботаССообщениямиJRPC2` | Логика в МодулеМенеджера справочника |
| ОбщийМодуль | `инт_РаботаССообщениямиПодсистемаИнтеграции` | Логика в МодулеМенеджера справочника |
| ОбщийМодуль | `инт_РаботаССообщениямиRabbitMQ` | Логика в МодулеМенеджера справочника |

---

## 5. Диаграмма связей (целевая)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        ЦЕЛЕВАЯ АРХИТЕКТУРА                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  инт_ПотокиДанных                                                       │
│    └─ ТЧ ПодписчикиПотока                                               │
│         └─ Подписчик: ОпределяемыйТип.инт_Подписчик                     │
│              │                                                          │
│              ├─► инт_ПодписчикиHTTP ─────────────┐                      │
│              │     └─ Эндпоинт ──────────────────┼──► инт_Эндпоинты     │
│              │     └─ ТЧ ПостПроцессинг         │                      │
│              │                                   │                      │
│              ├─► инт_ПодписчикиJRPC ─────────────┤                      │
│              │     └─ Эндпоинт ──────────────────┤                      │
│              │     └─ ТЧ ПостПроцессинг         │                      │
│              │                                   │                      │
│              ├─► инт_ПодписчикиПодсистемаИнтеграции                     │
│              │     └─ Эндпоинт ──────────────────┤                      │
│              │     └─ ИдентификаторПотокаПриёмника                      │
│              │     └─ ТЧ ПостПроцессинг         │                      │
│              │                                   │                      │
│              ├─► инт_ПодписчикиKafka             │                      │
│              │     └─ Эндпоинт ──────────────────┤                      │
│              │     └─ ИмяТопика                  │                      │
│              │     └─ ПакетнаяОбработка          │                      │
│              │                                   │                      │
│              └─► инт_ПодписчикиRabbitMQ          │                      │
│                    └─ Эндпоинт ──────────────────┘                      │
│                    └─ Exchange, RoutingKey, Queue                       │
│                                                                         │
│  Каждый справочник реализует интерфейс в МодулеМенеджера:              │
│    ├─ СформироватьСообщение()                                          │
│    ├─ ОтправитьСообщение()                                             │
│    ├─ ПолучитьТипОтправки()                                            │
│    └─ ПолучитьПараметрыПовтора()                                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Порядок внедрения

1. ☐ Создать `ОбщийМодуль.инт_ПодписчикиОбщий`
2. ☐ Создать 5 справочников с модулями менеджеров
3. ☐ Создать `ОпределяемыйТип.инт_Подписчик`
4. ☐ Изменить ТЧ `ПодписчикиПотока` в `инт_ПотокиДанных`
5. ☐ Изменить регистры (измерение Подписчик)
6. ☐ Рефакторинг общих модулей отправки
7. ☐ Удалить устаревшие объекты
8. ☐ Обновить `Configuration.xml` и подсистему
9. ☐ Обновить тесты и `ГенераторТестовыхДанных`
