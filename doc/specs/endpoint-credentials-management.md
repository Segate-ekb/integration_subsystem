# Спецификация: Управление учётными данными в эндпоинтах

## Обзор

Редизайн системы управления учётными данными (credentials) для справочника `инт_Эндпоинты`. Отказ от динамического формирования интерфейса на форме подписчика в пользу собственной формы элемента эндпоинта с фиксированным интерфейсом для каждого типа авторизации.

## Цели

1. **Безопасность** — все секретные данные хранятся в БезопасномХранилище
2. **Удобство** — единая форма эндпоинта для управления учётными данными
3. **Расширяемость** — простое добавление новых типов авторизации
4. **Отказ от динамического UI** — фиксированные страницы формы вместо программного создания элементов

## Проблемы текущей архитектуры

1. **Динамическое формирование** — элементы формы создаются программно через `инт_ДинамическоеФормированиеИнтерфейса`
2. **Связанность** — эндпоинт интегрируется в форму подписчика, а не является самостоятельной сущностью
3. **Ограниченность** — поддержка только Basic, Bearer, TLS, Анонимный
4. **Хранение сертификатов** — TLS реквизиты описаны, но не используются

---

## Типы авторизации

### Перечисление `инт_ТипыАвторизации`

| Значение | Описание | Параметры |
|----------|----------|-----------|
| `Анонимный` | Без авторизации | — |
| `Basic` | HTTP Basic Auth | Пользователь, Пароль |
| `Bearer` | Bearer Token | Токен |
| `Digest` | HTTP Digest Auth | Пользователь, Пароль |
| `Tls` | Клиентский сертификат (mTLS) | Сертификат (путь/хранилище), Пароль сертификата |
| `ApiKey` | API Key в заголовке | Имя заголовка, Значение ключа |

### Новые значения перечисления

Добавить в `инт_ТипыАвторизации`:
- `Digest`
- `ApiKey`

---

## Архитектура хранения

### Реквизиты справочника `инт_Эндпоинты`

| Реквизит | Тип | Описание |
|----------|-----|----------|
| `Наименование` | Строка(150) | Наименование (стандартный) |
| `АдресРесурса` | Строка(500) | URL базового ресурса |
| `ТипАвторизации` | ПеречислениеСсылка.инт_ТипыАвторизации | Тип авторизации |
| `ПроверятьSSL` | Булево | Проверять сертификат сервера (по умолчанию Истина) |
| `ТаймаутСоединения` | Число(5,0) | Таймаут подключения в секундах |

### Безопасное хранилище (ключи)

Все секретные данные хранятся в `БезопасноеХранилищеДанных` с ключами:

| Ключ | Тип авторизации | Описание |
|------|-----------------|----------|
| `Basic_Пользователь` | Basic, Digest | Имя пользователя |
| `Basic_Пароль` | Basic, Digest | Пароль |
| `Bearer_Токен` | Bearer | Bearer-токен |
| `Tls_СертификатПуть` | Tls | Путь к файлу сертификата |
| `Tls_СертификатПароль` | Tls | Пароль сертификата |
| `Tls_СертификатХранилище` | Tls | Отпечаток сертификата в хранилище Windows |
| `ApiKey_ИмяЗаголовка` | ApiKey | Имя заголовка (например, X-API-Key) |
| `ApiKey_Значение` | ApiKey | Значение ключа |

---

## Форма элемента эндпоинта

### Структура формы

```
┌─────────────────────────────────────────────────────────────┐
│ Наименование: [_______________________________________]     │
│ Адрес ресурса: [https://api.example.com_______________]     │
│                                                             │
│ ┌─ Настройки подключения ──────────────────────────────┐    │
│ │ ☑ Проверять SSL сертификат                           │    │
│ │ Таймаут соединения: [30] сек                         │    │
│ └──────────────────────────────────────────────────────┘    │
│                                                             │
│ Тип авторизации: [Basic             ▼]                      │
│                                                             │
│ ┌─ Страницы авторизации (ОтображениеСтраниц = Нет) ─────┐   │
│ │                                                       │   │
│ │ [Страница: Basic]                                     │   │
│ │   Пользователь: [admin___________________________]    │   │
│ │   Пароль:       [••••••••••______] [Показать]         │   │
│ │                                                       │   │
│ │ [Страница: Bearer]                                    │   │
│ │   Токен: [••••••••••••••••••••••••] [Показать]        │   │
│ │                                                       │   │
│ │ [Страница: Tls]                                       │   │
│ │   ○ Файл сертификата                                  │   │
│ │     Путь: [C:\certs\client.pfx___] [...]              │   │
│ │     Пароль: [••••••••_____________]                   │   │
│ │   ○ Хранилище Windows                                 │   │
│ │     Отпечаток: [ABC123DEF456_______]                  │   │
│ │                                                       │   │
│ │ [Страница: ApiKey]                                    │   │
│ │   Имя заголовка: [X-API-Key_________________]         │   │
│ │   Значение:      [••••••••••••••••••••••••__]         │   │
│ │                                                       │   │
│ │ [Страница: Digest]                                    │   │
│ │   Пользователь: [admin___________________________]    │   │
│ │   Пароль:       [••••••••••______] [Показать]         │   │
│ │                                                       │   │
│ │ [Страница: Анонимный]                                 │   │
│ │   Авторизация не требуется                            │   │
│ │                                                       │   │
│ └───────────────────────────────────────────────────────┘   │
│                                                             │
│              [Проверить подключение] [Записать] [Закрыть]   │
└─────────────────────────────────────────────────────────────┘
```

### Реквизиты формы (не сохраняемые)

Для каждого типа авторизации создаются реквизиты формы для редактирования секретных данных:

```bsl
// Basic / Digest
Basic_Пользователь: Строка
Basic_Пароль: Строка
Basic_ПарольИзменен: Булево  // Флаг изменения

// Bearer  
Bearer_Токен: Строка
Bearer_ТокенИзменен: Булево

// TLS
Tls_ИсточникСертификата: Число  // 0 = файл, 1 = хранилище
Tls_СертификатПуть: Строка
Tls_СертификатПароль: Строка
Tls_СертификатХранилище: Строка
Tls_СертификатИзменен: Булево

// ApiKey
ApiKey_ИмяЗаголовка: Строка
ApiKey_Значение: Строка
ApiKey_ЗначениеИзменено: Булево
```

---

## Модуль менеджера справочника `инт_Эндпоинты`

### Публичный API

```bsl
#Область ПрограммныйИнтерфейс

// Возвращает структуру параметров соединения для эндпоинта.
// Структура содержит URL, настройки SSL и сессию с аутентификацией.
//
// Параметры:
//  Эндпоинт - СправочникСсылка.инт_Эндпоинты - Ссылка на эндпоинт
//
// Возвращаемое значение:
//  Структура:
//    * АдресРесурса - Строка - URL базового ресурса
//    * ПроверятьSSL - Булево - Проверять ли сертификат сервера
//    * ТаймаутСоединения - Число - Таймаут в секундах
//    * Сессия - Структура - см. инт_КоннекторHTTP.СоздатьСессию()
//
Функция СтруктураПараметровСоединения(Эндпоинт) Экспорт

// Возвращает структуру аутентификации для HTTP-коннектора.
//
// Параметры:
//  Эндпоинт - СправочникСсылка.инт_Эндпоинты - Ссылка на эндпоинт
//
// Возвращаемое значение:
//  Структура, Неопределено - Структура аутентификации или Неопределено для анонимного
//
Функция ПолучитьАутентификацию(Эндпоинт) Экспорт

// Проверяет возможность подключения к эндпоинту.
// Выполняет HEAD или GET запрос и проверяет ответ.
//
// Параметры:
//  Эндпоинт - СправочникСсылка.инт_Эндпоинты - Ссылка на эндпоинт
//
// Возвращаемое значение:
//  Структура:
//    * Успех - Булево
//    * КодСостояния - Число - HTTP код ответа
//    * СообщениеОбОшибке - Строка
//
Функция ПроверитьПодключение(Эндпоинт) Экспорт

#КонецОбласти
```

### Работа с аутентификацией

```bsl
#Область СлужебныеПроцедурыИФункции

Функция ЗаполнитьАутентификацию(Эндпоинт)
    
    ТипАвторизации = Эндпоинт.ТипАвторизации;
    
    Если ТипАвторизации = Перечисления.инт_ТипыАвторизации.Анонимный Тогда
        Возврат Неопределено;
        
    ИначеЕсли ТипАвторизации = Перечисления.инт_ТипыАвторизации.Basic Тогда
        Возврат ЗаполнитьАутентификациюBasic(Эндпоинт);
        
    ИначеЕсли ТипАвторизации = Перечисления.инт_ТипыАвторизации.Digest Тогда
        Возврат ЗаполнитьАутентификациюDigest(Эндпоинт);
        
    ИначеЕсли ТипАвторизации = Перечисления.инт_ТипыАвторизации.Bearer Тогда
        Возврат ЗаполнитьАутентификациюBearer(Эндпоинт);
        
    ИначеЕсли ТипАвторизации = Перечисления.инт_ТипыАвторизации.Tls Тогда
        Возврат ЗаполнитьАутентификациюTls(Эндпоинт);
        
    ИначеЕсли ТипАвторизации = Перечисления.инт_ТипыАвторизации.ApiKey Тогда
        Возврат ЗаполнитьАутентификациюApiKey(Эндпоинт);
        
    Иначе
        ВызватьИсключение СтрШаблон("Неизвестный тип авторизации: %1", ТипАвторизации);
    КонецЕсли;
    
КонецФункции

Функция ЗаполнитьАутентификациюBasic(Эндпоинт)
    
    Пользователь = ПрочитатьИзБезопасногоХранилища(Эндпоинт, "Basic_Пользователь");
    Пароль = ПрочитатьИзБезопасногоХранилища(Эндпоинт, "Basic_Пароль");
    
    Возврат инт_КоннекторHTTP.НоваяАутентификацияBasic(Пользователь, Пароль);
    
КонецФункции

Функция ЗаполнитьАутентификациюDigest(Эндпоинт)
    
    Пользователь = ПрочитатьИзБезопасногоХранилища(Эндпоинт, "Basic_Пользователь");
    Пароль = ПрочитатьИзБезопасногоХранилища(Эндпоинт, "Basic_Пароль");
    
    Возврат инт_КоннекторHTTP.НоваяАутентификацияDigest(Пользователь, Пароль);
    
КонецФункции

Функция ЗаполнитьАутентификациюBearer(Эндпоинт)
    
    Токен = ПрочитатьИзБезопасногоХранилища(Эндпоинт, "Bearer_Токен");
    
    Возврат инт_КоннекторHTTP.НоваяАутентификацияBearer(Токен);
    
КонецФункции

Функция ЗаполнитьАутентификациюTls(Эндпоинт)
    
    СертификатПуть = ПрочитатьИзБезопасногоХранилища(Эндпоинт, "Tls_СертификатПуть");
    СертификатПароль = ПрочитатьИзБезопасногоХранилища(Эндпоинт, "Tls_СертификатПароль");
    СертификатХранилище = ПрочитатьИзБезопасногоХранилища(Эндпоинт, "Tls_СертификатХранилище");
    
    Если ЗначениеЗаполнено(СертификатПуть) Тогда
        // Сертификат из файла
        КлиентскийСертификат = Новый СертификатКлиентаФайл(СертификатПуть, СертификатПароль);
    ИначеЕсли ЗначениеЗаполнено(СертификатХранилище) Тогда
        // Сертификат из хранилища Windows
        КлиентскийСертификат = Новый СертификатКлиентаWindows(СертификатХранилище);
    Иначе
        ВызватьИсключение "Не указан клиентский сертификат для TLS авторизации";
    КонецЕсли;
    
    Результат = Новый Структура;
    Результат.Вставить("КлиентскийСертификатSSL", КлиентскийСертификат);
    
    Возврат Результат;
    
КонецФункции

Функция ЗаполнитьАутентификациюApiKey(Эндпоинт)
    
    ИмяЗаголовка = ПрочитатьИзБезопасногоХранилища(Эндпоинт, "ApiKey_ИмяЗаголовка");
    Значение = ПрочитатьИзБезопасногоХранилища(Эндпоинт, "ApiKey_Значение");
    
    // ApiKey передаётся через заголовки сессии
    Результат = Новый Структура;
    Результат.Вставить("Тип", "ApiKey");
    Результат.Вставить("ИмяЗаголовка", ИмяЗаголовка);
    Результат.Вставить("Значение", Значение);
    
    Возврат Результат;
    
КонецФункции

#КонецОбласти
```

---

## Интеграция с подписчиками

### Отказ от динамического формирования на форме подписчика

Вместо вызова `Справочники.инт_Эндпоинты.ДобавитьИнформациюОбЭндпоинтеНаФорму()` на форме подписчика, используем:

1. **Реквизит `Эндпоинт`** типа `СправочникСсылка.инт_Эндпоинты` 
2. **Поле выбора** с кнопкой создания/редактирования
3. **Гиперссылка** для быстрого перехода к форме эндпоинта

### Изменения в формах подписчиков

```bsl
// Форма подписчика HTTP/JRPC/ПодсистемаИнтеграции

// Вместо:
// Справочники.инт_Эндпоинты.ДобавитьИнформациюОбЭндпоинтеНаФорму(...)

// Используем стандартный реквизит Объект.Эндпоинт с полем выбора
// и кнопкой "Настроить подключение" для открытия формы эндпоинта
```

### Пример формы подписчика HTTP

```
┌─────────────────────────────────────────────────────────────┐
│ Наименование: [API платёжной системы_______________]        │
│                                                             │
│ ☑ Активен                                                   │
│                                                             │
│ ┌─ Подключение ────────────────────────────────────────┐    │
│ │ Эндпоинт: [Платежи API (Basic) ▼] [⚙ Настроить]      │    │
│ │                                                       │    │
│ │ URL: https://api.payments.com                         │    │
│ │ Авторизация: Basic (admin)                            │    │
│ └───────────────────────────────────────────────────────┘    │
│                                                             │
│ ┌─ Параметры отправки ─────────────────────────────────┐    │
│ │ Способ передачи ID сообщения: [В заголовке ▼]        │    │
│ │ Способ передачи ID потока:    [В пути URL  ▼]        │    │
│ │                                                       │    │
│ │ Количество попыток: [3]                               │    │
│ │ Пауза между попытками: [60] сек                       │    │
│ └───────────────────────────────────────────────────────┘    │
│                                                             │
│              [Проверить подключение] [Записать] [Закрыть]   │
└─────────────────────────────────────────────────────────────┘
```

---

## Команды и обработчики

### Команда "Настроить подключение"

```bsl
&НаКлиенте
Процедура НастроитьЭндпоинт(Команда)
    
    Если Не ЗначениеЗаполнено(Объект.Эндпоинт) Тогда
        // Создаём новый эндпоинт
        ПараметрыФормы = Новый Структура;
        ОткрытьФорму("Справочник.инт_Эндпоинты.ФормаОбъекта", ПараметрыФормы, ЭтотОбъект);
    Иначе
        // Редактируем существующий
        ПараметрыФормы = Новый Структура("Ключ", Объект.Эндпоинт);
        ОткрытьФорму("Справочник.инт_Эндпоинты.ФормаОбъекта", ПараметрыФормы, ЭтотОбъект);
    КонецЕсли;
    
КонецПроцедуры
```

### Команда "Проверить подключение"

```bsl
&НаКлиенте
Процедура ПроверитьПодключение(Команда)
    
    Если Не ЗначениеЗаполнено(Объект.Эндпоинт) Тогда
        ПоказатьПредупреждение(, "Сначала выберите или создайте эндпоинт");
        Возврат;
    КонецЕсли;
    
    Результат = ПроверитьПодключениеНаСервере(Объект.Эндпоинт);
    
    Если Результат.Успех Тогда
        ПоказатьПредупреждение(, СтрШаблон("Подключение успешно! Код ответа: %1", Результат.КодСостояния));
    Иначе
        ПоказатьПредупреждение(, СтрШаблон("Ошибка подключения: %1", Результат.СообщениеОбОшибке));
    КонецЕсли;
    
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПроверитьПодключениеНаСервере(Эндпоинт)
    Возврат Справочники.инт_Эндпоинты.ПроверитьПодключение(Эндпоинт);
КонецФункции
```

---

## План миграции

### Этап 1: Расширение перечисления типов авторизации

1. Добавить значения в `инт_ТипыАвторизации`: Digest, ApiKey
2. Добавить реквизиты в справочник `инт_Эндпоинты`: ПроверятьSSL, ТаймаутСоединения

### Этап 2: Создание формы элемента эндпоинта

1. Создать форму `Справочник.инт_Эндпоинты.ФормаОбъекта`
2. Реализовать страницы для каждого типа авторизации
3. Реализовать сохранение/загрузку из БезопасногоХранилища
4. Добавить команду "Проверить подключение"

### Этап 3: Рефакторинг модуля менеджера

1. Реализовать функции аутентификации для новых типов
2. Удалить методы динамического формирования интерфейса

### Этап 4: Обновление форм подписчиков

1. Удалить вызовы `ДобавитьИнформациюОбЭндпоинтеНаФорму()`
2. Добавить кнопку "Настроить эндпоинт"
3. Добавить информационную декорацию с параметрами эндпоинта

### Этап 5: Удаление устаревшего кода

1. Удалить модуль `инт_ДинамическоеФормированиеИнтерфейса` (если больше не используется)
2. Удалить модули `инт_ЭндпоинтыКлиент`, `инт_ЭндпоинтыКлиентСервер`

---

## Тестирование

### Юнит-тесты (YAXUnit)

```bsl
// ОМ_инт_Эндпоинты

Процедура ИсполняемыеСценарии() Экспорт
    ЮТТесты.УдалениеТестовыхДанных().ВТранзакции()
        .ДобавитьТестовыйНабор("АутентификацияBasic")
            .ДобавитьТест("ТестЗаполнитьАутентификациюBasic")
        .ДобавитьТестовыйНабор("АутентификацияBearer")
            .ДобавитьТест("ТестЗаполнитьАутентификациюBearer")
        .ДобавитьТестовыйНабор("ПроверкаПодключения")
            .ДобавитьТест("ТестПроверитьПодключениеУспешно")
            .ДобавитьТест("ТестПроверитьПодключениеОшибка");
КонецПроцедуры

Процедура ТестЗаполнитьАутентификациюBasic() Экспорт
    // Arrange
    Эндпоинт = ГенераторТестовыхДанных.Эндпоинт("Basic");
    
    // Act
    Аутентификация = Справочники.инт_Эндпоинты.ПолучитьАутентификацию(Эндпоинт);
    
    // Assert
    ЮТест.ОжидаетЧто(Аутентификация).ИмеетСвойство("Тип").Равно("Basic");
    ЮТест.ОжидаетЧто(Аутентификация).ИмеетСвойство("Пользователь");
    ЮТест.ОжидаетЧто(Аутентификация).ИмеетСвойство("Пароль");
КонецПроцедуры
```

---

## Совместимость

- Метод `ДобавитьИнформациюОбЭндпоинтеНаФорму()` помечается как устаревший (deprecated)
- Существующие подписчики со встроенными эндпоинтами продолжают работать
- Миграция данных не требуется — секреты уже в БезопасномХранилище

---

## Безопасность

1. **Секреты** — все пароли, токены, ключи хранятся только в БезопасномХранилище
2. **Привилегированный режим** — доступ к хранилищу только через `УстановитьПривилегированныйРежим()`
3. **Маскирование** — поля паролей отображаются в режиме `РежимПароля = Истина`
4. **Журналирование** — попытки подключения логируются (без секретных данных)
